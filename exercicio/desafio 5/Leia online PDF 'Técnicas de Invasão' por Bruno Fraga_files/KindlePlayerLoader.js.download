define("KPLoader.min",function(){}),define("modules/utils/LocalStorage",["require","exports"],function(e,t){"use strict";function o(){var e="testLocalStorage",t="1";try{if(!window.localStorage)return!1;if(window.localStorage.setItem(e,t),window.localStorage.getItem(e)!==t)return!1}catch(o){return!1}return!0}function i(e){return void 0===e&&(e=n),o()?new s(e):new a(e)}var n="KindlePlayer",r={},a=function(){function e(e){this.namespace=e,r[e]||(r[e]={}),this.data=r[e]}return e.prototype.getItem=function(e){return this.data[e]},e.prototype.setItem=function(e,t){this.data[e]=t},e.prototype.removeItem=function(e){var t=this.data[e];return delete this.data[e],t},e.prototype.clear=function(){this.data={},delete r[this.namespace]},e}();t.MemoryStorage=a;var s=function(){function e(e){this.namespace=e;var t=window.localStorage.getItem(e);this.data=t&&JSON.parse(t)||{}}return e.prototype.getItem=function(e){return this.data[e]},e.prototype.setItem=function(e,t){this.data[e]=t,window.localStorage.setItem(this.namespace,JSON.stringify(this.data))},e.prototype.removeItem=function(e){var t=this.data[e];return delete this.data[e],window.localStorage.setItem(this.namespace,JSON.stringify(this.data)),t},e.prototype.clear=function(){this.data={},window.localStorage.removeItem(this.namespace)},e}();t.LocalStorage=s,t.getStorage=i}),define("modules/metrics/UploadManager",["require","exports","modules/utils/Config","modules/utils/Service","modules/metrics/MetricsUtils","modules/metrics/PMET","modules/metrics/ReadingStreams","modules/utils/LocalStorage","modules/utils/DeviceUtils","jquery"],function(e,t,o,i,n,r,a,s,l,d){"use strict";function c(e){function t(){var e=f;return e+="uploadMetrics"}function o(){var t={devicePlatform:e.devicePlatform,clientName:e.clientName,version:e.version,versionForCapability:e.versionForRS,versionForRS:e.versionForRS,messageNumber:e.messageNumber,sessionId:e.sessionId,metricBreakdown:e.breakdowns,metrics:e.metrics,readingStreamsMetrics:e.readingStreamsMetrics,marketplace:e.marketplace,pfm:e.pfm};return t}var n={Input:o(),Operation:"uploadMetricsExternal"},r=!e.isSync,a={url:t(),serviceCall:"uploadMetrics",postData:n,async:r};return console.debug("Uploading metrics:",n.Input),i.ajaxUnauthenticated(a).then(function(e){return e})}function u(e){function t(){R=!1,"hidden"!==document.visibilityState&&p()}if(!R){R=!0;var o=d.map(r.getBreakdownMap(),function(e,t){return t}),i=parseInt(y.getItem(w)||"0",10),n=d.map(E.getEvents(),function(e){return JSON.stringify(e)}),a=d.map(r.getMetrics(),function(e){return{method:e.reportedName,time:e.mainTimer.time,count:e.mainCounter.count,breakdown:o,properties:e.properties,counters:d.map(e.counters,function(e){return{name:e.name,count:e.count,breakdown:o}}),timers:d.map(e.timers,function(e){return delete e.started,e.breakdown=o,e})}});T.push.apply(T,n),k.push.apply(k,a),E.clearEvents(n.length),r.clearMetrics(a.length),T.length>0||k.length>0?(c({devicePlatform:m,clientName:g,marketplace:window.KindleGlobal.marketplace,pfm:window.KindleGlobal.pfm,breakdowns:r.getBreakdownMap(),version:v,versionForCapability:b,versionForRS:b,messageNumber:i,sessionId:window.KindleGlobal.requestInfo&&window.KindleGlobal.requestInfo.sId,metrics:k,readingStreamsMetrics:T,isSync:e}).then(function(){k=[],T=[]})["finally"](t)["catch"](function(e){console.warn("Error occurred during uploadMetrics() attempt (will try again shortly):",e)}),y.setItem(w,(i+1).toString())):t()}}function p(){P&&clearTimeout(P),P=setTimeout(u,C)}function h(){function e(){var e=n.getCurrentContainerView();e&&(E.hideContext(e),r.record(r.createMetric("ClosedTab").appendToReportedName(e))),u(!0)}S||(S=!0,p(),document.addEventListener("visibilitychange",function(){var e=n.getCurrentContainerView();"hidden"===document.visibilityState?(e&&E.hideContext(e),u()):(e&&E.showContext(e),p())}),d(window).bind("unload",e),window.addEventListener("beforeunload",function(){d(window).unbind("unload",e),e()}))}var f=o.getUnauthenticatedBaseServiceUrl(),m=window.KindleGlobal.amazonDeviceType+":"+l.getDeviceCategory(),g=o.getMetricsProgram(),v=o.appConfig.version,b=o.appConfig.versionForRS,E=a.getManager(),y=s.getStorage(),w="messageNumber",S=!1,R=!1,k=[],T=[],C=2e3;t.uploadMetrics=u;var P;t.init=h}),define("modules/book/BookInfo",["require","exports","modules/utils/Errors"],function(e,t,o){"use strict";function i(e,t){switch(e){case r.TOPAZ:case r.MOBI7:case r.MOBI8:var i=Number(t);if(i>=0)return new s(e,i);throw new o.KcrError("Negative positions are not allowed: "+i);default:throw new o.KcrError("Unrecognized position source type: "+e).setErrorCode(o.Codes.ReaderCreatePositionInvalidType)}}function n(e,t,o){return new l(e,t,o)}!function(e){e[e.EBOK=0]="EBOK",e[e.EBSP=1]="EBSP"}(t.Type||(t.Type={}));t.Type;!function(e){e[e.TOPAZ=1]="TOPAZ",e[e.MOBI7=2]="MOBI7",e[e.MOBI8=3]="MOBI8",e[e.YJBINARY=4]="YJBINARY"}(t.Format||(t.Format={}));var r=t.Format;!function(e){e[e.REFLOWABLE=0]="REFLOWABLE",e[e.FIXED=1]="FIXED"}(t.FlowType||(t.FlowType={}));var a=t.FlowType;!function(e){e[e.Metadata=0]="Metadata",e[e.Fragmap=1]="Fragmap",e[e.Manifest=2]="Manifest",e[e.Skeleton=3]="Skeleton",e[e.Fragment=4]="Fragment",e[e.Resource=5]="Resource",e[e.Glyph=6]="Glyph",e[e.LocationMap=7]="LocationMap",e[e.PageNumbers=8]="PageNumbers",e[e.SearchIndex=9]="SearchIndex",e[e.Annotations=10]="Annotations"}(t.ArtifactType||(t.ArtifactType={}));var s=(t.ArtifactType,function(){function e(e,t){this.type=e,this.position=t}return e.prototype.toString=function(){return String(this.position)},e.prototype.valueOf=function(){return this.position},e}());t.createPosition=i;var l=function(){function e(e,t,n){this.asin=e.asin,this.title=e.title,this.authors=e.authorsList||[],this.publisher=e.publisher,this.releaseDate=e.releaseDate,this.sample=e.sample,this.locationsInfo=e.locationsInfo,this.flowType=e.headerMetadata&&e.headerMetadata.fixedLayout?a.FIXED:a.REFLOWABLE;var s=String(n.format).toUpperCase(),l=String(t.fragmentMetadata.bookType).toUpperCase();if(this.format=r[s]||r[l],!this.format)throw new o.KcrError("No recognizable book format could be found").setErrorCode(o.Codes.ReaderMetadataImplUnknownFormat);var d=e.endPosition;(!d||0>d)&&(d=t.fragmentArray[t.fragmentArray.length-1].ePos),this.endPosition=i(this.format,d);var c=e.positions.toc;c>=0&&(this.tableOfContentsPosition=i(this.format,c));var u=e.positions.cover>=0?e.positions.cover:0;this.coverPosition=i(this.format,u),this.startReadingPosition=void 0!==n.srl&&n.srl>=0&&n.srl<=d?i(this.format,n.srl):void 0!==e.positions&&void 0!==e.positions.srl&&e.positions.srl>=0&&e.positions.srl<=d?i(this.format,e.positions.srl):i(this.format,this.coverPosition)}return e.prototype.getFormatTypeName=function(){return r[this.format].toLowerCase()},e}();t.createMetadata=n}),define("modules/utils/StreamUtils",["require","exports"],function(e,t){"use strict";function o(e){for(var t,o,i,n=[],r=0;r<e.length;)t=e.charCodeAt(r),128>t?(n.push(String.fromCharCode(t)),r++):t>191&&224>t?(o=e.charCodeAt(r+1),n.push(String.fromCharCode((31&t)<<6|63&o)),r+=2):(o=e.charCodeAt(r+1),i=e.charCodeAt(r+2),n.push(String.fromCharCode((15&t)<<12|(63&o)<<6|63&i)),r+=3);return n.join("")}function i(){d=[];for(var e=0;e<l.length;e+=1)d[l.charCodeAt(e)]=e;return d}function n(e){for(var t,o,i,n,r,a,s,l=[],c=0;c<e.length;)n=d[e.charCodeAt(c++)],r=d[e.charCodeAt(c++)],a=d[e.charCodeAt(c++)],s=d[e.charCodeAt(c++)],t=n<<2|r>>4,o=(15&r)<<4|a>>2,i=(3&a)<<6|s,l.push(String.fromCharCode(t)),64!==a&&l.push(String.fromCharCode(o)),64!==s&&l.push(String.fromCharCode(i));return l.join("")}function r(e,t){var o=[];o.length=256;for(var i=0;256>i;i++)o[i]=i;var n,r=0;for(i=0;256>i;i++)r=r+o[i]+t[i%t.length]&255,n=o[i],o[i]=o[r],o[r]=n;i=0,r=0;for(var a=[],s=0;s<e.length;s++)i=i+1&255,r=r+o[i]&255,n=o[i],o[i]=o[r],o[r]=n,a.push(String.fromCharCode(e.charCodeAt(s)^o[o[i]+o[r]&255]));return a.join("")}function a(e){for(var t=[],o=0;o<e.length;o++)t.push(e.charCodeAt(o));return t}function s(e,t){return o(r(n(e),a(t)))}var l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",d=i();t.rc4DecryptWithString=s}),define("modules/book/NetworkArtifactCache",["require","exports","q","modules/utils/Service","modules/utils/ErrorHandler"],function(e,t,o,i,n){"use strict";var r=function(){function e(){var e=this;this.artifactInfo={skeleton:"loadSkeleton",fragment:"loadFragment",glyph:"loadGlyphFragment",resource:"loadResource",locationMap:"loadMobiLocationMap"},this.networkRequestQueue=[],this.activeNetworkRequests=0,this.MaximumNetworkRequests=6,this.cache={},Object.keys(this.artifactInfo).forEach(function(t){e.cache[t]=[]})}return e.prototype.getArtifacts=function(e,t){var o=$.extend({},e),i={},n=t?{}:null,r=this.satisfyRequestsFromCache(o,i,n);return t&&Object.keys(n).length>0&&this.prioritizeRequestsInQueue(n),r||this.requestMissingArtifacts(o,i,t),i},e.prototype.satisfyRequestsFromCache=function(e,t,o){var i=!0,n=this.cache;return Object.keys(this.artifactInfo).forEach(function(r){var a=e[r+"Ids"]||[],s=[],l=[];a.length&&console.debug("Looking for bookinfo "+r+"s ["+a.join(",")+"]"),a.forEach(function(e){n[r][e]?(t[r]=t[r]||[],t[r][e]=n[r][e].promise,o&&n[r][e].promise.isPending()&&(o[r]=o[r]||{},o[r][e]=!0),l.push(e)):(s.push(e),i=!1)}),delete e[r+"Ids"],s.length&&(e[r+"Ids"]=s),l.length&&console.debug("Found cached bookinfo "+r+"s ["+l.join(",")+"]")}),i},e.prototype.prioritizeRequestsInQueue=function(e){for(var t=this.networkRequestQueue,o=[],i=[],n=0;n<t.length;n++){var r=t[n];e[r.artifactName]&&e[r.artifactName][r.idAndUrl.id]?o.push(r):i.push(r)}this.networkRequestQueue=o.concat(i)},e.prototype.requestMissingArtifacts=function(e,t,i){var n=this.cache;Object.keys(this.artifactInfo).forEach(function(i){var r=e[i+"Ids"]||[];r.forEach(function(e){n[i][e]=o.defer(),t[i]=t[i]||[],t[i][e]=n[i][e].promise}),r.length&&console.debug("Created requests for bookinfo "+i+"s ["+r.join(",")+"]")}),this.getArtifactsFromNetwork(e,i)},e.prototype.getArtifactsFromNetwork=function(e,t){var o=this,r=this.cache,a=function(t){Object.keys(o.artifactInfo).forEach(function(o){var i=e[o+"Ids"]||[];i.forEach(function(e){r[o][e].reject(t),delete r[o][e]}),i.length&&console.debug("Rejecting requests for bookinfo "+o+"s ["+i.join(",")+"]")}),n.handleError(t)};i.getFileUrl(e).then(function(e){o.enqueueNetworkRequests(e,t)},function(e){a(e)}).done()},e.prototype.enqueueNetworkRequests=function(e,t){var o=this.networkRequestQueue;Object.keys(this.artifactInfo).forEach(function(i){var n=e[i+"Urls"]||[];n.forEach(function(e){var n={idAndUrl:e,artifactName:i};t?o.unshift(n):o.push(n)})}),this.checkRequestQueue()},e.prototype.checkRequestQueue=function(){for(;this.networkRequestQueue.length>0&&this.activeNetworkRequests<this.MaximumNetworkRequests;)this.startNextNetworkRequest()},e.prototype.startNextNetworkRequest=function(){var e=this,t=function(t,o,i){e.activeNetworkRequests--,e.checkRequestQueue(),e.cache[t][o].resolve(i)},o=function(t,o,i){e.activeNetworkRequests--,e.checkRequestQueue(),e.cache[t][o].reject(i),delete e.cache[t][o],n.handleError(i)},r=this.networkRequestQueue.shift();r&&(this.activeNetworkRequests++,i.qJsonpUsingAjax(r.idAndUrl.signedUrl).then(function(e){t(r.artifactName,r.idAndUrl.id,e)},function(e){o(r.artifactName,r.idAndUrl.id,e)}).done())},e}();t.NetworkArtifactCache=r}),define("modules/utils/Decompressor",["require","exports"],function(){"use strict";var e=9983,t=e+1,o=100,i=t+o+1,n=function(){function o(t,o){this.maxChar=void 0!==o?o&&o-1:e,this.firstCode=o||i;var n={};this.addStringsToDictionary(t,n),this.addNumbersToDictionary(n),this.dictionary=this.getDecompressionDictionary(n)}return o.prototype.expand=function(e){for(var o=[],i=0;i<e.length;){var n=e.charCodeAt(i);if(i++,n<=this.maxChar)o.push(String.fromCharCode(n));else if(n>=this.firstCode)o.push(this.dictionary[n]);else{var r=n-t;o.push(e.substr(i,r)),i+=r}}return o.join("")},o.prototype.findNextCode=function(e){var t=this.firstCode;for(var o in e)Number(e[o])>=t&&(t=Number(e[o])+1);return t},o.prototype.addStringsToDictionary=function(e,t){var o=this.findNextCode(t);for(var i in e)for(var n=e[i],r=2;r<=n.length;r++){var a=n.substr(0,r);t.hasOwnProperty(a)||(t[a]=String(o++))}},o.prototype.addNumbersToDictionary=function(e){for(var t=[],o=100;1e3>o;o++)t.push(""+o);this.addStringsToDictionary(t,e)},o.prototype.getDecompressionDictionary=function(e){var t={};for(var o in e)t[e[o]]=o;return t},o}();return n}),define("modules/book/LocationConverters",["require","exports","modules/book/BookInfo","q"],function(e,t,o,i){"use strict";var n=function(){function e(){}return e.prototype.locationFromPosition=function(e){var t=e.valueOf();return i.resolve(Math.floor((3*t+100)/100))},e.prototype.positionFromLocation=function(e){e*=100,100>e&&(e=100);var t=o.createPosition(o.Format.TOPAZ,Math.floor((e-100)/3));return i.resolve(t)},e}();t.TopazLocationConverter=n;var r=function(){function e(){}return e.prototype.locationFromPosition=function(e){var t=e.valueOf();return i.resolve(Math.floor(2*t/300+1))},e.prototype.positionFromLocation=function(e){e*=100,100>e&&(e=100);var t=o.createPosition(o.Format.MOBI7,Math.floor(3*(e-100)/2));return i.resolve(t)},e}();t.Mobi7LocationConverter=r;var a=function(){function e(e,t,o,i,n){this.mapSize=e,this.numOfLocations=t,this.minPosition=o,this.maxPosition=i,this.mapGetter=n,this.origin=1,this.mapBoundList=[],this.mapCache={},this.cacheEntrySeq=1,this.maxCacheSize=Math.max(5,Math.floor(2e4/e))}return e.prototype.getMapById=function(e){function t(e){var t=e.metadata.id;if(!a.mapBoundList[t]||!a.mapBoundList[t].firstPos){a.mapBoundList[t]=a.mapBoundList[t]||{};var o=a.getPositionRangeForMap(e);a.mapBoundList[t].lastPos||(a.mapBoundList[t].lastPos=o.lastPos),a.mapBoundList[t].firstPos||(a.mapBoundList[t].firstPos=o.firstPos,t>0&&(a.mapBoundList[t-1]=a.mapBoundList[t-1]||{},a.mapBoundList[t-1].lastPos=o.firstPos-1))}}if(this.mapCache[e]&&!this.mapCache[e].promise.isRejected())return this.mapCache[e].promise;var o,i,n,r,a=this;if(o=this.mapGetter(e),o.done(t),this.cacheEntrySeq++,this.mapCache[e]={promise:o,cacheEntrySeq:this.cacheEntrySeq},this.cacheEntrySeq>this.maxCacheSize){r=this.cacheEntrySeq;for(i in this.mapCache)this.mapCache[i].cacheEntrySeq<r&&(n=i,r=this.mapCache[i].cacheEntrySeq);r!==this.cacheEntrySeq&&delete this.mapCache[n]}return o},e.prototype.getPositionRangeForMap=function(e){var t,o,i=e.metadata.id;try{$.isArray(e.locations)?(t=e.locations[0],o=e.locations[e.locations.length-1]):(t=e.locations[i*this.mapSize+this.origin],o=e.locations[Math.min((i+1)*this.mapSize+this.origin-1,this.numOfLocations)])}catch(n){t=Number.MAX_VALUE,o=-1;for(var r in e.locations)e.locations.hasOwnProperty(r)&&e.locations[r]&&(t=Math.min(e.locations[r],t),o=Math.max(e.locations[r],o))}return{firstPos:t,lastPos:o}},e.prototype.getLocationIxRangeForMap=function(e){var t,o,i,n=e.metadata.id;try{$.isArray(e.locations)?(t=0,o=e.locations.length-1,i=n*this.mapSize+this.origin):(t=n*this.mapSize+this.origin,o=Math.min((n+1)*this.mapSize+this.origin-1,this.numOfLocations),i=0)}catch(r){t=Number.MAX_VALUE,o=-1;for(var a in e.locations){var s=parseInt(a,10);e.locations.hasOwnProperty(a)&&e.locations[a]&&(t=Math.min(s,t),o=Math.max(s,o))}}return{firstIx:t,lastIx:o,offset:i}},e.prototype.mapForLocation=function(e){var t=Math.floor((e-this.origin)/this.mapSize);return this.getMapById(t)},e.prototype.mapForPosition=function(e){function t(o,i){function n(n){var l=a.mapBoundList[n.metadata.id];l.firstPos>e?t(o,r-1):l.lastPos>=e?s.resolve(n):t(r,i)}if(o===i)return void a.getMapById(o).then(s.resolve,s.reject).done();var r=Math.floor((o+i)/2);r===o&&i===o+1&&(r=i),a.getMapById(r).then(n,s.reject).done()}var o,n,r,a=this;for(n=0,r=Math.floor((this.numOfLocations-this.origin)/this.mapSize),o=0;o<this.mapBoundList.length;o++)if(this.mapBoundList[o])if(this.mapBoundList[o].firstPos){if(this.mapBoundList[o].firstPos<=e&&this.mapBoundList[o].lastPos>=e)return this.getMapById(o);if(this.mapBoundList[o].firstPos>e){r=o-1;break}n=o}else if(this.mapBoundList[o].lastPos){if(this.mapBoundList[o].lastPos===e)return this.getMapById(o);if(this.mapBoundList[o].lastPos>e){r=o;break}n=o+1}var s=i.defer();return t(n,r),s.promise},e.prototype.locationFromPosition=function(e){function t(e){function t(e,i,n){var s=Math.floor((e+i)/2);n[s]===r?a.resolve(s+o.offset):n[s]>r?t(e,s-1,n):s===i||n[s+1]>r?a.resolve(s+o.offset):t(s+1,i,n)}var o=n.getLocationIxRangeForMap(e);t(o.firstIx,o.lastIx,e.locations)}function o(){if(r<=n.minPosition)a.resolve(n.origin);else if(r>=n.maxPosition)a.resolve(n.numOfLocations-1+n.origin);else{var e=(r-n.minPosition)/(n.maxPosition-n.minPosition);a.resolve(Math.floor(e*(n.numOfLocations-n.origin)+n.origin))}}var n=this,r=e.valueOf(),a=i.defer();return this.mapForPosition(r).then(t,o).done(),a.promise},e.prototype.positionFromLocation=function(e){function t(t){var i,n;try{$.isArray(t.locations)?(i=(e-r.origin)%r.mapSize,n=t.locations[i]):n=t.locations[e]}catch(s){n=1}var l=o.createPosition(o.Format.MOBI8,n);a.resolve(l)}function n(){var t;if(e<=r.origin)t=r.minPosition;else if(e>=r.numOfLocations-1+r.origin)t=r.maxPosition;else{var i=(e-r.origin)/r.numOfLocations;t=Math.floor(i*(r.maxPosition-r.minPosition)+r.minPosition)}var n=o.createPosition(o.Format.MOBI8,t);a.resolve(n)}var r=this,a=i.defer();return this.mapForLocation(e).then(t,n).done(),a.promise},e}();t.Mobi8LocationConverter=a}),define("modules/utils/Performance",["require","exports"],function(e,t){"use strict";function o(e){window.performance&&window.performance.mark&&window.performance.mark(e)}function i(e){window.performance&&window.performance.clearMarks&&(e?window.performance.clearMarks(e):window.performance.clearMarks())}function n(e,t,o){window.performance&&window.performance.measure&&(t?o?window.performance.measure(e,t,o):window.performance.measure(e,t):window.performance.measure(e))}function r(e){window.performance&&window.performance.clearMeasures&&(e?window.performance.clearMeasures():window.performance.clearMeasures(e))}function a(){return window.performance&&window.performance.now?window.performance.now():Date.now()}function s(){return window.performance&&window.performance.getEntries?window.performance.getEntries():void 0}function l(e){return window.performance&&window.performance.getEntriesByType?window.performance.getEntriesByType(e):void 0}function d(e,t){return window.performance&&window.performance.getEntriesByName?t?window.performance.getEntriesByName(e,t):window.performance.getEntriesByName(e):void 0}t.PerformanceTiming={navigationStart:"navigationStart",unloadEventStart:"unloadEventStart",unloadEventEnd:"unloadEventEnd",redirectStart:"redirectEnd",redirectEnd:"redirectEnd",fetchStart:"fetchStart",domainLookupStart:"domainLookupStart",domainLookupEnd:"domainLookupEnd",connectStart:"connectStart",connectEnd:"connectEnd",secureConnectionStart:"secureConnectionStart",requestStart:"requestStart",requestEnd:"requestEnd",domLoading:"domLoading",domInteractive:"domInteractive",domContentLoadedEventStart:"domContentLoadedEventStart",domContentLoadedEventEnd:"domContentLoadedEventEnd",domComplete:"domComplete",loadEventStart:"loadEventStart",loadEventEnd:"loadEventEnd"},t.mark=o,t.clearMarks=i,t.measure=n,t.clearMeasures=r,t.now=a,t.getEntries=s,t.getEntriesByType=l,t.getEntriesByName=d}),define("modules/book/BookInCloud",["require","exports","q","modules/utils/Errors","modules/book/BookInfo","modules/utils/Service","modules/utils/StreamUtils","modules/book/NetworkArtifactCache","modules/utils/Decompressor","modules/book/LocationConverters","modules/utils/Performance"],function(e,t,o,i,n,r,a,s,l,d,c){"use strict";function u(e){return c.mark("mark_start_reading"),r.startReading(e).then(function(t){return c.mark("mark_start_reading_done"),p(e,t)})}function p(e,t){var i=function(){return r.loadArtifact(n.ArtifactType.Fragmap).then(function(e){"EBSP"===t.contentType&&r.preloadFromFragmap(e)})},r=new b(e,t);return o.all([r.initialize(),i(),r.loadArtifact(n.ArtifactType.Manifest)]).then(function(){return r})}function h(e){return c.mark("mark_still_reading"),r.stillReading(e).then(function(){c.mark("mark_still_reading_done")})}function f(e){return c.mark("mark_done_reading"),r.doneReading(e).then(function(){c.mark("mark_done_reading_done")})}var m=1,g=2,v=100,b=function(){function e(e,t){this.args=e,this.response=t,this.promises={},this.artifactCache=new s.NetworkArtifactCache}return Object.defineProperty(e.prototype,"asin",{get:function(){return this.args.asin},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"revisionID",{get:function(){throw new i.KcrError("get revisionID not implemented")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"guid",{get:function(){return this.response.formatVersion+":"+this.response.contentVersion},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"assetID",{get:function(){throw new i.KcrError("get assetID not implemented")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"type",{get:function(){return"EBOK"===this.response.contentType?n.Type.EBOK:n.Type.EBSP},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"title",{get:function(){return this.md.title},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"authors",{get:function(){return this.md.authors},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"furthestPositionRead",{get:function(){var e=this.response.lastPageReadData&&this.response.lastPageReadData.position||-1;return e>=0?"mobi8"===this.response.format?n.createPosition(n.Format.MOBI8,e):n.createPosition(n.Format.MOBI7,e):null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"startReadingPosition",{get:function(){return this.md.startReadingPosition},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"continuousReadingPosition",{get:function(){throw new i.KcrError("get continuousReadingPosition not implemented")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"mostRecentPositionRead",{get:function(){throw new i.KcrError("get mostRecentPositionRead not implemented")},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"metadata",{get:function(){return this.md},enumerable:!0,configurable:!0}),e.prototype.initialize=function(){var e=this;return c.mark("mark_load_metadata"),this.promises[n.ArtifactType.Metadata]=this.loadArtifact(n.ArtifactType.Metadata),this.promises[n.ArtifactType.Fragmap]=this.loadArtifact(n.ArtifactType.Fragmap),o.all([this.promises[n.ArtifactType.Metadata],this.promises[n.ArtifactType.Fragmap]]).spread(function(t,o){c.mark("mark_load_metadata_done"),e.md=n.createMetadata(t,o,e.response),e.mdRaw=t,t.cpr&&(e.decompressor=new l(t.cpr)),t.cprJson&&(e.jsonDecompressor=new l(t.cprJson,256))})},e.prototype.loadArtifacts=function(e,t,o,i){var n=this.makeUrlRequestArgs([{type:e,ids:t}]);this.getArtifactsFromCache(n,o,i)},e.prototype.loadArtifact=function(e,t){var a=this.promises;switch(e){case n.ArtifactType.Metadata:return a[e]||(a[e]=r.qJsonpUsingAjax(this.response.metadataUrl)),a[e];case n.ArtifactType.Fragmap:return a[e]||(a[e]=r.qJsonpUsingAjax(this.response.fragmentMapUrl)),a[e];case n.ArtifactType.Manifest:return a[e]||(a[e]=this.response.manifestUrl?r.qJsonpUsingAjax(this.response.manifestUrl):o.resolve({})),a[e];case n.ArtifactType.PageNumbers:break;case n.ArtifactType.SearchIndex:break;case n.ArtifactType.Annotations:break;default:var s=o.defer();return this.loadArtifacts(e,[t],s.resolve,s.reject),s.promise}return o.reject(new i.KcrError("Unknown artifact:"+e))},e.prototype.getLocationConverter=function(){var e=this;if(this.locationConverterPromise)return this.locationConverterPromise;var t=this.md;switch(t.format){case n.Format.TOPAZ:this.locationConverterPromise=o.resolve(new d.TopazLocationConverter);break;case n.Format.MOBI7:this.locationConverterPromise=o.resolve(new d.Mobi7LocationConverter);break;case n.Format.MOBI8:this.locationConverterPromise=this.loadArtifact(n.ArtifactType.Fragmap).then(function(o){var i=function(t){return e.loadArtifact(n.ArtifactType.LocationMap,t)},r=t.locationsInfo.mapSize,a=t.locationsInfo.numOfLocations,s=o.fragmentArray[0].cPos,l=o.fragmentArray[o.fragmentArray.length-1].ePos;return new d.Mobi8LocationConverter(r,a,s,l,i)});break;default:throw new i.KcrError("getLocationConverter: Unknown book format: "+n.Format[t.format])}return this.locationConverterPromise},e.prototype.preloadFromFragmap=function(e){if(e.fragmentMetadata){for(var t=null!==this.response.srl&&this.response.srl>0?this.response.srl:0,o=this.findFragmapItemsToPreload(e,t),i={sIds:{},fIds:{}},r=0;r<o.length;r++)i.sIds[o[r].sId]=!0,i.fIds[o[r].fId]=!0;for(var a=[],s=[],l=0;l<e.fragmentMetadata.numberOfSkeletons;l++)i.sIds[l]?a.push(l):s.push(l);for(var d=a.concat(s),c=[],u=[],p=!1,h=[],l=0;l<e.fragmentMetadata.numberOfFragments;l++)if(i.fIds[l])p=!0,c.push(l);else if(p){if(u.push(l),u.length>v)break}else h.push(l);var f=u.concat(h).slice(0,v),m=c.concat(f);console.debug("Preload fragments:",m);var g=[{type:n.ArtifactType.Skeleton,ids:d},{type:n.ArtifactType.Fragment,ids:m}],b=this.makeUrlRequestArgs(g);this.artifactCache.getArtifacts(b,!1)}},e.prototype.findFragmapItemsToPreload=function(e,t){for(var o=0;o<e.fragmentMetadata.numberOfFragments;o++){var i=e.fragmentArray[o];if(i.cPos>=t||i.ePos>=t)return e.fragmentArray.slice(o-m,o+g+1)}return[]},e.prototype.makeUrlRequestArgs=function(e){var t={asin:this.args.asin,useAuthenticated:this.args.useAuthenticated,contentVersion:this.response.contentVersion,formatVersion:this.response.formatVersion};this.response.kindleSessionId&&(t.kindleSessionId=this.response.kindleSessionId),this.response.isSample&&(t.isSample=this.response.isSample);for(var o in e)switch(e[o].type){case n.ArtifactType.Skeleton:t.skeletonIds=e[o].ids;break;case n.ArtifactType.Fragment:t.fragmentIds=e[o].ids;break;case n.ArtifactType.Glyph:t.glyphIds=e[o].ids;break;case n.ArtifactType.Resource:t.resourceIds=e[o].ids;break;case n.ArtifactType.LocationMap:t.locationMapIds=e[o].ids}return t},e.prototype.getArtifactsFromCache=function(e,t,o){var i=this,n=function(e){if(e=$.extend(!0,{},e),e.skeletonMetadata&&1===e.skeletonMetadata.encryption){var o=a.rc4DecryptWithString(e.skeletonData,i.response.contentChecksum);e.skeletonData=o,delete e.skeletonMetadata.encryption}1===e.skeletonMetadata.compression&&(e.skeletonData=i.decompressor.expand(e.skeletonData),delete e.skeletonMetadata.compression),t(e)},r=function(e){if(e=$.extend(!0,{},e),e.fragmentMetadata&&1===e.fragmentMetadata.encryption){var o=a.rc4DecryptWithString(e.fragmentData,i.response.contentChecksum);e.fragmentData=o,delete e.fragmentMetadata.encryption}if(1===e.fragmentMetadata.compression||2===e.fragmentMetadata.compression){if(e.fragmentData=i.decompressor.expand(e.fragmentData),e.paraData&&"string"==typeof e.paraData){var n=i.jsonDecompressor.expand(e.paraData);e.paraData=JSON.parse(n)}delete e.fragmentMetadata.compression}t(e)},s=function(e,o){if(e=$.extend(!0,{},e),e.glyphMetadata&&(e.glyphMetadata=o),1===e.glyphFragmentMetadata.compression||"string"==typeof e.glyphData){var n=i.jsonDecompressor.expand(e.glyphData);e.glyphData=JSON.parse(n),delete e.glyphFragmentMetadata.compression}t(e)},l=function(e){e=$.extend(!0,{},e),t(e)},d=function(e,t){e&&e.forEach(function(e,i){e.then(function(e){t(e,i)},function(e){o(e)}).done()})},c=this.artifactCache.getArtifacts(e,!0);d(c.skeleton,n),d(c.fragment,r),d(c.glyph,s),d(c.resource,l),d(c.locationMap,l)},e}();t.startReading=u,t.openBook=p,t.stillReading=h,t.doneReading=f}),define("modules/utils/Fullscreen",["require","exports","modules/utils/DeviceUtils"],function(e,t,o){"use strict";function i(){return document.documentElement.requestFullscreen?function(){document.documentElement.requestFullscreen()}:document.documentElement.msRequestFullscreen?function(){document.documentElement.msRequestFullscreen()}:document.documentElement.mozRequestFullScreen?function(){document.documentElement.mozRequestFullScreen()}:document.documentElement.webkitRequestFullscreen?function(){var e=document.documentElement;e.webkitRequestFullscreen(e)}:null}function n(){return document.exitFullscreen||document.msExitFullscreen||document.mozCancelFullScreen||document.webkitExitFullscreen}function r(){return document.fullscreenEnabled||document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled}function a(){return!o.hasFullscreenCrashProblem()&&!(!i()||!n())}function s(){return a()&&r()}function l(){var e=i();e&&e()}function d(){var e=n();e&&e.call(document)}function c(){return p()?void l():void d()}function u(e){document.addEventListener("fullscreenchange",e),document.addEventListener("webkitfullscreenchange",e),document.addEventListener("mozfullscreenchange",e),document.addEventListener("MSFullscreenChange",e)}function p(){return!!(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement)}t.fullscreenIsAvailable=s,t.requestFullscreen=l,t.exitFullscreen=d,t.toggleFullscreen=c,t.addFullscreenEventListener=u,t.isFullscreenActive=p}),define("modules/utils/GlideInfo",["require","exports","modules/utils/DeviceUtils"],function(e,t,o){"use strict";function i(){return o.isDesktop()}function n(){return!!(window.KindleGlobal.buyUrl&&window.KindleGlobal.pricingInfo&&window.KindleGlobal.displayPrice&&window.KindleGlobal.soldBy)}function r(){return!!window.KindleGlobal.userFirstName}t.isGlideAllowed=i,t.hasGlideBookDetails=n,t.hasLoggedInAs=r}),define("modules/utils/KeyboardConstants",["require","exports"],function(e,t){"use strict";!function(e){e[e.SPACE=32]="SPACE",e[e.PAGE_UP=33]="PAGE_UP",e[e.PAGE_DOWN=34]="PAGE_DOWN",e[e.LEFT_ARROW=37]="LEFT_ARROW",e[e.UP_ARROW=38]="UP_ARROW",e[e.RIGHT_ARROW=39]="RIGHT_ARROW",e[e.DOWN_ARROW=40]="DOWN_ARROW"}(t.KEYCODES||(t.KEYCODES={}));t.KEYCODES}),define("modules/marketplace/Marketplace",["require","exports"],function(e,t){"use strict";var o=function(){function e(){this.USAmazon={marketplaceCode:"us"},this.CAAmazon={marketplaceCode:"ca"},this.BRAmazon={marketplaceCode:"br"},this.AUAmazon={marketplaceCode:"au"},this.MXAmazon={marketplaceCode:"mx"},this.GBAmazon={marketplaceCode:"uk"},this.DEAmazon={marketplaceCode:"de"},this.FRAmazon={marketplaceCode:"fr"},this.ITAmazon={marketplaceCode:"it"},this.ESAmazon={marketplaceCode:"es"},this.INAmazon={marketplaceCode:"in"},this.JPAmazon={marketplaceCode:"jp"},this.CNAmazon={marketplaceCode:"cn"},this.NLAmazon={marketplaceCode:"nl"},this.RUAmazon={marketplaceCode:"ru"}}return e}();t.AmazonMarketplaces=o;var i=new o;t["default"]=i}),define("modules/utils/ReadInKindle",["require","exports","modules/utils/DeviceUtils","modules/metrics/PMET","modules/metrics/ReadingStreams","modules/utils/RefTag","modules/utils/Utility","modules/utils/QueryParamUtils","modules/marketplace/Marketplace"],function(e,t,o,i,n,r,a,s,l){"use strict";function d(){var e=c();console.debug("Opening URL for RIK: "+e),o.isFBOpenLinkWorkaroundNeeded()?window.location.href=e:a.openInNewWindow(e)}function c(){var e,n=i.createMetric(t.metricsPrefix);return o.isAndroid()&&!o.isFireOS()&&g.marketplace!==l["default"].CNAmazon.marketplaceCode?(i.record(n.appendToReportedName("Interstitial")),e=a.getReadUrl(g.appName+"-rik")):(i.record(n.appendToReportedName("PreAuth")),e=a.getReadUrl(g.appName+"-pre-auth"),o.isFireOS()&&(e=s.appendQueryParams(e,"fos=true")),o.isIOS()&&(e=e.replace(/^https/,"http"),e=s.updateQueryParams(e,{type:"EBSP",ref:"kindleplayer"}))),s.setSessionIdQueryParam(e)}function u(){if(o.isIOS()){var e=r.getEndpointRefTag(r.Constants.RIK_SUFFIX),t=a.getAppStoreUrlWithRefTag(window.KindleGlobal.appStoreUrl,e),i=window.KindleGlobal.openAppUrl;t&&i&&h(i,t)}}function p(e){var t=document.createElement("iframe");return t.style.display="none",document.body.appendChild(t),t.src=e,t}function h(e,o){var n=p(e),r=t.metricsPrefix+"::DeepLinking",a=i.createMetric(r);i.record(a.appendToReportedName(E)),m.recordMetadata(r,{status:E});
{var s=i.createMetric(r),l=Date.now();setTimeout(function(){var e=Date.now()-l;e>v+b?(n.parentNode.removeChild(n),n=null,i.record(s.appendToReportedName(w)),m.recordMetadata(r,{status:w})):document.webkitHidden||document.hidden||(i.record(s.appendToReportedName(y)),m.recordMetadata(r,{status:y}),f(o))},v)}}function f(e){console.debug("Opening URL for RIK: "+e),window.location.href=e}var m=n.getManager(),g=window.KindleGlobal,v=1e3,b=500;t.metricsPrefix="ReadInKindle";var E="DeepLinkingAttempted",y="OpenedFallback",w="TimeExceeded";t.trigger=d,t.performDeepLinkingIfPossible=u}),define("modules/ui/Widget",["require","exports"],function(){"use strict";var e=function(){function e(e){this.element=e}return e.prototype.show=function(){this.element.show()},e.prototype.hide=function(){this.element.hide()},e.prototype.isVisible=function(){return this.element.is(":visible")},e.prototype.appendTemplate=function(e,t){void 0===t&&(t={}),t.KindleGlobal=window.KindleGlobal,this.element.append($(Handlebars.templates[e](t)))},e}();return e});var __extends=this&&this.__extends||function(e,t){function o(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)};define("modules/ui/widgets/ToolbarBase",["require","exports","modules/utils/Service","modules/utils/DeviceUtils","modules/ui/Widget"],function(e,t,o,i,n){"use strict";var r=9,a=15,s=120,l=function(e){function t(t){e.call(this,t),this._hideOnRenderClass="kp-toolbar-hide",this._templateIdentifierClass="",this._baseCssClasses=""}return __extends(t,e),t.prototype.render=function(e,t,o){void 0===t&&(t={}),void 0===o&&(o=!1),this._templateIdentifierClass=this._baseCssClasses="kp-"+e,o&&(this._baseCssClasses+=" "+this._hideOnRenderClass),t.baseCssClasses=this._baseCssClasses,this.appendTemplate(e,t),this.initAfterAppend()},t.prototype.initAfterAppend=function(){var e=this;i.isIOS()&&o.requireWithRetry(["hammer"],function(t){var o=new t.Manager(e.element[0]);o.add([new t.Tap({threshold:r,posThreshold:a,time:s})]),o.on("tap",function(e){for(var t=0;t<e.tapCount;t++)$(e.target).trigger("click"),e.preventDefault()})}),this.element.find("[data-action]").on("click",function(t){e.itemClicked(t)}),this.element.on("click",function(t){e.toolbarClicked(t)})},t.prototype.showAfterRender=function(){this.element.find("."+this._templateIdentifierClass).removeClass(this._hideOnRenderClass)},t.prototype.itemClicked=function(e){e.preventDefault(),e.stopPropagation(),this.element.trigger("actionInvoked",$(e.target).attr("data-action"))},t.prototype.toolbarClicked=function(e){e.stopPropagation()},t}(n);return l}),define("modules/utils/WishList",["require","exports","modules/utils/DeviceUtils","modules/metrics/PMET","modules/utils/Utility"],function(e,t,o,i,n){"use strict";function r(){console.debug("Entering wish list flow with asin: "+window.KindleGlobal.asin);var e=i.createMetric(t.metricsPrefix);i.record(e);var r=i.createMetric(t.metricsPrefix);i.record(r.appendToReportedName(o.getDevicePlatform()));var a=n.getReadUrl(window.KindleGlobal.appName+"/getWishlist");n.openInNewWindow(a)}t.metricsPrefix="AddToWishListClicked",t.trigger=r});var __extends=this&&this.__extends||function(e,t){function o(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)};define("modules/ui/widgets/SharingHeaderBar",["require","exports","modules/ui/widgets/ToolbarBase","modules/utils/DeviceUtils","modules/utils/GlideInfo","modules/metrics/MetricsUtils","modules/utils/RefTag","modules/metrics/ReadingStreams","modules/utils/Utility","modules/utils/WishList","modules/utils/Localization"],function(e,t,o,i,n,r,a,s,l,d,c){"use strict";var u=s.getManager(),p="kp-header-has-logged-in-as",h="kp-logged-in-as",f="kp-logged-in-as-logout-link",m="kp-reader-view-details",g="kp-reader-publisher-info",v=c.getLocalizedString,b=window.KindleGlobal,E=function(e){function t(t,o){e.call(this,t);var i=[],r=n.hasLoggedInAs();r&&i.push(p);var a,s=b.wishlist,l=b.soldBy;l&&(a=v(g,{soldBy:l})),this.render("SharingHeaderBar",{toolbarClasses:i.join(" "),hasGlideInfo:o,shouldShowWishlist:s,title:b.title,author:b.author,bookCoverSrc:b.bookCoverSrc,soldBy:a,isBuyable:b.isBuyable,shouldHideSharing:b.shouldHideSharing}),this.populate(r),this.attachEventHandlers()}return __extends(t,e),t.prototype.populate=function(e){var t=b.localizedAmazonName;this.element.find(".kp-header-view-details-link").html(v(m,{userFacingName:t}));var o=this.element.find(".kp-header-image");o.length>0&&l.checkImageLoaded(o,null,function(e){$(e).hide()}),e&&this.addGlideLoginInfo(),this.element.find(".kp-header-view-details-link").bind(i.getClickEvent(),function(){l.openBookDetails(!0,a.Constants.VIEW_DETAILS_ON_READER_HEADER_SUFFIX,u.CONTEXT_READER)})},t.prototype.addGlideLoginInfo=function(){var e=this,t=b.userFirstName;if(t){var o=$("<a>",{"class":"kp-logout-link",id:"kp-header-logout-link"}).text(v(f)).click(function(){e.element.trigger("doLogout")}),i=v(h,{userFirstName:t});this.element.find(".kp-reader-header-buttons").addClass("kp-header-has-logged-in-as"),this.element.find(".kp-header-logged-in-as").html(i).append("&nbsp;(").append(o).append(")")}},t.prototype.attachEventHandlers=function(){this.attachWishlistButtonHandler(),this.attachDPButtonHandler(),this.element.find("#kp-toolbar-learn-more-button").bind(i.getClickEvent(),function(){var e=window.KindleGlobal.bookDetailPageUrl;if(e){r.recordAction(u.CONTEXT_READER,u.ACTION_LEARN_MORE_CLICKED);var t=l.getAmazonAttributedUrl(e,a.Constants.VIEW_DETAILS_ON_READER_HEADER_SUFFIX);l.openInNewWindow(t)}else r.recordAction(u.CONTEXT_READER,u.ERROR_DP_URL_NOT_CONFIGURED)})},t.prototype.attachWishlistButtonHandler=function(){this.element.find(".kp-toolbar-wl-button").bind(i.getClickEvent(),function(){d.trigger(),r.recordAction(u.CONTEXT_READER,u.ACTION_WISH_LIST_CLICKED)})},t.prototype.attachDPButtonHandler=function(){var e=null,t=null;if("miniGlance"===b.purchaseExperience?(e=b.buyUrl,t="width=950,height=585,toolbar=0,menubar=0,location=0,status=1,scrollbars=1,resizable=1,left=0,top=0"):e=b.bookDetailPageUrl,!e)return void r.recordAction(u.CONTEXT_READER,u.ERROR_DP_URL_NOT_CONFIGURED);var o=l.getAmazonAttributedUrl(e,a.Constants.BUY_ACTION_ON_READER_HEADER_SUFFIX);this.element.find(".kp-toolbar-dp-buy-button").bind(i.getClickEvent(),function(){r.recordAction(u.CONTEXT_READER,u.ACTION_BUY_BUTTON_CLICKED),l.openInNewWindow(o,t)})},t}(o);return E}),define("modules/utils/KindleEvents",["require","exports","modules/utils/Errors"],function(e,t,o){"use strict";var i=function(){function e(e,t){this.type=e,this.source=t}return e}();t.Event=i;var n=function(){function e(){this.listeners=[]}return e.prototype.addListener=function(e){if(!e||"function"!=typeof e)throw new o.KcrError("Listener must be a function");this.listeners.every(function(t){return t!==e})&&this.listeners.push(e)},e.prototype.removeListener=function(e){this.listeners.some(function(t,o,i){return t===e?(i.splice(o,1),!0):void 0})},e.prototype.fire=function(e){this.listeners.forEach(function(t){t.call(null,e)})},e}();t.EventProvider=n});var __extends=this&&this.__extends||function(e,t){function o(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)};define("modules/ui/widgets/SliderEvents",["require","exports","modules/utils/KindleEvents"],function(e,t,o){"use strict";!function(e){e[e.SlideStart=0]="SlideStart",e[e.Sliding=1]="Sliding",e[e.SlideEnd=2]="SlideEnd"}(t.SlideEventType||(t.SlideEventType={}));var i=(t.SlideEventType,function(e){function t(t,o){e.call(this,"locationChanged",t),this.source=t,this.location=o}return __extends(t,e),t}(o.Event));t.LocationChangedEvent=i;var n=function(e){function t(t,o,i){e.call(this,t,o),this.type=t,this.source=o,this.location=i}return __extends(t,e),t}(o.Event);t.SlideEvent=n});var __extends=this&&this.__extends||function(e,t){function o(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)};define("modules/ui/widgets/Slider",["require","exports","jquery","modules/ui/widgets/ToolbarBase","modules/ui/widgets/SliderEvents","modules/utils/KindleEvents","modules/metrics/MetricsUtils","modules/utils/DeviceUtils","modules/metrics/ReadingStreams","modules/utils/Localization"],function(e,t,o,i,n,r,a,s,l,d){"use strict";var c=0,u=l.getManager(),p=function(e){function t(t){e.call(this,t),this.PERCENT_COMPLETE_STRING_ID="kp-book-percentage-text",this.slideEventsProvider=new r.EventProvider,this.locationChangedEventsProvider=new r.EventProvider,this._ratio=0,this._isDragged=!1,this._startSlideLocation=0,this._isRTL=!1,this.render("Slider"),this.bar=this.element,this.sliderBar=this.bar.find(".kp-slider-bar"),this.slider=this.bar.find(".kp-slider-range"),this.toggle=this.bar.find(".kp-slider-handle")}return __extends(t,e),Object.defineProperty(t.prototype,"startSlideLocation",{get:function(){return this._startSlideLocation},set:function(e){this._startSlideLocation=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isDragged",{get:function(){return this._isDragged},set:function(e){this._isDragged=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isRTL",{set:function(e){if(this._isRTL=e,this._isRTL){var t=this.slider.css("background-color"),o=this.sliderBar.css("background-color");this.slider.css("background-color",o),this.sliderBar.css("background-color",t)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ratio",{get:function(){return this._ratio},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"startReadingLocation",{get:function(){return this._startReadingLocation},set:function(e){this._startReadingLocation=e},enumerable:!0,configurable:!0}),t.prototype.enableSliderEvents=function(){var e=this;this.bar.on("mousedown touchstart",function(t){(t.button===c||"touchstart"===t.type)&&(e._startSlideLocation=e._ratio,e.startSlide(t),t.stopPropagation(),t.preventDefault())})},t.prototype.moveSliderToPercent=function(e){e=0>e?0:e,e=e>1?1:e,this._ratio=e,this.slider.css("width",this.percent()),this.locationChangedEventsProvider.fire(new n.LocationChangedEvent(this,this._ratio))},t.prototype.percent=function(e){return void 0===e&&(e=2),this._isRTL?(100-100*this._ratio).toFixed(e)+"%":(100*this._ratio).toFixed(e)+"%"},t.prototype.standardizePageX=function(e){return e.originalEvent.pageX?e.originalEvent.pageX:e.originalEvent.touches&&e.originalEvent.touches.length>0?e.originalEvent.touches[0].pageX:e.originalEvent.changedTouches&&e.originalEvent.changedTouches.length>0?e.originalEvent.changedTouches[0].pageX:void 0},t.prototype.offsetToLocation=function(e){var t,o=this.standardizePageX(e);return t=o-this.bar.offset().left,this._isRTL?(this.bar.width()-t)/this.bar.width():t/this.bar.width()},t.prototype.startSlide=function(e){this.moveSliderToPercent(this.offsetToLocation(e)),this.slideEventsProvider.fire(new n.SlideEvent(n.SlideEventType.SlideStart,this,this._ratio)),this.addTouchbarEventListeners()},t.prototype.moveSlide=function(e){this.moveSliderToPercent(this.offsetToLocation(e)),this._isDragged=!0,this.slideEventsProvider.fire(new n.SlideEvent(n.SlideEventType.Sliding,this,this._ratio))},t.prototype.stopSlide=function(){this.slideEventsProvider.fire(new n.SlideEvent(n.SlideEventType.SlideEnd,this,this._ratio)),o(document).off(".slider-drag"),this.bar.off(".slider-drag")},t.prototype.addTouchbarEventListeners=function(){var e=this;o(document).on("mousemove.slider-drag",function(t){e.moveSlide(t)}),o(document).on("mouseup.slider-drag",function(t){e.stopSlide(t),e.recordSlideMetrics()}),this.bar.on("touchmove.slider-drag",function(t){e.moveSlide(t)}),this.bar.on("touchend.slider-drag",function(t){e.stopSlide(t),e.recordSlideMetrics()})},t.prototype.addSlideEventListener=function(e){this.slideEventsProvider.addListener(e)},t.prototype.removeSlideEventListener=function(e){this.slideEventsProvider.removeListener(e)},t.prototype.addLocationChangedEventListener=function(e){this.locationChangedEventsProvider.addListener(e)},t.prototype.removeLocationChangedEventListener=function(e){this.locationChangedEventsProvider.removeListener(e)},t.prototype.updateReaderStatusMessage=function(e){var t=Math.round(100*e),o=d.getLocalizedString(this.PERCENT_COMPLETE_STRING_ID,{percent:t});this.bar.find(".kp-slider-reader-status").html(o)},t.prototype.recordSlideMetrics=function(){if(this._isDragged){var e=this._ratio-this._startSlideLocation;a.recordAction(u.CONTEXT_READER,u.ACTION_SLIDER_DRAGGED,{DEVICEPLATFORM:s.getDevicePlatform()}),a.recordAction(u.CONTEXT_READER,u.ACTION_SLIDER_DRAGGED_DISTANCE,{DEVICEPLATFORM:s.getDevicePlatform(),SLIDEDISTANCE:e.toString()})}else a.recordAction(u.CONTEXT_READER,u.ACTION_SLIDER_CLICKED,{DEVICEPLATFORM:s.getDevicePlatform()});this._isDragged=!1},t}(i);return p});var __extends=this&&this.__extends||function(e,t){function o(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)};define("modules/ui/widgets/FontSizeButtons",["require","exports","modules/ui/widgets/ToolbarBase"],function(e,t,o){"use strict";var i=function(e){function t(t){e.call(this,t),this._compactStyleCssClass="kp-font-adjust-buttons-compact",this._traditionalStyleCssClass="kp-font-adjust-buttons-wide",this.render("FontSizeButtons",{fontButtonCssClasses:this.getFontButtonCssClasses()},!0)}return __extends(t,e),t.prototype.setDisabledForSize=function(e,t){this.element.find(".kp-toolbar-increase-font").prop("disabled",e),this.element.find(".kp-toolbar-decrease-font").prop("disabled",t)},t.prototype.getFontButtonCssClasses=function(){return window.KindleGlobal.capabilities.FONT_BUTTONS_AT_TOP?this._compactStyleCssClass:this._traditionalStyleCssClass},t}(o);return i});var __extends=this&&this.__extends||function(e,t){function o(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)};define("modules/ui/widgets/ImmersiveFooterBar",["require","exports","modules/ui/widgets/ToolbarBase","modules/ui/widgets/Slider","modules/ui/widgets/FontSizeButtons"],function(e,t,o,i,n){"use strict";var r=function(e){function t(t){e.call(this,t),this._isPermaHidden=!1,this._isFontButtonsInFooter=!window.KindleGlobal.capabilities.FONT_BUTTONS_AT_TOP,this._isSliderAvailable=window.KindleGlobal.capabilities.SLIDER,this.render("ImmersiveFooterBar",{isSliderAvailable:this._isSliderAvailable,isFontButtonsInFooter:this._isFontButtonsInFooter},!0),this._isSliderAvailable&&(this._slider=new i(t.find("#kp-slider"))),this._isFontButtonsInFooter&&(this._fontSizeButtons=new n(t.find("#kp-font-adjust-buttons")))}return __extends(t,e),Object.defineProperty(t.prototype,"slider",{get:function(){return this._slider},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fontSizeButtons",{get:function(){return this._fontSizeButtons},enumerable:!0,configurable:!0}),t.prototype.hide=function(){this.element.transition({y:this.element.height()}).hide({duration:0,queue:!0})},t.prototype.show=function(){this._isPermaHidden||this.element.show({duration:0,queue:!0}).transition({y:0})},t.prototype.setDisplayForFeatureStatus=function(e){this._isFontButtonsInFooter&&e?(this._fontSizeButtons.showAfterRender(),this.showAfterRender()):this._isSliderAvailable?this.showAfterRender():(this._isPermaHidden=!0,this.element.hide())},t.shouldRender=function(){return!window.KindleGlobal.capabilities.FONT_BUTTONS_AT_TOP||window.KindleGlobal.capabilities.SLIDER},t}(o);return r});var __extends=this&&this.__extends||function(e,t){function o(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)};define("modules/viewport/Viewport",["require","exports","modules/utils/KindleEvents"],function(e,t,o){"use strict";!function(e){e[e["toc-page"]=0]="toc-page",e[e["page-numbers"]=1]="page-numbers",e[e["search-in-the-book"]=2]="search-in-the-book",e[e.annotations=3]="annotations",e[e.ncx=4]="ncx"}(t.Capability||(t.Capability={}));var i=(t.Capability,function(e){function t(t,o,i){e.call(this,t,o),this.type=t,this.source=o,this.book=i}return __extends(t,e),t.STATE_LOADED="loaded",t.STATE_LOADING="loading",t}(o.Event));t.LoadingEvent=i;var n=function(e){function t(t,o,i,n,r,a,s){void 0===r&&(r=0),void 0===a&&(a=null),e.call(this,t,o),this.type=t,this.source=o,this.position=i,this.pageRange=n,this.location=r,this.pagingMethod=a,this.book=s}return __extends(t,e),t.NAVIGATION_LOADED="loaded",t}(o.Event);t.NavigationEvent=n;var r=function(e){function t(t,o,i){e.call(this,t,o),this.type=t,this.source=o,this.availability=i}return __extends(t,e),t}(o.Event);t.CapabilityEvent=r}),define("modules/viewport/krew/ResourceUrlTranslator",["require","exports","modules/book/BookInfo"],function(e,t,o){"use strict";var i=function(){function e(e,t){this.compositeResourceMap={},this.reverseLookup={};var o;this.book=t,e?(this.resourceManifest=e.resourceManifest,o=e.compositeResourceManifest):(this.resourceManifest={},o={});for(var i in o){this.resourceManifest[i]=o[i];var n=o[i].parent;this.compositeResourceMap[n]||(this.compositeResourceMap[n]=[]),this.compositeResourceMap[n].push(i)}for(i in this.resourceManifest)this.reverseLookup[this.resourceManifest[i].name]=i}return e.prototype.getResourceUrls=function(e,t,i){function n(e){var o=l[e.metadata.id].name,i={};i[o]=e.data,t(i)}for(var r=[],a=0;a<e.length;a++){var s=this.reverseLookup[e[a]];void 0!==s&&r.push(s)}var l=this.resourceManifest;if(r.length!==e.length&&(console.error("Unable to find all the requested resources."),console.error("Requested: "+JSON.stringify(e)),console.error("Found IDs: "+JSON.stringify(r)),i()),r.length>0){this.book.loadArtifacts(o.ArtifactType.Resource,r,n,i)}else t({})},e}();return i}),define("modules/viewport/krew/SkeletonBuilder",["require","exports","q","modules/book/BookInfo"],function(e,t,o,i){"use strict";var n=function(){function e(e,t){this.book=t,this.manifest=e}return e.prototype.replaceAllFromMap=function(e,t){if(t){var o=/\burl\s*\(\s*(?:'([^']*)'|"([^"]*)")\s*\)/gi;e=e.replace(o,function(e,o,i){var n=o||i,r=t[n];return r?'url("'+r+'")':null===r?"none":e})}return e},e.prototype.injectInlineDataURIs=function(e){e.data=this.replaceAllFromMap(e.data,e.resList)},e.prototype.injectResourceIncludes=function(e,t){for(var o in t){var i=t[o],n=e[i.metadata.id],r=n.includes;if(void 0!==r){for(var a={},s=0;s<r.length;s++){var l=e[r[s]],d=t[r[s]];void 0===d?a[l.name]=null:(void 0!==l.includes&&null!==l.includes&&l.includes.length>0&&console.error("Nested includes: "+n.name+" includes "+l.name+" which has includes of its own!"),a[l.name]=d.data)}i.data=this.replaceAllFromMap(i.data,a)}}},e.prototype.injectSkeletonIncludes=function(e,t,o,i){var n=e.includes;if(void 0!==n){for(var r,a=0;a<n.length;a++){var s=i[n[a]],l=t[s.metadata.id];"text/css"===l.type&&(r=r||{},r[l.name]=s.data)}if(r){var d=/<link\s(?:[^\/>'"]|'[^']*'|"[^"]*")*href\s*=\s*(?:'([^']*)'|"([^"]*)")(?:[^\/>'"]|'[^']*'|"[^"]*")*(?:\/>|>\s*<\/link>)/gi;o.skeletonData=o.skeletonData.replace(d,function(e,t,o){var i=t||o,n=r[i];return n?'<style type="text/css">'+n+"</style>":e})}}},e.prototype.addResourceInfoToSkeleton=function(e,t,o){var i=o.depends;if(void 0!==i){for(var n=[],r=0;r<i.length;r++){var a=t[i[r]];void 0!==a.resInfo&&n.push(a.resInfo)}e.resourceInfo=n}},e.prototype.processSkeletonAndResources=function(e,t,o,i){if(null!==o){var n=e.resourceManifest,r=e.skeletonManifest[t.skeletonMetadata.id];this.injectResourceIncludes(n,o),this.injectSkeletonIncludes(r,n,t,o),this.addResourceInfoToSkeleton(t,n,r)}i.resolve(t)},e.prototype.buildSkeleton=function(e){function t(e){l>=s?a.processSkeletonAndResources(p,e,u,r):c=e}function n(e){a.injectInlineDataURIs(e),u[e.metadata.id]=e,l++,null!==c&&l>=s&&a.processSkeletonAndResources(p,c,u,r)}var r=o.defer(),a=this,s=0,l=0,d=[];void 0!==this.manifest.skeletonManifest&&void 0!==this.manifest.skeletonManifest[e]&&null!==this.manifest.skeletonManifest[e].depends&&(d=this.manifest.skeletonManifest[e].depends.slice(0),s=d.length);var c=null,u=null,p=this.manifest;return this.book.loadArtifacts(i.ArtifactType.Skeleton,[e],t,r.reject),s>0&&(u={},this.book.loadArtifacts(i.ArtifactType.Resource,d,n,r.reject)),r.promise},e}();return n}),define("modules/viewport/krew/BookInfoAdapter",["require","exports","modules/book/BookInfo","modules/metrics/PMET","modules/viewport/krew/ResourceUrlTranslator","modules/viewport/krew/SkeletonBuilder"],function(e,t,o,i,n,r){"use strict";var a=function(){function e(e){this.book=e,this.bookContentRenderedMetric=i.getMetric(i.Constants.BOOK_CONTENT_RENDERED)}return e.prototype.getMetadata=function(e,t){console.debug("getMetadata"),this.book.loadArtifact(o.ArtifactType.Metadata).then(e,t).done()},e.prototype.getBookSkeleton=function(e,t,i){var n=this;console.debug("getBookSkeleton:",i),this.skeletonBuilder?this.skeletonBuilder.buildSkeleton(i).then(e,t).done():this.book.loadArtifact(o.ArtifactType.Manifest).then(function(o){n.skeletonBuilder=new r(o,n.book),n.skeletonBuilder.buildSkeleton(i).then(e,t).done()},t).done()},e.prototype.getFragmentMap=function(e,t){console.debug("getFragmentMap"),this.book.loadArtifact(o.ArtifactType.Fragmap).then(e,t).done()},e.prototype.getBookFragments=function(e,t,i){console.debug("getBookFragments:",i),this.book.loadArtifacts(o.ArtifactType.Fragment,i,e,t)},e.prototype.getGlyphFragments=function(e,t,i){console.debug("getGlyphFragments:",i),this.book.loadArtifacts(o.ArtifactType.Glyph,i,e,t)},e.prototype.getResourceUrls=function(e,t,i){var r=this;console.debug("getResourceUrls:",i),this.resourceUrlTranslator?this.resourceUrlTranslator.getResourceUrls(i,e,t):this.book.loadArtifact(o.ArtifactType.Manifest).then(function(o){r.resourceUrlTranslator=new n(o,r.book),r.resourceUrlTranslator.getResourceUrls(i,e,t)},t).done()},e.prototype.hasCover=function(e){console.debug("hasCover"),e(!1)},e.prototype.getCoverUrl=function(e,t){console.debug("getCoverUrl"),t("Not implemented")},e}();return a}),define("modules/viewport/krew/ColumnCalculator",["require","exports"],function(){"use strict";var e=function(){function e(){}return e.getColumns=function(e,t){var o=1;return e>this.COLUMN_MODE_TRIGGER_POINT&&(o=2),{num:o,gap:this.getGap(o,e,t)}},e.getGap=function(e,t,o){if(1>=e)return 0;var i=(this.MAX_MARGIN_PERCENT-o)*this.GAP_RATIO+this.MIN_COLUMN_GAP_PERCENT,n=Math.round(t*i/100);return n},e.GAP_RATIO=1/16,e.COLUMN_MODE_TRIGGER_POINT=950,e.MAX_MARGIN_PERCENT=22,e.MIN_COLUMN_GAP_PERCENT=2,e}();return e}),define("modules/viewport/krew/KReWDisplaySettingsManager",["require","exports","modules/viewport/krew/ColumnCalculator"],function(e,t,o){"use strict";var i=function(){function e(e,t){void 0===e&&(e=!0),this.ONE_COLUMN_SETTING={num:1,gap:0},this.FONT_SCALE_FACTORS=[.5,.75,1,1.2,1.4,1.6,1.8],this.FONT_SIZE_PRESETS=[9,10,12,14,16,20,28,36,48],this.fontSizePosition=4,this.fontSizeUnits="px",this.atMaxFontSize=!1,this.atMinFontSize=!1,this.glyphScale=1,this.backgroundColor="#ffffff",this.margin=8,this.twoColumnsEnabled=e,this.settingsChangedCallback=t}return e.prototype.setFontMaxMin=function(){this.atMinFontSize=0===this.fontSizePosition,this.atMaxFontSize=this.fontSizePosition===this.FONT_SIZE_PRESETS.length-1},e.prototype.increaseFontSize=function(){var e=this.fontSizePosition;return this.fontSizePosition=Math.min(e+1,this.FONT_SIZE_PRESETS.length-1),e!==this.fontSizePosition&&this.settingsChangedCallback&&(this.setFontMaxMin(),this.settingsChangedCallback(this.getRendererSettings())),this.FONT_SIZE_PRESETS[this.fontSizePosition]},e.prototype.decreaseFontSize=function(){var e=this.fontSizePosition;return this.fontSizePosition=Math.max(e-1,0),e!==this.fontSizePosition&&this.settingsChangedCallback&&(this.setFontMaxMin(),this.settingsChangedCallback(this.getRendererSettings())),this.FONT_SIZE_PRESETS[this.fontSizePosition]},e.prototype.calculateColumns=function(e){var t=this.margin,i=o.getColumns(e,t);return i},e.prototype.setColumns=function(e){this.columns=this.twoColumnsEnabled?this.calculateColumns(e):this.ONE_COLUMN_SETTING},e.prototype.getColumns=function(){return this.columns},e.prototype.getRendererSettings=function(){var e={columns:this.columns,margin:this.margin,glyphScale:this.glyphScale,fontSize:this.getFontSize(),fontSizes:this.getFontSizes(),fontSizeUnits:this.fontSizeUnits,atMaxFontSize:this.atMaxFontSize,atMinFontSize:this.atMinFontSize,backgroundColor:this.backgroundColor};return e},e.prototype.getFontSize=function(){return this.FONT_SIZE_PRESETS[this.fontSizePosition]},e.prototype.getFontSizes=function(){for(var e=new Array,t=this.FONT_SIZE_PRESETS[this.fontSizePosition],o=0;o<this.FONT_SCALE_FACTORS.length;o++)e.push(t*this.FONT_SCALE_FACTORS[o]);return e},e.prototype.updateColumns=function(e){if(this.twoColumnsEnabled){var t=this.getColumns(),o=this.calculateColumns(e),i=!(o.num===t.num&&o.gap===t.gap);i&&(this.setColumns(e),this.settingsChangedCallback(this.getRendererSettings()))}},e}();return i}),define("modules/utils/MouseEvents",["require","exports"],function(e,t){"use strict";function o(){return i||(i="onwheel"in document.createElement("div")?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll"),i}var i=null;t.getMouseWheelEventName=o});var __extends=this&&this.__extends||function(e,t){function o(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)};define("modules/ui/widgets/Spinner",["require","exports","modules/ui/Widget","modules/utils/MouseEvents"],function(e,t,o,i){"use strict";var n=function(e){function t(t){e.call(this,t),this.appendTemplate("Spinner"),this.spinner=this.element.find(".kp-spinner");var o=i.getMouseWheelEventName();this.spinner.on(o,function(e){return e.preventDefault(),e.stopPropagation(),!1})}return __extends(t,e),t.prototype.hide=function(){this.spinner.hide()},t.prototype.show=function(){this.spinner.show()},t}(o);return n}),define("modules/viewport/krew/ZoomableManager",["require","exports"],function(){"use strict";var e;!function(e){e[e.NEXT=0]="NEXT",e[e.PREV=1]="PREV"}(e||(e={}));var t=function(){function t(e,t){this.currentZoomableIndex=null,this.zoomables=null,this.zoomablesForFtu=null,this.zoomedState=!1,this.direction=null,this.kindleRenderer=null,this.krewViewport=null,this.kindleRenderer=t,this.krewViewport=e}return t.prototype.clearZoomablesInternal=function(){if(this.zoomables&&this.zoomables.length>0)for(var e=0;e<this.zoomables.length;e++)this.zoomables[e].deactivate();this.currentZoomableIndex=null,this.zoomedState=!1,this.zoomables=null,this.zoomablesForFtu=null},t.prototype.prepareZoomables=function(){this.zoomables=this.kindleRenderer.getZoomableList(),this.zoomedState=!!this.zoomables},t.prototype.getZoomableIndex=function(e){if(this.zoomables&&this.zoomables.length>0)for(var t=0;t<this.zoomables.length;t++)if(this.zoomables[t].isSame(e))return t;return-1},t.prototype.activateZoomableOnPageTurnInternal=function(){this.prepareZoomables(),this.zoomables&&this.zoomables.length>0&&(this.direction===e.PREV?(this.currentZoomableIndex=this.zoomables.length-1,this.zoomables[this.currentZoomableIndex].activate()):this.direction===e.NEXT&&(this.currentZoomableIndex=0,this.zoomables[this.currentZoomableIndex].activate()),this.direction=null)},t.prototype.goToLastZoomableOnPrevPage=function(){var t=this;this.clearZoomablesInternal(),this.kindleRenderer.hasPreviousScreen()&&(this.direction=e.PREV,this.krewViewport.doPrevPage("click").then(function(){t.activateZoomableOnPageTurnInternal()}))},t.prototype.goToFirstZoomableOnNextPage=function(){var t=this;this.clearZoomablesInternal(),this.kindleRenderer.hasNextScreen()&&(this.direction=e.NEXT,this.krewViewport.doNextPage("click").then(function(){t.activateZoomableOnPageTurnInternal()}))},t.prototype.isPointWithinZoomableBounds=function(e,t,o){var i=o.getBounds();return e<i.right&&e>i.left&&t>i.top&&t<i.bottom},t.prototype.activateZoomableAtPosition=function(e,t){this.deactivateZoomable();try{var o=this.kindleRenderer.getZoomableAt(e,t)||this.findZoomableInZoomablesListForFtu(e,t);o&&o.activate&&(this.zoomables||this.prepareZoomables(),this.currentZoomableIndex=this.getZoomableIndex(o),this.currentZoomableIndex>=0&&(this.zoomables[this.currentZoomableIndex].activate(),this.zoomedState=!0))}catch(i){console.debug("activateZoomableAtPosition failed: "+i.stack||"no stack trace")}},t.prototype.findZoomableInZoomablesListForFtu=function(e,t){if("Ftu"!==window.KindleGlobal.appName)return null;this.zoomablesForFtu||(this.zoomablesForFtu=this.kindleRenderer.getZoomableList());for(var o=0;o<this.zoomablesForFtu.length;o++){var i=this.zoomablesForFtu[o];if(this.isPointWithinZoomableBounds(e,t,i))return i}return null},t.prototype.gotoPreviousZoomable=function(){try{if(!this.zoomables)return;0===this.zoomables.length?this.goToLastZoomableOnPrevPage():(this.zoomables[this.currentZoomableIndex].deactivate(),this.currentZoomableIndex>0?this.zoomables[--this.currentZoomableIndex].activate():this.goToLastZoomableOnPrevPage())}catch(e){console.debug("gotoPreviousZoomable failed: "+e.stack||"no stack trace")}},t.prototype.gotoNextZoomable=function(){try{if(!this.zoomables)return;0===this.zoomables.length?this.goToFirstZoomableOnNextPage():(this.zoomables[this.currentZoomableIndex].deactivate(),this.currentZoomableIndex<this.zoomables.length-1?this.zoomables[++this.currentZoomableIndex].activate():this.goToFirstZoomableOnNextPage())}catch(e){console.debug("gotoNextZoomable failed: "+e.stack||"no stack trace")}},t.prototype.gotoZoomable=function(e,t){e?t?this.gotoPreviousZoomable():this.gotoNextZoomable():t?this.gotoNextZoomable():this.gotoPreviousZoomable()},t.prototype.activateZoomableOnPageTurn=function(){this.activateZoomableOnPageTurnInternal()},t.prototype.deactivateZoomable=function(){try{this.zoomedState&&(this.zoomables&&this.zoomables.length>0&&this.zoomables[this.currentZoomableIndex].deactivate(),this.currentZoomableIndex=null,this.zoomedState=!1)}catch(e){console.debug("deactivateZoomable failed: "+e.stack||"no stack trace")}},t.prototype.isZoomed=function(){return this.zoomedState},t.prototype.clearZoomables=function(){try{this.clearZoomablesInternal()}catch(e){console.debug("clearZoomables failed: "+e.stack||"no stack trace")}},t}();return t});var __extends=this&&this.__extends||function(e,t){function o(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)};define("modules/viewport/krew/KReWViewport",["require","exports","q","modules/utils/Performance","modules/book/BookInfo","modules/viewport/krew/BookInfoAdapter","modules/utils/DeviceUtils","modules/utils/KindleEvents","modules/viewport/krew/KReWDisplaySettingsManager","kindleRendererFactory","modules/metrics/MetricsUtils","modules/metrics/PMET","modules/ui/widgets/Spinner","modules/viewport/Viewport","modules/ui/Widget","modules/utils/Utility","modules/utils/MouseEvents","modules/utils/Service","modules/viewport/krew/ZoomableManager","modules/metrics/ReadingStreams"],function(e,t,o,i,n,r,a,s,l,d,c,u,p,h,f,m,g,v,b,E){"use strict";var y,w=200,S=400,R=10,k="FontSizeIncreased",T="FontSizeDecreased",C="kp-viewport-touchLayer",P="kp-viewport-content",_="kp-viewport-title",A="kp-viewport-prev-page",I="kp-viewport-next-page",O="click",M="swipe",N="tap";!function(e){e[e.Initial=0]="Initial",e[e.Loading=1]="Loading",e[e.Requesting=2]="Requesting",e[e.Navigating=3]="Navigating",e[e.Navigated=4]="Navigated",e[e.Ready=5]="Ready",e[e.Error=6]="Error"}(y||(y={}));var F=function(e){function t(t,o,i,n){var r=this;e.call(this,t),this.capabilities={},this.loadingEvent=new s.EventProvider,this.navigationEvent=new s.EventProvider,this.capabilityEvent=new s.EventProvider,this.navigationState=y.Initial,this.navigationMethod=null,this.handledBySwipe=!1,this.hasHammerSwipeClickProblem=a.hasHammerSwipeClickBothFireProblem(),this.isRTL=!1,this.container=t,this.book=i,this.metadata=n,this.bookContentRenderedMetric=u.getMetric(u.Constants.BOOK_CONTENT_RENDERED),this.rendererSettings=new l(o.twoColumnsEnabled,function(e){r.onRendererSettingsChanged(e)
}),this.position=o.position||this.book.furthestPositionRead||this.book.startReadingPosition,this.capabilities[h.Capability["toc-page"]]=!!this.metadata.tableOfContentsPosition,this.capabilities[h.Capability["page-numbers"]]=!1,this.appendTemplate("KReWViewport"),this.content=t.find("."+P),this.titleLabel=t.find("."+_),this.titleLabel.text(this.metadata.title),this.prevPageButton=t.find("."+A),this.nextPageButton=t.find("."+I),this.spinner=new p(t.find(".kp-viewport-spinner")),this.touchLayer=t.find("."+C),a.isTouchDevice()?this.attachGestureHandlers():console.debug("This is not a touch device."),a.hasTransparentDivProblem()&&this.touchLayer.css("background-image","url(.)"),this.attachEventHandlersToTouchLayer(),this.kindleRenderer=d(),this._zoomableManager=new b(this,this.kindleRenderer),this._readerStreamManager=E.getManager(),this.immersiveMode=o.immersiveMode,this.initializeRenderer(),this.bindWindowResize()}return __extends(t,e),Object.defineProperty(t.prototype,"maxPosition",{get:function(){return this.metadata.endPosition||null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"zoomableManager",{get:function(){return this._zoomableManager},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"currentPosition",{get:function(){return this.position},enumerable:!0,configurable:!0}),t.prototype.isRTLReadingDirection=function(){return this.isRTL},Object.defineProperty(t.prototype,"currentPositionRangeAtReady",{get:function(){return this.isRendererReady()?this.kindleRenderer.getPagePositionRange():null},enumerable:!0,configurable:!0}),t.prototype.onRendererSettingsChanged=function(e){this.kindleRenderer.updateSettings(e),this.container.trigger("fontSizeChanged",[e.atMaxFontSize,e.atMinFontSize])},t.prototype.getFontSize=function(){return this.rendererSettings.getFontSize()},t.prototype.atMaxFontSize=function(){return this.rendererSettings.getRendererSettings().atMaxFontSize},t.prototype.atMinFontSize=function(){return this.rendererSettings.getRendererSettings().atMinFontSize},t.prototype.increaseFontSize=function(){u.getMetric(k)||u.createMetric(k).startTimer(),this.rendererSettings.increaseFontSize()},t.prototype.decreaseFontSize=function(){u.getMetric(T)||u.createMetric(T).startTimer(),this.rendererSettings.decreaseFontSize()},t.prototype.gotoPosition=function(e,t){return t&&(this.navigationMethod=t),this.position!==e&&this.isRendererReady()?(this.position=e,this.navigationState=y.Requesting,this.kindleRenderer.gotoPosition(e.valueOf())||this.kindleRenderStatus===this.kindleRenderer.STATUS_DONE?this.navigated():this.navigationStarted()):o.resolve(this.position)},t.prototype.gotoLocation=function(e,t){var o=this;return t&&(this.navigationMethod=t),this.book.getLocationConverter().then(function(t){return t.positionFromLocation(e)}).then(function(e){return o.gotoPosition(e)})},t.prototype.getMaxLocation=function(){var e=this;return this.book.getLocationConverter().then(function(t){return t.locationFromPosition(e.maxPosition)})},t.prototype.gotoCover=function(e){return e&&(this.navigationMethod=e),this.gotoPosition(this.metadata.coverPosition)},t.prototype.gotoToc=function(){return this.gotoPosition(this.metadata.tableOfContentsPosition)},t.prototype.gotoBeginning=function(){return this.gotoPosition(this.book.startReadingPosition)},t.prototype.addLoadingEventListener=function(e){this.loadingEvent.addListener(e)},t.prototype.removeLoadingEventListener=function(e){this.loadingEvent.removeListener(e)},t.prototype.addNavigationEventListener=function(e){this.navigationEvent.addListener(e)},t.prototype.removeNavigationEventListener=function(e){this.navigationEvent.removeListener(e)},t.prototype.addCapabilityEventListener=function(e){this.capabilityEvent.addListener(e)},t.prototype.removeCapabilityEventListener=function(e){this.capabilityEvent.removeListener(e)},t.prototype.wrapFunctionAndParameters=function(e,t,o){return function(){e.apply(t,o)}},t.prototype.deferSingleClick=function(e,t){var o=this.content.offset(),i=e.pageX-o.left,n=e.pageY-o.top;if(this.isRendererReady()&&(this.kindleRenderer.getZoomableAt(i,n)||this.zoomableManager.findZoomableInZoomablesListForFtu(i,n))||this.zoomableManager.isZoomed())if(this.isSingleClickDelayed)clearTimeout(this.doubleClickTimer),this.isSingleClickDelayed=!1,this.handleDoubleClick(i,n);else{this.isSingleClickDelayed=!0;var r=this;this.doubleClickTimer=setTimeout(function(){t(),r.isSingleClickDelayed=!1},S)}else clearTimeout(this.doubleClickTimer),this.isSingleClickDelayed=!1,t()},t.prototype.announceCapability=function(e,t){void 0===t&&(t=!0),this.capabilityEvent.fire(new h.CapabilityEvent(e,this,t))},t.prototype.shutdown=function(){this.kindleRenderer.shutdown(),this.container.empty()},t.prototype.bindWindowResize=function(){function e(e){function i(){$.when(o.navigationPromise).always(function(){o.updateColumns(),o.kindleRenderer.onWindowResize(),console.debug("resize renderer")})}clearTimeout(t),t=setTimeout(i,e)}var t,o=this;$(window).on("resize",function(){console.debug("window resize event fired");var t=a.requireDelayOnResize()?w:0;e(t)})},t.prototype.updateColumns=function(){var e=this.container.find("."+C).width();this.rendererSettings.updateColumns(e)},t.prototype.onTap=function(e){var t=e.tapCount;console.debug(1>=t?"tap detected.":t+" taps detected.");for(var o=this.content.offset(),i=e.center.x,n=e.center.y,r=i-o.left,a=n-o.top,s=0;t>s;s++)this.handleClick(r,a,i,n,N)&&e.preventDefault()},t.prototype.onSwipe=function(e){var t=e.type;console.debug(t+" detected."),this.handledBySwipe=!1,"swipeleft"===t?(window.KindleGlobal.capabilities.REGION_MAGNIFICATION&&this.zoomableManager.isZoomed()?(c.recordAction(this._readerStreamManager.CONTEXT_READER,this._readerStreamManager.ACTION_REGION_MAGNIFICATION_FORWARD,{DEVICEPLATFORM:a.getDevicePlatform()}),this.zoomableManager.gotoZoomable(!0,this.kindleRenderer.isRTLReadingDirection())):this.nextPage(M),this.handledBySwipe=!0):"swiperight"===t&&(window.KindleGlobal.capabilities.REGION_MAGNIFICATION&&this.zoomableManager.isZoomed()?(c.recordAction(this._readerStreamManager.CONTEXT_READER,this._readerStreamManager.ACTION_REGION_MAGNIFICATION_BACKWARD,{DEVICEPLATFORM:a.getDevicePlatform()}),this.zoomableManager.gotoZoomable(!1,this.kindleRenderer.isRTLReadingDirection())):this.prevPage(M),this.handledBySwipe=!0),this.handledBySwipe&&e.preventDefault()},t.prototype.handleClickAndStopPropagation=function(e,t,o,i,n){!this.handleClick(t,o,i,n,O)&&this.immersiveMode?this.immersiveMode.toggle():e.stopImmediatePropagation()},t.prototype.onClick=function(e){if(console.debug("click detected."),this.hasHammerSwipeClickProblem&&this.handledBySwipe)return e.stopImmediatePropagation(),void(this.handledBySwipe=!1);var t=this.content.offset(),o=e.pageX,i=e.pageY,n=o-t.left,r=i-t.top;if(window.KindleGlobal.capabilities.REGION_MAGNIFICATION){var a=this.wrapFunctionAndParameters(this.handleClickAndStopPropagation,this,[e,n,r,o,i]);this.deferSingleClick(e,a)}else this.handleClickAndStopPropagation(e,n,r,o,i)},t.prototype.handleClick=function(e,t,o,i,n){var r=!!this.kindleRenderer.handleClick(e,t);if(r)return!0;var s=$("."+C).width(),l=s/4,d=3*s/4;return l>o?(console.debug("Prev page clicked"),window.KindleGlobal.capabilities.REGION_MAGNIFICATION&&this.zoomableManager.isZoomed()?(this.zoomableManager.gotoZoomable(!1,this.kindleRenderer.isRTLReadingDirection()),c.recordAction(this._readerStreamManager.CONTEXT_READER,this._readerStreamManager.ACTION_REGION_MAGNIFICATION_BACKWARD,{DEVICEPLATFORM:a.getDevicePlatform()})):this.prevPage(n),!0):o>d?(console.debug("Next page clicked"),window.KindleGlobal.capabilities.REGION_MAGNIFICATION&&this.zoomableManager.isZoomed()?(this.zoomableManager.gotoZoomable(!0,this.kindleRenderer.isRTLReadingDirection()),c.recordAction(this._readerStreamManager.CONTEXT_READER,this._readerStreamManager.ACTION_REGION_MAGNIFICATION_FORWARD,{DEVICEPLATFORM:a.getDevicePlatform()})):this.nextPage(n),!0):!1},t.prototype.handleDoubleClick=function(e,t){this.isRendererReady()&&(this.kindleRenderer.getZoomableAt(e,t)||this.zoomableManager.findZoomableInZoomablesListForFtu(e,t))?(this.zoomableManager.activateZoomableAtPosition(e,t),c.recordAction(this._readerStreamManager.CONTEXT_READER,this._readerStreamManager.ACTION_REGION_MAGNIFICATION_ACTIVATE,{DEVICEPLATFORM:a.getDevicePlatform()})):this.zoomableManager.isZoomed()&&(c.recordAction(this._readerStreamManager.CONTEXT_READER,this._readerStreamManager.ACTION_REGION_MAGNIFICATION_DEACTIVATE,{DEVICEPLATFORM:a.getDevicePlatform()}),this.zoomableManager.deactivateZoomable())},t.prototype.attachEventHandlersToTouchLayer=function(){var e=this,t=g.getMouseWheelEventName();this.touchLayer.on(t,m.throttled(function(t){e.onMouseWheel(t)})),this.touchLayer.on(t,function(e){return e.preventDefault(),e.stopPropagation(),!1}),this.touchLayer.on("click",function(t){return e.onClick(t)})},t.prototype.attachGestureHandlers=function(){var e=this;console.debug("Attaching gesture handlers..."),v.requireWithRetry(["hammer"],function(t){var o=e.touchLayer[0],i=new t.Manager(o);i.add([new t.Swipe({direction:t.DIRECTION_HORIZONTAL,velocity:.01,threshold:R})]),i.add([new t.Tap({threshold:R-1,posThreshold:15,time:120})]),i.on("swipeleft swiperight",function(t){e.onSwipe(t)});var n;try{n=a.getMobileOSMajorVersion()}catch(r){console.warn(r)}a.isIOS()&&n&&13>n&&"Ftu"!==window.KindleGlobal.appName&&i.on("tap",function(t){return e.onTap(t)})})},t.prototype.onNavigationComplete=function(e,t,o,i,n){var r=this;this.navigationMethod=null,this.spinner.hide(),this.position!==e&&(this.position=e,"Ftu"===window.KindleGlobal.appName&&this.zoomableManager.clearZoomables(),this.book.getLocationConverter().then(function(a){a.locationFromPosition(r.position).then(function(a){r.navigationEvent.fire(new h.NavigationEvent("navigation",r,e,t,a,o,n));var s=r.metadata.startReadingPosition.valueOf(),l=(r.position.valueOf()-s)/(r.maxPosition.valueOf()-s);0>l?l=0:l+=.01,l=Math.max(0,Math.min(l,1)),r.container.trigger("navigatedToPercentage",[l,t,o,i]),i&&r.container.trigger("reachedEndOfBook",!0),window.KindleGlobal.capabilities.LANDING_PAGE||r.setPrevPageButtonDisplayForPage(),window.KindleGlobal.capabilities.END_ACTION||r.setNextPageButtonDisplayForPage()}).done()}).done())},t.prototype.navigationStarted=function(){return this.spinner.show(),this.navigationPromise&&this.navigationPromise.promise.done(),this.navigationState=y.Navigating,this.navigationPromise=o.defer(),this.navigationPromise.promise.delay(0)},t.prototype.navigationFinished=function(){var e=this.kindleRenderer.getPagePositionRange(),t=this.position.valueOf()>=this.maxPosition.valueOf(),o=n.createPosition(this.metadata.format,e.currentTopOfPage);this.navigationPromise&&(this.navigationPromise.resolve(o),this.navigationPromise=null),this.navigationState=y.Ready,this.onNavigationComplete(o,e,this.navigationMethod,t,this.book)},t.prototype.navigated=function(){var e=this.navigationStarted();return this.navigationFinished(),e},t.prototype.isRendererReady=function(){return this.navigationState===y.Ready},t.prototype.doPrevPage=function(e){if(this.isRendererReady()){var t=u.createMetric("Reader").appendToReportedName("PrevPage",this.metadata.getFormatTypeName()).startTimer(),o=u.createMetric("Reader").appendToReportedName("PrevPage").startTimer();if(u.record(u.createMetric("Reader").appendToReportedName("PageTurn",e)),this.navigationState!==y.Loading&&this.navigationState!==y.Navigating&&!this.kindleRenderer.hasPreviousScreen())return console.debug("Beginning of book reached"),this.zoomableManager.deactivateZoomable(),void this.container.trigger("reachedBeginningOfBook");if(this.navigationState=y.Requesting,this.navigationMethod=e,this.zoomableManager.clearZoomables(),this.kindleRenderer.previousScreen())return console.debug("Immediate prevPage"),this.navigated().then(function(){u.record(t.stopTimer().appendToReportedName(u.Constants.LOCAL_CONTENT),o.stopTimer())});console.debug("Pending prevPage");var i=this.navigationStarted();return i.then(function(){u.record(t.stopTimer().appendToReportedName(u.Constants.REMOTE_CONTENT),o.stopTimer())})}},t.prototype.doNextPage=function(e){if(this.isRendererReady()){var t=u.createMetric("Reader").appendToReportedName("NextPage",this.metadata.getFormatTypeName()).startTimer(),o=u.createMetric("Reader").appendToReportedName("NextPage").startTimer();if(u.record(u.createMetric("Reader").appendToReportedName("PageTurn",e)),this.navigationState!==y.Loading&&this.navigationState!==y.Navigating&&!this.kindleRenderer.hasNextScreen())return this.zoomableManager.deactivateZoomable(),console.debug("End of book reached"),void this.container.trigger("reachedEndOfBook",!1);if(this.navigationState=y.Requesting,this.navigationMethod=e,this.zoomableManager.clearZoomables(),this.kindleRenderer.nextScreen())return console.debug("Immediate nextPage"),this.navigated().then(function(){u.record(t.stopTimer().appendToReportedName(u.Constants.LOCAL_CONTENT),o.stopTimer())});console.debug("Pending nextPage");var i=this.navigationStarted();return i.then(function(){u.record(t.stopTimer().appendToReportedName(u.Constants.REMOTE_CONTENT),o.stopTimer())})}},t.prototype.nextPage=function(e){this.kindleRenderer.isRTLReadingDirection()?this.doPrevPage(e):this.doNextPage(e)},t.prototype.prevPage=function(e){this.kindleRenderer.isRTLReadingDirection()?this.doNextPage(e):this.doPrevPage(e)},t.prototype.setPrevPageButtonDisplayForPage=function(){this.kindleRenderer.isRTLReadingDirection()?this.kindleRenderer.hasPreviousScreen()?this.nextPageButton.is(":visible")||this.nextPageButton.show():this.nextPageButton.hide():this.kindleRenderer.hasPreviousScreen()?this.prevPageButton.is(":visible")||this.prevPageButton.show():this.prevPageButton.hide()},t.prototype.setNextPageButtonDisplayForPage=function(){this.kindleRenderer.isRTLReadingDirection()?this.kindleRenderer.hasNextScreen()?this.prevPageButton.is(":visible")||this.prevPageButton.show():this.prevPageButton.hide():this.kindleRenderer.hasNextScreen()?this.nextPageButton.is(":visible")||this.nextPageButton.show():this.nextPageButton.hide()},t.prototype.onMouseWheel=function(e){var t=e.originalEvent,o=t.wheelDelta||-1*t.deltaY||-1*t.detail;0>o?this.nextPage("mousewheel"):this.prevPage("mousewheel")},t.prototype.gotoPositionRenderer=function(e){console.debug("Goto position from renderer: "+e),this.navigationMethod="gotoPositionFromRenderer",this.gotoPosition(n.createPosition(this.metadata.format,e)).done()},t.prototype.openStoreRenderer=function(){console.debug("Goto store from renderer")},t.prototype.initializeRenderer=function(){var e=this,t={bookInfo:new r(this.book),containerId:"krew-viewport-container",startingPositionDfd:$.Deferred().resolve(this.position)},o=this.container.find("."+C).width();this.rendererSettings.setColumns(o);var n=this.rendererSettings.getRendererSettings(),a={statusCallback:function(t){e.statusCallback(t)},annotationEventCallback:function(t,o){e.annotationEventCallback(t,o)},contentInterfaceCallbacks:{gotoPosition:function(t){return e.gotoPositionRenderer(t)},openStoreDP:function(){return e.openStoreRenderer()}}};i.mark("mark_renderer_initialize"),this.kindleRenderer.initialize(t,n,a)},t.prototype.statusCallback=function(e){switch(console.debug("**** statusCallback: status = "+e.status),this.kindleRenderStatus=e.status,e.status){case this.kindleRenderer.STATUS_DONE:var t=u.getMetric(k);t&&u.record(t.stopTimer());var o=u.getMetric(T);o&&u.record(o.stopTimer()),this.navigationState===y.Loading?(i.mark("mark_renderer_done"),console.info("Renderer loaded"),this.isRTL=this.kindleRenderer.isRTLReadingDirection(),this.navigationState=y.Ready,this.navigationMethod=h.NavigationEvent.NAVIGATION_LOADED,this.loadingEvent.fire(new h.LoadingEvent(h.LoadingEvent.STATE_LOADED,this,this.book)),this.navigated()):this.navigationState===y.Navigating&&(console.debug("Renderer navigation complete"),this.navigationFinished());break;case this.kindleRenderer.STATUS_PAGINATING:console.debug("Renderer paginating"),this.onPaginating();break;case this.kindleRenderer.STATUS_PAGINATED:i.mark("mark_renderer_paginated"),console.debug("Renderer paginated"),this.onPaginated();break;case this.kindleRenderer.STATUS_LOADING:i.mark("mark_renderer_loading"),console.info("Renderer loading"),this.navigationState=y.Loading,this.loadingEvent.fire(new h.LoadingEvent(h.LoadingEvent.STATE_LOADING,this,this.book));break;case this.kindleRenderer.STATUS_ERROR:var n,r="["+e.errorCode+"] "+e.errorMsg;try{throw new Error}catch(a){n=a.stack||"no stack trace"}console.debug("Error status from Renderer: "+r);var s=u.createMetric("KindleRendererError");s.setProperty("ErrorStatus",r),s.setProperty("ErrorStackTrace",n),u.record(s),this.navigationState=y.Error}},t.prototype.onPaginating=function(){this.spinner.show(),this.hideRenderer()},t.prototype.onPaginated=function(){this.spinner.hide(),this.showRenderer()},t.prototype.hideRenderer=function(){this.content.css({opacity:0})},t.prototype.showRenderer=function(){this.content.css({opacity:1})},t.prototype.annotationEventCallback=function(e,t){console.debug("**** annotationEventCallback: type = "+e+", start = "+t)},t}(f);return F}),define("modules/viewport/ViewportFactory",["require","exports","modules/book/BookInfo","modules/book/BookInCloud","modules/viewport/krew/KReWViewport","modules/utils/Errors"],function(e,t,o,i,n,r){"use strict";function a(e,t){function a(){return t.startReadingResponse?i.openBook(t,t.startReadingResponse):i.startReading(t)}return a().then(function(i){switch(i.metadata.format){case o.Format.TOPAZ:case o.Format.MOBI7:case o.Format.MOBI8:return new n(e,t,i,i.metadata);default:throw new r.KcrError("Unknown book format: "+o.Format[i.metadata.format]).setErrorCode(r.Codes.ReaderGetBookInfoUnknownFormat)}})}t.createViewport=a}),define("modules/ui/widgets/ImmersiveMode",["require","exports","modules/metrics/ReadingStreams"],function(e,t,o){"use strict";var i=o.getManager(),n=function(){function e(e,t){this._autoEnterDelayDefault=2e3,this._immersiveFooterBar=e,this._immersiveHeaderBar=t}return e.prototype.enter=function(){console.info("entering immersive mode"),this.cancelAutoEnter(),this._immersiveFooterBar&&this._immersiveFooterBar.hide(),this._immersiveHeaderBar&&this._immersiveHeaderBar.hide()},e.prototype.leave=function(){console.info("exiting immersive mode"),this._immersiveFooterBar&&this._immersiveFooterBar.show(),this._immersiveHeaderBar&&this._immersiveHeaderBar.show()},e.prototype.autoEnter=function(){var e=e?e:this._autoEnterDelayDefault,t=this;this._autoEnterTimeout=setTimeout(function(){t.enter()},e)},e.prototype.cancelAutoEnter=function(){clearTimeout(this._autoEnterTimeout)},e.prototype.isImmersiveMode=function(){var e=!this._immersiveFooterBar||!this._immersiveFooterBar.isVisible(),t=!this._immersiveHeaderBar||!this._immersiveHeaderBar.isVisible();return e&&t},e.prototype.toggle=function(){console.debug("body clicked"),this.isImmersiveMode()?(this.leave(),this._immersiveFooterBar&&i.showContext(i.CONTEXT_CHANGE_IMMERSIVE_FOOTER),this._immersiveHeaderBar&&i.showContext(i.CONTEXT_CHANGE_IMMERSIVE_HEADER)):(this.enter(),this._immersiveFooterBar&&i.hideContext(i.CONTEXT_CHANGE_IMMERSIVE_FOOTER),this._immersiveHeaderBar&&i.hideContext(i.CONTEXT_CHANGE_IMMERSIVE_HEADER))},e}();return n});var __extends=this&&this.__extends||function(e,t){function o(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)};define("modules/ui/widgets/ImmersiveHeaderBar",["require","exports","modules/ui/widgets/ToolbarBase","modules/ui/widgets/FontSizeButtons"],function(e,t,o,i){"use strict";var n=function(e){function t(t){e.call(this,t),this._isPermaHidden=!1,this._bothHeadersPresentClass="kp-immersive-hdr-standout",this._isFontButtonsInHeader=window.KindleGlobal.capabilities.FONT_BUTTONS_AT_TOP;var o=window.KindleGlobal.capabilities.SHARING_HEADER?this._bothHeadersPresentClass:"";this.render("ImmersiveHeaderBar",{isFontButtonsInHeader:this._isFontButtonsInHeader,cssClass:o},!0),this._isFontButtonsInHeader&&(this._fontSizeButtons=new i(t.find("#kp-font-adjust-buttons")))}return __extends(t,e),Object.defineProperty(t.prototype,"fontSizeButtons",{get:function(){return this._fontSizeButtons},enumerable:!0,configurable:!0}),t.prototype.hide=function(){this.element.transition({y:-this.element.height()}).hide({duration:0,queue:!0})},t.prototype.show=function(){this._isPermaHidden||this.element.show({duration:0,queue:!0}).transition({y:0})},t.prototype.setDisplayForFeatureStatus=function(e){this._isFontButtonsInHeader&&e?(this._fontSizeButtons.showAfterRender(),this.showAfterRender()):(this._isPermaHidden=!0,this.element.hide())},t.shouldRender=function(){return window.KindleGlobal.capabilities.FONT_BUTTONS_AT_TOP},t}(o);return n}),define("modules/ui/views/ReaderView",["require","exports","q","modules/book/BookInfo","modules/book/BookInCloud","modules/metrics/CSM","modules/utils/DeviceUtils","modules/utils/Errors","modules/utils/Fullscreen","modules/utils/GlideInfo","modules/utils/KeyboardConstants","modules/metrics/MetricsUtils","modules/metrics/PMET","modules/metrics/ReadingStreams","modules/utils/ReadInKindle","modules/utils/RefTag","modules/ui/widgets/SharingHeaderBar","modules/ui/widgets/ImmersiveFooterBar","modules/utils/Utility","modules/viewport/Viewport","modules/viewport/ViewportFactory","modules/utils/Localization","modules/marketplace/Marketplace","modules/ui/widgets/SliderEvents","modules/ui/widgets/ImmersiveMode","modules/ui/widgets/ImmersiveHeaderBar"],function(e,t,o,i,n,r,a,s,l,d,c,u,p,h,f,m,g,v,b,E,y,w,S,R,k,T){"use strict";function C(e,t){console.info("initialize ReaderView"),p.createMetric(p.Constants.BOOK_CONTENT_RENDERED).startTimer(),dt=e,ut=o.defer();var h=a.isDesktop()&&t.allowFullScreen,m=window.KindleGlobal.capabilities.SHARING_HEADER,b=window.KindleGlobal.capabilities.READER_STATUS_BAR,w=T.shouldRender(),S=v.shouldRender(),R=l.fullscreenIsAvailable(),C=window.KindleGlobal.capabilities.SLIDER,P=window.KindleGlobal.capabilities.AUTO_ENTER_IMMERSIVE_MODE,_=m?"":bt,F=b?"":Et,L=d.isGlideAllowed()&&d.hasGlideBookDetails();if(L&&dt.addClass(vt),ct=$(Handlebars.templates[mt]({shouldShowFullscreenControl:h,shouldShowReaderHeader:m,shouldShowReaderStatus:b,readerTopSpacerClass:_,readerBottomSpacerClass:F,fullscreenIsAvailable:R,glideEnabled:L,conditionsOfUseLink:window.KindleGlobal.conditionsOfUseLink,privacyNoticeLink:window.KindleGlobal.privacyNoticeLink,canClientLaunchAppProtocols:window.KindleGlobal.deviceInfo.canClientLaunchAppProtocols,shouldShowImmersiveHeader:w,shouldShowImmersiveFooter:S})),m&&(Q=new g(ct.filter(".kp-reader-header"),L)),w&&(tt=new T(ct.filter(".kp-reader-immersive-header"))),S&&(et=new v(ct.filter(".kp-reader-footer")),C&&(ot=et.slider,ot||(C=!1,console.warn("Slider capability active but slider not initialized by containing widget")))),it=window.KindleGlobal.capabilities.FONT_BUTTONS_AT_TOP?tt.fontSizeButtons:et.fontSizeButtons,nt=new k(et,tt),h&&R?D():h||A(),window.KindleGlobal.capabilities.ALLOW_FULL_BOOK){var x=function(){var e={asin:ht.asin,guid:pt,kindleSessionId:window.KindleGlobal.startReading.kindleSessionId,lastPageRead:at.position.toString(),localTimeOffset:-(new Date).getTimezoneOffset(),positionType:i.Format[at.position.type].toLowerCase()};n.doneReading(e).then(function(){console.debug("doneReading last read position: "+at.position)})["catch"](function(e){console.debug("Failed to call doneReading with position: "+at.position+",reason is: "+e)}).done()};"undefined"!=typeof window.onbeforeunload?window.addEventListener("beforeunload",x):window.addEventListener("unload",x)}dt.append(ct),dt.on("actionInvoked",function(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];N(e,t[0])}),ct.find(".kp-toolbar-rik-button").bind(a.getClickEvent(),function(){u.recordAction(ft.CONTEXT_READER,ft.ACTION_READ_IN_KINDLE_CLICKED,{devicePlatform:a.getDevicePlatform()}),p.record(p.createMetric(ft.ACTION_READ_IN_KINDLE_CLICKED).appendToReportedName(a.getDevicePlatform(),ft.CONTEXT_READER));var e=p.createMetric(f.metricsPrefix);p.record(e.appendToReportedName("Clicked"));var t=p.createMetric(f.metricsPrefix);p.record(t.appendToReportedName("Clicked",a.getDevicePlatform())),f.trigger()});var B=ct.find(".kp-toolbar-share-button");return B.click(function(){u.recordAction(ft.CONTEXT_READER,ft.ACTION_SHARE_CLICKED),ct.trigger("showSharingDialog",B)}),window.KindleGlobal.capabilities.DISPLAY_SHARE_JIT&&ct.trigger("showSharingDialog",B),yt.promise.then(function(){var e=p.Constants.QUARTILE_STARTED;M(1),dt.on("navigatedToPercentage",function(t,o,i){if(C)try{Y(i)}catch(n){console.warn("Could not set Slider after Navigation: "+n.message)}var r=Math.round(100*o);M(r);var a=Math.ceil(r/25);a!==St&&(ft.consumeContentPoint(ft.CONTEXT_READER,e,a),Rt[a]||(p.record(p.createMetric(e).appendToReportedName(a.toString(),ft.CONTEXT_READER)),Rt[a]=!0),St=a)})}),dt.on("fontSizeChanged",function(e,t,o){it.setDisabledForSize(t,o)}),dt.on("handleKeyDown",function(e,t){switch(t.which){case c.KEYCODES.SPACE:t.shiftKey?at.prevPage("keyboard"):at.nextPage("keyboard");break;case c.KEYCODES.LEFT_ARROW:case c.KEYCODES.PAGE_UP:case c.KEYCODES.UP_ARROW:at.prevPage("keyboard");break;case c.KEYCODES.RIGHT_ARROW:case c.KEYCODES.PAGE_DOWN:case c.KEYCODES.DOWN_ARROW:at.nextPage("keyboard");break;default:return}e.preventDefault(),e.stopPropagation(),t.preventDefault(),t.stopPropagation()}),y.createViewport($(".kp-viewport"),W(nt)).then(function(e){console.info("ViewManager got viewport."),at=e,O(),rt=at.zoomableManager;var t=p.getMetric(p.Constants.BOOK_CONTENT_RENDERED);at.addLoadingEventListener(function(e){if(e.type===E.LoadingEvent.STATE_LOADED){if(C)try{X(P),Y(at.currentPositionRangeAtReady)}catch(o){console.warn("Could not Initialize slider: "+o.message)}P&&nt.autoEnter(),pt=e.book.guid,ht=e.book.metadata;var n=p.getNow(),a=ht.getFormatTypeName();J(ht),r.registerTag("bookFormat:"+a),r.logCriticalFeatureMarker(),r.uploadCSM(),p.record(t.stopTimer().appendToReportedName(a));var s=kt&&Tt?wt:yt;s.promise.then(function(t){V(t,n,a),ft.openContent(i.Type[e.book.type],"",ht.asin,ht.startReadingPosition.valueOf(),ht.endPosition.valueOf(),ht.endPosition.valueOf())})}}),at.addNavigationEventListener(function(e){console.debug("Navigated to position "+e.position),yt.promise.then(function(){if(e.pageRange.currentTopOfPage>e.pageRange.currentBottomOfPage)return void p.record(p.createMetric("InvalidPageRange").appendToReportedName(e.pagingMethod,e.pageRange.currentTopOfPage.toString(),e.pageRange.currentBottomOfPage.toString(),window.KindleGlobal.requestInfo.requestId));var t={};if(e.pagingMethod&&(t={pagingMethod:e.pagingMethod}),ft.consumeContentSpan(ft.CONTEXT_READER,ft.SPAN_TYPE_TEXT,e.pageRange.currentTopOfPage,e.pageRange.currentBottomOfPage,t),window.KindleGlobal.capabilities.ALLOW_FULL_BOOK){var o={asin:e.book.asin,guid:e.book.guid,kindleSessionId:window.KindleGlobal.startReading.kindleSessionId,lastPageRead:e.position.toString(),localTimeOffset:-(new Date).getTimezoneOffset(),positionType:i.Format[e.position.type].toLowerCase()};n.stillReading(o).then(function(){console.debug("Send last read position: "+e.position)})["catch"](function(t){console.warn("Failed to send position: "+e.position+",reason is: "+t)}).done()}}),e.pagingMethod!==E.NavigationEvent.NAVIGATION_LOADED&&e.pagingMethod!==Ct&&nt.enter()}),at.addLoadingEventListener(function(e){console.debug("Renderer LoadingEvent: "+e.type)}),at.addCapabilityEventListener(function(e){I(e)}),ut.resolve(!0)},function(e){ut.reject(e?e:new s.KcrError("Error creating viewport"))}),yt.promise.done(),ut.promise}function P(){at.shutdown()}function _(){yt.resolve(p.getNow())}function A(){if(a.isFireOS())ct.find(".kp-reader-status-right").hide();else{var e=m.getEndpointRefTag(m.Constants.GET_APP_READER_FOOTER_SUFFIX),t=b.getAppStoreUrlWithRefTag(window.KindleGlobal.appStoreUrl,e);ct.find(".kp-reader-status-right a").attr("href",t).click(function(){u.recordAction(ft.CONTEXT_READER,ft.ACTION_GET_KINDLE_APP_CLICKED)}).attr("target","_blank")}}function I(e){var t=E.Capability[e.type];console.debug("Viewport capability: "+t+" = "+e.availability),O(t)}function O(e){function t(e,t){var o=t.data("capability");if(o){var i=E.Capability[o];if(void 0!==i){var n=!at.capabilities[i];n!==t.hasClass("menu-item-disabled")&&(n?t.addClass("menu-item-disabled"):t.removeClass("menu-item-disabled"))}}}void 0===e&&(e="");var o="[data-capability"+(e?'="'+e+'"':"")+"]";dt.find(o).each(t)}function M(e){dt.find(".kp-reader-status-left").text(w.getLocalizedString(gt,{percent:e}))}function N(e,t){switch(console.debug("toolbar item clicked:",t),window.KindleGlobal.capabilities.AUTO_ENTER_IMMERSIVE_MODE&&nt.cancelAutoEnter(),t){case"goto-location":U();break;case"goto-cover":Z();break;case"goto-toc":j();break;case"goto-beginning":H();break;case"increase-font-size":F();break;case"decrease-font-size":L();break;case"enter-fullscreen":G();break;case"exit-fullscreen":q();break;default:throw new s.KcrError("Unknown data-action: "+t).setErrorCode(s.Codes.ReaderViewInvalidActionInvoked)}}function F(){console.debug("Increase font size clicked"),at.increaseFontSize(),ft.recordSetting(ft.CONTEXT_READER,ft.ACTION_FONT_SIZE_CHANGE,at.getFontSize().toString(10),!0,{changeType:"larger",atLimit:at.atMaxFontSize()})}function L(){console.debug("Decrease font size clicked"),at.decreaseFontSize(),ft.recordSetting(ft.CONTEXT_READER,ft.ACTION_FONT_SIZE_CHANGE,at.getFontSize().toString(10),!0,{changeType:"smaller",atLimit:at.atMinFontSize()})}function D(){st=ct.find(".kp-enter-fullscreen-control"),lt=ct.find(".kp-exit-fullscreen-control"),st.add(lt).on("click",function(){ct.trigger("actionInvoked",$(this).attr("data-action"))}),l.addFullscreenEventListener(z),x()}function x(){st.show(),lt.hide()}function B(){lt.show(),st.hide()}function z(e){console.info("fullscreen changed",e),l.isFullscreenActive()?B():x()}function G(){console.debug("enter fullscreen clicked"),l.requestFullscreen()}function q(){console.debug("exit fullscreen clicked"),l.exitFullscreen()}function U(){console.debug("go to location clicked");var e=parseInt(window.prompt("Location: "),10);at.gotoLocation(e).then(function(e){nt.enter(),console.debug("Goto Location at position: "+e)})["catch"](function(e){console.warn("Failed to go to location: "+e.toString())}).done()}function K(e,t){console.info("Goto calculated position: "+e);var o=at.maxPosition,n=Math.round(e*o.valueOf());if(1>n)return at.gotoCover(t);var r=i.createPosition(ht.format,n);return at.gotoPosition(r,t)}function Z(){console.debug("go to cover clicked"),at.gotoCover().then(function(e){nt.enter(),console.debug("Goto Cover at position: "+e)})["catch"](function(e){console.warn("Failed to go to cover: "+e.toString())}).done()}function j(){console.debug("go to TOC clicked"),at.gotoToc().then(function(e){nt.enter(),console.debug("Goto TOC at position: "+e)})["catch"](function(e){console.warn("Failed to go to TOC: "+e.toString())}).done()}function H(){console.debug("go to beginning clicked"),at.gotoBeginning().then(function(e){nt.enter(),console.debug("Goto Beginning at position: "+e)})["catch"](function(e){console.warn("Failed to go to beginning: "+e.toString())}).done()}function W(e){var t=window.KindleGlobal.capabilities.SINGLE_PAGE_VIEW?!1:!0;return a.isMSBrowser()&&window.KindleGlobal.marketplace===S["default"].CNAmazon.marketplaceCode&&(t=!1),{asin:window.KindleGlobal.asin,useAuthenticated:window.KindleGlobal.capabilities.ALLOW_FULL_BOOK,startReadingResponse:window.KindleGlobal.startReading,twoColumnsEnabled:t,immersiveMode:e}}function V(e,t,o){if(t>=e){var i=t-e,n=ft.ACTION_CONTENT_NOT_RENDERED_IN_TIME,r=p.createMetric(n).appendToReportedName(o);r.mainTimer.setTime(i),p.record(r),ft.performAction(ft.CONTEXT_READER,n,{format:o,renderingDelayInMillis:i.toString()})}}function X(e){ot.isRTL=at.isRTLReadingDirection(),ot.enableSliderEvents(),ot.addSlideEventListener(function(t){t.type===R.SlideEventType.SlideEnd?(rt&&rt.isZoomed()&&rt.clearZoomables(),K(ot.ratio,Ct)):e&&t.type===R.SlideEventType.SlideStart&&nt.cancelAutoEnter()
})}function Y(e){var t;if(e){var o=e.currentTopOfPage.valueOf(),i=e.currentBottomOfPage.valueOf(),n=at.maxPosition.valueOf(),r=i===n?n:(o+i)/2;t=r/n}else t=at.currentPosition.valueOf()/at.maxPosition.valueOf();ot.moveSliderToPercent(t),ot.updateReaderStatusMessage(t)}function J(e){var t=e.flowType===i.FlowType.FIXED?!1:!0;tt&&tt.setDisplayForFeatureStatus(t),et&&et.setDisplayForFeatureStatus(t)}var Q,et,tt,ot,it,nt,rt,at,st,lt,dt,ct,ut,pt,ht,ft=h.getManager(),mt="ReaderView",gt="kp-sample-percentage-text",vt="kp-reader-with-glide",bt="kp-reader-top-spacer",Et="kp-reader-bottom-spacer",yt=o.defer(),wt=o.defer(),St=0,Rt={},kt="inline"===b.getEmbedPreviewMode(),Tt=b.isFromBookCard(),Ct="SliderMoved";!function(){kt&&Tt&&(window.addEventListener("message",function(e){if(e.origin===b.getOrigin())try{var t=JSON.parse(e.data);t.readerShowTime&&wt.resolve(t.readerShowTime)}catch(o){}}),window.parent.postMessage(JSON.stringify({event:"readerLoading"}),b.getOrigin()))}(),t.initialize=C,t.shutdown=P,t.onShow=_}),define("modules/utils/HandlebarsHelpers",["require","exports","modules/utils/Localization","handlebars"],function(e,t,o,i){"use strict";function n(){i.registerHelper("localize",function(e,t){return o.getLocalizedString(e,t.hash)})}t.registerLocalize=n}),define("modules/utils/ConsolePolyfill",["require","exports"],function(e,t){"use strict";function o(){var e=window.console||{},t=function(){};e.log=window.console.log||t,e.debug=window.console.debug||t,e.info=window.console.info||t,e.warn=window.console.warn||t,e.error=window.console.error||t,window.console=e}t.polyfillWindowConsole=o}),define("KindlePlayer",["require","exports","modules/utils/ErrorHandler","modules/metrics/UploadManager","q","modules/ui/views/ReaderView","modules/utils/HandlebarsHelpers","modules/utils/ConsolePolyfill"],function(e,t,o,i,n,r,a,s){"use strict";var l=n.defer();s.polyfillWindowConsole(),requirejs.onError=function(e){console.error(e)};var d={capabilities:{},initPlayer:function(e){this.capabilities=e,a.registerLocalize(),l.resolve(!0)},initView:function(e){var t=this;console.info("initView("+e+")"),l.promise.done(function(){var n={allowFullScreen:t.capabilities.ALLOW_FULL_SCREEN};r.initialize($(e),n).fail(o.handleError).done(),i.init()})},onShow:function(){r.onShow()}};return d}),define("modules/weblabs/Weblabs",["require","exports","modules/utils/Service","modules/utils/StringUtils","modules/utils/QueryParamUtils"],function(e,t,o,i,n){"use strict";function r(e){return window.KindleGlobal.weblabs?window.KindleGlobal.weblabs[e]:null}function a(e){var t=r(e);return t&&s(e),t}function s(e){if(!(d.indexOf(e)>=0)){d.push(e);var t=n.appendQueryParams(i.format(l,{id:e}),"requestId="+window.KindleGlobal.requestInfo.requestId);return console.info(i.format("Triggering weblab treatment ${id}:${treatment}: ${url}",{id:e,url:t,treatment:r(e)})),o.qAjax({url:t,type:"POST"})}}t.Treatments={C:"C",T1:"T1",T2:"T2",T3:"T3"},t.Experiments={RIK_BUTTON_TEXT:"KP_64353",QUOTE_SHARE_LANDING_PAGE:"KP_65412"};var l="https://"+location.hostname+"/kp/weblab/trigger/${id}"+location.search,d=[];t.getTreatment=r,t.getTreatmentAndTrigger=a,t.trigger=s}),requirejs.config({waitSeconds:0,paths:{jquery:"jquery",jquery_transit:"jquery.transit.min",q:"q",handlebars:"handlebars.runtime-v1.3.0",kindleRendererFactory:"KindleRendererLib",reader_templates:"Reader.hbs",hammer:"hammer"},shim:{jquery:"$",jquery_transit:{deps:["jquery"],exports:"jquery_transit"},handlebars:{exports:"Handlebars"},reader_templates:{deps:["handlebars"],exports:"Handlebars.templates.SearchInput"},kindleRendererFactory:{deps:["jquery"],exports:"KindleRendererFactory"}}}),require(["KindlePlayer","jquery","jquery_transit","q","handlebars","reader_templates","modules/weblabs/Weblabs","modules/utils/Localization"],function(e){e.initPlayer(window.KindleGlobal.capabilities)}),define("KindlePlayerLoader",function(){});