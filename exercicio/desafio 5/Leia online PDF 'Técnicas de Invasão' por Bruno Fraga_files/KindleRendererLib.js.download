/* Copyright (c) 2021 Amazon.com, Inc. or its affiliates. All Rights Reserved. */
function KindleRendererFactory() {


var KindleDebug=function(){return{error:function(){},warn:function(){},log:function(){},debug:function(){},breakPt:function(){}}}();
var KindleHostDeviceDetector=function(){function a(){return-1!==navigator.platform.indexOf("iPad")}function b(){return a()&&KindleHostPadDetector.isPad1(C())}function c(){return-1!==navigator.platform.indexOf("iPhone")||-1!==navigator.platform.indexOf("iPod")}function d(){return a()||c()||l()}function e(){var a=-1;if(d()){a=navigator.userAgent.match(/OS (\d+)_/)[1]}return a}function f(){var a=-1;if(d()){a=navigator.userAgent.match(/OS (\d+)_(\d+_?(\d+)?)/)[2]}return a}function g(){return(a()||c())&&-1!==navigator.userAgent.indexOf("OS 4")}function h(){return(a()||c())&&parseInt(e(),10)>=5}function i(){return(a()||c())&&7===parseInt(e(),10)}function j(){return-1!==navigator.userAgent.indexOf("Firefox")&&navigator.userAgent.indexOf("Trident")<0}function k(a){var b=navigator.userAgent.match(/Version\/(\d+\.\d+)(?:\.\d+)*(?: Mobile\/\S+)? Safari/);return!!b&&(!a||Number(b[1])>=Number(a))}function l(){return-1!==navigator.userAgent.indexOf("Cloud9")}function m(){return-1!==navigator.userAgent.indexOf("(Macintosh;")}function n(){return-1!==navigator.userAgent.indexOf("MSAppHost")}function o(){return n()&&p()}function p(){return!!/arm/i.test(navigator.cpuClass)}function q(){return n()&&320===window.outerWidth}function r(){return!!window.openDatabase}function s(){return!!window.mozIndexedDB||!!window.indexedDB}function t(){return window.chrome}function u(){if(!j())return!1;var a=/Firefox\/(\d+)/.exec(navigator.userAgent);return a.length>=1&&a[1]>=17}function v(){return j()?navigator.onLine:KindleModuleManager.getModuleSync(KindleModuleManager.NETWORK).isOnline()}function w(){if(!v())return(new jQuery.Deferred).reject().promise();var a=$.Deferred();return $.ajax({url:"/ping",error:function(){a.reject()},timeout:5e3}).then(a.resolve,a.reject),a.promise()}function x(){if(!v())return!1;var a=!0;return $.ajax({url:"/ping",error:function(){a=!1},timeout:50,async:!1}),a}function y(){return-1!==navigator.userAgent.indexOf("MSIE")||-1!==navigator.userAgent.indexOf("Trident")}function z(){return y()&&-1!==navigator.userAgent.indexOf("Trident/6.0")}function A(){return y()&&-1!==navigator.userAgent.indexOf("Trident/7.0")}function B(){return C()||D()}function C(){return"standalone"in navigator&&navigator.standalone}function D(){return window.chrome&&Kindle.top.chrome.app&&Kindle.top.chrome.app.isInstalled}function E(){return!!KindleHostDeviceDetector.isFirefox()&&window.navigator.mozApps}function F(){return a()?"iPad":c()?"iPhone":l()?"otter":o()?"metroArm":n()?"metro":"desktop"}function G(){return b()||o()}function H(){return n()?Kindle.DeviceType.Metro:Kindle.DeviceType.KCR}function I(){return n()?Kindle.ClientName.Metro:Kindle.ClientName.KCR}function J(){return navigator.cookieEnabled}function K(){return window.navigator.msMaxTouchPoints>=1}function L(){return"undefined"!=typeof Worker}function M(){return d()||K()}function N(){var a="testLocalStorage";if(!window.localStorage)return!1;try{window.localStorage.setItem(a,"1"),window.localStorage.removeItem(a)}catch(b){return!1}return!0}function O(){return!d()||parseInt(KindleHostDeviceDetector.getOSMajorVersion(),10)>=6}function P(){return a()||n()}function Q(){return navigator.language||navigator.userLanguage}return{isiOS:d,isiPad:a,isiPhone:c,isiOS_4x:g,isiOS_5xOrGreater:h,isiOS_7x:i,isMacintosh:m,isFirefox:j,hasHangingDbPrompt:u,isSafari:k,isMetro:n,isMetroArm:o,isMetroSnappedView:q,isIE:y,isIE10:z,isIE11:A,isArm:p,isCloud9:l,isTablet:P,isOnline:v,isNetworkAvailable:w,isNetworkAvailableSync:x,isChrome:t,isiOSAppMode:C,isChromeApp:D,isFirefoxAppSupported:E,isInAppMode:B,isCookieEnabled:J,areWebWorkersSupported:L,isLocalStorageEnabled:N,hasArrayLikeApply:O,isWebSQLSupported:r,isIndexedDBSupported:s,isMSTouchEnabledDevice:K,isTouchDevice:M,getDevicePlatform:F,hasCanvasPerformanceProblem:G,getDeviceType:H,getClientName:I,getOSMajorVersion:e,getOSMinorVersion:f,getBrowserLanguage:Q}}();
var KindleHostPadDetector=function(){function a(a){if(window.localStorage.getItem(b))return!1;var c,d,e=0,f=1e3,g=0,h=100,j=200,k=3;for(i=0;i<k;i++)d=SunSpiderBenchmark.get3DSpeed(),d>e?e=d:d<f&&(f=d),g+=d;return!!((c=g/k)>=j&&a)||(c>=h&&!a||(window.localStorage.setItem(b,"true"),!1))}var b="definitelyNotPad1";return{isPad1:a}}();
var KindleMetricsProfiler=function(a){function b(){return(new Date).getTime()}function c(a){for(var b=0,c=0;c<a.length;c+=1)b+=a[c].end-a[c].start;return b}var d={};return d.name=a,d.counters=null,d.subTimers=null,d.runs=[{start:b(),end:null}],d.endTimer=function(){var a=this.runs[this.runs.length-1];null===a.end&&(a.end=b())},d.addCount=function(a,b){null===this.counters&&(this.counters={}),void 0===this.counters[a]?this.counters[a]=b:this.counters[a]+=b},d.createSubTimer=function(a){return null===this.subTimers&&(this.subTimers={}),void 0===this.subTimers[a]?this.subTimers[a]=KindleMetricsProfiler(a):this.subTimers[a].runs.push({start:b(),end:null}),this.subTimers[a]},d.log=function(){var a=c(this.runs);this.logAsPercentageOfTime("",a)},d.logAsPercentageOfTime=function(a,b){var d,e=a+":"+this.name,f=c(this.runs),g=b?f/b*100:100;KindleDebug.debug(e+":Time: "+f+"ms - ("+g.toFixed(2)+"%)");for(d in this.counters)KindleDebug.debug(e+":"+d+" : "+this.counters[d]);for(d in this.subTimers)this.subTimers[d].logAsPercentageOfTime(e,b)},d};
/*
 * Copyright (c) 2014 Amazon.com, Inc. All rights reserved.
 *
 * KReW Version 2.9.7
 */
var KindleRendererAnnotationRenderer=function(){function f(){var c={};return function(b,g){if(c[b]!==void 0)return c[b];var a=g[b];if(!a)return c[b]=!1;if(a.tagName==="IMG")return c[b]=!0;for(;a.tagName!=="BODY";){var d=$(a);if(d){var e=d.css("background-color"),d=d.css("background-image");if(e&&e!=="rgba(0, 0, 0, 0)"&&e!=="transparent"||d&&d!=="none")return c[b]=!0;a=a.parentNode}}return c[b]=!1}}function m(c){var b={};$(c).find("[data-nid]").each(function(g,a){b[a.getAttribute("data-nid")]=a});
        return b}function k(c,b){b!==void 0&&(b.clickable!==void 0&&c.setAttribute(e,b.clickable),b.feedbackAnimation!==void 0&&c.setAttribute(d,b.feedbackAnimation))}var e="data-annotationClickable",d="data-annotationClickFeedback";return{DRAW_AFTER:"after",DRAW_OVER:"over",ANNOTATION_CLICK_ATTRIBUTE:e,ANNOTATION_CLICK_FEEDBACK_ATTRIBUTE:d,createAnnotationElements:function(c,b,g,a,d){var e=[];if(a!==null)for(var j=KindleRendererSettings.getSettings().annotationStyles,n=KindleRendererSettings.getSettings().annotationClick,
                                                                                                                                                                                                                                                                                                                                                                                                                                 p,o=p=null,q=null,s=m(c.contentDocument),r=f(),x=0;x<a.length;x+=1)if(o=a[x],p=o.type,j[p]){var q=n?n[p]:void 0,w=j[o.type].className;if(o.additionalStyles)for(var y in o.additionalStyles)w+=" "+o.additionalStyles[y];if(j[p].drawingType==="over"){var t=c;p=d;var z=b,D=o,v=w,o=s,A=r,u=t.contentDocument.createElement("DIV");u.setAttribute("annotationType",D.type);u.setAttribute("annotationStart",D.start);k(u,q);for(var z=KindleRendererWordRectsHelper.createWordBoundaries(D,z,t.contentDocument,t.contentWindow,
        t.writingMode),q=t,w=u,t=z,z=q.contentDocument,D=z.createElement("DIV"),H=!1,M=!1,E={isNewDiv:!0,isImageBound:!1,lineBounds:{top:0,height:0,left:0,right:0,width:0}},C=!1,I=!0,F=t.length,G=0;G<F;G+=1){var B=t[G].dataNid;H||typeof B==="string"&&A(B,o)&&(H=!0);!B&&!H&&t[G].tagName==="IMG"&&(H=!0);var I=t[G].rect,K=void 0,J=o[B],B=void 0,O=!1;if(G<F-1)K=t[G+1].rect,B=o[t[G+1].dataNid],M=A(t[G+1].dataNid,o);J&&B&&(O=J.tagName==="IMG"||H,C=J.tagName==="IMG",J=!1,J=B!==void 0?B.tagName==="IMG":!1,C=C!==
        J||M!==H);if(I=q.writingMode.updateDivIfNewLineOrImageBound(E,I,K,O,C,$(z).width()))I=D,K=E.lineBounds,B=v,I.style.top=K.top+"px",I.style.height=K.height+"px",I.style.left=K.left+"px",I.style.width=K.width+"px",I.className=H?B+" semiTransparentOverlay":B,w.appendChild(D),D=z.createElement("DIV"),H=!1}p.appendChild(u);p=u}else if(j[p].drawingType==="after"){p=c;u=d;t=b;v=g;z=q;A=o.start;D=-1;q=void 0;for(v.addBoundsForPosition(p.contentDocument,t,A,p.writingMode);t[A]===void 0&&D<100;)A=o.start+D,
            v.addBoundsForPosition(p.contentDocument,t,A,p.writingMode),D+=1;if(t[A]!==void 0)q=p.contentDocument.createElement("DIV"),q.setAttribute("annotationType",o.type),q.setAttribute("annotationStart",o.start),k(q,z),v=q,t=t[A].rects[t[A].rects.length-1],o=p.contentDocument,A=o.createElement("DIV"),p.writingMode.positionDivAfterWord(A,t,"px",$(o).width()),A.className="note-annotation "+w,v.appendChild(A),u.appendChild(q);p=q}else p=null;p&&e.push(p)}return e},removeAnnotationElements:function(c,b){$(c).children('[annotationtype="'+
        b.type+'"][annotationstart="'+b.start+'"]').remove()}}}(),KindleRenderer=function(){function f(a,b,g){a={status:a};if(b!==void 0)a.errorCode=b;if(g!==void 0)a.errorMsg=g;E!==void 0&&E(a)}function m(a,b){f(o,a,b?b:"no msg")}function k(){M=H=!1;f(s)}function e(){C!==null&&(C.endTimer(),C.log(),C=null);H=!0;f(r)}function d(){M=!1}function c(){M=!0;f(x)}function b(a){M=!1;m(z,a)}function g(a){H=!1;m(t,a)}function a(a){a=parseInt(a,10);isNaN(a)&&(a=0);return KindleRendererContentDisplay.gotoPosition(a,
    !0)}function l(){return setTimeout(function(){u||(A=!0,m(w,"Init timed out"))},v)}function h(a){clearTimeout(a);return l()}function j(r,o,x,j){C===null&&(C=KindleMetricsProfiler("Renderer-Load"));E=x.statusCallback;x.contentInterfaceCallbacks&&KindleRendererContentScripts.setCallbacks(x.contentInterfaceCallbacks);A=!1;if(r)if(r.bookInfo&&r.containerId)if(I=$(document.getElementById(r.containerId)),I.length===0)m(y,"Container not found");else{f(q);KindleRendererDeviceSpecific.initialize();v=KindleRendererDeviceSpecific.rendererInitializationTimeout();
        var n=l();KindleRendererFragmentLoader.initialize(r.bookInfo).then(function(){A||(n=h(n),KindleRendererSettings.initialize(r.bookInfo).then(function(){if(!A){n=h(n);KindleRendererPositionLoadingCalculator.updateScreenDimensions(I.width(),I.height());var l={waitNotification:k,readyNotification:e,rectsWaitNofification:d,rectsReadyNotification:c,rectsErrorNotification:b,errorNotification:g,annotationTriggered:x.annotationEventCallback};r.startingPositionDfd.done(function(b){A||(n=h(n),KindleRendererContentDisplay.initialize(I.get(0),
        l,r.bookInfo,j,b).then(function(){A||(KindleRendererSettings.updateSettings(o),KindleGlyphRenderer.updateSettings(o),KindleRendererContentDisplay.updateSettings(o),u=!0,a(b))},function(a){A||m(w,"Load Failure: "+a)}))})}},function(){A||m(w,"Load Failure: Metadata")}))},function(a){A||m(w,"Load Failure: "+a)})}else throw{name:"initializationError",message:"required parameters not present"};}function n(){if(!u)throw{name:"initializationError",message:"Please call KindleRenderer.initialize function first"};
    }var p=0,o=p++,q=p++,s=p++,r=p++,x=p++,w=p++,y=p++,t=p++,z=p++,D=p++,p=p++,v=12E4,A=!1,u=!1,H=!1,M=!1,E=void 0,C=null,I=null;return{STATUS_ERROR:o,STATUS_LOADING:q,STATUS_PAGINATING:s,STATUS_PAGINATED:r,STATUS_DONE:x,ERROR_LOAD_FAILURE:w,ERROR_CONTAINER_NOT_FOUND:y,ERROR_UNABLE_TO_GET_BOOK_CONTENT:t,ERROR_UNABLE_TO_GET_WORD_RECTS:z,ERROR_TIMEOUT_WHILE_LOADING_BOOK_CONTENT:D,ERROR_UNKNOWN:p,PAGE_LOAD_INCOMPLETE_FLAG_NAME:"PageLoadIncomplete",initialize:function(a,b,g,c){try{j(a,b,g,c)}catch(d){}},
        shutdown:function(){try{u&&(u=!1,KindleRendererContentDisplay.cleanup(),KindleGlyphRenderer.cleanup(),KindleRendererCanvasInsertion.cleanup())}catch(a){}},getMinimumPosition:function(){n();return KindleRendererFragmentLoader.getMinimumPosition()},getMaximumPosition:function(){n();return KindleRendererFragmentLoader.getMaximumPosition()},createWordIterator:function(){n();try{return KindleRendererWordIteratorFactory.build()}catch(a){}return null},updateSettings:function(a){try{KindleRendererSettings.updateSettings(a),
            KindleGlyphRenderer.updateSettings(a),KindleRendererContentDisplay.updateSettings(a)}catch(b){return!1}},gotoPosition:function(b){n();try{return a(b)}catch(g){}return!1},nextScreen:function(){n();try{if(H)return KindleRendererContentDisplay.nextScreen()}catch(a){}return!1},previousScreen:function(){n();try{if(H)return KindleRendererContentDisplay.previousScreen()}catch(a){}return!1},hasNextScreen:function(){n();try{if(H)return KindleRendererContentDisplay.hasNextScreen()}catch(a){}return!1},hasPreviousScreen:function(){n();
            try{if(H)return KindleRendererContentDisplay.hasPreviousScreen()}catch(a){}return!1},getPagePositionRange:function(){n();try{if(H)return KindleRendererContentDisplay.getPagePositionRange()}catch(a){}return null},getPageSelectableItemBoundaries:function(){n();try{if(M)return KindleRendererContentDisplay.getSelectableItemBoundaries()}catch(a){}return null},getPageWordPositions:function(){n();try{if(M)return KindleRendererContentDisplay.getWordPositions()}catch(a){}return null},onWindowResize:function(){if(u)try{KindleRendererPositionLoadingCalculator.updateScreenDimensions(I.width(),
        I.height()),KindleRendererContentDisplay.onWindowResize()}catch(a){}},handleClick:function(a,b){try{if(H)return KindleRendererContentDisplay.handleClick(a,b)}catch(g){}return null},reloadAnnotations:function(){try{H&&KindleRendererContentDisplay.reloadAnnotations()}catch(a){}},getContentRects:function(){n();try{if(H)return KindleRendererContentDisplay.getContentRects()}catch(a){}return null},getZoomableAt:function(a,b){n();try{if(H)return KindleRendererContentDisplay.getZoomableAt(a,b)}catch(g){}return null},
        getZoomableList:function(){n();try{if(H)return KindleRendererContentDisplay.getZoomableList()}catch(a){}return null},clearSelection:function(){if(u)try{H&&KindleRendererContentDisplay.clearSelection()}catch(a){}},getSelection:function(){n();try{if(H)return KindleRendererContentDisplay.getSelection()}catch(a){}},isRTLReadingDirection:function(){try{return KindleRendererSettings.isRTLReadingDirection()}catch(a){return!1}}}}(),KindleRendererWordIteratorFactory=function(){function f(b,a,c,d){for(var e=
        !0;e;){e=b.getItem();if(e.pos>a){d.resolve(c);return}c+=e.text;e=b.next()}b.getLoadingDfd().then(function(e){e?f(b,a,c,d):d.resolve(c)},d.reject)}function m(g){g.cancelCurrentRequest=function(){if(this.currentRequest)this.currentRequest=null};g.newRequest=function(a,b,g){this.cancelCurrentRequest();this.currentRequest={requestId:KindleRendererRequestId.getUniqueRequestId(),metrics:KindleMetricsProfiler("word-iterator-load"),position:a,stopPosition:b,direction:g}};g.newRequestDfd=function(){this.currentRequestDfd=
        new jQuery.Deferred;this.currentRequestReachedTerminal=!1};g.fragmentLoadedCallback=function(a){var b=this;b.loadedRange=a.contentRange;b.wordMapGenerator.createWordMap(a.fragmentRoot,a.positionData).then(function(a){b.createPositionInfo(a)},function(){b.currentRequestDfd.reject()})};g.calculateContinuePosition=function(a){return a===c?this.loadedRange.startPosition-1:this.loadedRange.endPosition+1};g.hasReachedStopPosition=function(a){if(this.currentRequest&&this.currentRequest.stopPosition!==void 0){var b=
        this.currentRequest.direction,g=this.currentRequest.stopPosition,a=a?this.positions[this.currPositionIndex]:this.calculateContinuePosition(b);return b===c&&a<g||a>g}return!1};g.createPositionInfo=function(a){this.wordMap=a;a=this.currentRequest.direction;this.positions=[];for(var g in this.wordMap)this.positions.push(parseInt(g,10));this.positions.sort(function(a,b){return a-b});g=this.findPosition(this.currentRequest.position,a);this.hasReachedStopPosition(g)?this.currentRequestDfd.reject():g?(this.currentRequest=
        null,this.currentRequestDfd.resolve(!this.currentRequestReachedTerminal)):a===c&&this.startPositionIsLoaded()||this.endPositionIsLoaded()?this.currentRequestReachedTerminal?this.currentRequestDfd.reject():(this.currentRequestReachedTerminal=a!==d,a=a===c?b:c,this.beginLoad(this.calculateContinuePosition(a),this.currentRequest.stopPosition,a)):this.beginLoad(this.calculateContinuePosition(a),this.currentRequest.stopPosition,a)};g.findPosition=function(a,b){this.currPositionIndex=KindleListUtilities.binarySearch(this.positions,
    a);return b===c?a>=this.positions[0]:(this.positions[this.currPositionIndex]<a&&++this.currPositionIndex,this.currPositionIndex<this.positions.length)};g.beginLoad=function(a,b,g){var d=this;d.newRequest(a,b,g);a=KindleRendererFragmentLoader.getFragmentIdForPosition(a,g===c);KindleRendererFragmentLoader.getFragmentAtId(a,d.currentRequest).then(function(a,b){d.currentRequest&&d.currentRequest.requestId===a.requestId&&d.fragmentLoadedCallback(b)},function(){d.currentRequestDfd.reject()})};g.gotoPosition=
        function(a,b){this.newRequestDfd();if(this.currentRequest===null&&this.loadedRange!==null&&a>=this.loadedRange.startPosition&&a<this.loadedRange.endPosition&&this.findPosition(a,d))return this.currentRequestDfd.resolve(!0),this.currentRequestDfd.promise();this.beginLoad(a,b,d);return this.currentRequestDfd.promise()};g.getItem=function(){if(this.currentRequest===null){var a=this.positions[this.currPositionIndex];return{pos:a,text:this.wordMap[a].text}}return null};g.previous=function(a){if(this.currPositionIndex===
    null||this.currentRequest!==null)return!1;this.currPositionIndex--;return this.currPositionIndex<0?(this.startPositionIsLoaded()?(this.currPositionIndex=0,this.newRequestDfd(),this.currentRequestDfd.resolve(!1)):(this.newRequestDfd(),this.beginLoad(this.loadedRange.startPosition-1,a,c)),!1):!0};g.next=function(a){if(this.currPositionIndex===null||this.currentRequest!==null)return!1;this.currPositionIndex++;return this.currPositionIndex>=this.positions.length?(this.endPositionIsLoaded()?(this.currPositionIndex=
    this.positions.length-1,this.newRequestDfd(),this.currentRequestDfd.resolve(!1)):(this.newRequestDfd(),this.beginLoad(this.loadedRange.endPosition+1,a,b)),!1):!0};g.getLoadingDfd=function(){return this.currentRequestDfd.promise()};g.startPositionIsLoaded=function(){return this.loadedRange.startPosition<=KindleRendererFragmentLoader.getMinimumPosition()};g.endPositionIsLoaded=function(){return this.loadedRange.endPosition>=KindleRendererFragmentLoader.getMaximumPosition()}}function k(b,a){b.getItem=
        function(){return a.getItem()};b.previous=function(b){return a.previous(b)};b.next=function(b){return a.next(b)};b.getLoadingDfd=function(){return a.getLoadingDfd()};b.gotoPosition=function(b,g){var c=Math.max(b,KindleRendererFragmentLoader.getMinimumPosition()),c=Math.min(c,KindleRendererFragmentLoader.getMaximumPosition());return a.gotoPosition(c,g)};b.getText=function(a,b){var g=this,c=new jQuery.Deferred;g.gotoPosition(a).then(function(){f(g,b,"",c)},c.reject);return c.promise()};b.clear=function(){e(a)}}
        function e(b){b.currentRequest=null;b.currentRequestDfd=null;b.currentRequestReachedTerminal=null;b.loadedRange=null;b.wordMap=null;b.positions=null;b.currPositionIndex=null}var d="goto",c="prev",b="next";return{build:function(){var b={};b.wordMapGenerator=KindleRendererWordMapGeneratorFactory.buildWordMapGeneratorForWordText();e(b);m(b);var a={};k(a,b);return a}}}(),KindleRendererCanvasInsertion=function(){function f(b,c){for(var a=b;a<c.length;a++){c[a].innerHTML="";c[a].width=0;for(var d=c[a].attributes.length;--d>=
    0;)c[a].removeAttribute(c[a].attributes[d].nodeName)}}function m(b,g,a,d){var h=g.getElementsByTagName("html")[0],j=g.getElementsByTagName("body")[0],n=Array.prototype.slice.call(j.getElementsByClassName("k4wc"));if(n.length>0){h.removeChild(j);var p=n.length,o=KindleRendererDeviceSpecific.maximumCanvases();e[b]=0;var q=null;k[b]||(k[b]=[]);var s=function(a){a=n[a];if(e[b]>=o)if(a.parentNode.removeChild(a),a=parseInt(a.id,10),d){if(q===null||a>q)q=a}else{if(q===null||a<q)q=a}else{var h=c(b,g);h.id=
        a.id;h.setAttribute("height",a.getAttribute("height"));h.setAttribute("width",a.getAttribute("width"));h.setAttribute("data-nid",h.id);h.innerHTML=a.innerHTML;a.parentNode.replaceChild(h,a)}},r;if(d)for(r=p-1;r>=0;r--)s(r);else for(r=0;r<p;r++)s(r);if(q!==null){p=KindleMetricsProfiler("remove-extra-canvases");if(d){if($(j).find("*").filter(function(){return parseInt(this.getAttribute("id"),10)<q}).remove(),a.startPosition<=q)a.startPosition=q+1}else if($(j).find("*").filter(function(){return parseInt(this.getAttribute("id"),
    10)>q}).remove(),a.endPosition>=q)a.endPosition=q-1;p.endTimer();p.log()}f(e[b],k[b]);h.appendChild(j)}}var k=[],e=[],d=0,c=function(){return(window.ActiveXObject||"ActiveXObject"in window)&&window.XMLHttpRequest?function(b,c){return c.createElement("CANVAS")}:function(b,c){e[b]++;var a=e[b],l=k[b],h=null;a>l.length?(h=c.createElement("CANVAS"),d+=1,l[a-1]=h):h=l[a-1];return h}}();return{changeSpanToCanvas:function(b,c,a,d){m(b,c,a,d)},cleanup:function(){for(var b in k)for(var c=k[b],a=c.length,d=
            0;d<a;d+=1){var e=c[d],j=e.parentNode;j!==null&&j!==void 0&&j.removeChild(e)}k=null}}}(),KindleGlyphRenderer=function(){function f(a,b,c,g,d,e,l,h){b=b[g.imgSrc];if(c.getContext&&b!==void 0){var o=new Image,j=g.o;j||(j=[0,0]);o.onload=function(){if(a===p){var b=j,g=c,o=g.getContext("2d"),x=b[0]*d/1440,b=b[1]*d/1440,n={x:x,y:b,w:this.width*e,h:this.height*e};l[g.id]||(l[g.id]=[]);g=l[g.id];g[g.length]=n;o.translate(x,b);o.scale(e,e);o.drawImage(this,0,0);o.scale(1/e,1/e);o.translate(-x,-b);c=null}setTimeout(h,
    25)};o.src=b;g=b=b=null}else setTimeout(h,10)}function m(a,b,c,g){if(b.getContext){var d=c.o;d||(d=[0,0]);var e=b.getContext("2d");e.translate(d[0]*g/1440,d[1]*g/1440);e.fillStyle=k(b);for(var l,h,o,j,n,f=c.l.length,p=0;p<f;p++){a:{l=c.l[p][0];o=void 0;for(n=0;n<a.length;n+=1)if(o=a[n].glyphFragmentMetadata,l>=o.startingGlyph&&l<=o.endingGlyph){o=l-o.startingGlyph;l=a[n].glyphData[o];break a}l=null}if(l!==null){o=c.l[p][1]+c.p[0];j=c.l[p][2]+c.p[1];n=g/l.dpi;o=(o-c.p[0])*g/1440;j=(j-c.p[1])*g/1440;
        e.translate(o,j);e.scale(n,n);e.beginPath();for(var q=l.c.length,m=0;m<q;m++){var F=l.c[m];e.moveTo(F[0],F[1]);h=F.length-6;for(var G=2;G<h;G+=6)e.bezierCurveTo(F[G],F[G+1],F[G+2],F[G+3],F[G+4],F[G+5]);h=F.length;e.bezierCurveTo(F[h-4],F[h-3],F[h-2],F[h-1],F[0],F[1])}e.closePath();e.fill();e.scale(1/n,1/n);e.translate(-o,-j)}}e.translate(-(d[0]*g/1440),-(d[1]*g/1440));if(b.parentNode.tagName==="A")e.strokeStyle=k(b),e.lineWidth=s.lineWidth,e.beginPath(),e.moveTo(0,b.height-1),e.lineTo(b.width,b.height-
    1),e.stroke(),e.closePath()}}function k(a){a=a.parentNode;return a.tagName==="A"?s.linkColor:(a=a.getAttribute("class"))&&a.indexOf("fixedOverlap")>=0?n:s.textColor}function e(a){for(var a=a.getElementsByTagName("CANVAS"),b={},c=0;c<a.length;c+=1)b[a[c].id]=a[c];return b}function d(a,b,c,g,d,e){for(var l={},h=0;h<a.length;h+=1){var o=b[a[h].id];if(o)for(var j=0;j<o.length;j++){var n=d[o[j].id];if(n){var f=g,p=n.parentNode.getAttribute("class");if(p&&p.indexOf("fixed")>=0){var f=c,p=n,s=e;if(s[p.id])f=
        s[p.id];else{var q=p.getAttribute("height"),k=p.getAttribute("width"),m=0,B=0,K=1;if(q&&!(q<=0||!k||k<=0))q>f.height&&(m=f.height/q),k>f.width&&(B=f.width/k),m>0&&B>0?K=m<B?m:B:m>0?K=m:B>0&&(K=B),s[p.id]=K;f=K}}if(f!==1&&!l[n.id])l[n.id]=1,n.width=Math.round(f*n.width),n.height=Math.round(f*n.height)}}}}function c(a,b,g,d,e,l,h,j,n,s,q){function k(){a===p?c(a,b,g+1,d,e,l,h,j,n,s,q):setTimeout(q,10)}for(var m=d.length;b<m;){var C=e[d[b].id];if(C)for(var I=C.length;g<I;){var F=C[g];if(F.imgSrc!==void 0){var G=
        j[F.id];if(G){m=n[G.id];m=m!==void 0?m:l;f(a,h,G,F,m*o,m,s,k);return}}g+=1}b+=1;g=0}setTimeout(q,10)}function b(a,b,g,d,e,l,h,o,j){c(a,0,0,b,g,d,e,l,h,o,j)}function g(a,b,c,d,e,l,h,j,n,f,s){function q(){a===p?g(a,b,c+1,d,e,l,h,j,n,f,s):setTimeout(s,f.time)}var k=0,C=d.length;for(KindleRendererProcessTuning.startingOperation("GlyphRenderering");b<C;){var I=e[d[b].id];if(I)for(var F=I.length;c<F;){var G=I[c];if(G.l!==void 0&&G.l.length>0){var B=j[G.id];if(B){var K=n[B.id];m(h,B,G,(K!==void 0?K:l)*o);
        k+=1;if(k>=f.frequency){KindleRendererProcessTuning.endingOperation("GlyphRenderering",k);setTimeout(q,f.time);return}}}c+=1}b+=1;c=0}KindleRendererProcessTuning.endingOperation("GlyphRenderering",k);setTimeout(s,f.time)}function a(a,b,c,d,e,l,h,o,j){g(a,0,0,b,c,d,e,l,h,o,j)}function l(c,g,l,h,o,j){var n={height:$(c).parent().height()*0.85,width:$(c).parent().width()*0.85},f=e(c.contentDocument),k=[],u=c.contentDocument.getElementsByTagName("html")[0],m=c.contentDocument.getElementsByTagName("body")[0],
    m=u.removeChild(m),M=$(m).find("p"),E={},C=o.createSubTimer("resizing-canvases");d(M,l.paraData,n,s.glyphScale,f,E);C.endTimer();C=o.createSubTimer("rendering-all-images");b(g.requestId,M,l.paraData,s.glyphScale,l.imageData,f,E,k,function(){C.endTimer();if(!(p!==g.requestId||c.processingRequestId.id!==g.requestId)){C=o.createSubTimer("rendering-all-glyphs");var b={frequency:KindleRendererProcessTuning.drawYieldFrequency("GlyphRenderering"),time:KindleRendererProcessTuning.drawYieldUpdateTime("GlyphRenderering")};
        a(g.requestId,M,l.paraData,s.glyphScale,h,f,E,b,function(){C.endTimer();p!==g.requestId||c.processingRequestId.id!==g.requestId||(u.appendChild(m),q[c.id]=k,f=E=null,setTimeout(j,b.time))})}})}function h(a,b,c,g){var d=new jQuery.Deferred;if(p===null||b.requestId>=p){p=b.requestId;var e=b.metrics.createSubTimer("glyph-rendering");l(a,b,c,g,e,function(){p===b.requestId&&a.processingRequestId.id===b.requestId&&(p=null,e.endTimer(),d.resolve())})}return d.promise()}function j(a){var b={r:parseInt(s.textColor.substring(1,
        3),16),g:parseInt(s.textColor.substring(3,5),16),b:parseInt(s.textColor.substring(5,7),16)},c=q[a.id];$(a.contentDocument).find("canvas").each(function(){var a=this.parentNode;if(a.tagName!=="A"&&(a=a.getAttribute("class"),!a||a.indexOf("fixedOverlap")<0)){a=this.getContext("2d");try{var g=a.getImageData(0,0,this.width,this.height),d=this.width*this.height*4,e=c[this.id];if(e){for(var l=this.width,h=0,o=e.length,r=[];h<o;h+=1)for(var j=Math.floor(e[h].x),n=Math.floor(e[h].y),f=Math.ceil(e[h].w),p=
        Math.ceil(e[h].h),s=0;s<p;s+=1)for(var q=(l*(n+s)+j)*4,k=q+f*4;q<=k;q+=4)r[q]=1;for(var m=g.data,J=b.r,O=b.g,L=b.b,e=0;e<d;e+=4)m[e+3]>0&&!r[e]&&(m[e]=J,m[e+1]=O,m[e+2]=L)}else{r=g.data;h=b.r;s=b.g;q=b.b;for(m=0;m<d;m+=4)r[m+3]>0&&(r[m]=h,r[m+1]=s,r[m+2]=q)}a.putImageData(g,0,0)}catch(N){}}})}var n="#000000",p=null,o=100,q=[],s={glyphScale:1,textColor:n,linkColor:"#0000ff",lineWidth:1};return{renderAllContent:function(a,b,c,g){return h(a,b,c,g)},updateTextColor:function(a){j(a)},updateSettings:function(a){if(a.glyphScale!==
        void 0&&(s.glyphScale=a.glyphScale,s.glyphScale<0.75||s.glyphScale>3))s.glyphScale=Math.max(0.75,Math.min(3,s.glyphScale));if(a.fontColor!==void 0)s.textColor=a.fontColor},clearIframeData:function(a){q[a.id]=void 0},cleanup:function(){q=null}}}(),KindleRendererContentFragmentation=function(){function f(a){a=$.extend(!0,{},a);if(!isFinite(a.startPosition)||!isFinite(a.endPosition))a.startPosition=0,a.endPosition=1E4;if(a.startPosition<0)a.startPosition=0;if(a.endPosition<0)a.endPosition=1E4;return a}
        function m(a){return!a||!a.requestData||a.requestData.cancelled===!0}function k(a,b){for(var c=Math.max(j[0].cPos,b.startPosition),g=Math.min(j[j.length-1].ePos,b.endPosition),d=[],e=Infinity,l=-Infinity,h=0;h<j.length;h+=1)if(j[h].sId===a){var o=h===0?j[h].cPos:Math.min(j[h].cPos,j[h-1].ePos+1),n=j[h].ePos;if(!(n<c)){if(o>g)break;o<e&&(e=o);n>l&&(l=n);d.push(h)}}d[0]===1&&j[0].cPos===j[0].ePos&&j[0].cPos===j[1].cPos&&d.push(0);return{fragmentList:d,startPosition:e,endPosition:l}}function e(a,d){if(d!==
        null)d.skeletonData=a.skeletonData,d.resourceInfo=a.resourceInfo,c(a),d.fragmentLoadMetrics=d.overallLoadMetrics.createSubTimer("fragments"),n.getBookFragments(function(a){m(d)?(d=null,l(a)):KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeOnContentReceived(),d.requestData.type,function(){var c=d;if(c===null||c.loadedFragments===null)l(a);else{c.numFragmentsLoaded+=1;var e=a.fragmentMetadata.id,h=j[e];if(a.wordList)for(var o in a.wordList)a.wordList[o]+=h.cPos;c.loadedFragments[e]=
            a;if(!(c.numFragmentsLoaded<c.fragmentsToLoad.length)&&(c.fragmentLoadMetrics.endTimer(),c!==null)){var n,h=c.loadedFragments,e={},f;for(f in h)if(o=h[f].imageRefs)for(var p in o)e[o[p]]=!0;f=[];for(n in e)f.push(n);n=f=KindleRendererImageRenderer.resolveCompositeResources(f);n.length>0?g(n,c):b(c)}}})},function(){if(d!==null){var a=d.requestData;d.fragmentLoadMetrics.addCount("Failure",1);d.fragmentLoadMetrics.endTimer();var b=d.deferredResult;d.loadedFragments=null;d=d.glyphData=null;b.reject("Error trying to download file fragments.",
        a)}},d.fragmentsToLoad)}function d(a){if(a!==void 0&&a!==null&&a.length>0&&o>0){var b=[],c,g,d,e;p=[];g=Math.min(a.length,o);c=o-g;for(d=0;d<a.length&&d<g;++d)e=a[d].glyphFragmentMetadata.id,b[e]=a[d],delete p[e];if(c>0)for(d in p)if(b[d]=p[d],--c===0)break;p=b}}function c(a){if(a.skeletonMetadata){var b=a.skeletonMetadata.id;q[b]===void 0&&(q={},q[b]=a)}}function b(b){function c(d){m(b)&&(b=null);KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeOnContentReceived(),
        b&&b.requestData.type,function(){var c=b;c===null||c.glyphData===null?(d.glyphData=null,d.glyphFragmentMetadata=null):(c.glyphChunkLoadCnt+=1,c.glyphData.push(d),c.glyphChunkLoadCnt<c.glyphChunksToDownload.length||(c.glyphLoadMetrics.endTimer(),a(c)))})}function g(){if(b!==null&&b.glyphData!==null){var a=b.requestData,c=b.deferredResult;b.glyphLoadMetrics.addCount("Failure",1);b.glyphLoadMetrics.endTimer();b=b.glyphData=null;c.reject("Error trying to download glyph chunks.",a)}}if(b!==null){var d,
        e=[],l=[],o;for(o in b.loadedFragments)if(d=h(parseInt(o,10)),d.gCks)for(var j=0;j<d.gCks.length;j+=1)$.inArray(d.gCks[j],l)===-1&&l.push(d.gCks[j]);d=[];for(o=0;o<l.length;o+=1)j=l[o],p[j]===void 0?d.push(j):e.push(p[j]);b.glyphData=e;d.length>0?(e=b.overallLoadMetrics.createSubTimer("glyph-loading"),e.addCount("NumGlyphCunks",d.length),b.glyphChunkLoadCnt=0,b.glyphChunksToDownload=d,b.glyphLoadMetrics=e,n.getGlyphFragments(c,g,d,b)):a(b)}}function g(a,c){var d=c.overallLoadMetrics.createSubTimer("resources");
            c.fragmentResources={};c.fragmentResourceLoadCnt=0;c.fragmentResourceToDownload=a;c.fragmentResourceLoadMetrics=d;n.getResourceUrls(function(a){m(c)&&(c=null);KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeOnContentReceived(),c&&c.requestData.type,function(){var d=c;d!==null&&(d.fragmentResourceLoadCnt+=1,jQuery.extend(d.fragmentResources,a),d.fragmentResourceLoadCnt<d.fragmentResourceToDownload.length||(d.fragmentResourceLoadMetrics.endTimer(),b(d)))})},function(){if(c!==
            null){var a=c.requestData,b=c.deferredResult;c.fragmentResourceLoadMetrics.addCount("Failure",1);c.fragmentResourceLoadMetrics.endTimer();c=null;b.reject("Error trying to download fragment resources.",a)}},a)}function a(a){if(!(a===null||a.loadedFragments===null)){d(a.glyphData);var b,c;for(c in a.loadedFragments)if(a.loadedFragments[c].fragmentMetadata.lId===void 0)b=h(parseInt(c,10)),a.loadedFragments[c].fragmentMetadata.lId=b.lId,a.loadedFragments[c].fragmentMetadata.lt=b.lt,a.loadedFragments[c].fragmentMetadata.nOff=
            b.off;b=null;var g=a.deferredResult,e=a.requestData,l={};l.skeletonData=a.skeletonData;l.resourceInfo=a.resourceInfo;l.glyphData=a.glyphData;l.fragmentResources=a.fragmentResources;l.contentRange={skeletonId:a.skeletonId,startPosition:a.fragmentsStartPosition,endPosition:a.fragmentsEndPosition};l.fragmentData=a.loadedFragments;var o=a.overallLoadMetrics;a.glyphData=null;a.fragmentResources=null;var a=a.loadedFragments=null,j=o.createSubTimer("(YIELD) finish-content-fetch");setTimeout(function(){j.endTimer();
            o.endTimer();g.resolve(e,l);l=e=null},KindleRendererDeviceSpecific.drawYieldUpdateTime())}}function l(a){a.fragmentData=null;a.fragmentMetadata=null;a.paraData=null}function h(a){return j[a]}var j=null,n=null,p=[],o,q={};return{initialize:function(a){p=[];o=KindleRendererDeviceSpecific.glyphCacheMaxSize();q={};n=a;var b=new jQuery.Deferred;n.getFragmentMap(function(a){j=a.fragmentArray;n.getManifest?n.getManifest(function(c){KindleRendererImageRenderer.initialize(c);b.resolve(a,c)},function(){b.resolve(a,
            null)}):b.resolve(a)},function(){b.reject()});return b.promise()},cleanup:function(){n=j=null;p=[];q={};KindleRendererImageRenderer.cleanup()},loadNextFragmentGroup:function(a,c,d){function g(a){m(u)?u=null:(p.endTimer(),e(a,u))}function l(){if(u!==null){var a=u.requestData;u.fragmentLoadMetrics.addCount("Failure",1);u.fragmentLoadMetrics.endTimer();u=null;o.reject("Error trying to download skeleton.",a)}}function h(){H.endTimer();m(u)?u=null:(p=u.overallLoadMetrics.createSubTimer("skeletons"),q[a]!==
            void 0?g(q[a]):n.getBookSkeleton(g,l,a))}var o=new jQuery.Deferred,c=f(c),j=d.metrics.createSubTimer("content-fetch"),p,c=k(a,c),c=f(c),A=c.fragmentList.slice(),u={deferredResult:o,skeletonId:a,fragmentsStartPosition:c.startPosition,fragmentsEndPosition:c.endPosition,overallLoadMetrics:j,loadedFragments:{},fragmentsToLoad:A,numFragmentsLoaded:0,requestData:d},H=j.createSubTimer("(YIELD) begin-content-fetch");A.length===0?b(u):setTimeout(h,KindleRendererDeviceSpecific.drawYieldUpdateTime());return o.promise()},
            isContentRangeLoaded:function(a,b,c,d){if(a===null||a===void 0||!b||c===null||c===void 0||!d)return!1;if(a!==c)return!1;b=f(b);d=f(d);a=k(a,b);c=k(c,d);if(c.fragmentList.length>a.fragmentList.length)return!1;for(d=0;d<c.fragmentList.length;++d)if(a.fragmentList.indexOf(c.fragmentList[d])===-1)return!1;return!0}}}(),KindleRendererFragmentLoader=function(){function f(b){for(var a=0;a<d.length;a++){var c=d[a];if(c.start<=b&&b<=c.end)return a}return 0}function m(g){b=g;var a=new jQuery.Deferred;KindleRendererContentFragmentation.initialize(b).then(function(b){var g=
        [],j,n=b.fragmentArray;for(j=0;j<n.length;j+=1){var f=n[j].sId,o=j===0?n[j].cPos:Math.min(n[j].cPos,n[j-1].ePos+1),q=n[j].ePos,k=g[f];if(k===void 0)g[f]={start:o,end:q};else{if(o<k.start)k.start=o;if(q>k.end)k.end=q}}if(b.skeletonMap!==void 0)for(j=0;j<b.skeletonMap.length;++j)if(g[j])g[j].properties=b.skeletonMap[j].properties;d=g;e=b.fragmentArray;c=b.fragmentMetadata.bookType;a.resolve()},a.reject);return a.promise()}function k(c,a,d){b.getBookFragments(function(b){KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeOnContentReceived(),
    a.type,function(){var c=b.fragmentMetadata.id,g=e[c],f,o;f=b.fragmentMetadata.lId===void 0||b.fragmentMetadata.lId===null?g.lId:b.fragmentMetadata.lId;o=b.fragmentMetadata.nOff===void 0||b.fragmentMetadata.nOff===null?g.off:b.fragmentMetadata.nOff;var q=document.createElement("DIV");q.id=f;q.setAttribute("data-nid",f);q.innerHTML=b.fragmentData;f=q.childNodes;for(var k=f.length,r=0;r<k;r+=1)f[r].ownChildIndex=o+r;d.resolve(a,{id:c,contentRange:{startPosition:g.cPos,endPosition:g.ePos},fragmentRoot:q,
        positionData:{posMap:b.posMap}})})},function(){d.reject("Error trying to download file fragments ID : ",c)},[c])}var e=null,d=null,c=!1,b=null;return{initialize:function(b){return m(b)},cleanup:function(){KindleRendererContentFragmentation.cleanup();d=e=null;c=!1},loadFragments:function(b,a){var c=f(b.focus);return KindleRendererContentFragmentation.loadNextFragmentGroup(c,b,a)},getFragmentAtId:function(c,a){var d=new jQuery.Deferred;b?k(c,a,d):d.reject();return d.promise()},getFragmentIdForPosition:function(b,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          a){var c;a:{for(var d=0;d<e.length-1;++d)if(c=a?e[d+1].cPos-1:e[d].ePos,b<=c){c=d;break a}c=e.length-1}return c},needToLoadFragments:function(b,a){var c;if(!b||!a)c=!0;else{c=f(b.startPosition);var d=f(a.focus);c=!KindleRendererContentFragmentation.isContentRangeLoaded(c,b,d,a)}return c},getMaximumPosition:function(){return e[e.length-1].ePos},getMinimumPosition:function(){return e[0].cPos},isPositionAtBeginningOfSkeletonOrDocument:function(b,a){return a<=e[0].cPos||a===d[b].start},isPositionAtEndOfSkeletonOrDocument:function(b,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              a){return a>=e[e.length-1].ePos||a===d[b].end},getBookContentType:function(){return c},getSkeletonForPosition:function(b){return f(b)},getSkeletonRange:function(b){return{start:d[b].start,end:d[b].end}},getGroupInfo:function(b){if(d[b].properties&&d[b].properties.group)return d[b].properties.group;var a=b%2===0?b+1:b-1;return a<0||a>=this.getNumSkeletons()||d[a].properties&&d[a].properties.group?{start:b,length:1,spine:!0}:{start:Math.min(b,a),length:2,spine:!0}},isBlankPage:function(b){return!d[b].properties?
        !1:d[b].properties.blank===!0},getNumSkeletons:function(){return d.length},getFragmentMap:function(){}}}(),KindleRendererPositionLoadingCalculator=function(){function f(){if(c>0)return c;var b,d;d=KindleRendererSettings.getSettings();if(KindleRendererFragmentLoader.getBookContentType()==="topaz")b=k.width/(25*d.glyphScale),d=k.height/(25*d.glyphScale);else{var a=d.fontSizes[m];b=k.width/(a*0.4);d=k.height/(a*d.lineSpacingMultiplier)}return Math.round(b*d)}var m=2,k={height:1,width:1},e=0,d=[],c=0;
        return{updateScreenDimensions:function(b,d){k.width=b;k.height=d;c=_displayedScreenCount=_logSumPositionsDisplayed=0},updateDisplayedPositionRange:function(b){b>0&&(d[e]=b,e=(e+1)%10,c=0,c=Math.max.apply(Math,d))},calculateDesiredFragmentRangeForPageFlip:function(b,c){var a=KindleRendererFragmentLoader.getBookContentType()==="topaz",d=KindleRendererDeviceSpecific.fragmentBufferCapacityForPageFlip(a),e=f();d*=e;var j=Math.ceil(d*0.25),n=Math.ceil(d*0.75),d=KindleRendererFragmentLoader.getMinimumPosition(),
                p=KindleRendererFragmentLoader.getMaximumPosition(),j=Math.max(d,b-j),n=Math.min(p,b+n),o=c.currentTopOfPage,q=c.currentBottomOfPage;a?(j=Math.min(j,Math.max(d,o-1)),n=Math.max(n,Math.min(p,q+1))):b<o&&o-b<3*e?n=Math.min(p,q+1):b>q&&b-q<3*e&&(j=Math.max(d,o-1));return{focus:b,startPosition:j,endPosition:n}},calculateDesiredFragmentRangeForGoTo:function(b){var c=f()*KindleRendererDeviceSpecific.fragmentBufferCapacityForGoTo(),a=Math.ceil(c*0.1),c=Math.ceil(c),d=KindleRendererFragmentLoader.getMinimumPosition(),
                e=KindleRendererFragmentLoader.getMaximumPosition();return{focus:b,startPosition:Math.max(d,b-a),endPosition:Math.min(e,Math.max(d+c,b+c))}}}}(),KindleRendererRequestId=function(){var f=0;return{getUniqueRequestId:function(){f+=1;return f}}}(),KindleRendererIframeLoading=function(){function f(){window.focus()}function m(a){a.ctrlKey&&a.preventDefault();switch(a.which){case 219:case 221:a.shiftKey||a.preventDefault();break;case 37:case 38:case 33:case 39:case 40:case 34:case 32:case 8:a.preventDefault()}}
        function k(a,b){var c=b.ownerDocument.createEvent("CustomEvent");c.initCustomEvent(a.type,!0,!0,a);b.dispatchEvent(c)}function e(a,b){var c=b.ownerDocument.createEvent("MSPointerEvent");c.initPointerEvent(a.type,!0,!0,window.parent,a.detail,a.screenX,a.screenY,a.clientX,a.clientY,a.ctrlKey,a.altKey,a.shiftKey,a.metaKey,a.button,null,a.offsetX,a.offsetY,a.width,a.height,a.pressure,a.rotation,a.tiltX,a.tiltY,a.pointerId,a.pointerType,a.hwTimestamp,a.isPrimary);b.dispatchEvent(c)}function d(a,b){var c;
            a.type==="mousewheel"?(a.preventDefault(),c=b.ownerDocument.createEvent("WheelEvent"),c.initWheelEvent(a.type,!0,!0,window.parent,-1*a.wheelDelta,a.screenX,a.screenY,a.clientX,a.clientY,a.button,null,null,a.deltaX,a.deltaY,a.deltaZ,a.deltaMode)):(c=b.ownerDocument.createEvent("MouseEvent"),c.initMouseEvent(a.type,!0,!0,window.parent,a.detail,a.screenX,a.screenY,a.clientX,a.clientY,a.ctrlKey,a.altKey,a.shiftKey,a.metaKey,a.button,null));b.dispatchEvent(c)}function c(a){var b=a.contentDocument.getElementsByTagName("body")[0];
            b.className+=" amzUserPref";var c=a.contentDocument.getElementsByTagName("head")[0];KindleRendererDefaults.addCSSRules(c,KindleRendererFragmentLoader.getBookContentType());KindleRendererSettings.addCSSRules(a.contentDocument,c);KindleRendererContentScripts.addInterfaceScripts(a);b.onmousewheel=function(b){d(b,a);return!1};a.contentWindow.onkeydown=function(b){m(b);k(b,a)};a.contentWindow.onkeyup=function(b){m(b);k(b,a)};a.contentWindow.onkeypress=function(b){m(b);k(b,a)};if(KindleRendererSettings.useNativeSelection()){if(window.navigator.msPointerEnabled)b.onmspointerdown=
                function(b){e(b,a)},b.onmspointerup=function(b){e(b,a)},b.onmspointermove=function(b){e(b,a)},b.onmspointerout=function(b){e(b,a)},b.onmspointercancel=function(b){e(b,a)},b.onmspointerover=function(b){e(b,a)},b.onmspointerhover=function(b){e(b,a)},b.addEventListener("MSGestureHold",function(a){a.preventDefault()},!1);b.oncontextmenu=function(b){e(b,a);b.preventDefault()};b.onclick=function(b){d(b,a)};b.ondblclick=function(b){d(b,a)};b.onmousedown=function(b){d(b,a)};b.onmouseup=function(b){d(b,a)};
                b.onmousemove=function(b){d(b,a)};b.onmouseover=function(b){d(b,a)};b.onmouseout=function(b){d(b,a)}}else a.contentWindow.onfocus=f,a.contentWindow.onclick=f,b.onselectstart=function(){return!1}}function b(a){if(a=a.getElementsByTagName("body")[0])for(;a.hasChildNodes();)a.removeChild(a.lastChild)}function g(a,b){if(a&&a.nodeType===Node.ELEMENT_NODE){var c=a.getAttribute("data-nid");c!==null&&(b[c]={linkNode:a,typeArray:[a.firstChild,a.nextSibling]});for(var c=a.childNodes,d=c.length,e=0;e<d;e+=1)g(c[e],
        b)}}function a(a){var b={};try{if((window.ActiveXObject||"ActiveXObject"in window)&&window.XMLHttpRequest)g(a.contentDocument.body,b);else for(var c=(new XPathEvaluator).evaluate("//*[@data-nid]",a.contentDocument,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),d=c.iterateNext();d;){var e=d.getAttribute("data-nid");b[e]={linkNode:d,typeArray:[d.firstChild,d.nextSibling]};d=c.iterateNext()}}catch(l){g(a.contentDocument.body,b)}return b}function l(a){var b=[],c;for(c in a)b.push(parseInt(c,10));
            b.sort(function(a,b){return a-b});return b}function h(a,b,c,d){function g(){if(B!==null)G.insertBefore(B,K),B=null,I.lId=null,I.lt=-1}function e(){j=c.fragmentData[J[O]];n=j.fragmentMetadata;if(I.lId!==n.lId||I.lt!==n.lt){g();I.lId=n.lId;I.lt=n.lt;F=b[n.lId];if(F===void 0){var l=b,N=n.lId,S=a.contentDocument.getElementById(N);l[N]={linkNode:S,typeArray:[S.firstChild,S.nextSibling]};F=b[n.lId]}B=n.lt===0?F.linkNode:F.linkNode.parentNode;G=B.parentNode;K=B.nextSibling;B=G.removeChild(B)}C=a.contentDocument.createElement(B.tagName);
            C.innerHTML=j.fragmentData;l=c.fragmentResources;N=j.resList===void 0?j.imageData:j.resList;if(l||N)for(var S=$(C).find("img"),Q=0,R=0;R<S.length;R+=1){Q=S[R].getAttribute("dataUrl");if(Q===void 0||Q===null)Q=S[R].getAttribute("src");KindleRendererImageRenderer.loadImage(S[R],l,N,Q)}for(l=n.nOff;C.hasChildNodes();){N=C.removeChild(C.firstChild);if(N.nodeType===Node.TEXT_NODE)N.ownChildIndex=l;B.insertBefore(N,F.typeArray[n.lt]);l+=1}if(j.posMap!==void 0){k=!0;for(var P in j.posMap)f[P]=j.posMap[P]}j.wordList!==
            void 0&&(u=!0,p=p.concat(j.wordList));if(j.paraIds!==void 0&&j.paraIds!==null){E=!0;for(P=0;P<j.paraIds.length;P+=1)m[j.paraIds[P]]=j.paraData[P];for(var T in j.imageData)M[T]=j.imageData[T]}j.fragmentData=null;j.imageData=null;j.paraData=null;O+=1;if(O<J.length)O%50===49?setTimeout(e,0):KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeLoadNextFragment(),d.type,e);else{g();K=B=G=j=null;T={positionData:{}};if(k)T.positionData.posMap=f;if(u)T.positionData.wordList=p;if(E)T.glyphData=
                {paraData:m,imageData:M};h.resolve(T)}}var h=$.Deferred(),j,n,f={},p=[],k=!1,u=!1,m={},M={},E=!1,C=null,I={lId:null,lt:-1},F=null,G=null,B=null,K=null,J=l(c.fragmentData),O=0;KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeLoadNextFragment(),d.type,e);return h.promise()}function j(a,b,c){KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeBeforeBulkWriteToIframe(),c.type,function(){KindleHostDeviceDetector.isFirefox&&KindleHostDeviceDetector.isFirefox()||
        KindleHostDeviceDetector.isMSEdge&&KindleHostDeviceDetector.isMSEdge()?b.open("text/html","replace"):b.open();b.write(a);KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeAfterBulkWriteToIframe(),c.type,function(){b.close()})})}function n(a,d,g,e){if(a.processingRequestId.id===d.requestId){var l=a.contentDocument;a.screenManager=null;b(l);KindleGlyphRenderer.clearIframeData(a);a.onload=function(){KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeAfterIframeLoaded(),
        d.type,function(){if(a.processingRequestId.id===d.requestId){a.onload=null;var b=KindleRendererSettings.getSettings(),l=$(a).parent(),l={height:l.height(),width:l.width()},h=d.contentLoadMetrics.createSubTimer("css-style-sanitization");KindleRendererContentStyleSanitization.sanitizeCSS(a.contentDocument,b,l);h.endTimer();c(a);a.writingMode=KindleRendererWritingModeFactory.buildIFrameWritingMode(a);a.writingMode.resetIframeDimensions(a);p(a,d,g,e)}})};j(g.skeletonData,l,d)}}function p(b,c,d,g){function e(a){g.reject(c,
        a)}var l=a(b),j=c.contentLoadMetrics.createSubTimer("fragment-loading"),n;try{n=h(b,l,d,c)}catch(f){e(f);return}n.then(function(a){j.endTimer();var d=KindleRendererSettings.getSettings(),l=$(b).parent(),l={height:l.height(),width:l.width()},h=c.contentLoadMetrics.createSubTimer("node-style-sanitization");KindleRendererContentStyleSanitization.sanitizeContent(b.contentDocument,d,l).then(function(){h.endTimer();g.resolve(c,a)},e)},e)}return{loadIframe:function(a,b,c){var d=new jQuery.Deferred;a.processingRequestId.id===
            b.requestId?n(a,b,c,d):d.reject();return d.promise()},copyIframeContents:function(a,d,g){function e(){KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeAfterIframeLoaded(),a.type,function(){if(g.processingRequestId.id===a.requestId)c(g),KindleRendererContentStyleSanitization.copySanitizationData(d.contentDocument,g.contentDocument),KindlePaginator.copyIframe(d,g),g.onload=null,g.writingMode.prepareForPagination(g),l.resolve(a)})}var l=new jQuery.Deferred,h,n;g.processingRequestId.id===
            a.requestId?(n=d.contentDocument.getElementsByTagName("html")[0],b(g.contentDocument),g.writingMode.resetHeight(g),g.onload=e,h=n.outerHTML,h===void 0&&(h="<html>"+n.innerHTML+"</html>"),j(h,g.contentDocument,a)):l.reject();return l.promise()},cleanupIframe:function(a){b(a.contentDocument)},updateSettingsInIframe:function(a){if(a&&a.contentDocument){var b=a.contentDocument.getElementsByTagName("head")[0];if(b){KindleRendererSettings.addCSSRules(a.contentDocument,b);var b=KindleRendererSettings.getSettings(),
            c={height:$(a).parent().height(),width:$(a).parent().width()},d=KindleMetricsProfiler("style-sanitization");KindleRendererContentStyleSanitization.sanitizeCSS(a.contentDocument,b,c);KindleRendererContentStyleSanitization.sanitizeContent(a.contentDocument,b,c);d.endTimer()}}}}}(),KindleRendererIframeManagerFactory=function(){function f(e){e.cancelCurrentRequest=function(){if(this.currentRequest)this.currentRequest.cancelled=!0,this.currentRequest=null};e.createNewRequest=function(a,b){this.cancelCurrentRequest();
        this.currentRequest={type:a,requestId:KindleRendererRequestId.getUniqueRequestId(),metrics:KindleMetricsProfiler("iframe-load"),retryCount:0,initialPosition:b};this.currentRequestDfd=new jQuery.Deferred};e.willRetryCurrentRequest=function(){this.currentRequest&&this.currentRequest.retryCount++};e.canRetryCurrentRequest=function(){return this.currentRequest?this.currentRequest.retryCount<g:!0};e.getCurrentProcessDfd=function(){return this.currentRequestDfd.promise()};e.getCurrentProcessId=function(){return this.currentRequest.requestId};
        e.createIframe=function(b,c,d){var g=document.createElement("iframe");g.writingMode=KindleRendererWritingModeFactory.buildIFrameWritingMode(g);g.index=d;g.processingRequestId={};g.computingRectsId={};g.setAttribute("frameBorder","0");g.setAttribute("id",c+"_frame_"+d);g.setAttribute("name","book_iframe_"+d);g.setAttribute("scrolling","no");g.setAttribute("tabindex",-1);$(g).css({height:"100%",width:b+"px",position:"absolute","margin-top":"0px",left:"0px",visibility:"hidden","z-index":a});return g};
        e.setIframeVisibility=function(b,c){if(this.showContent||!c)if(c){if($(b).css({visibility:"visible","z-index":0,"margin-top":"0px"}),$(b.pageOverflowDiv).css({visibility:"visible","z-index":0}),KindleHostDeviceDetector.hasImageRenderingProblem&&KindleHostDeviceDetector.hasImageRenderingProblem()){var d=b.contentDocument.querySelector("img[data-repaint-on-show]");if(d){var g=function(){d.style.borderColor="#FFF"};setTimeout(g,1);setTimeout(g,1500)}}}else $(b).css({visibility:"hidden","z-index":a,"margin-top":l+
                "px"}),$(b.pageOverflowDiv).css({visibility:"hidden","z-index":a})};e.calculateIframePaginationData=function(a,c,d){var g=this,e=KindleRendererFragmentLoader.getBookContentType()==="topaz"?g.currentRequest.type===g.loadedType.PREVIOUS?KindleRendererIframePreparation.CANVAS_INSERTION_PREVIOUS:KindleRendererIframePreparation.CANVAS_INSERTION_NEXT:KindleRendererIframePreparation.CANVAS_INSERTION_NONE;KindleRendererIframePreparation.prepareIframe(a,g.currentRequest,c,d,e).then(function(b){if(a.processingRequestId.id===
        b.requestId&&g.currentRequest&&g.currentRequest.requestId===b.requestId)a.processingRequestId.id=null,g.frameIsLoadedAndReady(a);g=null},function(a){g.currentRequest&&g.currentRequest.requestId===a.requestId&&g.currentRequestDfd.reject(b);g=null})};e.loadContentDataIntoIframe=function(a){var b=this;b.currentRequest.contentLoadMetrics=b.currentRequest.metrics.createSubTimer("content-load");var d=b.getIframeToLoad();if(d)b.contentRange[d.index]=a.contentRange,d.processingRequestId.id=b.currentRequest.requestId,
            d.computingRectsId.id=null,KindleRendererIframeLoading.loadIframe(d,b.currentRequest,a).then(function(c,g){if(d.processingRequestId.id===c.requestId&&b.currentRequest&&b.currentRequest.requestId===c.requestId)b.positionData[d.index]=g.positionData,b.calculateIframePaginationData(d,a,g);b=null},function(a){b.currentRequest&&b.currentRequest.requestId===a.requestId&&b.currentRequestDfd.reject(c);b=null})};e.loadFragmentsForRange=function(a){var b=this;KindleRendererFragmentLoader.loadFragments(a,b.currentRequest).then(function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               c){b.currentRequest&&b.currentRequest.requestId===a.requestId&&b.loadContentDataIntoIframe(c);b=null},function(a,c){b.currentRequest&&b.currentRequest.requestId===c.requestId&&b.currentRequestDfd.reject(d);b=null})};e.resizeWithoutReload=function(a){var c=this,d=this.iframes[a];d.processingRequestId.id=this.currentRequest.requestId;c.setIframeVisibility(d,!1);c.currentRequest.contentLoadMetrics=c.currentRequest.metrics.createSubTimer("content-load");KindleRendererContentReflow.reflow(d,this.currentRequest,
        this.positionData[a]).then(function(){c.currentRequest&&c.currentRequest.requestId===d.processingRequestId.id&&(c.frameIsLoadedAndReady(d),c.setIframeVisibility(d,d.index===c.visibleIframeIndex));c=null},function(){c.currentRequest&&c.currentRequest.requestId===d.processingRequestId.id&&(c.setIframeVisibility(d,d.index===c.visibleIframeIndex),c.currentRequestDfd.reject(b));c=null})};e.setCanPreloadNext=function(a){this.canPreloadNext=a};e.setCanPreloadPrevious=function(a){this.canPreloadPrevious=
            a};e.getIframeOrigin=function(a){a=$(this.iframes[a]);return{x:parseInt(a.css("left"),10),y:parseInt(a.css("top"),10)}};e.getBoundsWithOffset=function(a,b){if(a.getBoundingClientRect){var c=a.getBoundingClientRect();if(c)return{top:c.top+b.y,right:c.right+b.x,bottom:c.bottom+b.y,left:c.left+b.x,width:c.width,height:c.height}}return null}}function m(a,b){a.gotoPosition=function(a,c){return b.gotoPosition(a,c)};a.nextScreen=function(){return b.nextScreen()};a.previousScreen=function(){return b.previousScreen()};
        a.copyIframeData=function(a){return b.copyIframeData(a.internal)};a.hasNextScreen=function(){return b.hasNextScreen()};a.hasPreviousScreen=function(){return b.hasPreviousScreen()};a.getPagePositionRange=function(){return b.getPagePositionRange()};a.getCurrentPosition=function(){return b.getCurrentPosition()};a.getSelectableItemBoundaries=function(){return b.getSelectableItemBoundaries()};a.getWordPositions=function(){return b.getWordPositions()};a.reloadAnnotations=function(){b.reloadAnnotations()};
        a.updateGlyphColor=function(){b.updateGlyphColor()};a.handleClick=function(a,c){return b.handleClick(a,c)};a.cleanup=function(){b.cleanup()};a.updateSettings=function(a){b.updateSettings(a)};a.reloadNotification=function(){b.reloadNotification()};a.resizeNotification=function(){b.resizeNotification()};a.setAnnotationEventCallback=function(a){b.setAnnotationEventCallback(a)};a.getCurrentProcessDfd=function(){return b.getCurrentProcessDfd()};a.getComputedRectsDfd=function(){return b.getComputedRectsDfd()};
        a.getCurrentProcessId=function(){return b.getCurrentProcessId()};a.show=function(){b.show()};a.hide=function(){b.hide()};a.getContentRects=function(){return b.getContentRects()};a.getZoomableAt=function(a,c,d){return b.getZoomableAt(a,c,d)};a.getZoomableList=function(a){return b.getZoomableList(a)};a.setOverlayManager=function(a){b.setOverlayManager(a)};a.setCanPreloadPrevious=function(a){b.setCanPreloadPrevious(a)};a.setCanPreloadNext=function(a){b.setCanPreloadNext(a)};a.drawWordMap=function(){b.drawWordMap()};
        a.drawHeightMaps=function(){b.drawHeightMaps()};a.clearSelection=function(){b.clearSelection()};a.getSelection=function(){return b.getSelection()}}function k(a){a.showContent=!0;a.canPreloadNext=!0;a.canPreloadPrevious=!0}var e=0,d=e++,c=e++,b=e++,g=5,a=-1E3,l=1E4;return{DATA_LOAD_ERROR:d,IFRAME_ERROR_LOADING:c,IFRAME_ERROR_PAGINATING:b,build:function(a){if(KindleRendererSettings.useCSSRegions()){var b={};k(b,a);f(b);KindleRegionIframeManager.build(b,a);a={internal:b}}else KindleRendererSettings.getSettings().fixedContent?
        (b={},k(b,a),f(b),KindleRendererIframeManagerFixedFactory.build(b,a),a={}):(b={},k(b,a),f(b),KindleRendererIframeManagerReflowFactory.build(b,a),a={internal:b});m(a,b);return a}}}(),KindleRendererIframeManagerFixedFactory=function(){function f(f){f.findNextNonBlankPage=function(e,d){var c=this.findNextNonBlankPageInDirection(e,d);c===null&&(c=this.findNextNonBlankPageInDirection(e,!d));return c};f.findNextNonBlankPageInDirection=function(e,d){for(var c=e,b=KindleRendererFragmentLoader.getNumSkeletons();c>=
    0&&c<b;){if(KindleRendererFragmentLoader.isBlankPage(c)===!1)return c;d?c+=1:c-=1}return null};f.getNeededSkeletonsFrom=function(e,d){for(var c=this.getSkeletonsToShowWith(e,d),b=0;b<c.length;b++)if(KindleRendererFragmentLoader.isBlankPage(c[b])===!1)return c;b=this.findNextNonBlankPage(d?Math.max.apply(Math,c)+1:Math.min.apply(Math,c)-1,d);return b===null?c:this.getSkeletonsToShowWith(b,d)};f.addSkeletonRangeToList=function(e,d,c){for(var b=0;b<c;b+=1)e.push(d+b)};f.getSkeletonsToShowWith=function(e,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            d){var c=KindleRendererFragmentLoader.getGroupInfo(e);if(c.length>this.numberOfColumns){var b=[];this.addSkeletonRangeToList(b,e,Math.min(this.numberOfColumns,c.length-(e-c.start)));return b}return this.getGroupsToFillScreen(c,d)};f.getGroupsToFillScreen=function(e,d){var c=[];this.addSkeletonRangeToList(c,e.start,e.length);var b;b=d?e.start+e.length:e.start-1;for(var g=KindleRendererFragmentLoader.getNumSkeletons();c.length<this.numberOfColumns&&b>=0&&b<g;){var a=KindleRendererFragmentLoader.getGroupInfo(b);
        if(c.length+a.length<=this.numberOfColumns)this.addSkeletonRangeToList(c,b,a.length);else break;d?b+=a.length:b-=a.length}return c};f.getNeededSkeletonsForGoTo=function(e){return this.getNeededSkeletonsFrom(KindleRendererFragmentLoader.getSkeletonForPosition(e),!0)};f.getNeededSkeletonsForPageFlip=function(e){var d=this.getCurrentlyVisibleSkeletons();return e>0?(e=Math.max.apply(Math,d),e=Math.min(e+1,KindleRendererFragmentLoader.getNumSkeletons()),this.getNeededSkeletonsFrom(e,!0)):(e=Math.min.apply(Math,
    d),e=Math.max(e-1,0),this.getNeededSkeletonsFrom(e,!1))};f.clearCacheReservations=function(){for(var e=this.iframeStatus.length,d=0;d<e;d++)if(this.iframeStatus[d]===this.statusType.RESERVED)this.iframeStatus[d]=this.statusType.AVAILABLE};f.getLoadedSkeletons=function(){for(var e={},d=this.contentRange.length,c=0;c<d;c++)this.contentRange[c]&&this.iframes[c].processingRequestId.id===null&&(e[this.contentRange[c].skeletonId]=c);return e};f.reserveSkeletonsInCache=function(e){this.clearCacheReservations();
        for(var d=this.getLoadedSkeletons(),c=[],b=0;b<e.length;b++){var g=e[b],a=d[g];if(a===void 0)c.push(g);else if(this.iframeStatus[a]===this.statusType.AVAILABLE)this.iframeStatus[a]=this.statusType.RESERVED}return c};f.getIndicesToShow=function(e){for(var d=this.getLoadedSkeletons(),c=[],b=0;b<e.length;b++)c.push(d[e[b]]);return c};f.shouldShowSpineAfterSkeleton=function(e){var e=this.contentRange[e].skeletonId,d=KindleRendererFragmentLoader.getGroupInfo(e),c=d.start+d.length-1;return d.spine||e===
    c?!0:!1};f.getSpineCountForIndicies=function(e){var d=0;for(i=0;i<e.length-1;i++)this.shouldShowSpineAfterSkeleton(e[i])&&d++;return d};f.prepareSpine=function(){var e={position:"absolute",visibility:"visible","background-color":this.spineColor,"z-index":m},d=this.getAvailableSpine();$(d).css(e);return d};f.getAvailableSpine=function(){for(i=0;i<this.spines.length;i++)if(this.spines[i].status===this.statusType.AVAILABLE)return this.spines[i];var e=document.createElement("div");this.parent.appendChild(e);
        e.status=this.statusType.RESERVED;this.spines.push(e);return e};f.removeAllSpines=function(){for(i=0;i<this.spines.length;i++)$(this.spines[i]).css("visibility","hidden"),this.spines[i].status=this.statusType.AVAILABLE};f.isRTLProgression=function(){var e=KindleRendererSettings.getSettings().pageProgressionDirection;return e?e.value===e.RTL:!1};f.prepareDisplayElements=function(e,d,c){for(var b,g=[],a=0;a<e.length;a++){b=this.iframes[e[a]];var l=KindleRendererElementFitting.resize(b.contentDocument.body,
    d),h=Math.round((d.height-l.height)*0.5)+"px";$(b).css({top:h,height:l.height+"px",width:l.width+"px"});g.push(b);if(a!==e.length-1&&this.shouldShowSpineAfterSkeleton(e[a])){var f=this.prepareSpine();$(f).css({top:h,height:l.height+"px",width:this.columnGap+"px"});g.push(f)}this.iframeStatus[b.index]=this.statusType.VISIBLE;this.setIframeVisibility(b,!0);c[b.index]=!1}return g};f.placeElementsHorizontally=function(e,d){var c=0,b;for(b=0;b<e.length;b++)c+=$(e[b]).width();var g,a=Math.floor((d-c)*0.5);
        for(b=0;b<e.length;b++)c=e[b],g=$(c).width(),$(c).css({left:this.isRTLProgression()?d-(a+g):a}),a+=g};f.showSkeletons=function(e){var e=this.getIndicesToShow(e.sort(function(a,b){return a-b})),d=this.getCurrentlyVisibleIndices(),c={},b;for(b=0;b<d.length;b++)c[d[b]]=!0;if(e.length>0){var g=$(this.parent).height(),d=$(this.parent).width(),g={width:Math.round((d-this.columnGap*this.getSpineCountForIndicies(e))/e.length),height:g};this.removeAllSpines();this.placeElementsHorizontally(this.prepareDisplayElements(e,
    g,c),d)}for(b in c)if(c[b])this.iframeStatus[b]=this.statusType.AVAILABLE,this.setIframeVisibility(this.iframes[b],!1)};f.getCurrentlyVisibleIndices=function(){for(var e=[],d=this.iframeStatus.length,c=0;c<d;c++)this.iframeStatus[c]===this.statusType.VISIBLE&&e.push(c);return e};f.getSkeletonsFromIndices=function(e){for(var d=[],c=0;c<e.length;c++){var b=this.contentRange[e[c]];b&&d.push(b.skeletonId)}return d};f.getCurrentlyVisibleSkeletons=function(){return this.getSkeletonsFromIndices(this.getCurrentlyVisibleIndices())};
        f.getPrioritizedPreloadList=function(e){var d=e.slice(0);if(e.length>0)for(var c=KindleRendererFragmentLoader.getNumSkeletons(),b=this.iframes.length,g=Math.min.apply(Math,e),e=Math.max.apply(Math,e);d.length<b&&(g>0||e<c-1);){var a;for(a=0;a<this.numberOfColumns&&e<c-1&&d.length<b;a++)e++,d.push(e);for(a=0;a<this.numberOfColumns&&g>0&&d.length<b;a++)g--,d.push(g)}return d};f.getLowestPriority=function(e){for(var d=this.iframes.length,c=0,b=-1,g=0;g<d;g++){var a=this.contentRange[g];if(!a)return{iframeIndex:g,
            priorityRating:-Infinity};if(this.iframeStatus[g]===this.statusType.AVAILABLE)if(a=$.inArray(a.skeletonId,e),a===-1)return{iframeIndex:g,priorityRating:-Infinity};else a>b&&(b=a,c=g)}return{iframeIndex:c,priorityRating:d-b}};f.pickSkeletonToPreload=function(e){for(var d=this.getLoadedSkeletons(),c=0;c<e.length;c++)if(d[e[c]]===void 0)return{skeletonId:e[c],priorityRating:e.length-c};return null};f.considerLoadingMoreSkeletons=function(){if(!this.currentRequest){var e=this.getPrioritizedPreloadList(this.getCurrentlyVisibleSkeletons()),
        d=this.pickSkeletonToPreload(e);if(d!==null&&this.getLowestPriority(e).priorityRating<d.priorityRating)this.createNewRequest(this.loadedType.PRELOAD,null),this.currentRequest.skeletons=[d.skeletonId],this.loadFragmentsForRange(this.getDesiredRangeForSkeleton(d.skeletonId))}};f.updateSettings=function(e){if(e.columns!==void 0){if(e.columns.num!==void 0)this.numberOfColumns=e.columns.num;if(e.columns.gap!==void 0)this.columnGap=e.columns.gap;if(e.columns.spineColor!==void 0)this.spineColor=e.columns.spineColor}};
        f.getIframeToLoad=function(){return this.currentRequest?this.iframes[this.getLowestPriority(this.getPrioritizedPreloadList(this.currentRequest.type===this.loadedType.PRELOAD?this.getCurrentlyVisibleSkeletons():this.currentRequest.skeletons)).iframeIndex]:null};f.getDesiredRangeForSkeleton=function(e){e=KindleRendererFragmentLoader.getSkeletonRange(e);return{focus:e.start,startPosition:e.start,endPosition:e.end}};f.frameIsLoadedAndReady=function(){var e=this.currentRequest,d=this.reserveSkeletonsInCache(e.skeletons);
            d.length>0?this.loadFragmentsForRange(this.getDesiredRangeForSkeleton(d[0])):(e.type===this.loadedType.PRELOAD&&this.clearCacheReservations(),e.initialPosition!==null&&this.showSkeletons(e.skeletons),e.metrics.endTimer(),e.metrics.log(),this.currentRequest=null,setTimeout(this.currentRequestDfd.resolve,10),e.type!==this.loadedType.PAGE_FLIP&&this.considerLoadingMoreSkeletons())};f.pageFlip=function(e){var e=this.getNeededSkeletonsForPageFlip(e),d=this.reserveSkeletonsInCache(e),c=Math.max.apply(Math,
        e);this.currentPosition=KindleRendererFragmentLoader.getSkeletonRange(c).start;if(d.length>0)return this.createNewRequest(this.loadedType.PAGE_FLIP,null),this.currentRequest.skeletons=e,this.loadFragmentsForRange(this.getDesiredRangeForSkeleton(d[0])),!1;this.showSkeletons(e);this.considerLoadingMoreSkeletons();return!0};f.nextScreen=function(){return this.pageFlip(1)};f.previousScreen=function(){return this.pageFlip(-1)};f.gotoPosition=function(e,d){var c=this.getNeededSkeletonsForGoTo(e),b=this.reserveSkeletonsInCache(c);
            if(d){var g=Math.max.apply(Math,c);this.currentPosition=KindleRendererFragmentLoader.getSkeletonRange(g).start}if(b.length>0)return this.createNewRequest(this.loadedType.GOTO,e),this.currentRequest.skeletons=c,this.loadFragmentsForRange(this.getDesiredRangeForSkeleton(b[0])),!1;this.clearCacheReservations();this.showSkeletons(c);return!0};f.getPagePositionRange=function(){var e=this.getCurrentlyVisibleIndices();if(e.length===0)return null;for(var d=Infinity,c=-Infinity,b=0;b<e.length;b++)var g=this.contentRange[e[b]],
        d=Math.min(d,g.startPosition),c=Math.max(c,g.endPosition);return{currentTopOfPage:d,currentBottomOfPage:c}};f.getCurrentPosition=function(){return this.currentPosition};f.cleanup=function(){this.cancelCurrentRequest();for(var e=0;e<this.iframes.length;e++)KindleRendererIframeLoading.cleanupIframe(this.iframes[e]),KindlePaginator.cleanupIframe(this.iframes[e]),this.contentRange[e]=null,this.positionData[e]=null;this.iframes=null};f.hasNextScreen=function(){for(var e=this.getCurrentlyVisibleSkeletons(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            d=KindleRendererFragmentLoader.getNumSkeletons()-1,c=0;c<e.length;c++)if(e[c]===d)return!1;return!0};f.hasPreviousScreen=function(){for(var e=this.getCurrentlyVisibleSkeletons(),d=0;d<e.length;d++)if(e[d]===0)return!1;return!0};f.getSortedVisibleIndicies=function(){for(var e,d=[],c=this.getCurrentlyVisibleIndices(),b=0;b<c.length;b++){e=c[b];var g=this.contentRange[e].skeletonId;KindleRendererFragmentLoader.isBlankPage(g)||d.push([g,e])}d.sort(function(a,b){return a[0]-b[0]});e=[];for(b=0;b<d.length;b++)e.push(d[b][1]);
            return e};f.getContentRects=function(){for(var e=this.getSortedVisibleIndicies(),d=[],c=0;c<e.length;c++){var b=e[c],g=this.iframes[b],b=this.getIframeOrigin(b);d.push(this.getBoundsWithOffset(g.contentDocument.body,b))}return d};f.getZoomableAt=function(e,d,c){for(var b=this.getCurrentlyVisibleIndices(),g=0;g<b.length;g++){var a=b[g],l=$(this.iframes[a]),l={x:e.x+parseInt(l.css("left"),10),y:e.y+parseInt(l.css("top"),10)};if(a=KindleRendererZoomablesFactory.buildFromCoord(this.iframes[a].contentDocument,
        l,d,c))return a}return null};f.getZoomableList=function(e){for(var d=[],c=this.getSortedVisibleIndicies(),b=0;b<c.length;b++)var g=c[b],a=$(this.iframes[g]),a={x:e.x+parseInt(a.css("left"),10),y:e.y+parseInt(a.css("top"),10)},d=d.concat(KindleRendererZoomablesFactory.buildList(this.iframes[g].contentDocument,a));return d};f.getSelectableItemBoundaries=function(){return{}};f.getComputedRectsDfd=function(){return null};f.getWordPositions=function(){return null};f.show=function(){this.showContent=!0;
            for(var e=this.getCurrentlyVisibleIndices(),d=0;d<e.length;d++)this.setIframeVisibility(this.iframes[e[d]],!0)};f.hide=function(){this.showContent=!1;for(var e=this.getCurrentlyVisibleIndices(),d=0;d<e.length;d++)this.setIframeVisibility(this.iframes[e[d]],!1)};f.handleClick=function(e,d){for(var c=this.getCurrentlyVisibleIndices(),b,g=0;g<c.length;g++){var a=this.iframes[c[g]],l=a.offsetLeft,h=a.offsetTop,f=a.offsetHeight,n=a.offsetWidth;if(e>=l&&e<=l+n&&d>=h&&d<=h+f){b=a;break}}return b?(e-=parseInt(b.offsetLeft,
        10),d-=parseInt(b.offsetTop,10),c=KindleRendererUtils.elementFromPoint(b.contentDocument,e,d),KindleRendererEventHandler.handleClick(b.contentDocument,c,{x:e,y:d})):!1};f.resizeNotification=function(){this.reloadNotification()};f.reloadNotification=function(){this.showSkeletons(this.getCurrentlyVisibleSkeletons())};f.reloadAnnotations=function(){};f.updateGlyphColor=function(){};f.setAnnotationEventCallback=function(){};f.setOverlayManager=function(){};f.copyIframeData=function(){}}var m=-1;return{build:function(k,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              e){k.loadedType={PRELOAD:0,GOTO:1,PAGE_FLIP:2};k.statusType={AVAILABLE:0,RESERVED:1,VISIBLE:2};k.iframes=[];k.iframeStatus=[];k.contentRange=[];k.positionData=[];k.parent=e;for(var d=0;d<6;d+=1)k.iframes[d]=k.createIframe($(e).width(),e.name,d),k.iframeStatus[d]=k.statusType.AVAILABLE,k.contentRange[d]=null,k.positionData[d]=null,e.appendChild(k.iframes[d]);k.currentPosition=0;k.showContent=!0;k.numberOfColumns=1;k.columnGap=20;k.spineColor="transparent";k.spines=[];f(k)}}}(),KindleRendererIframeManagerReflowFactory=
        function(){function f(e){e.getIframeToLoad=function(){return this.iframes[this.hiddenIframeIndex]};e.annotationClickedHandler=function(d){if(this.annotationEventCallback!==void 0){var c=d.currentTarget.parentNode,d=c.getAttribute("annotationType"),c=c.getAttribute("annotationStart");this.annotationEventCallback(d,c)}};e.renderAnnotations=function(d,c){var b=d.contentDocument.getElementById(k);b!==null&&b.parentNode.removeChild(b);if(this.overlayManager&&(b=this.overlayManager.getOverlaysInRange(c.startPosition,
            c.endPosition))&&b.length>0)this.createAnnotationElements(d,b),d.writingMode.forceRepaint(d)};e.frameIsLoadedAndReady=function(d){var c=this,b=c.currentRequest;c.iframeLoadStatus[d.index]=b.type;var g=c.contentRange[d.index];c.renderAnnotations(d,g);var a=this.isStartOfSkeletonLoaded(d.index);b.initialPosition!==null?KindlePaginator.scrollToPosition(d,b.initialPosition,a):KindlePaginator.scrollToTop(d,a);if(!KindlePaginator.isIframePaginationValid(d)){if(c.canRetryCurrentRequest()){c.willRetryCurrentRequest();
            c.resizeWithoutReload(d.index);return}KindlePaginator.clearIframePaginationValidation(d)}if(!KindlePaginator.hasNextScreen(d)&&!KindleRendererFragmentLoader.isPositionAtEndOfSkeletonOrDocument(g.skeletonId,g.endPosition))if(g=g.endPosition-g.startPosition,g<0)c.currentRequestDfd.reject(DATA_LOAD_ERROR);else{KindleRendererPositionLoadingCalculator.updateDisplayedPositionRange(g+1);var e=b.initialPosition;if(e===null)e=KindlePaginator.getCurrentPagePositionRange(d).currentTopOfPage;setTimeout(function(){c.reloadHiddenFrame(e)},
            0)}else b.initialPosition!==null&&d===c.iframes[c.hiddenIframeIndex]&&(c.swapIframes(),this.updateDisplayedPositionsInPage()),b.metrics.endTimer(),b.metrics.log(),c.currentRequest=null,setTimeout(c.currentRequestDfd.resolve,10),d.computingRectsId.id=b.requestId,c.computedRectsDfd[d.index]=c.computeRectsInIframe(c.iframes[d.index],b.requestId),c.computedRectsDfd[d.index].then(function(){c.computedRectsDfd[d.index]=null;d.computingRectsId.id=null;!c.currentRequest&&b.type===c.loadedType.GOTO_POSITION&&
        c.considerLoadingMoreFragments();c=null},function(){c=null})};e.reloadHiddenFrame=function(d){this.loadFragmentsForRange(KindleRendererPositionLoadingCalculator.calculateDesiredFragmentRangeForGoTo(d))};e.gotoPosition=function(d){$(this.iframes[this.visibleIframeIndex].contentDocument.body).find("#"+m).empty();this.createNewRequest(this.loadedType.GOTO_POSITION,d);d=KindleRendererPositionLoadingCalculator.calculateDesiredFragmentRangeForGoTo(d);KindleRendererFragmentLoader.needToLoadFragments(this.contentRange[this.visibleIframeIndex],
            d)?this.loadFragmentsForRange(d):this.resizeWithoutReload(this.visibleIframeIndex);return!1};e.swapIframes=function(){this.iframeLoadStatus[this.visibleIframeIndex]=this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.NEXT?this.loadedType.PREVIOUS:this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.PREVIOUS?this.loadedType.NEXT:this.loadedType.EMPTY;this.iframeLoadStatus[this.hiddenIframeIndex]=this.loadedType.EMPTY;var d=this.visibleIframeIndex;this.visibleIframeIndex=this.hiddenIframeIndex;
            this.hiddenIframeIndex=d;this.setIframeVisibility(this.iframes[this.visibleIframeIndex],!0);this.setIframeVisibility(this.iframes[this.hiddenIframeIndex],!1);this.iframes[this.hiddenIframeIndex].writingMode.resetHeight(this.iframes[this.hiddenIframeIndex])};e.getPagePositionRange=function(){var d=this.contentRange[this.visibleIframeIndex];if(d===null)return null;var c=KindlePaginator.getCurrentPagePositionRange(this.iframes[this.visibleIframeIndex]);if(c.currentTopOfPage===null||c.currentBottomOfPage===
            null)c.currentTopOfPage=d.startPosition,c.currentBottomOfPage=d.endPosition;return c};e.getCurrentPosition=function(){var d=this.getPagePositionRange();return d?d.currentTopOfPage:null};e.getSelectableItemBoundaries=function(){return KindlePaginator.getSelectableItemBoundariesForCurrentScreen(this.iframes[this.visibleIframeIndex])};e.computeRectsInIframe=function(d,c){var b=KindleMetricsProfiler("rects-computation"),g=KindleRendererFragmentLoader.getBookContentType();return d.screenManager.wordMapGenerator.computeWordRects(d.contentDocument,
            d.screenManager.wordMap,d.screenManager.wordMapKeys,d.writingMode,g,c,d.computingRectsId,b)};e.getComputedRectsDfd=function(){return this.computedRectsDfd[this.visibleIframeIndex]};e.getWordPositions=function(){return KindlePaginator.getWordPositionsForCurrentScreen(this.iframes[this.visibleIframeIndex])};e.causeReflowEventInBrowser=function(){var d=this.iframes[this.visibleIframeIndex].contentDocument.getElementsByTagName("html")[0],c=this.iframes[this.visibleIframeIndex].contentDocument.getElementsByTagName("body")[0];
            d.removeChild(c);d.appendChild(c)};e.causeReflowEventInBrowserIfNeeded=function(){if(KindleRendererDeviceSpecific.needsReflowOnPageFlip()){var d=this;setTimeout(function(){d.causeReflowEventInBrowser()},KindleRendererDeviceSpecific.drawYieldUpdateTime())}};e.reloadAnnotations=function(){this.renderAnnotations(this.iframes[this.visibleIframeIndex],this.contentRange[this.visibleIframeIndex]);this.iframes[this.hiddenIframeIndex]!==null&&this.iframeLoadStatus[this.hiddenIframeIndex]!==this.loadedType.EMPTY&&
        this.renderAnnotations(this.iframes[this.hiddenIframeIndex],this.contentRange[this.hiddenIframeIndex])};e.loadNextPages=function(){if(this.iframeLoadStatus[this.hiddenIframeIndex]!==this.loadedType.NEXT&&(this.currentRequest===null||this.currentRequest.type!==this.loadedType.NEXT)){var d=this.contentRange[this.visibleIframeIndex].endPosition+1,c=this.getPagePositionRange(),d=KindleRendererPositionLoadingCalculator.calculateDesiredFragmentRangeForPageFlip(d,c);this.createNewRequest(this.loadedType.NEXT,
            null);this.loadFragmentsForRange(d)}};e.loadPreviousPages=function(){if(this.iframeLoadStatus[this.hiddenIframeIndex]!==this.loadedType.PREVIOUS&&(this.currentRequest===null||this.currentRequest.type!==this.loadedType.PREVIOUS)){var d=this.contentRange[this.visibleIframeIndex].startPosition-1,c=this.getPagePositionRange(),d=KindleRendererPositionLoadingCalculator.calculateDesiredFragmentRangeForPageFlip(d,c);this.createNewRequest(this.loadedType.PREVIOUS,null);this.loadFragmentsForRange(d)}};e.considerLoadingMoreFragments=
            function(d){if(this.canPreloadNext){var c=d!==this.direction.PREVIOUS?4:2;if(KindlePaginator.getApproximateNumNextScreens(this.iframes[this.visibleIframeIndex])<c&&this.hasMoreNextFragments()){this.loadNextPages();return}}this.canPreloadPrevious&&(d=d===this.direction.PREVIOUS?4:2,KindlePaginator.getApproximateNumPreviousScreens(this.iframes[this.visibleIframeIndex])<d&&this.hasMorePreviousFragments()&&this.loadPreviousPages())};e.handleClick=function(d,c){var b=KindleRendererUtils.elementFromPoint(this.iframes[this.visibleIframeIndex].contentDocument,
            d,c);return KindleRendererEventHandler.handleClick(this.iframes[this.visibleIframeIndex].contentDocument,b,{x:d,y:c})};e.crossSkeletonBoundary=function(){var d=this.contentRange[this.visibleIframeIndex],c=this.contentRange[this.hiddenIframeIndex];if(this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.NEXT)if(d.skeletonId+1===c.skeletonId)return KindlePaginator.scrollToTop(this.iframes[this.hiddenIframeIndex],!0),this.swapIframes(),!0;else if(d.skeletonId!==c.skeletonId)return this.iframeLoadStatus[this.hiddenIframeIndex]=
            this.loadedType.EMPTY,!1;if(this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.PREVIOUS)if(d.skeletonId-1===c.skeletonId)return d=this.hiddenIframeIndex,KindlePaginator.scrollToBottom(this.iframes[d],this.isStartOfSkeletonLoaded(d)),this.swapIframes(),!0;else if(d.skeletonId!==c.skeletonId)this.iframeLoadStatus[this.hiddenIframeIndex]=this.loadedType.EMPTY;return!1};e.cleanup=function(){this.cancelCurrentRequest();KindleRendererIframeLoading.cleanupIframe(this.iframes[this.visibleIframeIndex]);
            KindleRendererIframeLoading.cleanupIframe(this.iframes[this.hiddenIframeIndex]);KindlePaginator.cleanupIframe(this.iframes[this.visibleIframeIndex]);KindlePaginator.cleanupIframe(this.iframes[this.hiddenIframeIndex]);this.setOverlayManager(null);this.contentRange=[null,null];this.positionData=[null,null];this.iframes=null};e.hasMoreNextFragments=function(){return this.contentRange[this.visibleIframeIndex].endPosition!==KindleRendererFragmentLoader.getMaximumPosition()};e.hasMorePreviousFragments=
            function(){return this.contentRange[this.visibleIframeIndex].startPosition!==KindleRendererFragmentLoader.getMinimumPosition()};e.isAtEndOfDocumentOrSkeleton=function(){var d=this.contentRange[this.visibleIframeIndex];return KindleRendererFragmentLoader.isPositionAtEndOfSkeletonOrDocument(d.skeletonId,d.endPosition)};e.isAtBeginningOfDocumentOrSkeleton=function(){var d=this.contentRange[this.visibleIframeIndex];return KindleRendererFragmentLoader.isPositionAtBeginningOfSkeletonOrDocument(d.skeletonId,
            d.startPosition)};e.isStartOfSkeletonLoaded=function(d){d=this.contentRange[d];return KindleRendererFragmentLoader.isPositionAtBeginningOfSkeletonOrDocument(d.skeletonId,d.startPosition)};e.needToWaitForLoadToShowNextPage=function(){return!KindlePaginator.isNextFullScreen(this.iframes[this.visibleIframeIndex])&&this.hasMoreNextFragments()};e.needToWaitForLoadToShowPreviousPage=function(){var d=this.visibleIframeIndex;return!KindlePaginator.isPreviousFullScreen(this.iframes[d],this.isStartOfSkeletonLoaded(d))&&
            this.hasMorePreviousFragments()};e.hasNextScreen=function(){return KindlePaginator.hasNextScreen(this.iframes[this.visibleIframeIndex])||this.hasMoreNextFragments()};e.hasPreviousScreen=function(){return KindlePaginator.hasPreviousScreen(this.iframes[this.visibleIframeIndex])||this.hasMorePreviousFragments()};e.updateDisplayedPositionsInPage=function(){var d=KindlePaginator.getCurrentPagePositionRange(this.iframes[this.visibleIframeIndex]);KindleRendererPositionLoadingCalculator.updateDisplayedPositionRange(d.currentBottomOfPage-
            d.currentTopOfPage)};e.considerFlippingFrames=function(){var d=this.iframeLoadStatus[this.hiddenIframeIndex],c=this.currentRequest!==null&&this.currentRequest.type===d;if(d!==this.loadedType.EMPTY&&!c){var c=this.getPagePositionRange(),b=this.contentRange[this.hiddenIframeIndex],g=0,a=0;d===this.loadedType.NEXT?a=1:g=1;if(c.currentTopOfPage>=b.startPosition+g&&c.currentBottomOfPage<=b.endPosition-a)if(KindlePaginator.matchFrames(this.iframes[this.visibleIframeIndex],this.iframes[this.hiddenIframeIndex]),
            d=KindlePaginator.getCurrentPagePositionRange(this.iframes[this.hiddenIframeIndex]),d.currentTopOfPage===c.currentTopOfPage&&d.currentBottomOfPage===c.currentBottomOfPage)return this.swapIframes(),!0;else if(this.needToWaitForLoadToShowNextPage()||this.needToWaitForLoadToShowPreviousPage())throw"Pagination Error";}return!1};e.nextScreen=function(){if(!KindlePaginator.isIframePaginationValid(this.iframes[this.visibleIframeIndex]))return this.gotoPosition(this.getPagePositionRange().currentTopOfPage);
            var d=this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.NEXT;if(d&&this.considerFlippingFrames()===void 0)return!0;var c=this.isAtEndOfDocumentOrSkeleton(),b=KindlePaginator.nextScreen(this.iframes[this.visibleIframeIndex],c);if(!b)if(this.hasMoreNextFragments())if(d&&c&&this.crossSkeletonBoundary())b=!0;else return d=this.getPagePositionRange(),KindleRendererPositionLoadingCalculator.updateDisplayedPositionRange(this.contentRange[this.visibleIframeIndex].endPosition-d.currentBottomOfPage),
                this.loadNextPages(),!1;else KindlePaginator.showEndOfDocument(this.iframes[this.visibleIframeIndex]),b=!0;this.considerLoadingMoreFragments(this.direction.NEXT);this.causeReflowEventInBrowserIfNeeded();this.updateDisplayedPositionsInPage();return b};e.previousScreen=function(){if(!KindlePaginator.isIframePaginationValid(this.iframes[this.visibleIframeIndex]))return this.gotoPosition(this.getPagePositionRange().currentTopOfPage);var d=this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.PREVIOUS;
            if(d&&this.considerFlippingFrames()===void 0)return!0;var c=this.visibleIframeIndex,b=this.isAtBeginningOfDocumentOrSkeleton(),c=KindlePaginator.previousScreen(this.iframes[c],b,this.isStartOfSkeletonLoaded(c));if(!c&&this.hasMorePreviousFragments())if(d&&b&&this.crossSkeletonBoundary())c=!0;else return d=this.getPagePositionRange(),KindleRendererPositionLoadingCalculator.updateDisplayedPositionRange(d.currentTopOfPage-this.contentRange[this.visibleIframeIndex].startPosition),this.loadPreviousPages(),
                !1;this.considerLoadingMoreFragments(this.direction.PREVIOUS);this.causeReflowEventInBrowserIfNeeded();this.updateDisplayedPositionsInPage();return c};e.cancelHiddenIframeLoading=function(){var d=this.iframes[this.hiddenIframeIndex];if(d.processingRequestId.id!==null)d.processingRequestId.id=null,this.cancelCurrentRequest();d.computingRectsId.id=null};e.doGuardedAsyncCopyOf=function(d,c,b){var g=this;c.processingRequestId.id=g.currentRequest.requestId;c.computingRectsId.id=null;KindleRendererIframeLoading.copyIframeContents(g.currentRequest,
            d,c).done(function(a){if(c.processingRequestId.id===a.requestId&&g.currentRequest&&g.currentRequest.requestId===a.requestId)g.addClickHandlers(c),c.processingRequestId.id=null,b()})};e.copyIframeDataOf=function(d){var c=this;c.cancelHiddenIframeLoading();c.createNewRequest(c.loadedType.GOTO_POSITION,null);c.doGuardedAsyncCopyOf(d.iframes[d.visibleIframeIndex],c.iframes[c.visibleIframeIndex],function(){c.contentRange[c.visibleIframeIndex]=jQuery.extend({},d.contentRange[d.visibleIframeIndex]);c.positionData[c.visibleIframeIndex]=
            jQuery.extend({},d.positionData[d.visibleIframeIndex]);var b=c.iframes[c.hiddenIframeIndex],g=d.iframes[d.hiddenIframeIndex];d.iframeLoadStatus[d.hiddenIframeIndex]!==d.loadedType.EMPTY&&g.processingRequestId.id===null?c.doGuardedAsyncCopyOf(g,b,function(){c.contentRange[c.hiddenIframeIndex]=jQuery.extend({},d.contentRange[d.hiddenIframeIndex]);c.positionData[c.hiddenIframeIndex]=jQuery.extend({},d.positionData[d.hiddenIframeIndex]);c.iframeLoadStatus[c.visibleIframeIndex]=d.iframeLoadStatus[d.visibleIframeIndex];
            c.iframeLoadStatus[c.hiddenIframeIndex]=d.iframeLoadStatus[d.hiddenIframeIndex];c.currentRequestDfd.resolve()}):(c.iframeLoadStatus=[c.loadedType.EMPTY,c.loadedType.EMPTY],c.currentRequestDfd.resolve())});return c.currentRequestDfd.isResolved()};e.recreateFrame=function(d){var c=this.iframes[d],b=c.writingMode.width(c),g=c.parentNode,a=c.pageOverflowDiv;g.removeChild(c);c=this.createIframe(b,this.parentName,c.index);c.pageOverflowDiv=a;g.appendChild(c);g.appendChild(a);this.iframes[d]=c};e.copyIframeData=
            function(d){if(!(this.contentRange[this.visibleIframeIndex]===null||d.contentRange[d.visibleIframeIndex]===null?this.contentRange[this.visibleIframeIndex]===d.contentRange[d.visibleIframeIndex]:this.contentRange[this.visibleIframeIndex].startPosition===d.contentRange[d.visibleIframeIndex].startPosition&&this.contentRange[this.visibleIframeIndex].endPosition===d.contentRange[d.visibleIframeIndex].endPosition))return KindleRendererDeviceSpecific.needsReflowOnPageFlip()&&(this.recreateFrame(0),this.recreateFrame(1),
                this.setIframeVisibility(this.iframes[this.visibleIframeIndex],!0)),this.copyIframeDataOf(d);var c=this.iframes[this.visibleIframeIndex],d=d.iframes[d.visibleIframeIndex];c.currentTopOfScreen=d.currentTopOfScreen;c.currentBottomOfScreen=d.currentBottomOfScreen;return!0};e.updateSettingsInIframe=function(d){if(d&&d.contentDocument){var c=d.contentDocument.getElementById(m);c&&d.contentDocument.body.removeChild(c);KindleRendererIframeLoading.updateSettingsInIframe(d);c&&d.contentDocument.body.appendChild(c)}};
            e.updateSettings=function(){var d=KindleRendererSettings.getSettings().backgroundColor;$(this.iframes[this.visibleIframeIndex].pageOverflowDiv).css({"background-color":d});$(this.iframes[this.hiddenIframeIndex].pageOverflowDiv).css({"background-color":d});this.updateSettingsInIframe(this.iframes[this.visibleIframeIndex]);this.updateSettingsInIframe(this.iframes[this.hiddenIframeIndex])};e.reloadNotification=function(){this.contentRange=[null,null];this.positionData=[null,null];this.resizeNotification()};
            e.resizeNotification=function(){this.cancelHiddenIframeLoading();this.iframeLoadStatus=[this.loadedType.EMPTY,this.loadedType.EMPTY];var d=this.iframes[this.visibleIframeIndex];d.writingMode.resetIframeDimensions(d);d=this.iframes[this.hiddenIframeIndex];d.writingMode.resetIframeDimensions(d)};e.updateGlyphColorForFrameIndex=function(d){this.iframes[d].hasGlyphs&&this.iframes[d].contentDocument&&KindleGlyphRenderer.updateTextColor(this.iframes[d])};e.updateGlyphColor=function(){this.updateGlyphColorForFrameIndex(this.visibleIframeIndex);
                this.updateGlyphColorForFrameIndex(this.hiddenIframeIndex)};e.setAnnotationEventCallback=function(d){this.annotationEventCallback=d};e.getContentRects=function(){var d=this.iframes[this.visibleIframeIndex],c=this.getIframeOrigin(this.visibleIframeIndex),d={left:c.x,top:c.y,width:$(d).width(),height:$(d).height()};d.right=d.left+d.width;d.bottom=d.top+d.height;return[d]};e.getZoomableAt=function(d,c,b){var g=this.iframes[this.visibleIframeIndex];return!KindlePaginator.isPointOnVisiblePage(g,c-d.x,
                b-d.y)?null:KindleRendererZoomablesFactory.buildFromCoord(g.contentDocument,d,c,b)};e.getZoomableList=function(d){return KindleRendererZoomablesFactory.buildList(this.iframes[this.visibleIframeIndex].contentDocument,d)};e.addClickHandlers=function(d){var c=this,d=d.contentDocument.getElementById(k),d=$(d).find("["+KindleRendererAnnotationRenderer.ANNOTATION_CLICK_ATTRIBUTE+"='true']").children();$(d).unbind("click");$(d).click(function(b){c.annotationClickedHandler(b)})};e.createAnnotationElements=
                function(d,c){if(d.contentDocument.getElementsByTagName("body")[0]){var b=KindlePaginator.getWordMap(d),g=d.contentDocument.createDocumentFragment();KindleRendererAnnotationRenderer.createAnnotationElements(d,b,d.screenManager.wordMapGenerator,c,g);b=d.contentDocument.getElementById(k);if(!b){var a=d.contentDocument.getElementById(m),b=d.contentDocument.createElement("DIV");b.id=k;b.setAttribute("class","kindle-annotation-wrapper");a.appendChild(b)}b.appendChild(g);this.addClickHandlers(d)}};e.addAnnotation=
                function(d,c,b){d&&c&&b&&c.startPosition<=b.end&&b.start<=c.endPosition&&(this.createAnnotationElements(d,[b]),d.writingMode.forceRepaint(d))};e.removeAnnotation=function(d,c){if(d&&c){var b=d.contentDocument.getElementById(k);b&&(KindleRendererAnnotationRenderer.removeAnnotationElements(b,c),d.writingMode.forceRepaint(d))}};e.onOverlayAdded=function(d){e.addAnnotation(e.iframes[0],e.contentRange[0],d.overlay);e.addAnnotation(e.iframes[1],e.contentRange[1],d.overlay)};e.onOverlayRemoved=function(d){e.removeAnnotation(e.iframes[0],
                d.overlay);e.removeAnnotation(e.iframes[1],d.overlay)};e.setOverlayManager=function(d){this.overlayManager&&(this.overlayManager.removeEventListener(this.overlayManager.OVERLAY_ADDED_EVENT,this.onOverlayAdded),this.overlayManager.removeEventListener(this.overlayManager.OVERLAY_REMOVED_EVENT,this.onOverlayRemoved));if(this.overlayManager=d)this.overlayManager.addEventListener(this.overlayManager.OVERLAY_ADDED_EVENT,this.onOverlayAdded),this.overlayManager.addEventListener(this.overlayManager.OVERLAY_REMOVED_EVENT,
                this.onOverlayRemoved)};e.show=function(){this.showContent=!0;this.setIframeVisibility(this.iframes[this.visibleIframeIndex],!0)};e.hide=function(){this.showContent=!1;this.setIframeVisibility(this.iframes[this.visibleIframeIndex],!1)};e.drawWordMap=function(){var d=this.iframes[this.visibleIframeIndex];drawWordMap(d,d.screenManager,d.contentDocument.body)};e.drawHeightMaps=function(){drawHeightMaps(this.iframes[this.visibleIframeIndex],this.iframes[this.hiddenIframeIndex])}}var m="content-overlays",
            k="annotation-section";return{build:function(e,d){for(var c=[],b=0;b<2;b+=1){c[b]=e.createIframe($(d).width(),d.name,b);d.appendChild(c[b]);var g=c[b],a=d,l=b,h=document.createElement("div");h.setAttribute("id",a.name+"_page_overflow_"+l);$(h).css({position:"absolute",visibility:"hidden","z-index":1});a.appendChild(h);g.pageOverflowDiv=h}e.loadedType={EMPTY:0,GOTO_POSITION:1,NEXT:2,PREVIOUS:3};e.direction={NEXT:2,PREVIOUS:3};e.iframes=c;e.parentName=d.name;e.iframeLoadStatus=[e.loadedType.EMPTY,e.loadedType.EMPTY];
                e.contentRange=[null,null];e.positionData=[null,null];e.computedRectsDfd=[null,null];e.visibleIframeIndex=0;e.hiddenIframeIndex=1;e.overlayManager=null;f(e)}}}(),KindleRendererIframePreparation=function(){function f(d,c,b,g){KindleRendererSettings.useCSSRegions()?g.resolve(c):KindleRendererContentReflow.reflow(d,c,b).then(function(){g.resolve(c)},function(){g.reject(c,"reflow took too long")})}function m(d,c,b,g,a,l){a!==e&&KindleRendererCanvasInsertion.changeSpanToCanvas(d.id,d.contentDocument,b.contentRange,
    a===k);d.hasGlyphs=g.glyphData!==void 0&&b.glyphData!==void 0;d.hasGlyphs?KindleGlyphRenderer.renderAllContent(d,c,g.glyphData,b.glyphData).then(function(){f(d,c,g.positionData,l)},function(){l.reject(c,"glyph rendering took too long")}):(g.glyphData=null,f(d,c,g.positionData,l))}var k=-1,e=0;return{CANVAS_INSERTION_PREVIOUS:k,CANVAS_INSERTION_NONE:e,CANVAS_INSERTION_NEXT:1,prepareIframe:function(d,c,b,g,a){var e=new jQuery.Deferred;if(d.processingRequestId.id===c.requestId){var h=d.contentDocument.getElementById("content-overlays");
            if(!h)h=d.contentDocument.createElement("DIV"),h.id="content-overlays",d.contentDocument.body.appendChild(h);m(d,c,b,g,a,e)}else e.reject();return e.promise()}}}(),KindleRendererColumnManager=function(){function f(){for(var a=0;a<v;a++)u[a].hide()}function m(a){if(E||C){if(a<=y)throw{name:"pagingError",message:"Repeating wait request"};y=a;w<0&&(x.waitNotification&&x.waitNotification(),C=!0,f());w=a}}function k(a){if((E||C)&&w>=0&&w<=a){F=0;w=-1;if(C){for(a=0;a<v;a++)u[a].show();E=!0;C=!1}x.readyNotification&&
    x.readyNotification()}}function e(a){if(w===-1)if(a<v){var b=u[a].getComputedRectsDfd();b?(x.rectsWaitNofification&&x.rectsWaitNofification(),b.then(function(){e(a+1)},function(a){x.rectsErrorNotification&&x.rectsErrorNotification(a)})):e(a+1)}else x.rectsReadyNotification&&x.rectsReadyNotification()}function d(a){return a>v*G?(x.errorNotification&&x.errorNotification("Irrecoverable Error"),!0):!1}function c(a,b,c){w<=a&&(b!==KindleRendererIframeManagerFactory.DATA_LOAD_ERROR&&F<I?(++F,s(),p(c)):
    (x.errorNotification&&x.errorNotification(b),w=-1))}function b(a,g){try{if(d(g))return!1;if(u[a].copyIframeData(u[a===0?v-1:a-1])){var l=u[a].nextScreen(),h=a+1;if(l){if(h<v)return b(h,g+1);e(0);return!0}}var f=u[a].getCurrentProcessId();m(f);u[a].getCurrentProcessDfd().then(function(){b(a,g+1)&&(k(f),e(0))},function(a){c(f,a,g)})}catch(j){p(g)}return!1}function g(l,h){try{if(d(h))return!1;var f=u[l===v-1?0:l+1];if(!f.hasPreviousScreen())return a(0,h),!1;if(u[l].copyIframeData(f)){var j=u[l].previousScreen(),
    f=l-1;if(j)return f>=0?g(f,h+1):b(1,h)}var n=u[l].getCurrentProcessId();m(n);u[l].getCurrentProcessDfd().then(function(){g(l,h+1)&&(k(n),e(0))},function(a){c(n,a,h)})}catch(o){p(h)}return!1}function a(a,d,g){var l;u[0].gotoPosition(a,g)?(l=KindleRendererRequestId.getUniqueRequestId(),m(l),k(l),e(0)):(l=u[0].getCurrentProcessId(),m(l),a=u[0].getCurrentProcessDfd(),v===1?a.then(function(){k(l);e(0)},function(a){c(l,a,d)}):a.then(function(){b(1)&&(k(l),e(0))},function(a){c(l,a,d)}));return!1}function l(){try{if(v===
    1){var a=u[0].nextScreen();if(a)e(0);else{var d=u[0].getCurrentProcessId();m(d);u[0].getCurrentProcessDfd().then(function(){l();k(d);e(0)},function(a){c(d,a,0)})}return a}else return b(0,0)}catch(g){return p(0),!1}}function h(){try{if(v===1){var a=u[0].previousScreen();if(a)e(0);else{var b=u[0].getCurrentProcessId();m(b);u[0].getCurrentProcessDfd().then(function(){h();k(b);e(0)},function(a){c(b,a,0)})}return a}else return g(v-1,0)}catch(d){return p(0),!1}}function j(a){for(;a<v;a++)u[a].reloadNotification()}
        function n(){var a=u[0].getCurrentPosition();a!==null&&(H=a)}function p(b){n();j(0);a(H,b)}function o(a){if(t&&a&&a.length>0){var b=document.getElementById("renderer_translation_div");if(!b)b=document.createElement("div"),b.id="renderer_translation_div",$(b).css({visibility:"hidden","z-index":-1E3}),t.appendChild(b);$(b).css({margin:a});a=window.getComputedStyle(b);return{top:parseFloat(a.marginTop),bottom:parseFloat(a.marginBottom),left:parseFloat(a.marginLeft),right:parseFloat(a.marginRight)}}return{top:0,
            bottom:0,left:0,right:0}}function q(){var a=KindleRendererSettings.getSettings().inlineBaseDirection,b=a&&a.value===a.VERTICAL,a=o(z),c,d;b?(a={top:a.left,right:a.bottom,bottom:a.right,left:a.top},c=$(t).height(),d=$(t).width()):(c=$(t).width(),d=$(t).height());return{margins:a,parentWidth:c,parentHeight:d,getStyle:function(a){return b?{top:a.left,left:a.top,width:a.height,height:a.width}:a}}}function s(){v=Math.max(v,1);for(var a=q(),b=a.parentHeight,c=a.margins,d=D-(c.left+c.right),g=parseInt((a.parentWidth-
        d*(v-1))/v,10),e=c.top,b=b-c.top-c.bottom,c=0;c<v;c++){if(A[c]===void 0)A[c]=document.createElement("div"),A[c].name="column_"+c,$(A[c]).css("position","absolute"),t.appendChild(A[c]);var l=a.getStyle({top:e,left:c*(g+d),height:b,width:g});l.display="";$(A[c]).css(l);u[c]===void 0&&(u[c]=KindleRendererIframeManagerFactory.build(A[c]),u[c].setAnnotationEventCallback(x.annotationTriggered),u[c].setOverlayManager(M));u[c].setCanPreloadPrevious(c===0);u[c].setCanPreloadNext(c===v-1)}for(c=v;c<A.length;c++)$(A[c]).hide();
            E||f()}function r(a){a=$(A[a]);return{x:parseInt(a.css("left"),10),y:parseInt(a.css("top"),10)}}var x={},w=-1,y=-1,t=null,z=0,D=20,v=0,A=[],u=[],H=0,M,E=!0,C=!1,I=3,F=0,G=20;return{initialize:function(a,b,c,d){t=a;x=b;M=c;d>0&&(H=d);s()},cleanup:function(){for(var a=0;a<u.length;a++)u[a].cleanup()},hide:function(){f();C=E=!1},show:function(){C=!0},updateSettings:function(a){if(a.columns!==void 0)if(KindleRendererSettings.getSettings().fixedContent)v=1,D=0;else{if(a.columns.num!==void 0)v=a.columns.num;
                a.columns.gap!==void 0&&(D=parseInt(a.columns.gap,10))}if(a.margin!==void 0)z=a.margin;if(t!==null){s();for(var b=a.fontSizes!==void 0||a.lineSpacingMultiplier!==void 0||a.fontSizeUnits!==void 0||a.fontFamily!==void 0||a.margin!==void 0||a.columns!==void 0||a.textAlign!==void 0,c=0;c<v;c++)u[c].updateSettings(a),!b&&a.fontColor!==void 0&&u[0].updateGlyphColor();b&&(E?p(0):j(0))}},gotoPosition:function(b,c){return a(b,0,c)},nextScreen:function(){return l()},previousScreen:function(){return h()},hasNextScreen:function(){return u[v-
            1].hasNextScreen()},hasPreviousScreen:function(){return u[0].hasPreviousScreen()},getPagePositionRange:function(){var a;a=u[0].getPagePositionRange();if(v!==1){var b=u[v-1].getPagePositionRange();a={currentTopOfPage:a.currentTopOfPage,currentBottomOfPage:b.currentBottomOfPage}}return a},getSelectableItemBoundaries:function(){for(var a={},b=0;b<v;b++){var c=$(A[b]),d=parseFloat(c.css("top")),c=parseFloat(c.css("left")),g=u[b].getSelectableItemBoundaries(),e;for(e in g){a[e]=[];for(var l=g[e],h=0;h<
            l.length;h++)a[e].push({top:l[h].top+d,bottom:l[h].bottom+d,left:l[h].left+c,right:l[h].right+c})}}return a},getWordPositions:function(){for(var a=[],b=0;b<v;b++){var c=u[b].getWordPositions();c&&(a=a.concat(c))}return a.length?a:null},onWindowResize:function(){s();n();u[0].resizeNotification();j(1);a(H,0)},handleClick:function(a,b){for(var c=0;c<v;c++){var d=$(A[c]),g=a-parseInt(d.css("left"),10),d=b-parseInt(d.css("top"),10);if(u[c].handleClick(g,d))return!0}return!1},reloadAnnotations:function(){for(var a=
                0;a<v;a++)u[a].reloadAnnotations()},getContentRects:function(){for(var a=[],b=0;b<v;b++){for(var c=u[b].getContentRects(),d=r(b),g=0;g<c.length;g++)c[g].left+=d.x,c[g].right+=d.x,c[g].top+=d.y,c[g].bottom+=d.y;a=a.concat(c)}return a},getZoomableAt:function(a,b){for(var c=0;c<v;c++){var d=r(c);if(d=u[c].getZoomableAt(d,a,b))return d}return null},getZoomableList:function(){for(var a=[],b=0;b<v;b++)var c=r(b),c=u[b].getZoomableList(c),a=a.concat(c);return a}}}(),KindleRendererContentDisplay=function(){function f(a){c=
        document.createElement("DIV");$(c).css({position:"absolute",top:0,left:0});a.appendChild(c);b=document.createElement("DIV");var d=$(b);d.css({position:"absolute",top:0,left:0});KindleRendererSettings.useCSSRegions()&&d.css({height:"100%",width:"100%"});a.appendChild(b);m()}function m(){if(!KindleRendererSettings.useCSSRegions()){if(c){var a=$(c.parentNode);$(c).css({width:a.width(),height:a.height()})}b&&(jContentDivParentNode=$(b.parentNode),$(b).css({width:jContentDivParentNode.width(),height:jContentDivParentNode.height()}))}}
        function k(a){d!==a&&(d.hide(),d=a,d.show())}var e=null,d,c=null,b=null,g=!1;return{initialize:function(a,l,h,j,n){var p=new jQuery.Deferred;d=e=KindleRendererSettings.useCSSRegions()?KindleRegionContentManager:KindleRendererColumnManager;f(a);KindleRendererCover.initialize(c,l,h);e.initialize(b,l,j,n);KindleRendererContentReflow.initialize();h.hasCover(function(a){g=a;p.resolve()},p.resolve);return p.promise()},cleanup:function(){KindleRendererCover.cleanup();e.cleanup();b=c=d=null},updateSettings:function(a){e&&
            (m(),KindleRendererCover.onWindowResize(),e.updateSettings(a))},gotoPosition:function(a,b){a=parseInt(a,10);a=Math.max(a,0);g&&a===0?(k(KindleRendererCover),KindleRendererCover.showCover()):(k(e),a=Math.min(a,KindleRendererFragmentLoader.getMaximumPosition()));return e.gotoPosition(a,b)},nextScreen:function(){if(d===KindleRendererCover)return k(e),e.gotoPosition(0);else if(d.hasNextScreen())return d.nextScreen();return!0},previousScreen:function(){if(d===e)if(d.hasPreviousScreen())return d.previousScreen();
            else g&&(k(KindleRendererCover),KindleRendererCover.showCover());return!0},hasNextScreen:function(){return d.hasNextScreen()},hasPreviousScreen:function(){return g?d!==KindleRendererCover:d.hasPreviousScreen()},getPagePositionRange:function(){return d.getPagePositionRange()},getSelectableItemBoundaries:function(){return d.getSelectableItemBoundaries()},getWordPositions:function(){return d.getWordPositions()},onWindowResize:function(){m();KindleRendererCover.onWindowResize();e.onWindowResize()},handleClick:function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    b){return d.handleClick(a,b)},reloadAnnotations:function(){d.reloadAnnotations()},getContentRects:function(){return d.getContentRects()},getZoomableAt:function(a,b){return d.getZoomableAt(a,b)},getZoomableList:function(){return d.getZoomableList()},clearSelection:function(){e.clearSelection&&e.clearSelection()},getSelection:function(){if(e.getSelection)return e.getSelection()}}}(),KindleRendererCover=function(){function f(a){function d(){++x;x===r&&(k(b),e(b))}var l=a.data||a,h=a.metadata,a=l.split("resources")[0],
    f=KindleRendererImageRenderer.getCoverImageSlices();if(j=f!==void 0&&f!==null){b=c.ownerDocument.createElement("DIV");for(var l=$(b),r=f.length,x=0,w=0,y=0,t=0;t<r;t++)w=c.ownerDocument.createElement("IMG"),$(w).width(f[t].width),$(w).height(f[t].height),w.onload=d,w.src=a+f[t].name,$(w).appendTo(l),y+=f[t].height;w=f[0].width;$(b).width(w);$(b).height(y);$(b).css("visibility","hidden")}else b=c.ownerDocument.createElement("IMG"),b.src=l,$(b).css("visibility","hidden"),b.onload=function(){h&&h.map?
    ($(this).css("display","none"),g=KindleRendererImageRenderer.createCanvasImage(this,h.map),g=m(this.parentNode,g),$(this).after(g)):k(this);e(this)};c.appendChild(b)}function m(a,b){var c=$(a),d=c.width(),g=c.height(),e=Math.min(d/b.width,g/b.height),c=b.width*e;e*=b.height;d=Math.round((d-c)*0.5);g=Math.round((g-e)*0.5);$(b).css({top:g+"px",left:d+"px",height:e+"px",width:c+"px",position:"absolute"});return b}function k(a){if(!(a===null||a===void 0)){var b=$(a),d=$(b.parent()),g=d.width(),e=d.height();
        b.css("visiblity","hidden");var l=1,d=a.offsetWidth,h=a.offsetHeight;d>0&&h>0?(b.attr("nativeWidth")===void 0&&b.attr("nativeWidth",d),b.attr("nativeHeight")===void 0&&b.attr("nativeHeight",h)):(d=b.attr("nativeWidth")||g,h=b.attr("nativeHeight")||e);l=Math.min(g/d,e/h);d*=l;l*=h;g=Math.round((g-d)*0.5);e=Math.round((e-l)*0.5);j?(b=c.ownerDocument.createElement("IMG"),$(b).css({width:d+"px",height:l+"px",position:"absolute",left:g+"px",top:e+"px"}),KindleRendererImageRenderer.scaleImageSlices(b,a,
        !1),$(b).remove()):b.css({height:l+"px",width:d+"px",position:"absolute",left:g+"px",top:e+"px"});$(a).css("visibility","visible")}}function e(){h=!0;a.readyNotification&&a.readyNotification();a.rectsReadyNotification&&a.rectsReadyNotification()}function d(b){a.errorNotification&&a.errorNotification(b)}var c=null,b=null,g=null,a=null,l=null,h=!1,j=!1;return{initialize:function(b,d,g){c=b;a=d;l=g},cleanup:function(){l=a=b=c=null;j=h=!1},hide:function(){$(c).hide()},show:function(){$(c).show()},showCover:function(){h?
        (a.readyNotification&&a.readyNotification(),a.rectsReadyNotification&&a.rectsReadyNotification()):(a.waitNotification&&a.waitNotification(),l.getCoverUrl(f,d))},nextScreen:function(){return!0},previousScreen:function(){return!0},hasNextScreen:function(){return!0},hasPreviousScreen:function(){return!1},getPagePositionRange:function(){return{currentTopOfPage:0,currentBottomOfPage:0}},getSelectableItemBoundaries:function(){var a={};if(b&&b.getBoundingClientRect){var c=b.getBoundingClientRect();c&&(a[0]=
            [{left:c.left,top:c.top,right:c.right,bottom:c.bottom}])}return a},getWordPositions:function(){return null},onWindowResize:function(){g?m(g.parentNode,g):k(b)},handleClick:function(){return!1},reloadAnnotations:function(){},getContentRects:function(){var a=$(b),a={left:parseInt(a.css("left"),10),top:parseInt(a.css("top"),10),width:a.width(),height:a.height()};a.right=a.left+a.width;a.bottom=a.top+a.height;return[a]},getZoomableAt:function(){return b?KindleRendererZoomableReflowableContentFactory.buildFromElement(b,
        {x:0,y:0}):null},getZoomableList:function(){return[]}}}(),KindleRendererElementFitting=function(){function f(a){return(a.getAttribute("style")||"")+";"}function m(a,b,c,d){var g=0,e=g=0;a>c&&(g=c/a);b>d&&(e=d/b);g=g>0&&e>0?g<e?g:e:g>0?g:e;g!==0&&(a=g*parseInt(a,10),b=g*parseInt(b,10),b=Math.max(1,b),a=Math.max(1,a));return{height:a,width:b,scale:g}}function k(a){var b=a.getAttribute("data-isGaiji");if(b)return b==="true";var b=parseInt($(a).css("width"),10),c=parseInt($(a).css("height"),10),d=parseInt($(a).css("font-size"),
    10);if(Math.abs(b-d)<=1&&Math.abs(c-d)<=1)return a.setAttribute("data-isGaiji","true"),!0;a.setAttribute("data-isGaiji","false");return!1}function e(a,b){for(var c={neededCount:0,downloadedCount:0},d=function(){c.downloadedCount+=1;c.downloadedCount===c.neededCount&&setTimeout(b,KindleRendererDeviceSpecific.drawYieldUpdateTime())},g=0;g<a.length;g+=1)if(a[g].src!==""&&(a[g].complete!==void 0&&a[g].complete===!1||a[g].naturalHeight===0&&a[g].naturalWidth===0))c.neededCount+=1,a[g].onerror=d,a[g].onload=
        d,a[g].onabort=d;c.neededCount===0&&setTimeout(b,KindleRendererDeviceSpecific.drawYieldUpdateTime())}function d(a,b){var c=a.getElementsByTagName("IMG");c.length>0?e(c,b):b()}function c(c,e,n,p){var o=new jQuery.Deferred,q,s,r=function(){q=p.createSubTimer("element-fitting");if($(c).css("position")==="absolute")KindleRendererImageRenderer.scaleCompositeInlineImages(c),o.resolve();else{var d=c.getElementsByTagName("IMG");if(d.length>0){var r;for(r=0;r<d.length;r+=1){var y=d[r],t=y,z=$(t),D=z.css("max-height"),
    z=z.css("max-width"),D=D!=="auto"&&D!=="none",z=z!=="auto"&&z!=="none";if(D||z){var v=f(t);D&&(v+="max-height: none; ");z&&(v+="max-width: none; ");t.setAttribute("style",v)}t=y;t.getAttribute("data-nativeHeight")||t.setAttribute("data-nativeHeight",t.height);t.getAttribute("data-nativeWidth")||t.setAttribute("data-nativeWidth",t.width);t.getAttribute("data-nativeLeftOffset")||t.setAttribute("data-nativeLeftOffset",t.offsetLeft);t.getAttribute("data-nativeTopOffset")||t.setAttribute("data-nativeTopOffset",
    t.offsetTop);t=y;if(t.className.indexOf("unsupsvg")>=0&&(t.src=a,t.height=t.getAttribute("data-nativeHeight"),t.width=t.getAttribute("data-nativeWidth"),t.height===0||t.width===0))t.height=l,t.width=l,t.setAttribute("data-nativeHeight",t.height),t.setAttribute("data-nativeWidth",t.width);t=y;v=e.getAvailableSizeForImage(t,n,b);z=parseInt(t.getAttribute("data-nativeWidth"),10)||t.naturalWidth;D=parseInt(t.getAttribute("data-nativeHeight"),10)||t.naturalHeight;if(!z||!D)KindleDebug.warn("Defaulting image width/height. It'll be scaled down to fit."),
        D=z=1E3;var z=m(D,z,v.height,v.width),D=z.height,z=z.width,A=t,u=D,s=z,M=v.height,E=v.width,v={},C=0,I=parseInt($(A).css("padding-top"),10),F=parseInt($(A).css("padding-bottom"),10),G=I+F;if(G+u>M)C=u+G-M,u=Math.ceil(I/G*C),C-=u,v.top=I-u,v.bottom=F-C;I=parseInt($(A).css("padding-left"),10);A=parseInt($(A).css("padding-right"),10);F=I+A;if(F+s>E)C=s+F-E,s=Math.ceil(I/F*C),E=C-s,v.left=I-s,v.right=A-E;s=f(t);s+="height: "+D+"px; width: "+z+"px; ";s+=(v.top!==void 0?"padding-top: "+v.top+"px; ":"")+
    (v.bottom!==void 0?"padding-bottom: "+v.bottom+"px; ":"")+(v.left!==void 0?"padding-left: "+v.left+"px; ":"")+(v.right!==void 0?"padding-right: "+v.right+"px; ":"");t.setAttribute("style",s);k(y)||e.padImageIfNeeded(y)}y=e.calculateOverlappingImageSets(d,k);for(t=g;t>0&&y.length>0;){for(r=0;r<y.length;r+=1)if(z=y[r],D=z.imgs,z=m(z.height,z.width,n.height*b,n.width*b).scale,z!==0){E=s=v=void 0;for(C=0;C<D.length;C+=1)v=D[C],s=v.height*z,E=v.width*z,s<1||E<1||(A=f(v),A+="height: "+s+"px; width: "+E+
    "px;",v.setAttribute("style",A))}--t;y=e.calculateOverlappingImageSets(d,k)}}if(e.getWritingMode()!=="vertical"){d=c.getElementsByTagName("TABLE");for(r=0;r<d.length;r++){y=d[r];v=n;D=t=0;z=parseInt(y.getAttribute("data-nativeWidth"),10);v=v.parentWidth||v.width;z||(z=$(y).width(),y.setAttribute("data-nativeWidth",z));s=Math.min(parseInt(y.getAttribute("data-nativeLeftOffset"),10),y.offsetLeft);if(!s)s=y.offsetLeft,y.setAttribute("data-nativeLeftOffset",s);E=$(y.offsetParent).width()||v;E=Math.min(E-
    s,v*b);z>E&&(D=E/z);D>0&&(t=D);t!==0&&(D="scale("+t+")",t=f(y),t+=" -moz-transform: "+D+"; -webkit-transform:"+D+"; -o-transform:"+D+"; -ms-transform:"+D+"; ms-transform:"+D+"; transform:"+D+"; ",D=$(y).css("float"),z="top ",z+=D==="right"?"right":"left",t+=" -moz-transform-origin: "+z+"; -webkit-transform-origin: "+z+"; -o-transform-origin: "+z+"; -ms-transform-origin: "+z+"; ms-transform-origin: "+z+"; transform-origin: "+z+"; ",y.setAttribute("style",t))}}setTimeout(o.resolve,10)}};(window.ActiveXObject||
    "ActiveXObject"in window)&&window.XMLHttpRequest?$(c.ownerDocument).ready(r):(s=p.createSubTimer("(WAIT) image-loading"),d(c,function(){s.endTimer();r()}));return o.promise().then(function(){q.endTimer()})}var b=0.95,g=3,a="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' version='1.1' viewBox='0 0 100 100'><g><rect x='1%' y='1%' rx='20' ry='20' width='98%' height='98%' style='fill:white; stroke:gray;stroke-width:2;'></rect><text x='50%' y='50%' fill='black' font-size='8px' style='text-anchor: middle; dominant-baseline: central;'>Image Not Supported</text></g></svg>",
    l=200;return{fitToViewport:function(a,b,d,g){return c(a,b,d,g)},resize:function(a,b){var c;if($(a).css("position")==="absolute")if(b.width>0&&b.height>0){c=a.offsetWidth>0&&a.offsetHeight>0?Math.min(b.width/a.offsetWidth,b.height/a.offsetHeight):1;var d="scale("+c+")";$(a).css({"-moz-transform":d,"-moz-transform-origin":"left top","-webkit-transform":d,"-webkit-transform-origin":"left top","-o-transform":d,"-o-transform-origin":"left top","ms-transform":d,"ms-transform-origin":"left top","-ms-transform":d,
            "-ms-transform-origin":"left top",transform:d,"transform-origin":"left top"});c={width:$(a).width()*c,height:$(a).height()*c}}else c=void 0;return c}}}(),KindleRendererImageRenderer=function(){function f(a,b){for(var c=b.length,d=document.createElement("canvas"),g=0,e=0,l=0;l<c;l+=6)g=Math.max(g,b[l+1]+b[l+5]),e=Math.max(e,b[l]+b[l+4]);d.height=g;d.width=e;m(a,b,d);$(d).css({height:"100%",width:"auto"});return d}function m(a,b,c){for(var d,g,e,l,h,f=b.length,j=c.getContext("2d"),n=0;n<f;n+=6)c=b[n],
        d=b[n+1],g=b[n+2],e=b[n+3],l=b[n+4],h=b[n+5],j.drawImage(a,g,e,l,h,c,d,l,h)}function k(a){function b(a,c){return parseInt(a.name.match(q),10)-parseInt(c.name.match(q),10)}for(var c in a){var d=a[c].parent;if(p[d]===void 0||p[d]===null)p[d]=[];p[d].push({name:a[c].name,width:a[c].width,height:a[c].height})}for(c in p)p[c].sort(b)}function e(a,b,c,d){var g=b&&b.metadata||c&&c.metadata;if(g&&g.map){$(a).css("display","none");var e,l=function(){a.parentNode&&(e?m(a,g.map,e):(e=f(a,g.map),$(a.parentNode).append(e)))},
    h=KindleHostDeviceDetector.hasMissingImgOnLoadProblem&&KindleHostDeviceDetector.hasMissingImgOnLoadProblem();if(h)var j=s.map(function(a){return setTimeout(l,a)});a.onload=function(){l();h&&j.forEach(function(a){clearTimeout(a)})}}else KindleHostDeviceDetector.hasImageRenderingProblem&&KindleHostDeviceDetector.hasImageRenderingProblem()&&$(a).attr("data-repaint-on-show","1");if(b&&b[d])a.src=b[d];else if(c&&c[d])a.src=c[d]}function d(a){a=a.split("url(")[1].split(")")[0].split("resources");bgImgFilepath=
        a[0];bgImgResourceName="resources"+a[a.length-1];return{bgImgFilepath:bgImgFilepath,bgImgResourceName:bgImgResourceName}}function c(a,b,c){var d=0;a.substring(a.length-1,a.length)==="%"?d=b!==0?parseFloat(a)/100*c/b:1:a.substring(a.length-2,a.length)==="px"?(c=0,c=parseFloat(a),d=b!==0?c/b:1):d=1;return d}function b(a,b,d,g){var e=b.css("background-size").split(",")[0].trim().split(" "),l,h=!1,f=!1;e[0]==="auto"?e=l="100%":e[0]==="cover"?(h=!0,e=l="100%"):e[0]==="contain"?(f=!0,e=l="100%"):e.length===
    1?(l=e[0],e="100%"):(l=e[0],e=e[1]);a.w=c(l,d,b.width());a.h=c(e,g,b.height());if(h)b=a.w>a.h?a.w:a.h,a.w=b,a.h=b;else if(f)b=a.w<a.h?a.w:a.h,a.w=b,a.h=b}function g(a,b,c,d,g,e,l){for(var h=[],f=[],j=0,n=0,o=0,j=0;j<g;j++)h[j]=e*c[j],f[j]=l*d[j],a[j]=Math.round(h[j]),n+=f[j],b[j]=Math.round(n-o),o+=b[j]}function a(a,b){if(a==="top"||a==="left")a="0%";a==="center"&&(a="50%");if(a==="bottom"||a==="right")a="100%";var c=0,c=a.substring(a.length-1,a.length)==="%"?parseFloat(a)/100*b:a.substring(a.length-
    2,a.length)==="px"?parseFloat(a):0;return Math.round(c)}function l(b,c){var d=c.css("background-position").split(",")[0].trim().split(" "),g;d.length===1?(g=d[0],d="50%"):(g=d[0],d=d[1]);b.x=a(g,c.width());b.y=a(d,c.height())}function h(a){function c(){E++;E===o&&e.css("background-image",s)}var e=$(a),h=e.css("background-image");if(!(h==="none"||h==="inherit")){var h=d(h),f=h.bgImgFilepath,j=p[h.bgImgResourceName];if(j!==void 0&&j!==null){var h=0,o=j.length;e.addClass(n);for(var v=[],q=[],k=0,m=0,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        s="",k=[],h=0;h<o;h++)k[h]="url("+f+j[h].name+")",v[h]=j[h].width,q[h]=j[h].height,m+=q[h],s+=k[h],h!==o-1&&(s+=",");for(var k=v[0],E=0,h=0;h<o;h++)jqImgSlicedNode=$("<img/>"),jqImgSlicedNode[0].onload=c,jqImgSlicedNode[0].src=f+j[h].name;h={w:1,h:1};b(h,e,k,m);m=[];f=[];g(m,f,v,q,o,h.w,h.h);v="";for(h=0;h<o;h++)v=v+m[h]+"px "+f[h]+"px",h!==o-1&&(v+=",");a.setAttribute("style",(a.style||"")+("; background-size: "+v+" !important;"));v={x:0,y:0};l(v,e);for(var q=[],m=[],j=0,C=k="",h=0;h<o;h++)q[h]=
        v.x,m[h]=v.y+j,k=k+q[h]+"px "+m[h]+"px",C+="no-repeat",j+=f[h],h!==o-1&&(k+=",",C+=",");a.setAttribute("style",(a.style||"")+("; background-position: "+k+" !important;"));e.css("background-repeat",C)}}}function j(a,b,c){for(var d=[],e=[],l=[],h=[],f=0,j=0,n=$(b).children(),j=j=0;j<n.length;j++)d[j]=n[j].width,e[j]=n[j].height,f+=e[j];j=d[0];if(!(f===0||j===0)){$(a).css("display","block");var o=parseInt($(a).css("height"),10),p=parseInt($(a).css("width"),10);p===0&&o===0?(p=j,o=f):o===0?o=Math.round(f/
    j*p):p===0&&(p=Math.round(j/f*o));$(a).width(p);$(a).height(o);g(l,h,d,e,n.length,p/j,o/f);for(j=0;j<n.length;j++)$(n[j]).width(l[j]),$(n[j]).height(h[j]),$(n[j]).css("top","0px"),$(n[j]).css("left","0px"),$(n[j]).css("position","relative"),$(n[j]).css("border","none"),$(n[j]).css("display","block"),c&&$(n[j]).css("margin-bottom","-1px");$(b).css("line-height",0);$(b).css("display","inline-block");$(b).css("position",$(a).css("position"));$(b).css("width",$(a).css("width"));$(b).css("height",$(a).css("height"));
        $(b).css("top",$(a).css("top"));$(b).css("left",$(a).css("left"));$(b).css("bottom",$(a).css("bottom"));$(b).css("right",$(a).css("right"));$(b).css("float",$(a).css("float"));$(b).css("padding",$(a).css("padding"));$(b).css("border",$(a).css("border"));$(b).css("margin",$(a).css("margin"))}}var n="amzn-sliced-bgimg-ori",p={},o=null,q=RegExp(/\d+$/),s=[200,500,1E3];return{initialize:function(a){if(a.coverResource!==null&&a.coverResource!==void 0)o=a.resourceManifest[a.coverResource].name;a=a.compositeResourceManifest;
            a!==void 0&&a!==null?k(a):p={}},cleanup:function(){p={}},getCompositeData:function(){return p},getCoverImageSlices:function(){return p[o]},resolveCompositeResources:function(a){if(!$.isEmptyObject(p)){for(var b=[],c=0;c<a.length;c++){var d=[],g=d,e=a[c];if(p[e]!==void 0&&p[e]!==null)for(var l=p[e].length,h=0;h<l;h++)g.push(p[e][h].name);b=d.length>0?b.concat(d):b.concat(a[c])}a=b}return a},loadImage:function(a,b,c,d){var g=p[d];if(g!==void 0&&g!==null){$(a).addClass("amzn-sliced-inimg-ori");(d=a.getAttribute("alt"))&&
        a.setAttribute("data-alt-text",d);a.removeAttribute("alt");$(a).css("display","none");d=$("<div/>",{"class":"amzn-sliced-inimg-div"});d.insertBefore($(a));d.attr("data-nid",a.getAttribute("data-nid"));for(var l=g.length,h=0;h<l;h++)a=$("<img/>",{"class":"amzn-sliced-inimg-imgslice"}),a.width(g[h].width),a.height(g[h].height),e(a[0],b,c,g[h].name),a.appendTo(d)}else e(a,b,c,d)},scaleCompositeInlineImages:function(a){if(!$.isEmptyObject(p)){for(var b=a.getElementsByClassName("amzn-sliced-inimg-ori"),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           a=a.getElementsByClassName("amzn-sliced-inimg-div"),c=b.length,d=0,d=0;d<c;d++){j(b[d],a[d],!0);var g=$(a[d]).children()[0],e=b[d].getAttribute("data-alt-text");e&&g.setAttribute("alt",e)}$(b).remove()}},scaleCompositeBackgroundImages:function(a){if(!$.isEmptyObject(p))for(var a=$(a).find("*"),b=0;b<a.length;b++)h(a[b])},scaleImageSlices:j,createCanvasImage:f,scaleCanvas:function(a,b){for(var c=a,d=c.width,g=c.height;d>b.width&&g>b.height;){var e=Math.max(b.width,Math.round(d*0.75)),l=Math.max(b.height,
        Math.round(g*0.75)),h=document.createElement("canvas"),f=h.getContext("2d");h.width=e;h.height=l;$(h).attr("id","c1");f.drawImage(c,0,0,d,g,0,0,e,l);f.globalAlpha=0.5;f.drawImage(a,0,0,a.width,a.height,0,0,e,l);c=h;d=c.width;g=c.height}return c}}}(),KindleRendererWritingModeFactory=function(){function f(c,b,d,a,l){var h=e*Math.min(d,a),f=Math.abs(d-a);return(c<b?c+d-b:b+a-c)>h&&(!l||f<h)}function m(){var c=KindleRendererDeviceSpecific.usesDocRelativeVerticalCoordinates(),b=0,d=!1;return{getWritingMode:function(){return"vertical"},
        resetHeight:function(a){$(a).css("width",$(a.parentNode).width()+"px")},resetWidth:function(a){$(a).css("height",$(a.parentNode).height()+"px")},resetIframeDimensions:function(a){$(a).css({width:$(a.parentNode).width()+"px",height:$(a.parentNode).height()+"px"})},padImageIfNeeded:function(a){var b=$(a).css("margin-left");parseInt(b,10)<=1&&$(a).css("margin-left","2px")},getAvailableSizeForImage:function(a,b,c){var d=Math.min(a.getAttribute("data-nativeTopOffset"),a.offsetTop),g=$(a.offsetParent).outerHeight()||
        b.height,e=$(a.offsetParent).outerWidth()||b.width,g=Math.min(g-d,b.height*c),e=Math.min(e,b.width*c);$(a).css("float")!=="none"&&(c=$(a).parent(),a=parseInt($(c).css("line-height"),10),c=parseInt($(c).css("font-size"),10),e=Math.min(e,b.width-(a+c)));return{width:e,height:g}},calculateOverlappingImageSets:function(a,b){function c(a,b){return a.offsetLeft-b.offsetLeft}var d=[];if(a.length>1){for(var a=Array.prototype.slice.call(a).sort(c),g=null,e=a[0],f=e.offsetLeft+e.width,q,k,r=1;r<a.length;++r)if(q=
            a[r],!b(q)){k=q.offsetLeft+q.width;if(q.offsetLeft<=f){g||(g={left:e.offsetLeft,right:f,imgs:[e]});if(k>g.right)g.right=k;g.imgs.push(q)}else g&&(d.push({height:0,width:g.right-g.left,imgs:g.imgs}),g=null);e=q;f=g?g.right:k}g&&d.push({height:0,width:g.right-g.left,imgs:g.imgs})}return d},forceRepaint:function(a){if(a.contentDocument)a.contentDocument.body.style.top=0,setTimeout(function(){a.contentDocument.body.style.top=""},1)},setHeight:function(a,b){$(a).css("width",b)},setWidth:function(a,b){$(a).css("height",
        b)},fitToBottomOfFrame:function(a,b,c){$(b).css({height:"100%",width:$(a).width()-c+1,top:0,left:$(a).position().left-1})},height:function(a){return $(a).width()},width:function(a){return $(a).height()},prepareForPagination:function(a){b=$(a).width();this.scrollToTopOfDocument(a);d=$(a.contentDocument).find("table").length>0},getBorderMap:function(a,c){var d,g,e,f;for(d=0;d<a.length;d++){e=a[d];g=e.getBoundingClientRect();if((f=$(e).css("border-right-style"))&&f!=="none")if(f=parseInt($(e).css("border-right-width"),
        10))f={borderStart:b-g.right-f,borderEnd:b-g.right},c.top.push(f);if((f=$(e).css("border-left-style"))&&f!=="none")if(e=parseInt($(e).css("border-left-width"),10))f={borderStart:b-g.left,borderEnd:b-g.left+e},c.bottom.push(f)}},getTransformedClientRects:function(a,c,e){var f=a.length,n=[],p=c&&c.deltaX||0,e=c&&c.fontSize||e&&parseInt(e.fontSize,10)||void 0,o=0;a.length>1&&(a[0].height<=1&&++o,a[a.length-1].height<=1&&--f);for(;o<f;o++){var q=a[o],k=q.right+p-(c&&parseInt(c.ownerDocument.body.style.left,
        10)||0),r=e&&c.tagName!=="IMG"?e:q.width,q={top:q.top,bottom:q.bottom,height:q.height,left:b-(k-r),right:b-k,width:r},r=c,k=q;if(d){var x=$(r).closest("TBODY")[0];if(x){var w=0,w=$(x).parent(),y=$(w).width(),w=y,t=$(r).closest("TD")[0];t&&(w-=$(t).width());x=y-$(x).width();w+=x;k.left+=w;k.right+=w}}r&&r.getAttribute&&r.getAttribute("data-isTextCombineBlock")&&(x=parseInt($(r).css("font-size"),10),r=k.height-x,x=k.width-x,r>0&&(w=Math.ceil(r/2),k.top+=w,k.bottom-=w,k.height-=r),x<0&&(r=Math.ceil(x/
        2),k.left-=r,k.right+=r,k.width-=x));n.push(q)}return n},getRectsAdjustedForAnnotationMarks:function(a,b){for(var c=a.length,d=[],g=Math.ceil(b/2)+1,e=0;e<c;e++){var f=a[e];d.push({top:f.top,bottom:f.bottom,height:f.height,left:f.left,right:f.right-g,width:f.width+g})}return d},unionRect:function(a){for(var b=a[0],b={left:b.top,right:b.bottom,bottom:b.left,top:b.right},c=1;c<a.length;++c)b.top=Math.min(b.top,a[c].right),b.bottom=Math.max(b.bottom,a[c].left),b.right=Math.max(b.right,a[c].bottom),b.left=
            Math.min(b.left,a[c].top);return b},clientRectTop:function(a){return a.right},clientRectBottom:function(a){return a.left},clientRectLeft:function(a){return a.top},clientRectRight:function(a){return a.bottom},clientRectWidth:function(a){return a.height},clientRectHeight:function(a){return a.width},clientRectCompare:function(a,b){return f(a.right,b.right,a.width,b.width,!1)?a.top-b.top:a.right-b.right},checkIfRectsOnSameLine:function(a,b){return f(a.right,b.right,a.width,b.width,!1)},scrollToTopOfDocument:function(a){var d=
            0;c&&(d=$(a.contentDocument).width()-b);$(a.contentWindow).scrollLeft(d);a.contentDocument.body.style.top=0;a.contentDocument.body.style.left=0},scrollTop:function(a,b){a.contentDocument.body.style.left=b},getRectBoundariesForScreen:function(a,c){for(var d=[],g=a.length,e=0;e<g;e++)d.push({left:b-(a[e].left-c),top:a[e].top,right:b-(a[e].right-c),bottom:a[e].bottom});return d},isPointOnVisiblePage:function(a,b,c){return c>b},checkIfNewLine:function(a,b,c){return b===void 0||!f(a.right,b.right,a.width,
        b.width,c)},updateLineBounds:function(a,b,c,d,g){a.left=g-c.left;a.right=g-c.right;a.height=b&&d?d.top-a.top:c.bottom-a.top;a.width=a.right-a.left},updateLineHeightOfBounds:function(a,b){a.left=a.left>=b.left?a.left:b.left;a.right=a.right<=b.right?a.right:b.right;a.top=b.top;a.bottom=b.bottom},updateDivIfNewLineOrImageBound:function(a,b,c,d,g,e){var f=!1;if(a.isNewDiv||a.isImageBound)a.lineBounds={top:a.isNewDiv?b.top:a.lineBounds.top+a.lineBounds.height,height:b.height,left:b.left,right:b.right,
            width:b.width};a.isImageBound=g;a.isNewDiv=this.checkIfNewLine(a.lineBounds,c,!0);(f=a.isNewDiv||a.isImageBound)&&this.updateLineBounds(a.lineBounds,!a.isNewDiv&&!(d||c===void 0),b,c,e);return f},positionDivAfterWord:function(a,b,c,d){a.style.top=b.top+c;a.style.left=d-b.left+b.width+c},getDeltaX:function(a,b){var h;var c=0;if(KindleHostDeviceDetector.isiOS()&&parseInt(KindleHostDeviceDetector.getOSMajorVersion(),10)<6){if(a.tagName==="RUBY"){var d=b.createRange();d.selectNodeContents(a);var d=d.getClientRects(),
        g=a.getClientRects();g&&d&&g.length&&d.length&&(c=g[0].left-d[0].left)}if(a.parentNode&&a.parentNode.parentNode){var d=a.nodeType===Node.TEXT_NODE?a.parentNode:a,g=a.nodeType!==Node.TEXT_NODE&&a.tagName!=="RUBY"&&$(d).css("display")==="inline",e=$(d).css("display")==="inline-block",f=$(d.parentNode).css("display")==="inline";if((g||e)&&f){c+=-d.getBoundingClientRect().right;e=g=d;do e=g,g=g.parentNode;while(g&&$(g).css("display")!=="block");e={containingBlock:g,furthestNonBlockParent:e};if(g=e.containingBlock){h=
            f=e.furthestNonBlockParent,e=h;do e=e.nextElementSibling;while(e&&$(e).css("display")!=="block");do f=f.previousElementSibling;while(f&&$(f).css("display")!=="block");f=f?f.getBoundingClientRect().left-parseInt($(f).css("margin-left"),10):g.getBoundingClientRect().right;g=e?e.getBoundingClientRect().right+parseInt($(e).css("margin-right"),10):g.getBoundingClientRect().left;d=f-(d.getBoundingClientRect().left-g)}else d=d.getBoundingClientRect().right;c+=d}}}return c},floatToTopOfIframe:function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               c){var d=a.document.body,g=d.getBoundingClientRect(),d=a.getComputedStyle(d);$(c).css({position:"absolute",top:parseInt(d.top,10)-g.top,left:parseInt(d.left,10)-(g.left+$(a.document).width()-b)})}}}function k(){return{getWritingMode:function(){return"horizontal"},resetHeight:function(c){$(c).css("height",$(c.parentNode).height()+"px")},resetWidth:function(c){$(c).css("width",$(c.parentNode).width()+"px")},resetIframeDimensions:function(c){$(c).css({height:$(c.parentNode).height()+"px",width:$(c.parentNode).width()+
            "px"})},padImageIfNeeded:function(c){var b=$(c).css("margin-bottom");parseInt(b,10)<=1&&$(c).css("margin-bottom","2px")},getAvailableSizeForImage:function(c,b,d){var a=Math.min(c.getAttribute("data-nativeLeftOffset"),c.offsetLeft),e=$(c.offsetParent).outerHeight()||b.height,f=$(c.offsetParent).outerWidth()||b.width,e=Math.min(e,b.height*d),f=Math.min(f-a,b.width*d);$(c).css("float")!=="none"&&(d=$(c).parent(),c=parseInt($(d).css("line-height"),10),d=parseInt($(d).css("font-size"),10),e=Math.min(e,
        b.height-(c+d)));return{width:f,height:e}},calculateOverlappingImageSets:function(c,b){function d(a,b){return a.offsetTop-b.offsetTop}var a=[];if(c.length>1){for(var c=Array.prototype.slice.call(c).sort(d),e=null,f=c[0],j=f.offsetTop+f.height,n,k,o=1;o<c.length;++o)if(n=c[o],!b(n)){k=n.offsetTop+n.height;if(n.offsetTop<=j){e||(e={top:f.offsetTop,bottom:j,imgs:[f]});if(k>e.bottom)e.bottom=k;e.imgs.push(n)}else e&&(a.push({height:e.bottom-e.top,width:0,imgs:e.imgs}),e=null);f=n;j=e?e.bottom:k}e&&a.push({height:e.bottom-
            e.top,width:0,imgs:e.imgs})}return a},forceRepaint:function(){},setHeight:function(c,b){$(c).css("height",b)},setWidth:function(c,b){$(c).css("width",b)},fitToBottomOfFrame:function(c,b,d){d=$(c).height()-d+1;c=$(c).position().top+$(c).height()-d+1;$(b).css({height:d,width:"100%",top:c,left:0})},height:function(c){return $(c).height()},width:function(c){return $(c).width()},prepareForPagination:function(c){this.scrollToTopOfDocument(c)},getBorderMap:function(c,b){var d,a,e,f;for(d=0;d<c.length;d++){e=
            c[d];a=e.getBoundingClientRect();if((f=$(e).css("border-top-style"))&&f!=="none")if(f=parseInt($(e).css("border-top-width"),10))f={borderStart:a.top-f,borderEnd:a.top},b.top.push(f);if((f=$(e).css("border-bottom-style"))&&f!=="none")if(e=parseInt($(e).css("border-bottom-width"),10))f={borderStart:a.bottom,borderEnd:a.bottom+e},b.bottom.push(f)}},getTransformedClientRects:function(c,b){c.length>1&&(c[0].width<=1&&(c=Array.prototype.slice.call(c,1)),c[c.length-1].width<=1&&(c=Array.prototype.slice.call(c,
        0,-1)));if(b){var d=[],a=parseInt(b.ownerDocument.body.style.top,10);if(a!==0){for(var e=0;e<c.length;++e){var f=c[e];d.push({top:f.top-a,bottom:f.bottom-a,height:f.height,left:f.left,right:f.right,width:f.width})}c=d}}return c},getRectsAdjustedForAnnotationMarks:function(c,b){for(var d=c.length,a=[],e=Math.ceil(b/2)+1,f=0;f<d;f++){var j=c[f];a.push({top:j.top-e,bottom:j.bottom,height:j.height+e,left:j.left,right:j.right,width:j.width})}return a},unionRect:function(c){for(var b=c[0],b={top:b.top,
            bottom:b.bottom,left:b.left,right:b.right},d=1;d<c.length;++d)b.top=Math.min(b.top,c[d].top),b.right=Math.max(b.right,c[d].right),b.bottom=Math.max(b.bottom,c[d].bottom),b.left=Math.min(b.left,c[d].left);return b},clientRectTop:function(c){return c.top},clientRectBottom:function(c){return c.bottom},clientRectLeft:function(c){return c.left},clientRectRight:function(c){return c.right},clientRectWidth:function(c){return c.width},clientRectHeight:function(c){return c.height},clientRectCompare:function(c,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   b){return f(c.top,b.top,c.height,b.height,!1)?c.left-b.left:c.top-b.top},checkIfRectsOnSameLine:function(c,b){return f(c.top,b.top,c.height,b.height,!1)},scrollToTopOfDocument:function(c){$(c.contentWindow).scrollTop(0);c.contentDocument.body.style.top=0;c.contentDocument.body.style.left=0},scrollTop:function(c,b){c.contentDocument.body.style.top=-b},getRectBoundariesForScreen:function(c,b){for(var d=[],a=c.length,e=0;e<a;e++)d.push({left:c[e].left,top:c[e].top-b,right:c[e].right,bottom:c[e].bottom-
            b});return d},isPointOnVisiblePage:function(c,b,d,a){return a<c-b},checkIfNewLine:function(c,b,d){return b===void 0||!f(c.top,b.top,c.height,b.height,d)},updateLineBounds:function(c,b,d,a){c.top=Math.min(d.top,c.top);c.bottom=Math.max(d.bottom,c.bottom);c.height=c.bottom-c.top;c.width=b&&a?a.left-c.left:d.right-c.left},updateLineHeightOfBounds:function(c,b){c.top=c.top?c.top<=b.top?c.top:b.top:b.top;c.bottom=c.bottom?c.bottom>=b.bottom?c.bottom:b.bottom:b.bottom;c.left=b.left;c.right=b.right},updateDivIfNewLineOrImageBound:function(c,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      b,e,a,f){var h=!1;if(c.isNewDiv||c.isImageBound)c.lineBounds={top:b.top,height:b.height,left:c.isNewDiv?b.left:c.lineBounds.left+c.lineBounds.width,right:b.right,width:b.width,bottom:b.bottom};c.isImageBound=f;var j=c.lineBounds,h=d;if(!j||!e)f=!1;else var f=this.clientRectTop(j),n=this.clientRectTop(e),k=this.clientRectHeight(j),o=this.clientRectHeight(e),j=Math.max(k,o),k=Math.abs(f+k-(n+o))/j,f=Math.abs(f-n)/j<=h&&k<=h;n=this.checkIfNewLine(c.lineBounds,e,!0);c.isNewDiv=!f||n;(h=c.isNewDiv||c.isImageBound)?
        this.updateLineBounds(c.lineBounds,!f&&!n&&!(a||e===void 0),b,e):(c.lineBounds.top=Math.min(b.top,c.lineBounds.top),c.lineBounds.bottom=Math.max(b.bottom,c.lineBounds.bottom));return h},positionDivAfterWord:function(c,b,d){c.style.top=b.top+d;c.style.left=b.left+b.width+d},getDeltaX:function(){return 0},floatToTopOfIframe:function(c,b){var d=c.document.body,a=d.getBoundingClientRect(),d=c.getComputedStyle(d);$(b).css({position:"absolute",top:parseInt(d.top,10)-a.top,left:parseInt(d.left,10)-a.left})}}}
        var e=0.25,d=0.25;return{buildIFrameWritingMode:function(c){if(!c.contentDocument)return k();if(KindleRendererDeviceSpecific.needsWritingModeSpecifiedOnBody()){var b=c.contentDocument,d=b.documentElement,b=b.body;if($(d).css("-webkit-writing-mode")==="vertical-rl"){var a=d.getAttribute("style"),e=b.getAttribute("style"),e=e?e+";":"";d.setAttribute("style",(a?a+";":"")+"-webkit-writing-mode: vertical-rl !important;");b.setAttribute("style",e+"-webkit-writing-mode: vertical-rl !important;")}}return(c=
                $(c.contentDocument.body).css("-webkit-writing-mode"))&&c.match(/^vertical/)!==null?m():k()},buildHorizontalWritingMode:k,buildVerticalWritingMode:m}}(),KindleRendererContentReflow=function(){function f(a){a=a.contentDocument.getElementsByTagName("body")[0];return $(a).css("position")==="absolute"}function m(a,b){KindleRendererLanguageOptions.getNeedsPageRefresh()&&!f(a)?(a.contentDocument.body.style.display="none",setTimeout(function(){a.contentDocument.body.style.display="block";b()},1)):b()}function k(b,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              c,d,e,k,o){a===null&&(a=KindleRendererWordMapGeneratorFactory.buildWordMapGeneratorForWordBounds());var q=k.createSubTimer("preparation");KindleRendererContentCorrection.applyDocumentWideCorrections(b.contentWindow,b.contentDocument,b.writingMode,q);m(b,function(){b.writingMode.prepareForPagination(b);var s=b.contentDocument.getElementById(g);b.writingMode.floatToTopOfIframe(b.contentWindow,s);q.endTimer();var r=k.createSubTimer("word-map");a.createWordMap(b.contentDocument,b.contentWindow,c,b.writingMode,
    d,b.processingRequestId,r).then(function(c,d,e){function g(a){h.endTimer();o(a)}r.endTimer();KindleRendererContentCorrection.cleanup(b.contentDocument.body);var h=k.createSubTimer("height-map");f(b)?KindlePaginatorFixedContent(b.contentDocument,c,$(b).parent().height(),g):KindlePaginatorScreenFragmentation(b.contentDocument,c,d,e,a,b.writingMode.height($(b).parent()),b.writingMode,g);m(b,function(){})},e.reject)})}function e(a,b,c,e){if(a.processingRequestId.id===b.requestId){a.writingMode.scrollToTopOfDocument(a);
        a.writingMode.resetHeight(a);var g={height:$(a).parent().height(),width:$(a).parent().width()},f=a.contentDocument.getElementsByTagName("body")[0];if(KindleRendererSettings.getSettings().initialExpandedBodyHeight!==void 0){var k=parseInt($(f).css("margin-top"),10),m=parseInt($(f).css("margin-bottom"),10);f.style.height=parseInt(g.height,10)-k-m+"px"}k=f.getElementsByClassName("k4w-margin");for(m=0;m<k.length;m+=1){var r=parseInt(k[m].getAttribute("vertical"),10);if(r>0)k[m].style.marginTop=Math.round(r*
        0.01*g.height)+"px"}KindleRendererElementFitting.fitToViewport(f,a.writingMode,g,b.contentLoadMetrics).then(function(){a.processingRequestId.id!==b.requestId?(b.contentLoadMetrics.addCount("Cancelled",1),b.contentLoadMetrics.endTimer()):d(a,b,c,e)},e.reject)}}function d(a,b,c,d){b.contentLoadMetrics.endTimer();var e=b.metrics.createSubTimer("pagination");k(a,c,b.requestId,d,e,function(c){e.endTimer();a.processingRequestId.id!==b.requestId?(b.contentLoadMetrics.addCount("Cancelled",1),b.contentLoadMetrics.endTimer()):
    (a.screenManager=c,b.contentLoadMetrics.endTimer(),d.resolve(b))})}function c(a,b){var c=KindleRendererDeviceSpecific.reflowTimeout();c>0&&setTimeout(function(){if(b.state?b.state()==="pending":!b.isRejected()&&!b.isResolved())a.contentLoadMetrics.addCount("Timeout",1),a.contentLoadMetrics.endTimer(),b.reject()},c)}function b(a,b,d){var g=new jQuery.Deferred;c(b,g);var f=b.contentLoadMetrics.createSubTimer("(YIELD) begin-element-fitting");setTimeout(function(){f.endTimer();e(a,b,d,g)},KindleRendererDeviceSpecific.drawYieldUpdateTime());
        return g.promise()}var g="content-overlays",a=null;return{initialize:function(){KindleRendererContentCorrection.initialize()},reflow:function(a,c,d){return b(a,c,d)}}}(),KindlePaginatorFixedContent=function(f,m,k,e){f={minDocTop:0,maxDocTop:0,docBottom:k,wordMap:m};(function(d){d.minPosition=Infinity;d.maxPosition=-Infinity;for(var c in m){var b=parseInt(c,10);if(b>d.maxPosition)d.maxPosition=b;if(b<d.minPosition)d.minPosition=b}})(f);(function(d){d.hasNextScreen=function(c){return c===0};d.hasPreviousScreen=
        function(c){return c===k};d.getFirstReadingPositionAtHeight=function(){return null};d.getFirstEmptySpaceBeforeHeight=function(){return 0};d.getTopOfNodeAtPosition=function(){return 0};d.findNextScreen=function(c){return!d.hasNextScreen(c)?null:{topOfScreen:0,bottomOfScreen:k}};d.findPreviousScreen=function(c){return!this.hasPreviousScreen(c)?null:{topOfScreen:0,bottomOfScreen:k}}})(f);e(f)},KindlePaginatorHeightMapGenerator=function(){function f(a,b,c,d,e,g){c<0&&(c=0);d<0&&(d=0);if(b.previousTop===
    c&&b.previousBottom===d&&b.previousFontSize===g)return!1;b.previousTop=c;b.previousBottom=d;b.previousFontSize=g;if(c<a.minDocTop)a.minDocTop=c;if(c>a.maxDocTop)a.maxDocTop=c;b=d;if(b>a.docBottom)a.docBottom=b;d-=c;g===void 0&&(g=d);d=c+Math.floor((d-g)/2);g=d+g;a=a.nodeHeightRanges;for(c+=1;c<d;)a[c]>=0||(a[c]=-e),++c;for(;c<g;)a[c]>=0||(a[c]=e),++c;for(;c<b;)a[c]===void 0&&(a[c]=-e),++c;return!0}function m(a){for(var a=a.nodeHeightRanges,b=a.length,c=0,d,e,g,f,k;c<b;){for(;a[c]<0;)a[c]=-a[c],++c;
        if(a[c]>=0){for(++c;a[c]>=0;)++c;if(a[c]<0){d=c;f=a[d-1];for(++c;a[c]<0;)++c;e=c-1;k=a[c];if(k>=0){g=Math.floor((d+e)/2);for(delete a[g];d<g;++d)a[d]=f;for(d=g+1;d<=e;++d)a[d]=k}else for(;d<=e;++d)a[d]=f}}++c}}function k(a,b,c,d,e,g,o){function q(){k(a+1,b,c,d,e,g,o)}var s=0;for(KindleRendererProcessTuning.startingOperation("HeightMap");a<b.length;){var r=b[a],x=r.position,w=r.rect,y=d.clientRectTop(w),w=d.clientRectBottom(w);if(y>0||w>0){var t=Math.round(y);f(c,e,t,t+Math.round(w-y+1),x,r.fontSize)&&
    s++}if(s>o.count){KindleRendererProcessTuning.endingOperation("HeightMap",s);setTimeout(q,o.interval);return}a++}KindleRendererProcessTuning.endingOperation("HeightMap",s);m(c);setTimeout(g.resolve,o.interval)}function e(a){var b={},a=a.body;b.bodyDimensions={height:a.offsetHeight,width:a.offsetWidth};if(a=a.lastElementChild){var c=$(a),a=c.offset(),d=c.width(),c=c.height();b.lastElementPos={top:a.top,left:a.left,width:d,height:c}}return b}function d(a,b,c,d,e,g,f,q){if(c){var m=new jQuery.Deferred,
    r={count:KindleRendererProcessTuning.drawYieldFrequency("HeightMap"),interval:KindleRendererProcessTuning.drawYieldUpdateTime("HeightMap")};k(0,c,d,b,{},m,r);m.promise().then(function(){var c=Array.prototype.slice.call(a.getElementsByTagName("hr")),d,h=[];for(d=0;d<c.length;++d)h.push(c[d].getBoundingClientRect());h=b.getTransformedClientRects(h);for(d=0;d<h.length;++d)g.push(h[d]);c=$(a.body).find("[data-hasCssBorder='true']");b.getBorderMap(c,f);c=[];c=c.concat(Array.prototype.slice.call(a.getElementsByClassName("page-break")));
        c=c.concat(Array.prototype.slice.call(a.getElementsByClassName("pagebreak")));d=[];for(h=0;h<c.length;++h)d.push(c[h].getBoundingClientRect());d=b.getTransformedClientRects(d);for(h=0;h<d.length;++h)e.push(Math.round(b.clientRectTop(d[h])));q()},function(){})}}function c(a,c){var d=function(){if(k<a.minDocTop)a.minDocTop=k;if(k>a.maxDocTop)a.maxDocTop=k;if(o>a.docBottom)a.docBottom=o;for(var c=k;c<o;c++)a.nodeHeightRanges[c]===void 0&&(a.nodeHeightRanges[c]=b)},e,f;e=c.top;f=c.bottom;var k,o,q,m,
    r;for(q=0;q<e.length;q++){k=Math.round(e[q].borderStart);o=Math.round(e[q].borderEnd);d();r=0;for(m=o;m<a.docBottom;m++)if(a.nodeHeightRanges[m]===void 0&&r<=g)a.nodeHeightRanges[m]=b,r++;else break}for(q=0;q<f.length;q++){k=Math.round(f[q].borderStart);o=Math.round(f[q].borderEnd);d();r=0;for(m=k;m>a.minDocTop;m--)if(a.nodeHeightRanges[m]===void 0&&r<=g)a.nodeHeightRanges[m]=b,r++;else break}}var b="border-height",g=2;return{getHeightMapTags:function(){return{HARD_PAGE_BREAK:"page-break",HORIZONTAL_RULE:"horizontal-rule",
            BORDER_HEIGHT:b}},createHeightMap:function(a,b,g,f){var n={nodeHeightRanges:[],minPosition:Infinity,maxPosition:0,minDocTop:Infinity,maxDocTop:0,docBottom:0};n.validationData=e(a);var k=[],o=[],q={top:[],bottom:[]};d(a,b,g,n,k,o,q,function(){for(var a=k,d=0;d<a.length;d++){var e=a[d],g=n.nodeHeightRanges[e];if(g===void 0)n.nodeHeightRanges[e]="page-break";else if(g!=="page-break")for(var h=1;h<20;h++){if(n.nodeHeightRanges[e-h]!==g){n.nodeHeightRanges[e-h]="page-break";break}if(n.nodeHeightRanges[e+
        h]!==g){n.nodeHeightRanges[e+h]="page-break";break}}}for(a=0;a<o.length;a++)if(e=Math.round(b.clientRectTop(o[a])),d=Math.round(b.clientRectBottom(o[a])),d>e){if(e<n.minDocTop)n.minDocTop=e;if(e>n.maxDocTop)n.maxDocTop=e;if(d>n.docBottom)n.docBottom=d;for(;e<d;e++)n.nodeHeightRanges[e]===void 0&&(n.nodeHeightRanges[e]="horizontal-rule")}c(n,q,b);k=null;f(n)})}}}(),KindlePaginator=function(){function f(e,d){if(d!==null)e.currentTopOfScreen=d.topOfScreen,e.currentBottomOfScreen=d.bottomOfScreen,k(e)}
        function m(e,d){if(d!==null)e.currentTopOfScreen=d.topOfScreen,e.currentBottomOfScreen=d.bottomOfScreen,k(e)}function k(e){var d=KindleRendererDeviceSpecific.animatePageFlip(),c=$(e);d&&(c.removeClass("pageTurnEnd"),c.addClass("pageTurnStart"));e.writingMode.scrollTop(e,e.currentTopOfScreen);e.writingMode.fitToBottomOfFrame(e,e.pageOverflowDiv,e.currentBottomOfScreen-e.currentTopOfScreen);d&&(c.removeClass("pageTurnStart"),c.addClass("pageTurnEnd"))}return{scrollToTop:function(e,d){var c=e.screenManager.findNextScreen(d||
            e.screenManager.minDocTop<=1?0:e.screenManager.minDocTop-1);f(e,c)},scrollToBottom:function(e,d){var c=e.screenManager.findPreviousScreen(e.screenManager.docBottom,d);m(e,c)},scrollToPosition:function(e,d,c){d=e.screenManager.getTopOfNodeAtPosition(e.contentDocument,d);d=e.screenManager.getFirstEmptySpaceBeforeHeight(d);c=e.screenManager.findNextScreen(c&&d<=e.screenManager.minDocTop?0:d);f(e,c)},matchFrames:function(e,d){var c=e.screenManager.getFirstReadingPositionAtHeight(e.currentTopOfScreen),
            b=e.screenManager.getTopOfNodeAtPosition(e.contentDocument,c)-e.currentTopOfScreen,g=e.currentBottomOfScreen-e.currentTopOfScreen,c=d.screenManager.getTopOfNodeAtPosition(d.contentDocument,c);d.currentTopOfScreen=c-b;d.currentBottomOfScreen=d.currentTopOfScreen+g;k(d)},getApproximateNumPreviousScreens:function(e){var d=e.writingMode.height($(e).parent());return(e.currentTopOfScreen-e.screenManager.minDocTop)/d},getApproximateNumNextScreens:function(e){var d=e.writingMode.height($(e).parent());return(e.screenManager.maxDocTop-
            e.currentBottomOfScreen)/d},getCurrentPagePositionRange:function(e){var d=e.screenManager.getFirstReadingPositionAtHeight(e.currentTopOfScreen),e=e.screenManager.getFirstReadingPositionAtHeight(e.currentBottomOfScreen)-1;return{currentTopOfPage:d,currentBottomOfPage:e}},hasPreviousScreen:function(e){return e.screenManager.hasPreviousScreen(e.currentTopOfScreen)},hasNextScreen:function(e){return e.screenManager.hasNextScreen(e.currentBottomOfScreen)},isPreviousFullScreen:function(e,d){var c=e.screenManager.findPreviousScreen(e.currentTopOfScreen,
            d);return c!==null?e.screenManager.hasPreviousScreen(c.topOfScreen):!1},isNextFullScreen:function(e){var d=e.screenManager.findNextScreen(e.currentBottomOfScreen);return d!==null?e.screenManager.hasNextScreen(d.bottomOfScreen):!1},nextScreen:function(e,d){var c=e.screenManager.findNextScreen(e.currentBottomOfScreen);return c!==null&&(d||e.screenManager.hasNextScreen(c.bottomOfScreen))?(f(e,c),!0):!1},previousScreen:function(e,d,c){c=e.screenManager.findPreviousScreen(e.currentTopOfScreen,c);return c!==
            null&&(d||e.screenManager.hasPreviousScreen(c.topOfScreen))?(m(e,c),!0):!1},getWordMap:function(e){return e.screenManager.wordMap},copyIframe:function(e,d){d.screenManager=e.screenManager;d.writingMode=e.writingMode;d.currentTopOfScreen=e.currentTopOfScreen;d.currentBottomOfScreen=e.currentBottomOfScreen;d.writingMode.resetIframeDimensions(d)},getSelectableItemBoundariesForCurrentScreen:function(e){for(var d=KindlePaginator.getCurrentPagePositionRange(e),c=e.screenManager.wordMap,b=d.currentBottomOfPage,
                                                                                                                                                                                                                                                                                                                                                                                                                                      g={},d=d.currentTopOfPage;d<=b;++d){var a=c[d]&&c[d].rects;if(a!==void 0){var f=c[d].selectableRects;f!==void 0&&(a=f);g[d]=e.writingMode.getRectBoundariesForScreen(a,e.currentTopOfScreen)}}return g},getWordPositionsForCurrentScreen:function(e){var d=KindlePaginator.getCurrentPagePositionRange(e),e=e.screenManager.wordPositions,c=d.currentTopOfPage,b=d.currentBottomOfPage,d=null;if(e&&e.length>0){var g=KindleListUtilities.binarySearch(e,c),b=KindleListUtilities.binarySearch(e,b,void 0,g);e[g]<c&&
            ++g;d=[];for(c=g;c<=b;++c)d.push(e[c])}return d},isPointOnVisiblePage:function(e,d,c){var b=e.writingMode.height(e),g=e.writingMode.height(e.pageOverflowDiv);return e.writingMode.isPointOnVisiblePage(b,g,d,c)},showEndOfDocument:function(e){e.currentTopOfScreen=e.currentBottomOfScreen;k(e)},isIframePaginationValid:function(e){var d=e.screenManager.validationData;if(d){var c=e.contentDocument.body,b=d.bodyDimensions,e=$(e).parent(),g=window.navigator.userAgent.indexOf("MSIE")!==-1;if(c.offsetHeight===
            b.height&&c.offsetWidth===b.width||c.offsetHeight<=e.height()&&c.offsetWidth<=e.width())return!0;else if(g&&(b=Math.abs(c.offsetHeight-b.height),c.offsetWidth===c.offsetWidth&&b<80))return!0;c=c.lastElementChild;return(d=d.lastElementPos)&&c?(e=$(c),c=e.offset(),b=e.width(),e=e.height(),c.top===d.top&&c.left===d.left&&b===d.width&&e===d.height):!1}return!0},clearIframePaginationValidation:function(e){e.screenManager.validationData=null},cleanupIframe:function(e){e.screenManager=null}}}(),KindlePaginatorScreenFragmentation=
        function(f,m,k,e,d,c,b,g){function a(a){d.addBoundsForPosition(f,m,a,b)}function l(d){d.hasNextScreen=function(a){return this.maxDocTop>=a};d.hasPreviousScreen=function(a){return a>this.minDocTop};d.getFirstReadingPositionAtHeight=function(c){if(this.nodeHeightRanges.length===0)return null;var d;a:{for(var e=this.nodeHeightRanges,g=c;g<e.length;g+=1)if(d=e[g],d!==void 0&&d!==j&&d!==n&&d!==p){d=Math.abs(d);break a}d=this.maxPosition+1}a(d);if(this.wordMap[d]===void 0)return d;e=b.unionRect(this.wordMap[d].rects);
            for(g=d;g>=this.minPosition;g--)if(a(g),this.wordMap[g]!==void 0){if(this.wordMap[g].rects===void 0)return null;var f=b.unionRect(this.wordMap[g].rects);if(b.checkIfRectsOnSameLine(f,e)||f.top>=c)d=g;else break}return d};d.getFirstEmptySpaceBeforeHeight=function(a){for(var b,c=a;c>=0;c-=1)if(b=this.nodeHeightRanges[c],b===void 0||b===j)return c;return a};d.getTopOfNodeAtPosition=function(c,d){if(d<this.minPosition)return this.minDocTop;if(d>this.maxPosition)return this.maxDocTop;for(;d<=this.maxPosition;){a(d);
            var e=this.wordMap[d];if(e){for(var e=e.rects,g=Infinity,f=0;f<e.length;f++){var l=b.clientRectTop(e[f]);l<g&&(g=l)}return Math.round(g)}d+=1}return this.minDocTop};d.findBestPaginationNearBottom=function(c,d){var e=this.nodeHeightRanges[d];return e!==void 0&&(a(e),e=this.wordMap[e]&&this.wordMap[e].rects,e!==void 0&&(e=Math.floor(b.clientRectTop(e[0])+1),c<=e&&e<d))?e:d-1};d.findBestPaginationNearTop=function(c,d){var e=this.nodeHeightRanges[c];return e!==void 0&&(e<0&&(e=-e),a(e),e=this.wordMap[e]&&
            this.wordMap[e].rects,e!==void 0&&(e=Math.floor(b.clientRectBottom(e[e.length-1])),c<e&&e<=d))?e:c+1};d.findNextScreen=function(a){if(this.nodeHeightRanges.length===0||!this.hasNextScreen(a))return null;var b=this.nodeHeightRanges.length;if(a!==0&&this.nodeHeightRanges[a]!==j)for(var d=a+1;d<=b&&this.nodeHeightRanges[d]===void 0;)a=d++;for(var e=a,g=d=0,f=!1,l=!1,h,g=a;g<=b;g+=1)if(d+=1,h=this.nodeHeightRanges[g],h===void 0?(e=g,l=f):h!==j&&(f=!0),h===j&&g>a){d=g-a;l=f;break}else if(d>=c){e===a&&
        (e=this.findBestPaginationNearBottom(a+1,a+c-1),l=f);d=e-a;break}e={topOfScreen:a,bottomOfScreen:0};g<b?e.bottomOfScreen=a+d:(e.bottomOfScreen=g,l=f);return!l?g<b?this.findNextScreen(e.bottomOfScreen):null:e};d.findPreviousScreen=function(a,b){if(this.nodeHeightRanges.length===0||!this.hasPreviousScreen(a))return null;for(var d=a,e=0,g=0,f,l=!1,h=!1,o=a,n=a,k=0,g=a;g>=0;g-=1)if(e+=1,f=this.nodeHeightRanges[g],f===void 0?(d=g,h=l,n=o,l||++k):f!==j&&(l=!0,o=g),f===j&&g<a){if(l)return this.findNextScreen(g);
            k=e=0;n=o=d=a=g}else if(e>=c){d===a&&(n=this.findBestPaginationNearTop(a-c,a-1),h=l);break}d=n-1;if(d<=this.minDocTop)if(d=this.findNextScreen(b||this.minDocTop<=1?0:this.minDocTop-1),d.bottomOfScreen>=a-k)return d;else d=d.bottomOfScreen;result={topOfScreen:d,bottomOfScreen:a};return!h?g>0?this.findPreviousScreen(result.topOfScreen,b):null:result}}var h=KindlePaginatorHeightMapGenerator.getHeightMapTags(),j=h.HARD_PAGE_BREAK,n=h.HORIZONTAL_RULE,p=h.BORDER_HEIGHT,o=function(a){var b=[],c;for(c in a){var d=
            parseInt(c,10);b.push(d)}b.sort(function(a,b){return a-b});return b}(m);if(e&&e.length)rects=e;else{rects=[];for(h=0;h<o.length;++h){var q=o[h],s=m[q].rects,r=m[q].fontSize,x;for(x in s)rects.push({position:q,rect:s[x],fontSize:r})}}KindlePaginatorHeightMapGenerator.createHeightMap(f,b,rects,function(a){a.wordMap=m;a.lineRects=e;a.wordPositions=k;a.wordMapKeys=o;a.wordMapGenerator=d;if(o.length>0)a.minPosition=o[0],a.maxPosition=o[o.length-1];l(a);g(a)})},KindleRendererWordMapGeneratorFactory=function(){function f(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    b){if(a&&a.getComputedStyle)return a.getComputedStyle(b)}function m(a,b){for(var c=[],d=0;d<a.length;++d){var e=a[d];b.clientRectWidth(e)>1&&c.push(e)}return c}function k(a,b,c,d){b&&c>=0&&a.push({rect:b,position:c,fontSize:d})}function e(a){if(a<128)return 1;else if(a<2048)return 2;else if(a>=55296&&a<=57343)return 2;return 3}function d(a,b){a.fontSize=b&&parseInt(b.fontSize,10)||0;a.hasTextEmphasis=b?b.webkitTextEmphasisStyle&&b.webkitTextEmphasisStyle!=="none":!1;if(a.domChildIndex===void 0)for(var c=
        a.parentNode.firstChild,d=0;c;){if(c.nodeType===Node.TEXT_NODE)c.domChildIndex=d;c=c.nextSibling;++d}}function c(a,b){if(KindleRendererSettings.getSettings().fixedContent){var d=a.className;if(d&&d.match(s))return}if(!(a.tagName==="RT"||a.tagName==="RP"))if(a.nodeType===Node.TEXT_NODE||a.tagName==="IMG")b.push(a);else for(var d=a.childNodes,e=d.length,g=0;g<e;g+=1)c(d[g],b)}function b(a){var b=[];c(a,b);return b}function g(a){if((window.ActiveXObject||"ActiveXObject"in window)&&window.XMLHttpRequest)return b(a.body);
    else try{var c=(new XPathEvaluator).evaluate("/html/body//text()[not(ancestor::ruby)] | //img[not(ancestor::ruby)] | //ruby",a,null,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null),d;if(c.invalidIteratorState)d=b(a.body);else{for(var e=[],g=c.iterateNext();g;)e.push(g),g=c.iterateNext();d=e}return d}catch(f){return b(a.body)}}function a(a){a.addElementsToWordMap=function(a,b,c,d,e,g,f){function l(){h.addElementsToWordMap(a,b,c+1,d,e,g,f)}var h=this;KindleRendererProcessTuning.startingOperation("ScreenManager");
        for(var j=0;c<b.length;){var o=b[c],n=o.id,o=h.getValueForNode(a,o,g);o!==null&&(e[n]=o);j+=1;if(j>=d.interval){KindleRendererProcessTuning.endingOperation("ScreenManager",j);setTimeout(l,d.time);return}c+=1}KindleRendererProcessTuning.endingOperation("ScreenManager",j);setTimeout(function(){f.resolve(e,[],null,0)},d.time)};a.getPositionDataForNode=function(a,b,c){a=a[b+"_"+c];return a===void 0||a.length===0?null:a};a.getNodeId=function(a){var b=a.parentNode,c=b.getAttribute(q),d=0;if(a.ownChildIndex===
    void 0)for(;b.childNodes[d]!==a;)d+=1;else d=a.ownChildIndex;return{parentId:c,index:d}};a.getAllBaseNodesInRuby=function(a){a=(new XPathEvaluator).evaluate(".//text()[not(ancestor::rt or ancestor::rp)] | .//img[not(ancestor::rt or ancestor::rp)]",a,null,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);if(!a.invalidIteratorState){for(var b=[],c=a.iterateNext();c;)c.nodeType===Node.TEXT_NODE&&c.nodeValue.trim().length===0||b.push(c),c=a.iterateNext();return b}};a.addRubyNodeToWordMap=function(a,b,c,e,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 g,l,h,j){for(var o=this.getAllBaseNodesInRuby(a),n,q=[],m,p=0;p<o.length;++p)m=o[p],m.deltaX=a.deltaX,m.isRuby=!0,m.nodeType===Node.TEXT_NODE?(n=f(c,m.parentNode),d(m,n),(n=this.addTextNodeToWordMap(this.getNodeId(m),m,b,c,e,g,h))&&this.addTextNodeToLineRects(m,l,g,n,h,j)):(n=f(c,m),m.fontSize=n?parseInt(n.fontSize,10):0,(n=this.addImageNodeToWordMap(m,e,g,h))&&k(l,g[n[0]].rects[0],n[0])),n&&n.length>0&&(q=q.concat(n));return q}}function l(a){a.addTextNodeToWordMap=function(a,b,c,d,e,g,f){var l=b.nodeValue;
        if(l&&l.trim().length>0&&(e=this.getPositionDataForNode(e,a.parentId,a.index))){var h=e.length-1,j,o=0,n;a:{n=b;for(var k=0;k<2;k++)if(n.parentNode)if(n.parentNode.getAttribute("data-isTextCombineBlock"))break a;else n=n.parentNode;n=null}if(n){if(n.deltaX===void 0)n.deltaX=f.getDeltaX(n,c);n.parentNode.deltaX=n.deltaX;if(j=this.getValueForNode(d,n.parentNode,f))return o=e[0][1],g[o]=j,[o]}d=0;n=d<h?e[d+1][0]:Infinity;for(var m=o=k=0,q=l.length,p=[],r=0;r<=q;r++)if(j=l.charCodeAt(r),j<128?k+=1:j<
        2048?k+=2:j>=55296&&j<=57343?(m+=1,k+=2):k+=3,j=j<=32||j===45,r<q){if(!j){if(m===0)j=this.getValueForWord(c,b,r,r+1,j,a.parentId,f);else if(m===1)continue;else m=0,j=this.getValueForWord(c,b,r-1,r+1,j,a.parentId,f);if(j!==null){for(;o>=n;)d++,n=d<h?e[d+1][0]:Infinity;o=e[d][1]+(o-e[d][0]);g[o]=j;p.push(o)}}o=k}return p}}}function h(a){a.addTextNodeToWordMap=function(a,b,c,d,e,g,f){if((d=b.nodeValue)&&d.trim().length>0)if(e=this.getPositionDataForNode(e,a.parentId,a.index)){for(var l=e.length-1,h=
        0,j=h<l?e[h+1][0]:Infinity,o=0,n=0,k=0,o=0,m=d.length,q=[],p=0;p<=m;p++){var r=d.charCodeAt(p);n+=r<128?1:r<2048?2:r>=55296&&r<=57343?2:3;r=r<=32||r===45||r===8212;if(p===m||r){k=this.getValueForWord(c,b,k,p,r,a.parentId,f);if(k!==null){for(;o>=j;)h++,j=h<l?e[h+1][0]:Infinity;o=e[h][1]+(o-e[h][0]);g[o]=k;q.push(o)}k=p+1;o=n}}return q}}}function j(a){a.getValueForWord=function(a,b,c,d,e,g){return d>c?{startOffset:c,endOffset:d,childIndex:b.domChildIndex,fontSize:b.fontSize,dataNid:g}:null};a.getValueForNode=
        function(a,b,c){var d=b.getClientRects();if(KindleRendererDeviceSpecific.clientRectsExpire()){for(var e=[],g=0;g<d.length;++g)e.push({top:d[g].top,left:d[g].left,bottom:d[g].bottom,right:d[g].right,width:d[g].width,height:d[g].height});d=e}if(d&&d.length>0){c={rects:c.getTransformedClientRects(d,b)};if(b.tagName==="SPAN")a=f(a,b),c.fontSize=a?parseInt(a.fontSize,10):void 0;if(b.tagName==="IMG")c.tagName="IMG";c.dataNid=b.getAttribute(q);return c}return null};a.getValueForImage=function(a,b){if(a.getClientRects){var c=
        a.getClientRects();if(c&&c.length>0)return c=this.getBoundingAndSelectableRects(a,c,b),{selectableRects:c.selectableRects,rects:c.boundingRects,dataNid:a.getAttribute(q)}}return null};a.getValueForWhitespace=function(a,b,c){b=b.createRange();b.setStart(a,0);b.setEnd(a,a.length);return b.getClientRects?(b=b.getClientRects(),this.getBoundingAndSelectableRects(a,b,c).boundingRects):null};a.getBoundingAndSelectableRects=function(a,b,c){var d=void 0,b=c.getTransformedClientRects(b,a),d=a.hasTextEmphasis||
    a.isRuby?c.getRectsAdjustedForAnnotationMarks(b,a.fontSize):b;return{boundingRects:d,selectableRects:b}};a.addBoundsForPosition=function(a,b,c,d,e){var g=b[c];if(g&&g.rects===void 0&&(e=e||$("["+q+'="'+g.dataNid+'"]',a).contents()[g.childIndex]))a=a.createRange(),a.setStart(e,g.startOffset),a.setEnd(e,g.endOffset),(a=a.getClientRects())&&a.length>0&&(a=this.getBoundingAndSelectableRects(e,a,d)),a&&a.boundingRects&&a.boundingRects.length>0?(g.selectableRects=a.selectableRects,g.rects=a.boundingRects):
    delete b[c]};a.getNextValidPositionIndexInNode=function(a,b,c,d,e,g){for(var f;f===void 0&&c<b.length;)f=b[c],this.addBoundsForPosition(e,d,f,g,a),f=d[f],++c;return f===void 0?-1:--c};a.addTextNodeToLineRects=function(a,b,c,d,e){if(d.length!==0){var g=a.ownerDocument,f=g.createRange();f.selectNode(a);var l=this.getBoundingAndSelectableRects(a,m(f.getClientRects(),e),e).boundingRects,h=l.length,j=a.fontSize,o=0.25*j;if(h===1)k(b,l[0],d[0],j);else if(h>1){var n;if(d.length===1)for(n=0;n<h;n++)k(b,l[n],
    d[0],j);else{var q=a.nodeValue.length,p=0;for(n=0;n<h;++n)p+=e.clientRectWidth(l[n]);var q=p/q,r=p=!1,s=this.getNextValidPositionIndexInNode(a,d,0,c,g,e);if(!(s<0)){var B=s,K=d[B],J=c[K],O=J.endOffset-J.startOffset,K=J.rects.length,L=0;for(n=0;n<h;++n)if(L<K-1)Math.abs(e.clientRectTop(J.rects[L])-e.clientRectTop(l[n]))<o&&(k(b,l[n],d[s],j),++L);else if(L=Math.min(L,K-1),Math.abs(e.clientRectTop(J.rects[L])-e.clientRectTop(l[n]))<o){var N=e.clientRectWidth(l[n]),N=Math.round(N/q);e.clientRectLeft(J.rects[L]);
        for(e.clientRectLeft(l[n]);B<d.length-1&&O<N;)++B,J=c[d[B]],O+=J.endOffset-J.startOffset;if(s===B&&(++B,B>=d.length)){k(b,l[n],d[s],j);break}for(f.setStart(a,c[d[s]].startOffset);;)if(f.setEnd(a,c[d[B]].endOffset),J=m(f.getClientRects(),e),J.length>K){if(B<=0)break;--B;if(r)break;p=!0}else if(J.length===K){if(p||B>=d.length-1)break;++B;r=!0}else break;k(b,l[n],d[s],j);if(B>=d.length-1)break;p=r=!1;s=this.getNextValidPositionIndexInNode(a,d,B+1,c,g,e);if(s<0)break;B=s;K=d[B];J=c[K];O=J.endOffset-J.startOffset;
        K=J.rects.length;L=0;Math.abs(e.clientRectTop(J.rects[0])-e.clientRectTop(l[n]))<o&&++L}}}}}};a.createBoundsWordMap=function(a,b,c,d,e,f,l){var h=new jQuery.Deferred,j={};c.posMap===void 0||$.isEmptyObject(c.posMap)?this.createWordMapFromElements(a,b,j,d,h):c.posMap!==null?(e={interval:KindleRendererProcessTuning.drawYieldFrequency("WordMapGen"),time:KindleRendererProcessTuning.drawYieldUpdateTime("WordMapGen"),metrics:l||KindleMetricsProfiler("wordMap"),requestId:e,processingRequest:f},this.createWordMapFromNodeList(0,
    g(a),a,b,c,j,[],d,e,h)):h.resolve(j,[],[],0);return h.promise()};a.computeAllWordRects=function(a,b,c,d,e,g){function f(){if(e.requestId===e.computingRectsId.id){KindleRendererProcessTuning.startingOperation("WordMapGen");for(var m=0;n<c.length;++n){if((j=b[c[n]])&&j.rects===void 0){if(j.dataNid!==h.dataNid||j.childIndex!==h.childIndex)if(l=$("["+q+'="'+j.dataNid+'"]',a).contents()[j.childIndex],!l)return;h=j;o.setStart(l,j.startOffset);o.setEnd(l,j.endOffset);var p=o.getClientRects();p&&p.length>
    0&&(p=k.getBoundingAndSelectableRects(l,p,d));p&&p.boundingRects&&p.boundingRects.length>0?(j.selectableRects=p.selectableRects,j.rects=p.boundingRects):delete b[c[n]];++m}if(m>=e.frequency){KindleRendererProcessTuning.endingOperation("WordMapGen",m);setTimeout(f,e.time);return}}KindleRendererProcessTuning.endingOperation("WordMapGen",m);g.resolve()}}var l,h={},j,n=0,o=a.createRange(),k=this;o.getClientRects?f():g.resolve()};a.addImageNodeToWordMap=function(a,b,c,d){d=this.getValueForImage(a,d);if(d!==
    null&&(a=a.getAttribute(q),a!==null))return b=b[a],c[b[0][1]]=d,[b[0][1]]};a.createWordMapFromElements=function(a,b,c,d,e){var g=[],g=g.concat(Array.prototype.slice.call(a.getElementsByTagName("IMG"))),g=g.concat(Array.prototype.slice.call(a.getElementsByTagName("CANVAS"))),g=g.concat(Array.prototype.slice.call(a.getElementsByClassName("k4w"))),g=g.concat(Array.prototype.slice.call(a.getElementsByClassName("k4wc"))),a={interval:KindleRendererProcessTuning.drawYieldFrequency("ScreenManager"),time:KindleRendererProcessTuning.drawYieldUpdateTime("ScreenManager")};
        this.addElementsToWordMap(b,g,0,a,c,d,e)};a.createWordMapFromNodeList=function(a,b,c,e,g,l,h,j,n,o){function m(){n.requestId===n.processingRequest.id&&q.createWordMapFromNodeList(a+1,b,c,e,g,l,h,j,n,o)}var q=this;KindleRendererProcessTuning.startingOperation("WordMapGen");var p=0,r=b.length,s=null,G=n.numPositionsAdded||0,B=g.wordList&&g.wordList.length;if(B&&!g.imageList)g.imageList=[];for(var K=g.imageList,J,O=n.metrics.createSubTimer("text counters (timeless)");a<r;){var L=b[a],N=l;L.deltaX=j.getDeltaX(L,
    c);if(L.nodeType===Node.TEXT_NODE)J=f(e,L.parentNode),J&&J.display==="none"||(d(L,J),s=q.getNodeId(L),s=q.addTextNodeToWordMap(s,L,c,e,g.posMap,l,j),s===void 0?(s=[],N=[{rects:q.getValueForWhitespace(L,c,j)}]):this.addTextNodeToLineRects(L,h,l,s,j,O));else if(L.tagName==="IMG"){if(J=f(e,L),L.fontSize=J?parseInt(J.fontSize,10):0,s=q.addImageNodeToWordMap(L,g.posMap,l,j))k(h,l[s[0]].rects[0],s[0]),B&&K.push(s[0])}else s=q.addRubyNodeToWordMap(L,c,e,g.posMap,l,h,j,O);s&&s.length&&(G+=s.length,KindleRendererContentCorrection.applyNodeLocalCorrections(L,
    s,N,e,j,n.metrics));++p;if(p>=n.interval){n.numPositionsAdded=G;KindleRendererProcessTuning.endingOperation("WordMapGen",p);setTimeout(m,n.time);return}++a}r=B?KindleListUtilities.sortedMerge(g.wordList,K):[];delete g.imageList;KindleRendererProcessTuning.endingOperation("WordMapGen",p);o.resolve(l,r,h,G)}}function n(a){a.getValueForWord=function(a,b,c,d,e){return d>c?(a=b.nodeValue,c={text:a.substr(c,e?d-c+1:d-c)},d===a.length&&(c.text+=this.WORD_DELIMITER),c):null};a.findSibling=function(a){return a&&
    a.nodeType!==Node.DOCUMENT_NODE?a.nextSibling?a.nextSibling:this.findSibling(a.parentNode):null};a.getValueForNode=function(a,b){if(b.tagName!=="IMG"){var c=b.textContent;if(!/\s/.test(c[c.length-1])){var d=this.findSibling(b);d&&d.className!=="k4w"&&(c+=" ")}return{text:c}}return null};a.getValueForImage=function(){return null};a.WORD_DELIMITER=KindleRendererLanguageOptions.getHasWhitespaceDelimitedWords()?" ":"";a.createTextWordMap=function(a,c){var d=new jQuery.Deferred,e={},g,f,l,h,j;if(c.posMap===
    void 0){h=$(a).find("CANVAS,.k4w,.k4wc");h=$.makeArray(h);j=h.length;for(g=0;g<j;g++)l=h[g],f=l.id,l=this.getValueForNode(null,l),l!==null&&(e[f]=l)}else if(c.posMap!==null){h=b(a);j=h.length;for(g=0;g<j;g++)l=h[g],l.nodeType===Node.TEXT_NODE&&(f=this.getNodeId(l),this.addTextNodeToWordMap(f,l,null,null,c.posMap,e))}d.resolve(e);return d.promise()}}function p(a,b){a.createWordMap=function(a,c,d,e,g,f,l){return b.createBoundsWordMap(a,c,d,e,g,f,l)};a.addBoundsForPosition=function(a,c,d,e,g){b.addBoundsForPosition(a,
    c,d,e,g)};a.computeWordRects=function(a,c,d,e,g,f,l,h){var j=new jQuery.Deferred;g==="mobi8"&&d&&d.length>0?(g={frequency:KindleRendererProcessTuning.drawYieldFrequency("WordMapGen"),time:KindleRendererProcessTuning.drawYieldUpdateTime("WordMapGen"),requestId:f,computingRectsId:l},b.computeAllWordRects(a,c,d,e,g,j,h)):j.resolve();return j.promise()}}function o(a,b){a.createWordMap=function(a,c){return b.createTextWordMap(a,c)}}var q="data-nid",s=/(?=.*target)(?=.*mag)/i;return{buildWordMapGeneratorForWordBounds:function(){var b=
            {},c={};a(b);j(b);p(c,b);KindleRendererLanguageOptions.getHasWhitespaceDelimitedWords()?h(b):l(b);return c},buildWordMapGeneratorForWordText:function(){var b={},c={};a(b);n(b);o(c,b);KindleRendererLanguageOptions.getHasWhitespaceDelimitedWords()?h(b):l(b);return c},countUTF8Bytes:function(a){return e(a)}}}(),KindleRegionAnnotationRenderer=function(){function f(d,c){return d.contentDocument.querySelectorAll("mark[annotationType"+(c?'="'+c.type+'"':"")+"][annotationStart"+(c?'="'+c.start+'"':"")+"]")}
        function m(d,c,b){var e,a;if(!d||!c||parseInt(d.id,10)>parseInt(c.id,10)||d.tagName==="MARK"||c.tagName==="MARK")throw"Insertion of <mark> tags failed.";if(d.parentNode===c.parentNode){b=b();e=c.nextSibling;a=d.parentNode;var f=d;do d=f,f=d.nextSibling,a.removeChild(d),b.appendChild(d);while(d!==c);a.insertBefore(b,e)}else KindleRendererUtils.treeDepth(d)>KindleRendererUtils.treeDepth(c)?d.previousElementSibling||KindleRendererUtils.isBlock(d.parentNode)?(e=KindleRendererUtils.previousPositionedNode(d.parentNode),
            a=KindleRendererUtils.nextPositionedNode(KindleRendererUtils.followingNode(d.parentNode)),m(d,e,b),m(a,c,b)):m(d.parentNode,c,b):c.nextElementSibling||KindleRendererUtils.isBlock(c.parentNode)?(e=KindleRendererUtils.previousPositionedNode(KindleRendererUtils.precedingNode(c.parentNode)),a=KindleRendererUtils.nextPositionedNode(c.parentNode),m(d,e,b),m(a,c,b)):m(d,c.parentNode,b)}function k(d,c,b){var e=d.contentDocument,d=KindleRendererUtils.findElementAtOrAfterPosition(e,c.start),a=KindleRendererUtils.findElementAtOrBeforePosition(e,
        c.end);try{m(d,a,function(){var a=e.createElement("mark");a.className=b;a.setAttribute("annotationType",c.type);a.setAttribute("annotationStart",c.start);return a})}catch(f){}}function e(d,c){for(var b=Array.prototype.slice.call(c),e=0;e<b.length;e++){var a=b[e],f=a.getAttribute("annotationType");if(f==="kindle.highlight"||f==="kindle.search"){for(var f=d.createDocumentFragment(),h=a.firstChild,j;h;)j=h.nextSibling,a.removeChild(h),f.appendChild(h),h=j;h=a.parentNode;j=a.nextSibling;h.removeChild(a);
            h.insertBefore(f,j)}else a.parentNode.removeChild(a)}}return{createAnnotationElements:function(d,c){var b;for(b=0;b<c.length;b++){var e=c[b];if(e.type==="kindle.highlight")k(d,e,"highlight");else if(e.type==="kindle.note"){var a=d.contentDocument,l=a.createElement("div");l.className="note-icon";var h=a.createElement("mark");h.className="note";h.setAttribute("annotationType",e.type);h.setAttribute("annotationStart",e.start);h.setAttribute(KindleRendererAnnotationRenderer.ANNOTATION_CLICK_ATTRIBUTE,
            "true");h.appendChild(l);e=KindleRendererUtils.findElementAtOrBeforePosition(a,e.start);e.parentNode.insertBefore(h,e.nextSibling)}else e.type==="kindle.search"&&(h=d,f(h,e).length>0||k(h,e,"search-result"))}},removeAnnotationElements:function(d,c){e(d.contentDocument,f(d,c))},removeAllAnnotationElements:function(d){e(d.contentDocument,f(d))}}}(),KindleRegionContentManager=function(){function f(b){if(o||q){if(b<=l)throw{name:"pagingError",message:"Repeating wait request"};l=b;a<0&&g.waitNotification&&
    g.waitNotification();a=b}}function m(b){if((o||q)&&a>=0&&a<=b)r=0,a=-1,q&&(o=!0,q=!1),g.readyNotification&&g.readyNotification(),g.rectsReadyNotification&&g.rectsReadyNotification()}function k(c,d,e){a<=c&&(d!==KindleRendererIframeManagerFactory.DATA_LOAD_ERROR&&r<s?(++r,b(e)):(g.errorNotification&&g.errorNotification(d),a=-1))}function e(a){a=j.gotoPosition(a);if(!a){var b=j.getCurrentProcessId();f(b);j.getCurrentProcessDfd().then(function(){m(b)},function(a){k(b,a)})}return a}function d(){try{var a=
        j.nextScreen();if(!a){var c=j.getCurrentProcessId();f(c);j.getCurrentProcessDfd().then(function(){d();m(c)},function(a){k(c,a,0)})}return a}catch(e){return KindleDebug.breakPt(),b(),!1}}function c(){try{var a=j.previousScreen();if(!a){var d=j.getCurrentProcessId();f(d);j.getCurrentProcessDfd().then(function(){c();m(d)},function(a){k(d,a,0)})}return a}catch(e){return KindleDebug.breakPt(),b(),!1}}function b(){var a=j.getPagePositionRange();if(a!==null)n=a.currentTopOfPage;j.reloadNotification();e(n)}
        var g={},a=-1,l=-1,h=null,j=null,n=0,p,o=!0,q=!1,s=3,r=0;return{initialize:function(a,b,c){h=a;g=b;p=c;n=void 0;j=KindleRendererIframeManagerFactory.build(h);j.setOverlayManager(p);j.setAnnotationEventCallback(g.annotationTriggered)},cleanup:function(){},hide:function(){q=o=!1},show:function(){q=!0},updateSettings:function(a){j.updateSettings(a)},gotoPosition:function(a){return e(a,0)},nextScreen:function(){return d()},previousScreen:function(){return c()},hasNextScreen:function(){return j.hasNextScreen()},
            hasPreviousScreen:function(){return j.hasPreviousScreen()},getPagePositionRange:function(){return j.getPagePositionRange()},getSelectableItemBoundaries:function(){return null},getWordPositions:function(){return null},onWindowResize:function(){j.resizeNotification()},handleClick:function(){},reloadAnnotations:function(){j&&j.reloadAnnotations()},getZoomableAt:function(){return null},getZoomableList:function(){return[]},clearSelection:function(){j.clearSelection()},getSelection:function(){return j.getSelection()}}}(),
    KindleRegionIframeManager=function(){function f(b){b.cancelCurrentRequest=function(){if(this.currentRequest)this.currentRequest.cancelled=!0,this.currentRequest=null};b.createNewRequest=function(b,a){this.cancelCurrentRequest();this.currentRequest={type:b,requestId:KindleRendererRequestId.getUniqueRequestId(),metrics:KindleMetricsProfiler("renderer-iframe-load"),retryCount:0,initialPosition:a};this.currentRequestDfd=new jQuery.Deferred};b.willRetryCurrentRequest=function(){this.currentRequest&&this.currentRequest.retryCount++};
        b.canRetryCurrentRequest=function(){return this.currentRequest?this.currentRequest.retryCount<c:!0};b.calculateIframePaginationData=function(b,a,c){var e=this,f=KindleRendererFragmentLoader.getBookContentType()==="topaz"?e.currentRequest.type?KindleRendererIframePreparation.CANVAS_INSERTION_PREVIOUS:KindleRendererIframePreparation.CANVAS_INSERTION_NEXT:KindleRendererIframePreparation.CANVAS_INSERTION_NONE;KindleRendererIframePreparation.prepareIframe(b,e.currentRequest,a,c,f).then(function(a){if(b.processingRequestId.id===
            a.requestId&&e.currentRequest&&e.currentRequest.requestId===a.requestId)b.processingRequestId.id=null,e.frameIsLoadedAndReady(b);e=null},function(a){e.currentRequest&&a&&e.currentRequest.requestId===a.requestId&&e.currentRequestDfd.reject(d);e=null})};b.loadContentDataIntoIframe=function(b){var a=this;a.currentRequest.contentLoadMetrics=a.currentRequest.metrics.createSubTimer("content-load");a.contentRange[this.hiddenIframeIndex]=b.contentRange;var c=this.iframes[this.hiddenIframeIndex];c.processingRequestId.id=
            a.currentRequest.requestId;KindleRendererIframeLoading.loadIframe(c,a.currentRequest,b).then(function(d,f){KindleRendererProcessTuning.runAfterYield(KindleRendererDeviceSpecific.yieldTimeAfterIframeLoaded(),d.type,function(){if(c.processingRequestId.id===d.requestId&&a.currentRequest&&a.currentRequest.requestId===d.requestId){a.positionData[a.hiddenIframeIndex]=f.positionData;var n=a.getViewportDimensions(c);a.regionManagers[a.hiddenIframeIndex].computeFilledRegionNodes();a.ensureElementsWillFit(c,
            n,a.currentRequest.contentLoadMetrics).then(function(){a.currentRequest.contentLoadMetrics.endTimer();a.calculateIframePaginationData(c,b,f);(KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE())&&a.addSelectionListener(c);a=null},function(){a.currentRequest&&a.currentRequestDfd.reject(e);a=null})}else a=null})},function(){a.currentRequest&&a.currentRequestDfd.reject(e)})};b.ensureElementsWillFit=function(b,a,c){b.writingMode.scrollToTopOfDocument(b);b.writingMode.resetHeight(b);var d=
            b.contentDocument.getElementsByTagName("body")[0];if(KindleRendererSettings.getSettings().initialExpandedBodyHeight!==void 0){var e=parseInt($(d).css("margin-top"),10),f=parseInt($(d).css("margin-bottom"),10);d.style.height=parseInt(a.height,10)-e-f+"px"}e=d.getElementsByClassName("k4w-margin");for(f=0;f<e.length;f+=1){var k=parseInt(e[f].getAttribute("vertical"),10);if(k>0)e[f].style.marginTop=Math.round(k*0.01*a.height)+"px"}return KindleRendererElementFitting.fitToViewport(d,b.writingMode,a,c)};
        b.annotationClickedHandler=function(b){if(this.annotationEventCallback!==void 0){var a=b.currentTarget.parentNode,b=a.getAttribute("annotationType"),a=a.getAttribute("annotationStart");this.annotationEventCallback(b,a)}};b.renderAnnotations=function(b,a){b&&KindleRegionAnnotationRenderer.removeAllAnnotationElements(b);if(this.overlayManager){var c=this.overlayManager.getOverlaysInRange(a.startPosition,a.endPosition);c&&c.length>0&&this.createAnnotationElements(b,c)}};b.frameIsLoadedAndReady=function(b){var a=
            this.currentRequest;this.iframeLoadStatus[b.index]=a.type;this.renderAnnotations(b,this.contentRange[b.index]);a&&a.initialPosition!==null&&(this.regionManagers[b.index].updateView(KindleRegionManagerFactory.VIEW_REQUEST.GO_TO_POSITION,{position:a.initialPosition}),b===this.iframes[this.hiddenIframeIndex]&&(this.swapIframes(),this.updateDisplayedPositionsInPage()));a.metrics.addCount("Success",1);a.metrics.endTimer();a.metrics.log();this.currentRequest=null;setTimeout(this.currentRequestDfd.resolve,
            10);a.type===this.loadedType.GOTO_POSITION&&this.considerLoadingMoreFragments()};b.loadFragmentsForRange=function(b){var a=this;KindleRendererFragmentLoader.loadFragments(b,a.currentRequest).then(function(b,c){a.currentRequest&&a.currentRequest.requestId===b.requestId&&a.loadContentDataIntoIframe(c);a=null},function(b,c){a.currentRequest&&a.currentRequest.requestId===c.requestId&&a.currentRequestDfd.reject(k);a=null})};b.gotoPosition=function(b){var a=this.iframes[this.visibleIframeIndex];a&&KindleRegionAnnotationRenderer.removeAllAnnotationElements(a);
            this.createNewRequest(this.loadedType.GOTO_POSITION,b);b=KindleRendererPositionLoadingCalculator.calculateDesiredFragmentRangeForGoTo(b);if(KindleRendererFragmentLoader.needToLoadFragments(this.contentRange[this.visibleIframeIndex],b))return this.loadFragmentsForRange(b),!1;else this.frameIsLoadedAndReady(this.iframes[this.visibleIframeIndex]);return!0};b.setIframeVisibility=function(b,a){a?this.regionManagers[b].show():this.regionManagers[b].hide()};b.swapIframes=function(){this.iframeLoadStatus[this.visibleIframeIndex]=
            this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.NEXT?this.loadedType.PREVIOUS:this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.PREVIOUS?this.loadedType.NEXT:this.loadedType.EMPTY;this.iframeLoadStatus[this.hiddenIframeIndex]=this.loadedType.EMPTY;var b=this.visibleIframeIndex;this.visibleIframeIndex=this.hiddenIframeIndex;this.hiddenIframeIndex=b;this.setIframeVisibility(this.visibleIframeIndex,!0);this.setIframeVisibility(this.hiddenIframeIndex,!1)};b.getPagePositionRange=
            function(){return this.regionManagers[this.visibleIframeIndex].getPagePositionRange()};b.reloadAnnotations=function(){this.renderAnnotations(this.iframes[this.visibleIframeIndex],this.contentRange[this.visibleIframeIndex]);this.iframes[this.hiddenIframeIndex]!==null&&this.iframeLoadStatus[this.hiddenIframeIndex]!==this.loadedType.EMPTY&&this.renderAnnotations(this.iframes[this.hiddenIframeIndex],this.contentRange[this.hiddenIframeIndex])};b.loadNextPages=function(){if(this.iframeLoadStatus[this.hiddenIframeIndex]!==
            this.loadedType.NEXT&&(this.currentRequest===null||this.currentRequest.type!==this.loadedType.NEXT)){var b=this.contentRange[this.visibleIframeIndex].endPosition+1,a=this.getPagePositionRange(),b=KindleRendererPositionLoadingCalculator.calculateDesiredFragmentRangeForPageFlip(b,a);this.createNewRequest(this.loadedType.NEXT,null);this.loadFragmentsForRange(b)}};b.loadPreviousPages=function(){if(this.iframeLoadStatus[this.hiddenIframeIndex]!==this.loadedType.PREVIOUS&&(this.currentRequest===null||this.currentRequest.type!==
            this.loadedType.PREVIOUS)){var b=this.contentRange[this.visibleIframeIndex].startPosition-1,a=this.getPagePositionRange(),b=KindleRendererPositionLoadingCalculator.calculateDesiredFragmentRangeForPageFlip(b,a);this.createNewRequest(this.loadedType.PREVIOUS,null);this.loadFragmentsForRange(b)}};b.considerLoadingMoreFragments=function(b){if(this.canPreloadNext){var a=b!==this.direction.PREVIOUS?4:2;if(this.getApproximateNumNextScreens()<a&&this.hasMoreNextFragments()){this.loadNextPages();return}}this.canPreloadPrevious&&
        (b=b===this.direction.PREVIOUS?4:2,this.getApproximateNumPrevScreens()<b&&this.hasMorePreviousFragments()&&this.loadPreviousPages())};b.crossSkeletonBoundary=function(){var b=this.contentRange[this.visibleIframeIndex],a=this.contentRange[this.hiddenIframeIndex];if(this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.NEXT)if(b.skeletonId+1===a.skeletonId)return this.swapIframes(),!0;else if(b.skeletonId!==a.skeletonId)return this.iframeLoadStatus[this.hiddenIframeIndex]=this.loadedType.EMPTY,
            !1;if(this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.PREVIOUS)if(b.skeletonId-1===a.skeletonId)return this.swapIframes(),!0;else if(b.skeletonId!==a.skeletonId)this.iframeLoadStatus[this.hiddenIframeIndex]=this.loadedType.EMPTY;return!1};b.cleanup=function(){this.cancelCurrentRequest();KindleRendererIframeLoading.cleanupIframe(this.iframes[this.visibleIframeIndex]);KindleRendererIframeLoading.cleanupIframe(this.iframes[this.hiddenIframeIndex]);this.setOverlayManager(null);this.contentRange=
            [null,null];this.positionData=[null,null];this.iframes=null};b.hasMoreNextFragments=function(){return this.contentRange[this.visibleIframeIndex].endPosition!==KindleRendererFragmentLoader.getMaximumPosition()};b.hasMorePreviousFragments=function(){return this.contentRange[this.visibleIframeIndex].startPosition!==KindleRendererFragmentLoader.getMinimumPosition()};b.isAtEndOfDocumentOrSkeleton=function(){var b=this.contentRange[this.visibleIframeIndex];return KindleRendererFragmentLoader.isPositionAtEndOfSkeletonOrDocument(b.skeletonId,
            b.endPosition)};b.isAtBeginningOfDocumentOrSkeleton=function(){var b=this.contentRange[this.visibleIframeIndex];return KindleRendererFragmentLoader.isPositionAtBeginningOfSkeletonOrDocument(b.skeletonId,b.startPosition)};b.getApproximateNumNextScreens=function(){return this.regionManagers[this.visibleIframeIndex].getApproximateNumNextScreens(this.isAtEndOfDocumentOrSkeleton())};b.getApproximateNumPrevScreens=function(){return this.regionManagers[this.visibleIframeIndex].getApproximateNumPrevScreens(this.isAtBeginningOfDocumentOrSkeleton())};
        b.hasNextScreen=function(){return this.regionManagers[this.visibleIframeIndex].hasNextScreen(this.isAtEndOfDocumentOrSkeleton())||this.hasMoreNextFragments()};b.hasPreviousScreen=function(){return this.regionManagers[this.visibleIframeIndex].hasPreviousScreen(this.isAtBeginningOfDocumentOrSkeleton())||this.hasMorePreviousFragments()};b.updateDisplayedPositionsInPage=function(){var b=this.getPagePositionRange();KindleRendererPositionLoadingCalculator.updateDisplayedPositionRange(b.currentBottomOfPage-
            b.currentTopOfPage)};b.considerFlippingFrames=function(){var b=this.iframeLoadStatus[this.hiddenIframeIndex];if(b!==this.loadedType.EMPTY){var a=this.getPagePositionRange(),c=this.contentRange[this.hiddenIframeIndex],d=0,e=0;b===this.loadedType.NEXT?e=1:d=1;if(a.currentTopOfPage>=c.startPosition+d&&a.currentBottomOfPage<=c.endPosition-e){a=this.regionManagers[this.hiddenIframeIndex];c=this.regionManagers[this.visibleIframeIndex].getPagePositionRange();if(b===this.loadedType.NEXT){if(b={position:c.currentBottomOfPage,
            allowPartialScreen:this.isAtEndOfDocumentOrSkeleton()},b=a.updateView(KindleRegionManagerFactory.VIEW_REQUEST.NEXT_PAGE,b),!b)return this.requestMoreNextPages(),!1}else if(b={position:c.currentTopOfPage,allowPartialScreen:this.isAtBeginningOfDocumentOrSkeleton()},b=a.updateView(KindleRegionManagerFactory.VIEW_REQUEST.PREVIOUS_PAGE,b),!b)return this.requestMorePreviousPages(),!1;this.swapIframes();return!0}}return!1};b.nextScreen=function(){var b=this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.NEXT;
            if(b&&this.considerFlippingFrames())return!0;var a=this.isAtEndOfDocumentOrSkeleton(),c=this.regionManagers[this.visibleIframeIndex].nextScreen(a);if(!c)if(this.hasMoreNextFragments())if(b&&a&&this.crossSkeletonBoundary())c=!0;else return this.requestMoreNextPages(),!1;else c=!0;this.considerLoadingMoreFragments(this.direction.NEXT);this.updateDisplayedPositionsInPage();KindleDebug.log("Next Screen Success:"+c);return c};b.requestMoreNextPages=function(){var b=this.getPagePositionRange(),a=this.contentRange[this.visibleIframeIndex];
            b.currentBottomOfPage&&KindleRendererPositionLoadingCalculator.updateDisplayedPositionRange(a.endPosition-b.currentBottomOfPage);this.iframeLoadStatus[this.hiddenIframeIndex]=this.loadedType.EMPTY;this.loadNextPages()};b.requestMorePreviousPages=function(){var b=this.getPagePositionRange(),a=this.contentRange[this.visibleIframeIndex];b.currentTopOfPage&&KindleRendererPositionLoadingCalculator.updateDisplayedPositionRange(b.currentTopOfPage-a.startPosition);this.iframeLoadStatus[this.hiddenIframeIndex]=
            this.loadedType.EMPTY;this.loadPreviousPages()};b.previousScreen=function(){KindleDebug.log("****Prev screen****");if(this.iframeLoadStatus[this.hiddenIframeIndex]===this.loadedType.PREVIOUS&&this.considerFlippingFrames())return!0;var b=this.isAtBeginningOfDocumentOrSkeleton(),a=this.regionManagers[this.visibleIframeIndex].previousScreen(b);if(!a&&this.hasMorePreviousFragments())if(b&&this.crossSkeletonBoundary())a=!0;else return this.requestMorePreviousPages(),!1;else!a&&!this.hasMorePreviousFragments()&&
        KindleDebug.error("PreviousScreen: Was not able to go to previous screen, and there is no more previous fragments.");this.considerLoadingMoreFragments(this.direction.PREVIOUS);this.updateDisplayedPositionsInPage();return a};b.cancelHiddenIframeLoading=function(){var b=this.iframes[this.hiddenIframeIndex];if(b.processingRequestId.id!==null)b.processingRequestId.id=null,this.cancelCurrentRequest()};b.scaleElementsInIframe=function(b){var a=this.getViewportDimensions(b);if(b&&b.contentDocument&&b.contentDocument.body){b.writingMode=
            KindleRendererWritingModeFactory.buildIFrameWritingMode(b);b.writingMode.resetIframeDimensions(b);var c;c=this.currentRequest&&this.currentRequest.contentLoadMetrics?this.currentRequest.contentLoadMetrics:KindleMetricsProfiler("content-load");this.ensureElementsWillFit(b,a,c).then(function(){c.endTimer()})}};b.getViewportDimensions=function(b){var a=$(this.parent).width(),c=this.numColumns-1,d=this.getMargins(this.margin),c=parseInt((a-(this.columnGap-(d.left+d.right))*c)/this.numColumns,10);return{height:$(b).parent().height(),
            width:c,parentWidth:a}};b.updateSettings=function(b){var a=this.visibleIframeIndex,c=this.hiddenIframeIndex,d=this.getPagePositionRange().currentTopOfPage;if(b.columns!==void 0){if(b.columns.num!==void 0){this.numColumns=b.columns.num;this.regionManagers[a].computeFilledRegionNodes();this.scaleElementsInIframe(this.iframes[a]);var e=this;setTimeout(function(){e.regionManagers[c].computeFilledRegionNodes();e.scaleElementsInIframe(e.iframes[c]);e=null},0)}if(b.columns.gap!==void 0)this.columnGap=parseInt(b.columns.gap,
            10)}if(b.margin!==void 0)this.margin=b.margin;KindleRendererIframeLoading.updateSettingsInIframe(this.iframes[a]);var f=this;setTimeout(function(){KindleRendererIframeLoading.updateSettingsInIframe(f.iframes[c]);f=null},0);d&&(this.regionManagers[a].updateView(KindleRegionManagerFactory.VIEW_REQUEST.GO_TO_POSITION,{position:d}),this.updateDisplayedPositionsInPage())};b.getMargins=function(b){if(this.parent&&b&&b.length>0){var a=document.getElementById("renderer_translation_div");if(!a)a=document.createElement("div"),
            a.id="renderer_translation_div",$(a).css({visibility:"hidden","z-index":-1E3}),this.parent.appendChild(a);$(a).css({margin:b});b=window.getComputedStyle(a);return{top:parseFloat(b.marginTop),bottom:parseFloat(b.marginBottom),left:parseFloat(b.marginLeft),right:parseFloat(b.marginRight)}}return{top:0,bottom:0,left:0,right:0}};b.reloadNotification=function(){this.contentRange=[null,null];this.positionData=[null,null];this.cancelHiddenIframeLoading();this.iframeLoadStatus=[this.loadedType.EMPTY,this.loadedType.EMPTY]};
        b.resizeNotification=function(){var b=this.getPagePositionRange();this.regionManagers[this.visibleIframeIndex].updateView(KindleRegionManagerFactory.VIEW_REQUEST.GO_TO_POSITION,{position:b.currentTopOfPage});this.updateDisplayedPositionsInPage()};b.updateGlyphColorForFrameIndex=function(b){this.iframes[b].hasGlyphs&&this.iframes[b].contentDocument&&KindleGlyphRenderer.updateTextColor(this.iframes[b])};b.updateGlyphColor=function(){this.updateGlyphColorForFrameIndex(this.visibleIframeIndex);this.updateGlyphColorForFrameIndex(this.hiddenIframeIndex)};
        b.setAnnotationEventCallback=function(b){this.annotationEventCallback=b};b.getCurrentProcessDfd=function(){return this.currentRequestDfd.promise()};b.getCurrentProcessId=function(){return this.currentRequest.requestId};b.getZoomableAt=function(b,a,c){return KindleRendererZoomablesFactory.buildFromCoord(this.iframes[this.visibleIframeIndex].contentDocument,b,a,c)};b.getZoomableList=function(b){return KindleRendererZoomablesFactory.buildList(this.iframes[this.visibleIframeIndex].contentDocument,b)};
        b.addClickHandlers=function(b){var a=this,b=$("mark["+KindleRendererAnnotationRenderer.ANNOTATION_CLICK_ATTRIBUTE+"='true']",b.contentDocument).children();$(b).unbind("click");$(b).click(function(b){a.annotationClickedHandler(b)})};b.createAnnotationElements=function(b,a){KindleRegionAnnotationRenderer.createAnnotationElements(b,a);this.addClickHandlers(b)};b.addAnnotation=function(b,a,c){b&&a&&c&&a.startPosition<=c.end&&c.start<=a.endPosition&&this.createAnnotationElements(b,[c])};b.removeAnnotation=
            function(b,a){b&&a&&KindleRegionAnnotationRenderer.removeAnnotationElements(b,a)};b.onOverlayAdded=function(c){b.addAnnotation(b.iframes[0],b.contentRange[0],c.overlay);b.addAnnotation(b.iframes[1],b.contentRange[1],c.overlay)};b.onOverlayRemoved=function(c){b.removeAnnotation(b.iframes[0],c.overlay);b.removeAnnotation(b.iframes[1],c.overlay)};b.setOverlayManager=function(b){this.overlayManager&&(this.overlayManager.removeEventListener(this.overlayManager.OVERLAY_ADDED_EVENT,this.onOverlayAdded),
            this.overlayManager.removeEventListener(this.overlayManager.OVERLAY_REMOVED_EVENT,this.onOverlayRemoved));if(this.overlayManager=b)this.overlayManager.addEventListener(this.overlayManager.OVERLAY_ADDED_EVENT,this.onOverlayAdded),this.overlayManager.addEventListener(this.overlayManager.OVERLAY_REMOVED_EVENT,this.onOverlayRemoved)};b.setCanPreloadNext=function(b){this.canPreloadNext=b};b.setCanPreloadPrevious=function(b){this.canPreloadPrevious=b};b.clearSelection=function(){var b=this.iframes[this.visibleIframeIndex].contentWindow;
            if(this.selection)this.selection.select(),this.selection=null;b.window.getSelection&&(b.window.getSelection().empty?b.window.getSelection.empty():b.window.getSelection().removeAllRanges&&b.window.getSelection().removeAllRanges());b.document.selection&&b.document.selection.empty&&b.document.selection.empty()};b.getSelection=function(){var b=this.iframes[this.visibleIframeIndex].contentWindow,a=null,a=KindleHostDeviceDetector.getDevicePlatform(),c=null,d=this.selection;d&&d.select();if((a==="metro"||
            a==="metroArm"||KindleHostDeviceDetector.isIE())&&b.document.selection)a=b.document.selection,c=this.createSelectionForIE(a);return c};b.createSelectionForIE=function(b){var a=KindleRendererDeviceSpecific.resolutionScale(),c=this.regionManagers[this.visibleIframeIndex].getOffsetTop()*a,b=b.createRange(),d=b.getClientRects(),e=d[d.length-1].width?d[d.length-1]:d[d.length-2],d=d[0],f={},k=null,k=null;b.text.indexOf(" ")!==0&&b.expand("word");f.context=b.text;k=document.createElement("div");k.innerHTML=
            b.htmlText;k=this.getSelectionBoundaries(k);f.start=parseInt(k.start,10);f.end=parseInt(k.end,10);f.lowerBounds={};f.lowerBounds.right=e.right/a;f.lowerBounds.bottom=(e.bottom-c)/a;f.lowerBounds.left=e.left/a;f.lowerBounds.top=(e.top-c)/a;f.lowerBounds.width=e.width/a;f.lowerBounds.height=e.height/a;f.upperBounds={};f.upperBounds.left=d.left/a;f.upperBounds.top=(d.top-c)/a;f.upperBounds.right=d.right/a;f.upperBounds.bottom=(d.bottom-c)/a;f.upperBounds.width=d.width/a;f.upperBounds.height=d.height/
            a;return f};b.getSelectionBoundaries=function(b){var a=[],c={},a=b.getElementsByTagName("canvas");if(a.length!==0)c.start=a[0].id,c.end=a[a.length-1].id;else if(a=b.getElementsByTagName("span"),a.length!==0){for(b=0;isNaN(a[b].id);)b++;c.start=a[b].id;for(b=1;isNaN(a[a.length-b].id);)b++;c.end=a[a.length-b].id}return c};b.addSelectionListener=function(b){function a(a){if(a.type==="MSPointerDown")e.addPointer(a.pointerId);else if(a.type==="MSGestureTap"&&b.contentWindow.document.selection.type==="Text")d.selection=
            null}var c=b.contentDocument.getElementsByTagName("body")[0],d=this;c.onselect=function(a){var c=b.contentWindow.document.selection;if(c&&c.type==="Text"){if(c=c.createRange(),!d.selection||!c.isEqual(d.selection))d.selection=c,c=b.ownerDocument.createEvent("CustomEvent"),c.initCustomEvent(a.type,!0,!0,a),b.dispatchEvent(c)}else d.selection=null};b.contentDocument.onselectionchange=function(a){var c=b.contentWindow.document.selection;if(c&&c.type==="Text"&&(c=c.createRange(),d.selection&&!c.isEqual(d.selection)))d.selection=
            null,c=b.ownerDocument.createEvent("CustomEvent"),c.initCustomEvent(a.type,!0,!0,a),b.dispatchEvent(c)};c.onselectstart=function(a){var c=b.contentWindow.document.selection;if(c&&c.type==="None"&&d.selection)d.selection=null,a.preventDefault()};c.ondblclick=function(a){d.selection=null;var c=b.ownerDocument.createEvent("MouseEvent");c.initMouseEvent(a.type,!0,!0,window.parent,a.detail,a.screenX,a.screenY,a.clientX,a.clientY,a.ctrlKey,a.altKey,a.shiftKey,a.metaKey,a.button,null);b.dispatchEvent(c)};
            if(window.MSGesture){var e=new MSGesture;e.target=c;c.addEventListener("MSGestureTap",a,!1);c.addEventListener("MSPointerDown",a,!1)}}}var m=0,k=m++,e=m++,d=m++,c=5;return{DATA_LOAD_ERROR:k,IFRAME_ERROR_LOADING:e,IFRAME_ERROR_PAGINATING:d,build:function(b,c){for(var a=[],d=[],e=0;e<2;e+=1){var j,k=e,m=c;j=document.createElement("iframe");var o="flow_"+k;j.index=k;j.processingRequestId={};j.setAttribute("frameBorder","0");j.setAttribute("id","frame_"+k);j.setAttribute("name","book_iframe_"+k);j.setAttribute("scrolling",
            "no");j.style.msFlowInto=o;$(j).css({msFlowInto:o,position:"absolute",top:"0px",left:"0px",display:"none"});k=KindleRegionManagerFactory.build(j,o,m);j={iframe:j,regionManager:k};a[e]=j.iframe;d[e]=j.regionManager;c.appendChild(a[e])}b.loadedType={EMPTY:0,GOTO_POSITION:1,NEXT:2,PREVIOUS:3};b.direction={NEXT:2,PREVIOUS:3};b.iframes=a;b.regionManagers=d;b.iframeLoadStatus=[b.loadedType.EMPTY,b.loadedType.EMPTY];b.contentRange=[null,null];b.positionData=[null,null];b.visibleIframeIndex=0;b.hiddenIframeIndex=
            1;b.overlayManager=null;b.numColumns=1;b.columnGap=20;b.margin=0;b.parent=c;b.selection=null;f(b)}}}();
function KindleRegionNodeFactory(f){var m=null,k=null,e=null,d=null;return{show:function(){f.style.left="0px"},hide:function(){f.style.left="-9999px"},setPagePositionRange:function(c,b){m=c;k=b},getPagePositionRange:function(){return{topOfPagePosition:m,bottomOfPagePosition:k}},setNumPageBreaks:function(c){e=c},getNumPageBreaks:function(){return e},getRegionContent:function(){return f.msGetRegionContent()},getRegionOverflow:function(){return d=f.msRegionOverflow},getCachedRegionOverflow:function(){return d},
    getHeight:function(){return f.clientHeight}}}
function KindleRegionPageBreakPivot(f){var m,k;return{insert:function(e){if(!m){var d=f.contentDocument.createElement("div");d.className="renderer-page-break";for(var c=f.contentWindow.document.getElementById(e);!c.previousSibling&&!KindleRendererUtils.isBlock(c)&&c.parentNode.tagName!=="BODY";)c=c.parentNode;f.contentWindow.document.body.firstElementChild!==c&&(c.parentNode.insertBefore(d,c),k=e,m=d)}},clear:function(){var e=f.contentDocument.getElementsByClassName("renderer-page-break");e&&e.length>
    0&&e[0].parentNode.removeChild(e[0]);k=m=null},getPosition:function(){return k}}}
var KindleRegionManagerFactory=function(){function f(c){c.updateView=function(b,c){var a,d=!1,e=c.position,f=c.allowPartialScreen;switch(b){case k.NEXT_PAGE:a=this.findPositionAfter(e);break;case k.PREVIOUS_PAGE:a=this.findPositionBefore(e);if(KindleRendererUtils.isNumeric(a))return d=this.showPreviousPage(a,f);break;case k.GO_TO_POSITION:this.computeFilledRegionNodes(),a=this.findPositionForGoTo(e)}KindleRendererUtils.isNumeric(a)&&(d=this.showPositionAtStart(a));return d};c.createDocumentFragmentWithRegions=
    function(b){for(var c=document.createDocumentFragment(),a=0;a<b;a++){var d=document.createElement("div");$(d).css({msFlowFrom:this.flowName,position:"absolute",top:"0px",left:"-9999px",width:"100%",height:"100%","z-index":"100"});c.appendChild(d)}return c};c.computeFilledRegionNodes=function(){function b(a){for(var b=[],c=0;c<a.length;c++)b.push(KindleRegionNodeFactory(a[c]));return b}var c=this.regions,a;this.regionCount===-1&&(c=this.createDocumentFragmentWithRegions(KindleRendererDeviceSpecific.defaultNumRegions()),
    this.container.appendChild(c),c=b(this.container.children),c=Array.prototype.slice.call(c));for(a=c[c.length-1].getRegionOverflow();a==="overflow"||a==="fit";)c=this.createDocumentFragmentWithRegions(c.length/4),this.container.appendChild(c),c=b(this.container.children),c=Array.prototype.slice.call(c),a=c[c.length-1].getRegionOverflow();for(var d=0;d<c.length;d++)if(a=c[d].getRegionOverflow(),a==="empty"){this.regionCount=d;break}this.regions=c};c.getRegionWithPosition=function(b){for(var c=this.regions,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  a,d=0;d<this.regionCount;d++)if(a=c[d].getPagePositionRange(),b>=a.topOfPagePosition&&b<=a.bottomOfPagePosition)return d;return null};c.showRegionWithPosition=function(b){var c=this.indexVisible,b=this.getRegionWithPosition(b);return b!==null?(this.hideRegion(c),this.showRegion(b),!0):!1};c.showRegion=function(b){var c=this.regions;return b!==null&&b>=0&&b<this.regionCount?(c[b].show(),this.indexVisible=b,!0):!1};c.hideRegion=function(b){var c=this.regions;return b!==null&&b>=0&&b<c.length?(c[b].hide(),
    !0):!1};c.findPositionBefore=function(b){return this.findNearestPosition(b,this.DIRECTION.PREV)};c.findPositionAfter=function(b){return this.findNearestPosition(b,this.DIRECTION.NEXT)};c.findNearestPosition=function(b,c){function a(){for(var a=d.iframe.contentWindow.document.querySelectorAll(e),f=null,h=Infinity,o=0;o<a.length;o++){var k=parseInt(a[o].id,10)-b;!(c===d.DIRECTION.PREV&&k>0)&&!(c===d.DIRECTION.NEXT&&k<0)&&(k=Math.abs(k),k>0&&k<h&&(h=k,f=a[o]))}return f}var d=this,f=null,f=(f=this.iframe.contentWindow.document.getElementById(b))?
    c===this.DIRECTION.PREV?KindleRendererUtils.previousPositionedNode(f):c===this.DIRECTION.NEXT?KindleRendererUtils.nextPositionedNode(f):KindleRendererUtils.nextPositionedNode(f)||KindleRendererUtils.previousPositionedNode(f):a(),d=null;return f?parseInt(f.id,10):null};c.showPositionAtStart=function(b){return(b=this.iframe.contentWindow.document.getElementById(b))?(this.pageBreakPivot.clear(),this.pageBreakPivot.insert(b.id),this.computeFilledRegionNodes(),this.computePaginationData(),this.showRegionWithPosition(b.id)):
    !1};c.fixPaginationDataHack=function(b,c){if(c>1){var a,d;for(a=0;a<c-1;a++){var e=b[a].getPagePositionRange();if(e.topOfPagePosition!==null)for(d=a+1;d<c;d++){var f=b[d].getPagePositionRange();if(f.topOfPagePosition!==null&&f.bottomOfPagePosition!==null){d=null;d=e.topOfPagePosition===f.topOfPagePosition?e.topOfPagePosition:f.topOfPagePosition-1;b[a].setPagePositionRange(e.topOfPagePosition,d);break}}}a=0;for(e=1;e<c;e++)a+=b[e].getNumPageBreaks();b[0].setNumPageBreaks(b[0].getNumPageBreaks()-a)}};
    c.computePaginationData=function(){for(var b=this.regions,c=this.regionCount,a=0;a<c;a++){for(var f=b[a],h=f.getRegionContent(),j=[],k=[],m=[],o,q=null,s=null,r=0;r<h.length;r++)m[r]=h[r].cloneContents().querySelectorAll(e),j=j.concat(Array.prototype.slice.call(m[r])),o=h[r].cloneContents().querySelectorAll(d),k=k.concat(Array.prototype.slice.call(o));j.length&&(q=parseInt(j[0].id,10),s=parseInt(j[j.length-1].id,10));f.setPagePositionRange(q,s);f.setNumPageBreaks(k.length)}this.fixPaginationDataHack(b,
        c)};c.cleanUp=function(){$(this.container).empty();this.regions=[]};c.getPagePositionRange=function(){var b={},c=this.regions,a=this.indexVisible;c&&a!==null&&(b=c[a].getPagePositionRange(),b={currentTopOfPage:b.topOfPagePosition?b.topOfPagePosition:0,currentBottomOfPage:b.bottomOfPagePosition?b.bottomOfPagePosition:0});return b};c.findNextScreen=function(b,c){for(var a=(KindleRendererUtils.isNumeric(c)?c:this.indexVisible)+1;a<this.regionCount;){var d=this.regions[a].getPagePositionRange();if(d.topOfPagePosition!==
        null||d.bottomOfPagePosition!==null){if(b)return a;if(this.findPositionAfter(d.bottomOfPagePosition)===null){for(d=this.iframe.contentWindow.document.getElementById(d.bottomOfPagePosition);d.parentNode&&d.parentNode.tagName!=="BODY";)d=d.parentNode;for(;d.nextSibling;){if(d.nextSibling.nodeName==="DIV"&&d.nextSibling.id!=="content-overlays")return null;d=d.nextSibling}}return a}a++}return null};c.findPreviousScreen=function(b,c){for(var a=(KindleRendererUtils.isNumeric(c)?c:this.indexVisible)-1;a>=
    0;){var d=this.regions[a].getPagePositionRange();if(d.topOfPagePosition!==null||d.bottomOfPagePosition!==null){if(b)return a;if(this.findPositionBefore(d.topOfPagePosition)===null){for(d=this.iframe.contentWindow.document.getElementById(d.topOfPagePosition);d.parentNode&&d.parentNode.tagName!=="BODY";)d=d.parentNode;for(;d.previousSibling;){if(d.previousSibling.nodeName==="DIV"&&d.previousSibling.id!=="content-overlays")return null;d=d.previousSibling}}return a}a--}return null};c.hasNextScreen=function(b){return this.findNextScreen(b)!==
        null};c.hasPreviousScreen=function(b){return this.findPreviousScreen(b)!==null};c.nextScreen=function(b){var c=!0,c=this.regions,a=this.indexVisible,d=this.findNextScreen(b);this.hideRegion(a);d===null||c[d].getCachedRegionOverflow()!=="overflow"&&!b?(c=!1,KindleDebug.log("NextScreen: No more next screens to show.")):c=this.showRegion(d);return c};c.previousScreen=function(b){var c=!0,a=this.regions,d=this.indexVisible,e=this.findPreviousScreen(b);this.hideRegion(d);if(e===null||a[e].getCachedRegionOverflow()!==
        "overflow"&&!b)c=!1,KindleDebug.log("PreviousScreen: No more previous screens to show.");else{if((a=this.pageBreakPivot.getPosition())&&this.getRegionWithPosition(a)-1===e)if(a=this.findPositionBefore(this.getPagePositionRange().currentTopOfPage),KindleRendererUtils.isNumeric(a))return this.showPreviousPage(a,b);else if(b&&e===0)return KindleDebug.log("PreviousScreen: Could not find a position before to show. Assuming it is a cover."),this.pageBreakPivot.clear(),this.computeFilledRegionNodes(),this.computePaginationData(),
        this.showRegion(e);wasAbleToGoToNextScreen=this.showRegion(e)}return c};c.getNumColumns=function(){return parseInt(this.iframe.contentWindow.document.body.currentStyle.columnCount,10)};c.showPreviousPage=function(b,c){this.pageBreakPivot.clear();this.computeFilledRegionNodes();this.computePaginationData();var a=this.getRegionWithPosition(b),f=this.regions[a],h=this.getBoundingClientRect(this.iframe.contentWindow.document.getElementById(b)),j=this.container.getBoundingClientRect();if(f.getNumPageBreaks()>
        0||f.getPagePositionRange().bottomOfPagePosition===b)return this.showRegionWithPosition(b),!0;var k=this.getNumColumns(),f=h.bottom,m=j.width/k,o=null;if(f-j.top<h.height)return!0;if(k>1)for(j=1;j<=k;j++)if(h.left<m*j){o={start:m*(j-1),end:m*j};break}k=this.findPreviousScreen(c,a);if(k===null)c&&this.showRegionWithPosition(b);else{a=this.regions[k].getRegionContent();if(a.length>0){a=a[0].cloneContents().querySelectorAll(e+","+d);h=null;for(m=j=0;m!==this.regions[k].getNumPageBreaks();){var q=$(a[j]);
        (q.hasClass("page-break")||q.hasClass("pagebreak"))&&m++;j++}for(;j<a.length;j++)if(k=this.iframe.contentWindow.document.getElementById(a[j].id),m=this.getBoundingClientRect(k),q=o?m.left>o.start&&m.left<o.end:!0,m.top>f&&q){h=k;break}h&&(this.pageBreakPivot.insert(h.id),this.computeFilledRegionNodes(),this.computePaginationData())}this.showRegionWithPosition(b);return!0}return!1};c.getBoundingClientRect=function(b){var b=b.getBoundingClientRect(),c=KindleRendererDeviceSpecific.resolutionScale();
        return{height:b.height/c,width:b.width/c,left:b.left/c,right:b.right/c,top:(b.top%this.container.clientHeight+this.container.getBoundingClientRect().top)/c,bottom:(b.bottom%this.container.clientHeight+this.container.getBoundingClientRect().top)/c}};c.show=function(){this.container.style.left="0px"};c.hide=function(){this.container.style.left="-9999px"};c.getApproximateNumNextScreens=function(b){for(var c=0,a=this.findNextScreen(b,this.indexVisible);a!==null&&a<this.regionCount;)a=this.findNextScreen(b,
        a+1),c++;KindleDebug.log("getApproximateNumNextScreens: # of next screens left:"+c);return c};c.getApproximateNumPrevScreens=function(b){for(var c=0,a=this.findPreviousScreen(b,this.indexVisible);a!==null&&a>0;)a=this.findPreviousScreen(b,a-1),c++;KindleDebug.log("getApproximateNumPrevScreens: # of prev screens left:"+c);return c};c.getOffsetTop=function(){return this.regions[this.indexVisible].getHeight()*this.indexVisible};c.findPositionForGoTo=function(b){function c(a){for(var b=a,d=parseInt(b.id,
        10),a=a.getClientRects()[0].top;b;)if((b=KindleRendererUtils.previousPositionedNode(b))&&b.getClientRects()[0].top===a)d=parseInt(b.id,10);else break;return d}var a=this.iframe,d=a.contentDocument.getElementById(b);if(!d){var e=this.findPositionAfter(b)||this.findPositionBefore(b);e&&(d=a.contentWindow.document.getElementById(e))}return d?c(d):b}}function m(c){c.nextScreen=function(b){return this.internal.nextScreen(b)};c.previousScreen=function(b){return this.internal.previousScreen(b)};c.hasNextScreen=
    function(b){return this.internal.hasNextScreen(b)};c.hasPreviousScreen=function(b){return this.internal.hasPreviousScreen(b)};c.getPagePositionRange=function(){return this.internal.getPagePositionRange()};c.cleanup=function(){this.internal.cleanup()};c.show=function(){this.internal.show()};c.hide=function(){this.internal.hide()};c.updateView=function(b,c){return this.internal.updateView(b,c)};c.getApproximateNumNextScreens=function(b){return this.internal.getApproximateNumNextScreens(b)};c.getApproximateNumPrevScreens=
    function(b){return this.internal.getApproximateNumPrevScreens(b)};c.getOffsetTop=function(){return this.internal.getOffsetTop()};c.computeFilledRegionNodes=function(){this.internal.computeFilledRegionNodes()}}var k={GO_TO_POSITION:1,NEXT_PAGE:2,PREVIOUS_PAGE:3},e="span.k4w, canvas.k4wc, img",d=".page-break, .pagebreak";return{VIEW_REQUEST:k,build:function(c,b,d){var a={internal:{}};a.internal.DIRECTION={NEXT:"next",PREV:"prev"};var e=a.internal,h=document.createElement("div");h.id="container_"+b;
        $(h).css({position:"absolute",top:"0px",left:"0px",height:"100%",width:"100%"});d.appendChild(h);e.iframe=c;e.flowName=b;e.parent=d;e.container=h;e.regions=[];e.regionCount=-1;e.indexVisible=null;e.pageBreakPivot=KindleRegionPageBreakPivot(c);f(a.internal);m(a);return a}}}(),KindleRendererDeviceSpecific=function(){var f={};return{initialize:function(){var m=KindleHostDeviceDetector.getDevicePlatform();if(m==="desktop"){f.fragmentBufferCapacityForGoTo=2;f.fragmentBufferCapacityForPageFlip=10;f.fragmentBufferCapacityForPageFlipGlyphs=
        3;f.drawYieldUpdateTime=25;f.drawYieldScreenManagerFrequency=5E3;f.drawYieldGlyphRendereringFrequency=1E3;f.drawYieldWordMapGenFrequency=5E3;f.drawYieldWordMapGenUpdateTime=25;f.drawYieldHeightMapFrequency=5E3;f.drawYieldHeightMapUpdateTime=25;f.drawYieldSanitizeNodesFrequency=2500;f.drawYieldSanitizeNodesTime=0;f.reflowTimeout=-1;f.maximumCanvases=4900;f.clientRectsExpire=KindleHostDeviceDetector.isIE();f.rendererInitializationTimeout=6E4;f.glyphCacheMaxSize=15;if(KindleHostDeviceDetector.hasCanvasPerformanceProblem())f.maximumCanvases=
        1750,f.drawYieldGlyphRendereringFrequency=200;if(m!=="metro"&&KindleHostDeviceDetector.isIE())f.fragmentBufferCapacityForPageFlip=6,f.drawYieldUpdateTime=0,f.drawYieldScreenManagerFrequency=500,f.drawYieldGlyphRendereringFrequency=200,f.drawYieldWordMapGenFrequency=500,f.drawYieldWordMapGenUpdateTime=0,f.drawYieldHeightMapFrequency=500,f.drawYieldHeightMapUpdateTime=25,f.yieldTimeOnContentReceived=0,f.yieldTimeAfterBulkWriteToIframe=0,f.yieldTimeBeforeBulkWriteToIframe=0,f.yieldTimeAfterIframeLoaded=
        0,f.yieldTimeLoadNextFragment=0,f.maximumCanvases=1750,f.clientRectsExpire=!0,f.mightUseCSSRegions=!0,f.defaultNumRegions=25,f.mightUseNativeSelection=!0}else m==="lassen"?(f.fragmentBufferCapacityForGoTo=1.2,f.fragmentBufferCapacityForPageFlip=7,f.fragmentBufferCapacityForPageFlipGlyphs=2,f.drawYieldGlyphRendereringFrequency=200,f.reflowTimeout=2E4,f.maximumCanvases=1750,f.rendererInitializationTimeout=2E4,f.drawYieldSanitizeNodesFrequency=2500,f.drawYieldSanitizeNodesTime=0,KindleHostDeviceDetector.isiPhone()?
        (f.drawYieldWordMapGenFrequency=20,f.drawYieldWordMapGenUpdateTime=10,f.drawYieldHeightMapFrequency=500,f.drawYieldHeightMapUpdateTime=10,f.drawYieldScreenManagerFrequency=250,f.drawYieldUpdateTime=50):(f.drawYieldWordMapGenFrequency=300,f.drawYieldWordMapGenUpdateTime=50,f.drawYieldHeightMapFrequency=500,f.drawYieldHeightMapUpdateTime=20,f.drawYieldScreenManagerFrequency=250,f.drawYieldUpdateTime=10)):m==="metro"?(f.fragmentBufferCapacityForGoTo=2,f.fragmentBufferCapacityForPageFlip=6,f.fragmentBufferCapacityForPageFlipGlyphs=
        3,f.drawYieldUpdateTime=0,f.drawYieldScreenManagerFrequency=500,f.drawYieldGlyphRendereringFrequency=200,f.drawYieldWordMapGenFrequency=500,f.drawYieldWordMapGenUpdateTime=0,f.drawYieldHeightMapFrequency=500,f.drawYieldHeightMapUpdateTime=25,f.yieldTimeOnContentReceived=0,f.yieldTimeAfterBulkWriteToIframe=0,f.yieldTimeBeforeBulkWriteToIframe=0,f.yieldTimeAfterIframeLoaded=0,f.yieldTimeLoadNextFragment=0,f.reflowTimeout=-1,f.maximumCanvases=1750,f.clientRectsExpire=!0,f.rendererInitializationTimeout=
        6E4,f.drawYieldSanitizeNodesFrequency=2500,f.drawYieldSanitizeNodesTime=0,f.glyphCacheMaxSize=15,f.mightUseCSSRegions=!0,f.defaultNumRegions=25,f.mightUseNativeSelection=!0):m==="metroArm"?(f.fragmentBufferCapacityForGoTo=1.2,f.fragmentBufferCapacityForPageFlip=5,f.fragmentBufferCapacityForPageFlipGlyphs=2,f.drawYieldUpdateTime=0,f.drawYieldScreenManagerFrequency=500,f.drawYieldGlyphRendereringFrequency=200,f.drawYieldWordMapGenFrequency=500,f.drawYieldWordMapGenUpdateTime=0,f.drawYieldHeightMapFrequency=
        500,f.drawYieldHeightMapUpdateTime=25,f.yieldTimeOnContentReceived=0,f.yieldTimeAfterBulkWriteToIframe=0,f.yieldTimeBeforeBulkWriteToIframe=0,f.yieldTimeAfterIframeLoaded=0,f.yieldTimeLoadNextFragment=0,f.reflowTimeout=-1,f.maximumCanvases=1750,f.clientRectsExpire=!0,f.rendererInitializationTimeout=9E4,f.drawYieldSanitizeNodesFrequency=2500,f.drawYieldSanitizeNodesTime=0,f.glyphCacheMaxSize=15,f.animatePageFlip=!1,f.mightUseCSSRegions=!0,f.defaultNumRegions=15,f.mightUseNativeSelection=!0):(f.fragmentBufferCapacityForGoTo=
        1.2,f.fragmentBufferCapacityForPageFlip=7,f.fragmentBufferCapacityForPageFlipGlyphs=2,f.drawYieldUpdateTime=50,f.drawYieldScreenManagerFrequency=250,f.drawYieldGlyphRendereringFrequency=200,f.drawYieldWordMapGenFrequency=300,f.drawYieldWordMapGenUpdateTime=50,f.drawYieldHeightMapFrequency=5E3,f.drawYieldHeightMapUpdateTime=50,f.drawYieldSanitizeNodesFrequency=2500,f.drawYieldSanitizeNodesTime=0,f.reflowTimeout=1E4,f.maximumCanvases=1750,f.rendererInitializationTimeout=9E4,f.animatePageFlip=KindleHostDeviceDetector.isiOS()&&
        !KindleHostDeviceDetector.isiOS_4x());f.needsReflowOnPageFlip=KindleHostDeviceDetector.isiOS_4x()||KindleHostDeviceDetector.isChrome&&KindleHostDeviceDetector.isChrome()&&navigator.userAgent.indexOf("Chrome/18.")>=0;f.usesDocRelativeVerticalCoordinates=KindleHostDeviceDetector.isiOS();f.needsWritingModeSpecifiedOnBody=KindleHostDeviceDetector.isiOS();f.verticalParagraphsScaleSeparately=KindleHostDeviceDetector.isiPhone();f.needsLanguageSpecificItalicsCheck=KindleHostDeviceDetector.isiOS()&&parseInt(KindleHostDeviceDetector.getOSMajorVersion(),
        10)===7;f.shouldRotateECJKChar=KindleHostDeviceDetector.isiOS()&&KindleHostDeviceDetector.getOSMajorVersion&&KindleHostDeviceDetector.getOSMinorVersion&&(parseInt(KindleHostDeviceDetector.getOSMajorVersion(),10)<6||parseInt(KindleHostDeviceDetector.getOSMajorVersion(),10)===6&&parseInt(KindleHostDeviceDetector.getOSMinorVersion(),10)===0)},fragmentBufferCapacityForGoTo:function(){return f.fragmentBufferCapacityForGoTo},fragmentBufferCapacityForPageFlip:function(m){return m?f.fragmentBufferCapacityForPageFlipGlyphs:
        f.fragmentBufferCapacityForPageFlip},drawYieldUpdateTime:function(){return f.drawYieldUpdateTime},glyphCacheMaxSize:function(){return f.glyphCacheMaxSize||0},drawYieldWordMapGenUpdateTime:function(){return f.drawYieldWordMapGenUpdateTime},drawYieldHeightMapUpdateTime:function(){return f.drawYieldHeightMapUpdateTime},drawYieldScreenManagerFrequency:function(){return f.drawYieldScreenManagerFrequency},drawYieldGlyphRendereringFrequency:function(){return f.drawYieldGlyphRendereringFrequency},drawYieldWordMapGenFrequency:function(){return f.drawYieldWordMapGenFrequency},
    drawYieldHeightMapFrequency:function(){return f.drawYieldHeightMapFrequency},drawYieldSanitizeNodesFrequency:function(){return f.drawYieldSanitizeNodesFrequency},yieldTimeOnContentReceived:function(){return f.yieldTimeOnContentReceived},yieldTimeAfterBulkWriteToIframe:function(){return f.yieldTimeAfterBulkWriteToIframe},yieldTimeBeforeBulkWriteToIframe:function(){return f.yieldTimeBeforeBulkWriteToIframe},yieldTimeAfterIframeLoaded:function(){return f.yieldTimeAfterIframeLoaded},yieldTimeLoadNextFragment:function(){return f.yieldTimeLoadNextFragment},
    needsReflowOnPageFlip:function(){return f.needsReflowOnPageFlip},shouldRotateECJKChar:function(){return f.shouldRotateECJKChar},needsLanguageSpecificItalicsCheck:function(){return f.needsLanguageSpecificItalicsCheck},usesDocRelativeVerticalCoordinates:function(){return f.usesDocRelativeVerticalCoordinates},needsWritingModeSpecifiedOnBody:function(){return f.needsWritingModeSpecifiedOnBody},verticalParagraphsScaleSeparately:function(){return f.verticalParagraphsScaleSeparately},reflowTimeout:function(){return f.reflowTimeout},
    maximumCanvases:function(){return f.maximumCanvases},animatePageFlip:function(){return f.animatePageFlip},clientRectsExpire:function(){return f.clientRectsExpire},rendererInitializationTimeout:function(){return f.rendererInitializationTimeout},drawYieldSanitizeNodesTime:function(){return f.drawYieldSanitizeNodesTime||0},mightUseCSSRegions:function(){return f.mightUseCSSRegions},mightUseNativeSelection:function(){return f.mightUseNativeSelection},defaultNumRegions:function(){return f.defaultNumRegions||
        0},resolutionScale:function(){var f=1;screen.deviceXDPI&&(f=screen.deviceXDPI/96);return f}}}(),KindleRendererLanguageOptions=function(){function f(f){function p(){var a={};a.fontFamilyRegex=d;a.sansFont=b;KindleHostDeviceDetector.isWindows&&KindleHostDeviceDetector.isWindows()?(a.serifFont=g,a.defaultFont=g):(a.serifFont=c,a.defaultFont=c);return a}var f=f&&f.split("-")[0].toLowerCase()||"en",o={};f==="ja"?(o={fontFamilyRegex:m,sansFont:e,serifFont:k,defaultFont:k},j={hasWhitespaceDelimitedWords:!1,
    language:f,lineHeight:"1.75",allowsVerticalLayout:!0,allowsNegativeTextIndent:!0,allowsClearStyle:!1,needsPageRefresh:!0,needsFontSanitization:!0,needsDeviceSpecificItalicsCheck:!0,fontOptions:o}):f==="zh"?(o=p(),j={hasWhitespaceDelimitedWords:!1,language:f,lineHeight:"1.4",allowsVerticalLayout:!0,allowsNegativeTextIndent:!0,allowsClearStyle:!0,needsPageRefresh:!0,needsFontSanitization:!0,needsDeviceSpecificItalicsCheck:!1,fontOptions:o}):(o={fontFamilyRegex:a,sansFont:h,serifFont:l,defaultFont:l},
    j={hasWhitespaceDelimitedWords:!0,language:f,lineHeight:"1.4",allowsVerticalLayout:!1,allowsNegativeTextIndent:!1,allowsClearStyle:!0,needsPageRefresh:!1,needsFontSanitization:!1,needsDeviceSpecificItalicsCheck:!1,fontOptions:o})}var m=/(Hiragino)|(HiraKaku)/,k="'Hiragino Mincho ProN'",e="HiraKakuProN-W3",d=/(SimSun)|(Songti)|(Heiti)/,c="'Songti SC'",b="'Heiti SC'",g="'SimSun'",a=/(serif)|(sans-serif)|(gothic)/i,l="Georgia, serif",h="sans-serif",j={};f("en");return{initialize:f,getHasWhitespaceDelimitedWords:function(){return j.hasWhitespaceDelimitedWords},
    getLanguage:function(){return j.language},getLineHeight:function(){return j.lineHeight},getAllowsVerticalLayout:function(){return j.allowsVerticalLayout},getAllowsNegativeTextIndent:function(){return j.allowsNegativeTextIndent},getAllowsClearStyle:function(){return j.allowsClearStyle},getNeedsPageRefresh:function(){return j.needsPageRefresh},getNeedsFontSanitization:function(){return j.needsFontSanitization},getAcceptedFontFamiliesRegex:function(){return j.fontOptions.fontFamilyRegex},getSansFont:function(){return j.fontOptions.sansFont},
    getSerifFont:function(){return j.fontOptions.serifFont},getDefaultFont:function(){return j.fontOptions.defaultFont},getAllowsItalicFont:function(){return!(j.needsDeviceSpecificItalicsCheck&&KindleRendererDeviceSpecific.needsLanguageSpecificItalicsCheck())}}}(),KindleRendererSettings=function(){function f(b,c,a){try{b.styleSheet&&b.styleSheet.addRule?b.styleSheet.addRule(c,a):b.sheet&&b.sheet.insertRule&&b.sheet.insertRule(c+"{"+a+"}",0)}catch(d){}}function m(b){var e=new jQuery.Deferred;b.getMetadata(function(a){if(a.hasFixedContent!==
    void 0)d.fixedContent=a.hasFixedContent;if(a.publisherMetadata!==void 0){var b=a.publisherMetadata;if(b[0]==="metadata"&&(b=b[2],b!==void 0))for(var f=b.length,j=0;j<f;++j){var k=b[j][1];if(k!==void 0)if(k.name==="fixed-layout")d.fixedContent=k.content==="true";else if(k.name==="original-resolution"&&(k=k.content.match(/(\d+)[Xx](\d+)/)))d.originalResolution={width:parseInt(k[1],10),height:parseInt(k[2],10)}}}if(a.headerMetadata!==void 0){b=a.headerMetadata;if(b.fixedLayout)d.fixedContent=b.fixedLayout===
    "true";if(b.originalResolution&&(f=b.originalResolution.match(/(\d+)[Xx](\d+)/)))d.originalResolution={width:parseInt(f[1],10),height:parseInt(f[2],10)};d.pageProgressionDirection={RTL:0,LTR:1};d.inlineBaseDirection={VERTICAL:0,HORIZONTAL:1};if(b.app_PrimaryWritingMode)d.pageProgressionDirection.value=b.app_PrimaryWritingMode==="vertical-rl"||b.app_PrimaryWritingMode==="horizontal-rl"?d.pageProgressionDirection.RTL:d.pageProgressionDirection.LTR,d.inlineBaseDirection.value=b.app_PrimaryWritingMode.match(/^vertical/)!==
null?d.inlineBaseDirection.VERTICAL:d.inlineBaseDirection.HORIZONTAL;a=a.headerMetadata.app_contentLanguageTag}else a="en";KindleRendererLanguageOptions.initialize(a);if(KindleRendererDeviceSpecific.verticalParagraphsScaleSeparately()&&KindleRendererLanguageOptions.getAllowsVerticalLayout()&&!d.fixedContent)d.initialExpandedBodyHeight=c;d.lineSpacingMultiplier=1;e.resolve()},function(){e.reject()});return e.promise()}function k(){return!d.fixedContent&&KindleRendererDeviceSpecific.mightUseCSSRegions()&&
    KindleRendererFragmentLoader.getBookContentType()!=="topaz"&&KindleRendererFragmentLoader.getBookContentType()!=="mobi8"}function e(){return!d.fixedContent&&KindleRendererDeviceSpecific.mightUseNativeSelection()&&KindleRendererFragmentLoader.getBookContentType()!=="topaz"&&KindleRendererFragmentLoader.getBookContentType()!=="mobi8"}var d={},c="500%";return{initialize:function(b){return m(b)},cleanup:function(){d={}},getSettings:function(){return d},updateSettings:function(b){for(var c in b)d[c]=b[c]},
    addCSSRules:function(b,c){var a=d,l=b.getElementById("kindleRendererOptionsStylesheet");l!==void 0&&l!==null&&l.parentNode.removeChild(l);l=b.createElement("style");l.type="text/css";l.id="kindleRendererOptionsStylesheet";if(!(/MSIE ((5\.5)|6|(7\.0))/.test(navigator.userAgent)&&navigator.platform==="Win32"))try{if(c.appendChild(l),a.fixedContent)f(l,"body","position : absolute; margin: 0;"),a.originalResolution&&f(l,"body.amzUserPref","background-size: contain !important; width: "+a.originalResolution.width+
        "px; height: "+a.originalResolution.height+"px");else{var h;if(a.fontSizes!==void 0){f(l,"body.amzUserPref","font-size : "+a.fontSizes[2]+a.fontSizeUnits+" !important");f(l,"font","font-size : "+a.fontSizes[2]+a.fontSizeUnits+" !important");for(h=0;h<a.fontSizes.length;h+=1)f(l,".font-size-"+(h+1),"font-size : "+a.fontSizes[h]+a.fontSizeUnits+" !important")}if(a.lineSpacingMultiplier!==void 0){var j=KindleRendererLanguageOptions.getLineHeight()*a.lineSpacingMultiplier;f(l,"body.amzUserPref","line-height: "+
        j+"  !important")}a.fontColor!==void 0&&f(l,"body.amzUserPref","color : "+a.fontColor+" !important");a.fontFamily!==void 0&&f(l,"body.amzUserPref","font-family : "+a.fontFamily+" !important");a.backgroundColor!==void 0&&f(l,"body.amzUserPref","background-color : "+a.backgroundColor+" !important");a.fontColor!==void 0&&a.backgroundColor!==void 0&&a.backgroundColor==="#000000"&&f(l,"a","color : "+a.fontColor+" !important");a.textAlign!==void 0&&f(l,"body.amzUserPref","text-align : "+a.textAlign+" !important");
        a.margin!==void 0&&f(l,"body.amzUserPref","margin : "+a.margin+" !important");a.selectionColor!==void 0&&f(l,"div.amazon-selection","background-color : "+a.selectionColor);a.insertBgColor!==void 0&&f(l,".insert","background-color : "+a.insertBgColor);if(a.annotationStyles!==void 0)for(var m in a.annotationStyles){var p=a.annotationStyles[m],o=p.htmlElementTag?p.htmlElementTag+"."+p.className:"div."+p.className;f(l,o,p.style);if(p.additionalStyles)for(var q in p.additionalStyles){var s=p.additionalStyles[q];
            f(l,o+"."+s.className,s.style)}}a.clickableElementFeedbackStyles!==void 0&&f(l,"."+a.clickableElementFeedbackStyles.className,a.clickableElementFeedbackStyles.classStyle);if(a.keyframes!==void 0){var r=a.keyframes,x;for(x in r)f(l,x,r[x])}k()&&a.columns!==void 0&&(f(l,"body","column-count : "+a.columns.num),f(l,"body","column-gap : "+a.columns.gap),f(l,"body","column-fill: auto"),l.styleSheet.cssText+="@media screen and (max-width:320px) { body { column-count: 1 } }");e()&&f(l,"::selection","background-color : "+
            a.selectionColor);if(a.additionalRules!==void 0&&a.additionalRules.length!==void 0)for(h=0;h<a.additionalRules.length;h+=1)f(l,a.additionalRules[h].selector,a.additionalRules[h].style)}}catch(w){}},useCSSRegions:k,useNativeSelection:e,isRTLReadingDirection:function(){return d.pageProgressionDirection.value===d.pageProgressionDirection.RTL}}}(),KindleRendererContentCorrection=function(){function f(a,b,c){if(c.getWritingMode()==="vertical"){a=$(b.body).find(".azn-ECJK");for(b=0;b<a.length;b++){var c=
    a[b].firstChild.nodeValue.charCodeAt(0),d;d=c>=65307&&c<=65308?!0:c===65310?!0:c===65293?!0:!1;d&&(c="rotate(90deg) translateX("+(c===65293?x:"0.5")+"em)",$(a[b]).css({display:"inline-block","-webkit-transform":c,width:"1em",height:"1em","text-indent":"0px","vertical-align":"text-top"}))}}}function m(a,b){var c=a.getComputedStyle(b.body).fontFamily,c=KindleRendererFontHelper.sanitizeFontFamily(c);b.body.setAttribute("style",(b.body.getAttribute("style")||"")+("; font-family: "+c))}function k(a,b){for(var c=
    $(b.body).find(".azn-UNB"),d=0;d<c.length;++d){var e=c[d].firstChild.nodeValue.charCodeAt(0);if(e===8213||e===8212||e===9472){if(e!==9472)e=String.fromCharCode(9472),c[d].innerHTML=e+e;$(c[d]).css("-webkit-transform","scaleY(.9)")}}}function e(a,b,c){if(c.getWritingMode()==="vertical"){a=$(b.body).find(".azn-NTE");for(b=0;b<a.length;b++){c=a[b].firstChild.nodeValue.charCodeAt(0);switch(c){case 8220:c=12317;break;case 8221:c=12319}a[b].firstChild.nodeValue=String.fromCharCode(c)}}}function d(a,b){b.documentElement.setAttribute("lang",
    "ja")}function c(a,b,c){if(c.getWritingMode()==="vertical"){a=$("img",b.body).filter(function(){return $(this).css("float")!=="none"&&$(this).parent().css("display")!=="block"});for(b=0;b<a.length;b++)$(a[b]).parent().css("display","block")}}function b(a,b,c){for(var a=$('img[data-isGaiji="true"]',b.body),d=0;d<a.length;d++)if(c.getWritingMode()==="horizontal")$(a[d]).css("vertical-align","text-top");else if(c.getWritingMode()==="vertical"&&KindleHostDeviceDetector.isAndroid_JellyBean&&KindleHostDeviceDetector.isAndroid_JellyBean()){var e=
    b.createElement("SPAN");e.style.backgroundSize="1em 1em";e.style.backgroundPosition="center";e.style.backgroundImage="url("+a[d].getAttribute("src")+")";e.style.backgroundRepeat="no-repeat";var f=b.createTextNode("\u00a0\u00a0\u00a0\u00a0");e.appendChild(f);a[d].parentNode.replaceChild(e,a[d])}}function g(a,b,c){var d={position:"absolute",height:a.height,width:a.width};b?$.extend(d,{top:a.top,left:a.left+1,borderLeft:"1px solid "+c}):$.extend(d,{top:a.top-1,left:a.left,borderBottom:"1px solid "+c});
    return d}function a(a,b,c){var d={position:"absolute",height:a.height,width:a.width};b?$.extend(d,{top:a.top,left:a.left-1,borderRight:"1px solid "+c}):$.extend(d,{top:a.top+1,left:a.left,borderTop:"1px solid "+c});return d}function l(a,b,c){var d={position:"absolute",top:a.top,left:a.left};b?$.extend(d,{height:a.height,width:Math.floor(a.width/2),borderRight:"1px solid "+c}):$.extend(d,{height:Math.floor(a.height/2),width:a.width,borderBottom:"1px solid "+c});return d}function h(a,b){for(var c,d=
    $('span:not([class*="azn-"])',b.body),e=0;e<d.length;++e)if(currNode=d[e],c=a.getComputedStyle(currNode),c.webkitTextCombine==="horizontal"&&c.webkitWritingMode==="vertical-rl"&&currNode.textContent.length>1&&currNode.textContent.length<5){currNode.setAttribute("data-isTextCombineBlock","true");var f=currNode;c=parseInt(c.fontSize,10);$(f).css("-webkit-text-combine","none");var g=f.getClientRects();if(g.length>0){var h=g[0].height,g=-Math.floor((h-c)/2)+"px";c=h>c?" scaleY("+c/h+")":"";$(f).css({"-webkit-transform":"rotate(270deg)"+
        c,margin:g+" 0px"})}}}function j(a,b){var c=function(a,b){var c=$(a).css("border-"+b+"-style");return c&&c!=="none"},d=$('a, span, div:not([class*="azn-"])',b.body),e,f,g,h,j;for(e=0;e<d.length;e++)currNode=d[e],f=c(currNode,"top"),g=c(currNode,"bottom"),h=c(currNode,"left"),j=c(currNode,"right"),(f||g||h||j)&&currNode.setAttribute("data-hasCssBorder","true")}function n(a,b){for(var c=$("rt",b.body),d=0;d<c.length;d++)$(c[d]).css("font-size","")}function p(b,c,d,e,f,h){if(c.webkitWritingMode.match(h.getWritingMode())!==
    null){var j=f.document,k=j.getElementById(s),o;a:{var m=b;o=c;var n=m,p;p=(p=$(m).attr("class"))&&p.match(/azn-/)?3:2;for(var t=0;t<=p;++t){if(!m)break;(o=m.getAttribute(r)||o.textDecoration)&&(o=o.split(" ")[0]);if(!o||o==="none"){m=m.parentElement;if(!m)break;o=f.getComputedStyle(m)}else{if(n.tagName==="RUBY"){b:{m=n.parentNode.childNodes;for(p=0;p<m.length;p++)if(m[p].tagName!=="RUBY"&&m[p].nodeType!==Node.TEXT_NODE){m=!1;break b}m=!0}n=m?{node:n.parentNode,decoration:o}:{node:n,decoration:o}}else n=
    {node:m,decoration:o};o=n;break a}}o=void 0}n={underline:g,overline:a,"line-through":l};if(!o||!n[o.decoration])k&&k.lastChild&&$(k.lastChild).removeData(r);else{if(!k){m=j.getElementById(q);if(!m)return;k=j.createElement("DIV");k.id=s;k.style.position="relative";k.style.zIndex="-8";m.appendChild(k)}n=n[o.decoration];o.node.setAttribute(r,o.decoration);if(b.tagName==="IMG")e=e[d[0]].rects;else{b={};b.start=d[0];b.end=d[d.length-1];d=KindleRendererWordRectsHelper.createWordBoundaries(b,e,j,f,h);e=
    [];for(f=0;f<d.length;f++)e.push(d[f].rect);e=e.sort(h.clientRectCompare)}d=j.createDocumentFragment();f=k.lastChild;b=o.node;o=c.webkitWritingMode==="vertical-rl";m=j.createElement("DIV");p=!0;var w=t=null,x;if(f&&e.length>0){var y=$(f).data(r);if(y){var L=b===y.node,N=n===y.decoration,S=h.checkIfNewLine(y.line,e[0],!1),Q;var R=y.line,P=e[0];Q=h.clientRectTop(R);var T=h.clientRectTop(P),R=h.clientRectBottom(R),P=h.clientRectBottom(P);Q=n===a?Q===T:n===g?R===P:n===l?Q+R===T+P:!1;L=N&&(L||Q)&&!S;$(f).removeData(r);
    if(L)p=!1,t=y.line,m=f,x=y.maxHeight}}for(f=0;f<e.length;f+=1)y=e[f],p&&(t={top:y.top,height:y.height,left:y.left,right:y.right,width:y.width},x={top:Infinity,right:Infinity,bottom:-Infinity,left:-Infinity}),w=$.extend({},t),p=h.checkIfNewLine(t,e[f+1],!1),h.updateLineHeightOfBounds(x,y),p&&(h.updateLineBounds(t,!1,x,e[f+1],$(j).width()),$(m).css(n(t,o,c.color)),d.appendChild(m),m=j.createElement("DIV"));c={line:w,maxHeight:x,node:b,decoration:n};$(d.lastChild).data(r,c);k.appendChild(d)}}}function o(a){for(var a=
    a.querySelectorAll("["+r+"]"),b=0;b<a.length;++b){var c=$(a[b]);c.attr("style",c.attr("style")+"; text-decoration: none !important")}}var q="content-overlays",s="text-decoration-correction",r="data-cjktextdecoration",x=".425",w=[],y=[],t=[];return{initialize:function(){var a=KindleRendererLanguageOptions.getLanguage();a==="ja"?(w.push(k),w.push(e),w.push(d),w.push(c),w.push(b),w.push(j),w.push(n),KindleRendererDeviceSpecific.shouldRotateECJKChar()&&w.push(f),document.body&&document.body.style.webkitWritingMode!==
    void 0&&(w.push(h),y.push(p)),t.push(o)):a==="zh"&&(w.push(b),w.push(n),w.push(j));KindleRendererLanguageOptions.getNeedsFontSanitization()&&w.push(m)},applyDocumentWideCorrections:function(a,b,c,d){for(var d=d.createSubTimer("correction"),e=0;e<w.length;++e)w[e](a,b,c);d.endTimer()},applyNodeLocalCorrections:function(a,b,c,d,e,f){if(!(y.length===0||!b||b.length===0)){for(var f=f.createSubTimer("correction"),a=a.nodeType===Node.TEXT_NODE?a.parentNode:a,g=d.getComputedStyle(a),h=0;h<y.length;++h)y[h](a,
        g,b,c,d,e);f.endTimer()}},cleanup:function(a){for(var b=0;b<t.length;++b)t[b](a)}}}(),KindleRendererDefaults=function(){function f(f,k,e){f.styleSheet&&f.styleSheet.addRule?f.styleSheet.addRule(k,e):f.sheet&&f.sheet.insertRule&&f.sheet.insertRule(k+"{"+e+"}",f.sheet.cssRules?f.sheet.cssRules.length:f.sheet.rules.length)}return{addCSSRules:function(m,k){if(k==="mobi8"){var e=document.createElement("style");e.type="text/css";e.id="kindleReaderStylesheetDefaults";try{m.insertBefore(e,m.firstChild);KindleRendererSettings.getSettings().fixedContent&&
    f(e,"html","font-size: 15px;");f(e,"table","color: inherit; font-size: inherit; line-height: inherit; font-weight: inherit; font-variant:inherit; font-style:inherit; white-space: inherit; word-wrap: inherit;");KindleRendererDeviceSpecific.needsWritingModeSpecifiedOnBody()&&f(e,"body","-webkit-writing-mode: horizontal-tb");KindleRendererLanguageOptions.getDefaultFont()&&f(e,"body","font-family: "+KindleRendererLanguageOptions.getDefaultFont()+";");KindleRendererLanguageOptions.getLineHeight()&&f(e,
        "body","line-height: "+KindleRendererLanguageOptions.getLineHeight()+";");var d=KindleRendererSettings.getSettings().initialExpandedBodyHeight;d!==void 0&&f(stylesheet,"body","height: "+d+";")}catch(c){}}e=document.createElement("style");e.type="text/css";e.id="kindleReaderStylesheetOverrides";try{m.appendChild(e),k==="mobi7"&&(f(e,"body","font-family: Georgia, serif; word-wrap: break-word;"),f(e,"p","margin-top: 0px; margin-bottom: 0px; text-indent:2em"),f(e,".was-a-p","margin-top: 0px; margin-bottom: 0px; text-indent:2em;"),
        f(e,"hr","margin-top: 15px; margin-bottom: 15px;"),f(e,"center,dd,div,dl,dt,li,ol,pre,table,ul,hr,h1,h2,h3,h4,h5,h6","margin-top: 0px; margin-bottom: 0px;"),f(e,"blockquote","text-indent: 0px; margin-top: 0px; margin-bottom: 0px;"),f(e,"ul","list-style-type: disc;"),f(e,"ol, ul, li .was-a-p","text-indent: 0;"),f(e,"table.amazon-table-style-0","border-collapse:collapse; font-size: inherit;"),f(e,"table.amazon-table-style-0 tr td","border:none; padding:1px;"),f(e,"table.amazon-table-style-0 tr th",
        "border:none; padding:1px; text-align:justify"),f(e,"table.amazon-table-style-1","border-collapse:collapse; font-size: inherit;"),f(e,"table.amazon-table-style-1 tr td","border:1px solid black; padding:1px;"),f(e,"table.amazon-table-style-1 tr th","border:1px solid black; padding:1px; text-align:justify")),k==="mobi8"&&(f(e,"body","word-wrap: break-word; padding: 0px !important;"),f(e,".azn-FWURG","-webkit-text-orientation: upright;"),f(e,".azn-NTE","-webkit-text-emphasis: none !important"),f(e,".azn-UNB",
        "letter-spacing: 0em !important; display: inline-block; text-indent: 0px !important; -webkit-text-orientation: vertical-right !important;"),f(e,".azn-JPLB","display:inline-block; text-indent: 0px !important;")),f(e,".semiTransparentOverlay","z-index: 10 !important; opacity: 0.5"),f(e,"svg img","display: none;"),f(e,".page-break","display:block; padding:1px"),f(e,".pagebreak","display:block; padding:1px"),f(e,".defaultHighlight","background-color:#ffff9b"),f(e,".noDisplay","display:none"),f(e,"body",
        "cursor: default; position: relative;"),KindleRendererSettings.getSettings().fixedContent||(f(e,"body","background: none !important; background-color: transparent !important;"),f(e,"html, body","width: auto; height: auto;"),f(e,"html","-webkit-text-size-adjust: 100%;")),KindleRendererSettings.useCSSRegions()&&(f(e,".was-a-p","orphans:0; widows:0"),f(e,".page-break","break-before:column"),f(e,".pagebreak","break-before:column"),f(e,".renderer-page-break","width:0px; height:0px; break-before:always")),
        KindleRendererSettings.useNativeSelection()?f(e,"body","-webkit-user-select:text; -moz-user-select:text; -ms-user-select:text; unselectable: off;"):f(e,"body","-webkit-user-select:none; -moz-user-select:none; -ms-user-select:none; unselectable: on;"),f(e,".kindle-annotation-wrapper, .kindle-annotation-wrapper *","margin: auto; padding: 0"),f(e,"div#content-overlays","margin: 0px; padding: 0px;")}catch(b){}}}}(),KindleRendererContentStyleSanitization=function(){function f(a,b){var c=a[b];if(c===void 0){var d=
    h.exec(b);d!==null&&d.length>=3&&(b=d[1]+d[2].substring(0,1).toUpperCase()+d[2].substring(1),c=a[b])}return c}function m(a,b,c){if(b==="float")return c.hasFloat=!0;if(b==="position")return a=f(a,b),!(a==="inherit"||a==="static")?c.isPositioned=!0:!1;if(b==="width"){a=f(a,b);if(a!==void 0){if(!c.widths)c.widths={percent:[],fixed:[]};a.indexOf("%")>=0?c.widths.percent.push(a):c.widths.fixed.push(a);return!0}return!1}if(b==="height"){a=f(a,b);if(a!==void 0){if(!c.heights)c.heights={percent:[],fixed:[]};
    a.indexOf("%")>=0?c.heights.percent.push(a):c.heights.fixed.push(a);return!0}return!1}if(b==="max-width"||b==="max-height"){a=f(a,b);if(a!==void 0&&a.indexOf("%")>=0){if(!c.prcntMaxDimension)c.prcntMaxDimension=[];c.prcntMaxDimension.push(a);return!0}return!1}if(b==="font-size")return a=f(a,b),a!==void 0&&!j.test(a)?(n.test(a)?c.remFontValue=a.trim():c.absFontValue=a.trim(),!0):!1;if(b==="line-height")return a=f(a,b),a!==void 0?(c.lineHeight=a,!0):!1;if(b==="background-color")return a=f(a,b),a!==
void 0?(c.backgroundColorRgb=KindleRendererColorHelper.toRgbArray(a.trim()),!0):!1;if(b==="text-indent")return!KindleRendererLanguageOptions.getAllowsNegativeTextIndent()&&(a=f(a,b),a!==void 0)?(c.textIndent=a,!0):!1;if(b==="color")return c.hasTextColor=!0;if(b==="clear")return!KindleRendererLanguageOptions.getAllowsClearStyle()?c.hasClearStyle=!0:!1;if(b==="-webkit-text-combine")return c.textCombine=f(a,b),!0;if(b==="font-family"&&KindleRendererLanguageOptions.getNeedsFontSanitization())return c.langFontFamily=
    f(a,b),!0;if(b==="font-style")return c.fontStyle=f(a,b),!0;if(b==="display")c.display=f(a,b);return!1}function k(a){try{for(var b={},c=a.style.length,d=!1,e=0;e<c;e++)d|=m(a.style,a.style[e],b);if(d)return b}catch(f){}return null}function e(a,b){for(var c=a.rules?a.rules:a.cssRules,d=c&&c.length||0,f=0;f<d;f++){var g=c[f];if(!g.style&&g.media&&g.media.mediaText==="all")e(g,b);else{if(g=k(c[f]))g.selectorText=c[f].selectorText,b.push(g);g=c[f];if(g.selectorText!==void 0&&g.selectorText==="span")g.selectorText=
    'span:not([class*="azn-"])';g=[];for(var h=0;h<g.length;++h)b.push(g[h])}}}function d(a,b){var c=KindleRendererScaleHelper.convertLength(a,"px");return c?(c=parseFloat(c),c=Math.floor(c),c=Math.min(c,b),c+"px"):a}function c(a,b,c,e,f,g,h,j){var k="",l=0;if(a.widths){for(var m=a.widths.percent,n=a.widths.fixed,u=0.95*j.width,l=0;l<m.length;l++)k+="width: auto; ",a.display==="inline-block"&&parseInt(m[l],10)>95&&(k+="display: block; ");for(l=0;l<n.length;l++)m=d(n[l],u),k+=parseInt(m,10)<1?"width: auto; ":
    "width: "+m+"; "}if(a.heights){m=a.heights.percent;n=a.heights.fixed;u=0.95*j.height;for(l=0;l<m.length;l++)k+="height: auto; ",a.display==="inline-block"&&parseInt(m[l],10)>95&&(k+="display: block; ");for(l=0;l<n.length;l++)m=d(n[l],u),k+=parseInt(m,10)<1?"height: auto; ":"height: "+m+"; "}a.lineHeight&&(l=parseFloat(a.lineHeight),k+=a.lineHeight.indexOf("%")>0&&l>=f*100?"line-height : "+l*g+"%; ":/^\d*(\.\d+)?$/.test(a.lineHeight.trim())&&l>=f?"line-height : "+l*g+"; ":"line-height : "+f*g+"; ");
    if(a.prcntMaxDimension)for(l=0;l<a.prcntMaxDimension.length;l++)k+=a.prcntMaxDimension[l]+": none; ";a.hasFloat&&(k+="line-height : "+(f+p)+"; ");a.isPositioned&&(k+="position: inherit; ");a.backgroundColorRgb&&!a.hasTextColor&&b&&(b=KindleRendererColorHelper.calculateTextColorForBackground(b,a.backgroundColorRgb))&&(k+="color : rgb("+b[0]+", "+b[1]+", "+b[2]+"); ");a.absFontValue&&(b=KindleRendererScaleHelper.scaleFont(a.absFontValue,c,e)||a.absFontValue,k+="font-size: "+b+"; ");a.remFontValue&&
    (h=Math.round(parseFloat(a.remFontValue)*parseInt(h,10))+"px",c=KindleRendererScaleHelper.scaleFont(h,c,e)||a.absFontValue,k+="font-size: "+c+"; ");a.textIndent&&parseInt(a.textIndent,10)<0&&(j=0.9*j.width,c=a.textIndent.replace(/-/g,""),c.indexOf("%")>0?(c=parseFloat(c,10)/100,c*=j,c=Math.min(c,j),c=Math.floor(c),c=Math.max(c,1),j=c+"px"):j=d(c,j),c=j,k+="text-indent: -"+c+"; padding-left: "+c+"; ");a.hasClearStyle&&(k+="clear:none");a.textCombine&&(k+="-webkit-text-combine: "+a.textCombine+"; display: inline-block; text-indent: 0px; height: auto;");
    a.langFontFamily&&(j=KindleRendererFontHelper.sanitizeFontFamily(a.langFontFamily),k+="font-family: "+j+";");a.fontStyle&&a.fontStyle==="italic"&&!KindleRendererLanguageOptions.getAllowsItalicFont()&&(k+="font-style: normal;");a.styleString&&(k+=a.styleString);return k}function b(a){var b=a.styleSheets,a=$(a).find('link[rel*="stylesheet"][href], style');if(b.length<a.length)for(var a=a.filter("link"),b=$.makeArray(b),c=$.map(b,function(a){return a.ownerNode}),d=0;d<a.length;++d){var e=a[d],f=e.sheet||
    e.styleSheet;f&&(f.rules?f.rules:f.cssRules)&&c.indexOf(e)<0&&b.push(f)}return b}function g(a){function b(){var a,h,j=0;f++;for(KindleRendererProcessTuning.startingOperation("SanitizeNodes");e.length&&j<g;)if(a=e.pop(),j++,a&&a.nodeType===Node.ELEMENT_NODE){(h=a.getAttribute("style"))&&h.length>0&&a.tagName!=="IMG"&&d.push(a);a=a.childNodes;for(h=0;h<a.length;h++)e.push(a[h])}KindleRendererProcessTuning.endingOperation("SanitizeNodes",j);e.length?setTimeout(b,processTimeout):c.resolve(d,f)}var c=
    $.Deferred(),d=[],e=[],f=0,g=KindleRendererProcessTuning.drawYieldFrequency("SanitizeNodes");processTimeout=KindleRendererProcessTuning.drawYieldUpdateTime("SanitizeNodes");e.push(a);b();return c.promise()}function a(a){var b=[];if((window.ActiveXObject||"ActiveXObject"in window)&&window.XMLHttpRequest)return a=a.querySelectorAll("[style]:not(HTML):not(BODY):not(IMG)"),$.Deferred().resolve(a);else try{for(var c=(new XPathEvaluator).evaluate("/html/body//*[@style]",a,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,
    null),d=c.iterateNext();d;)d.style.length>0&&d.tagName!=="IMG"&&b.push(d),d=c.iterateNext()}catch(e){return g(a.body)}return $.Deferred().resolve(b)}function l(a){var b=$(a).attr("style");b&&$(a).attr("style",b.replace(/!\s*important/g,""))}var h=/^(\w*)-(\w*)(-value)?$/,j=/%|[^r]em|smaller|larger/,n=/rem/,p=0.2;return{sanitizeCSS:function(a,d,f){for(var g=$('link[type="text/css"][title]',a.head),h=0;h<g.length;++h)g[h].removeAttribute("title");if(!d.fixedContent){h=!1;g=a.getElementById("kindleReaderSanitizationStylesheet");
        if(!g){g=a.createElement("style");g.id="kindleReaderSanitizationStylesheet";g.type="text/css";for(var h=g,j=b(a),k=[],l=j.length,m=0;m<l;m++)e(j[m],k);h.sanitizationRules=k;h=!0}if(g.sanitizationRules.length>0){for(var j=g.sanitizationRules,k=d.fontColor?KindleRendererColorHelper.toRgbArray(d.fontColor):null,l=d.fontSizes,m=d.fontSizeUnits,n=KindleRendererLanguageOptions.getLineHeight(),d=d.lineSpacingMultiplier,p=getComputedStyle(a.documentElement).fontSize,A="",u=j.length,H=0;H<u;H++)A+=j[H].selectorText+
            " { ",A+=c(j[H],k,l,m,n,d,p,f),A+=" } ";g.innerHTML=A}h&&a.head.appendChild(g)}},sanitizeContent:function(b,d,e){var f=$.Deferred();if(d.fixedContent)return f.resolve();l(b.body);a(b).done(function(a){for(var g=d.fontColor?KindleRendererColorHelper.toRgbArray(d.fontColor):null,h=d.fontSizes,j=d.fontSizeUnits,l=KindleRendererLanguageOptions.getLineHeight(),m=d.lineSpacingMultiplier,n=getComputedStyle(b.documentElement).fontSize,p=a.length,u=0;u<p;u++){var H=a[u],M=H,E=M.getAttribute("data-origStyle");
        E?M.setAttribute("style",E):M.setAttribute("data-origStyle",M.getAttribute("style"));if(M=k(a[u]))E=H.getAttribute("style")||"",E+="; ",E+=c(M,g,h,j,l,m,n,e),H.setAttribute("style",E)}f.resolve()});return f.promise()},copySanitizationData:function(a,b){var c=a.getElementById("kindleReaderSanitizationStylesheet"),d=b.getElementById("kindleReaderSanitizationStylesheet");if(c&&d)d.sanitizationRules=c.sanitizationRules}}}(),KindleRendererColorHelper=function(){function f(c){if(c.charAt(0)==="#")return c.length===
4?[parseInt(c.charAt(1)+c.charAt(1),16),parseInt(c.charAt(2)+c.charAt(2),16),parseInt(c.charAt(3)+c.charAt(3),16)]:c.length===7?[parseInt(c.charAt(1)+c.charAt(2),16),parseInt(c.charAt(3)+c.charAt(4),16),parseInt(c.charAt(5)+c.charAt(6),16)]:null;var c=c.toUpperCase(),b=e[c];if(b)return b;c=k.exec(c);return c!==null&&c.length===4?[parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10)]:null}function m(c){return d[0]*c[0]+d[1]*c[1]+d[2]*c[2]}var k=/RGB\s*\(\s*(\d*)\s*,\s*(\d*)\s*,\s*(\d*)\s*\)/,e={ALICEBLUE:[240,
        248,255],ANTIQUEWHITE:[250,235,215],AQUA:[0,255,255],AQUAMARINE:[127,255,212],AZURE:[240,255,255],BEIGE:[245,245,220],BISQUE:[255,228,196],BLACK:[0,0,0],BLANCHEDALMOND:[255,235,205],BLUE:[0,0,255],BLUEVIOLET:[138,43,226],BROWN:[165,42,42],BURLYWOOD:[222,184,135],CADETBLUE:[95,158,160],CHARTREUSE:[127,255,0],CHOCOLATE:[210,105,30],CORAL:[255,127,80],CORNFLOWERBLUE:[100,149,237],CORNSILK:[255,248,220],CRIMSON:[220,20,60],CYAN:[0,255,255],DARKBLUE:[0,0,139],DARKCYAN:[0,139,139],DARKGOLDENROD:[184,134,
        11],DARKGRAY:[169,169,169],DARKGREY:[169,169,169],DARKGREEN:[0,100,0],DARKKHAKI:[189,183,107],DARKMAGENTA:[139,0,139],DARKOLIVEGREEN:[85,107,47],DARKORANGE:[255,140,0],DARKORCHID:[153,50,204],DARKRED:[139,0,0],DARKSALMON:[233,150,122],DARKSEAGREEN:[143,188,143],DARKSLATEBLUE:[72,61,139],DARKSLATEGRAY:[47,79,79],DARKSLATEGREY:[47,79,79],DARKTURQUOISE:[0,206,209],DARKVIOLET:[148,0,211],DEEPPINK:[255,20,147],DEEPSKYBLUE:[0,191,255],DIMGRAY:[105,105,105],DIMGREY:[105,105,105],DODGERBLUE:[30,144,255],
    FIREBRICK:[178,34,34],FLORALWHITE:[255,250,240],FORESTGREEN:[34,139,34],FUCHSIA:[255,0,255],GAINSBORO:[220,220,220],GHOSTWHITE:[248,248,255],GOLD:[255,215,0],GOLDENROD:[218,165,32],GRAY:[128,128,128],GREY:[128,128,128],GREEN:[0,128,0],GREENYELLOW:[173,255,47],HONEYDEW:[240,255,240],HOTPINK:[255,105,180],INDIANRED:[205,92,92],INDIGO:[75,0,130],IVORY:[255,255,240],KHAKI:[240,230,140],LAVENDER:[230,230,250],LAVENDERBLUSH:[255,240,245],LAWNGREEN:[124,252,0],LEMONCHIFFON:[255,250,205],LIGHTBLUE:[173,216,
        230],LIGHTCORAL:[240,128,128],LIGHTCYAN:[224,255,255],LIGHTGOLDENRODYELLOW:[250,250,210],LIGHTGRAY:[211,211,211],LIGHTGREY:[211,211,211],LIGHTGREEN:[144,238,144],LIGHTPINK:[255,182,193],LIGHTSALMON:[255,160,122],LIGHTSEAGREEN:[32,178,170],LIGHTSKYBLUE:[135,206,250],LIGHTSLATEGRAY:[119,136,153],LIGHTSLATEGREY:[119,136,153],LIGHTSTEELBLUE:[176,196,222],LIGHTYELLOW:[255,255,224],LIME:[0,255,0],LIMEGREEN:[50,205,50],LINEN:[250,240,230],MAGENTA:[255,0,255],MAROON:[128,0,0],MEDIUMAQUAMARINE:[102,205,170],
    MEDIUMBLUE:[0,0,205],MEDIUMORCHID:[186,85,211],MEDIUMPURPLE:[147,112,216],MEDIUMSEAGREEN:[60,179,113],MEDIUMSLATEBLUE:[123,104,238],MEDIUMSPRINGGREEN:[0,250,154],MEDIUMTURQUOISE:[72,209,204],MEDIUMVIOLETRED:[199,21,133],MIDNIGHTBLUE:[25,25,112],MINTCREAM:[245,255,250],MISTYROSE:[255,228,225],MOCCASIN:[255,228,181],NAVAJOWHITE:[255,222,173],NAVY:[0,0,128],OLDLACE:[253,245,230],OLIVE:[128,128,0],OLIVEDRAB:[107,142,35],ORANGE:[255,165,0],ORANGERED:[255,69,0],ORCHID:[218,112,214],PALEGOLDENROD:[238,232,
        170],PALEGREEN:[152,251,152],PALETURQUOISE:[175,238,238],PALEVIOLETRED:[216,112,147],PAPAYAWHIP:[255,239,213],PEACHPUFF:[255,218,185],PERU:[205,133,63],PINK:[255,192,203],PLUM:[221,160,221],POWDERBLUE:[176,224,230],PURPLE:[128,0,128],RED:[255,0,0],ROSYBROWN:[188,143,143],ROYALBLUE:[65,105,225],SADDLEBROWN:[139,69,19],SALMON:[250,128,114],SANDYBROWN:[244,164,96],SEAGREEN:[46,139,87],SEASHELL:[255,245,238],SIENNA:[160,82,45],SILVER:[192,192,192],SKYBLUE:[135,206,235],SLATEBLUE:[106,90,205],SLATEGRAY:[112,
        128,144],SLATEGREY:[112,128,144],SNOW:[255,250,250],SPRINGGREEN:[0,255,127],STEELBLUE:[70,130,180],TAN:[210,180,140],TEAL:[0,128,128],THISTLE:[216,191,216],TOMATO:[255,99,71],TURQUOISE:[64,224,208],VIOLET:[238,130,238],WHEAT:[245,222,179],WHITE:[255,255,255],WHITESMOKE:[245,245,245],YELLOW:[255,255,0],YELLOWGREEN:[154,205,50]},d=[0.2126/255,0.7152/255,0.0722/255];return{toRgbArray:function(c){return f(c)},calculateTextColorForBackground:function(c,b){var d=Math.abs(m(b)-m(c));if(d<0.3)var a=m(b),
        e=m(c),a=a<0.5?e<a?160:80:e>a?-160:-80,a=[Math.max(0,Math.min(255,c[0]+a)),Math.max(0,Math.min(255,c[1]+a)),Math.max(0,Math.min(255,c[2]+a))],d=Math.abs(m(a)-m(b))>d?a:null;else d=null;return d}}}(),KindleRendererContentScripts=function(){function f(f){f=f.contentWindow.KindleContentInterface;typeof m.gotoPosition==="function"&&(f.gotoPosition=function(e,d){m.gotoPosition(d);return!1});typeof m.openStoreDP==="function"&&(f.buyNow=f.showDetails=function(){m.openStoreDP();return!1})}var m;return{addInterfaceScripts:function(k){var e=
        k.contentDocument.getElementsByTagName("head")[0],d=document.createElement("script");d.language="Javascript";d.type="text/javascript";d.id="kindleContentInterface";if(!(/MSIE ((5\.5)|6|(7\.0))/.test(navigator.userAgent)&&navigator.platform==="Win32"))try{e.appendChild(d),e="var KindleContentInterface = function() { return { ",e+=" gotoPosition : function(frm, pos) {parent.KindleReaderUI.gotoPosition(pos); return false;}, ",e+=" buyNow : function() {parent.KindleReaderUI.openStoreDP();return false;}, ",
        e+=" showDetails : function() {parent.KindleReaderUI.openStoreDP();  return false;} ",e+=" };}();",d.text=e,m&&f(k)}catch(c){}},setCallbacks:function(f){m=f}}}(),KindleRendererEventHandler=function(){function f(d){var c=KindleRendererSettings.getSettings().clickableElementFeedbackStyles;if(c!==void 0){var b=c.className,d=$(d),c=function(){var c=$(this);c.unbind("animationend");c.unbind("webkitAnimationEnd");c.removeClass(b)};d.bind("animationend",c);d.bind("webkitAnimationEnd",c);d.addClass(b)}}function m(d){var c=
    document.createEvent("MouseEvents");c.initEvent("click",!0,!0);var b=d.getAttribute("onclick");b&&(b=b.replace(k,e),d.setAttribute("onclick",b));d.dispatchEvent(c)}var k=/gotoPosition\(,/,e="gotoPosition(0,";return{handleClick:function(d,c,b){var e;var a;if(a=c)b:{for(a=c;a!==null;){if(a.getAttribute!==void 0){var k=a.getAttribute("onclick")||a.getAttribute("href");if(k!==null&&k.length>0){a=!0;break b}}a=a.parentNode}a=!1}a&&(f(c),m(c),e=!0);if(!(c=e)){d=d.getElementById("annotation-section");d=
        $(d).find("["+KindleRendererAnnotationRenderer.ANNOTATION_CLICK_ATTRIBUTE+"='true']").children();c=null;e=-Infinity;a=d.length;for(k=0;k<a;k+=1){var h=d[k],j=$(h).offset();j.top-10<b.y&&b.y<j.top+$(h).height()+10&&j.left-10<b.x&&b.x<j.left+$(h).width()+10&&(j=parseInt($(h).css("z-index"),10),isNaN(j)&&(j=0),j>e&&(e=j,c=h))}if(b=c){if((d=b.parentNode)&&d.getAttribute(KindleRendererAnnotationRenderer.ANNOTATION_CLICK_FEEDBACK_ATTRIBUTE)!=="false"){d=d.childNodes;for(c=0;c<d.length;c++)f(d[c])}m(b);
        c=!0}else c=!1}return c}}}(),KindleRendererFontHelper=function(){var f=/(sans)|(gothic)/i,m=/serif/i;return{sanitizeFontFamily:function(k){var e=k.split(",");if(KindleRendererLanguageOptions.getNeedsFontSanitization()&&!k.match(KindleRendererLanguageOptions.getAcceptedFontFamiliesRegex())){for(var k="",d=0;d<e.length;++d){var c=e[d];k+=c.match(f)?KindleRendererLanguageOptions.getSansFont()+", "+c:c.match(m)?KindleRendererLanguageOptions.getSerifFont()+", "+c:c;d<e.length-1&&(k+=",")}k.match(KindleRendererLanguageOptions.getAcceptedFontFamiliesRegex())||
    (k+=","+KindleRendererLanguageOptions.getDefaultFont());k+=" !important"}return k}}}(),KindleListUtilities=function(){return{binarySearch:function(f,m,k,e,d){if(!f.length)return 0;var c=f.length-1,b=0,g=0,a=null,l=0;e>b&&e<=c&&(b=e);for(d>=b&&d<c&&(c=d);b<=c;)if(g=Math.floor((b+c)/2),a=f[g],l=0,k===void 0?a>m?l=1:a<m&&(l=-1):l=k(m,a),l>0)c=g-1;else if(l<0)b=g+1;else return g;return g===0||l<0?g:g-1},sortedMerge:function(f,m){var k=[],e=f.length,d=m.length,c=0,b=0;if(e){if(!d)return f}else return m;
        for(var g,a;c<e&&b<d;)g=f[c],a=m[b],g<a?(k.push(g),++c):(k.push(a),++b);for(;c<e;)k.push(f[c++]);for(;b<d;)k.push(m[b++]);return k},first:function(f){return f[0]},last:function(f){return f[f.length-1]}}}(),KindleRendererProcessTuning=function(){function f(f){var e,d=m[f];if(d){if(!d.unitTime)return d.frequency;f=d.frequency*d.unitTime;if(f>100){if(e=Math.floor(Math.max(100/d.unitTime,d.minimumFrequency)),e<d.frequency)d.frequency=e}else if(f<50){if(e=Math.ceil(Math.max(50/d.unitTime,d.minimumFrequency)),
e>d.frequency)d.frequency=e}else e=d.frequency}else e=KindleRendererDeviceSpecific["drawYield"+f+"Frequency"]?KindleRendererDeviceSpecific["drawYield"+f+"Frequency"]():100,d=KindleRendererDeviceSpecific["drawYield"+f+"UpdateTime"]?KindleRendererDeviceSpecific["drawYield"+f+"UpdateTime"]():KindleRendererDeviceSpecific.drawYieldUpdateTime(),m[f]={frequency:e,minimumFrequency:e/4,yieldTime:d};return e}var m={};return{runAfterYield:function(f,e,d){e>=2&&f>=0?(e=KindleMetricsProfiler("(YIELD)"),setTimeout(d,
        f),e.endTimer()):d()},startingOperation:function(k){var e=m[k];e||(f(k),e=m[k]);e.startTime=Date.now()},endingOperation:function(k,e){var d;var c=m[k];c||(f(k),c=m[k]);if(c.startTime){var b=Date.now()-c.startTime;if(!(e<1)){var g=m[k];b/=e;if(g.unitTime){var a=0.1*e/g.frequency;g.unitTime=a*b+(1-a)*g.unitTime}else g.unitTime=b}c.startTime=0}else d=void 0;return d},drawYieldFrequency:function(k){return f(k)},drawYieldUpdateTime:function(k){var e=m[k];e||(f(time),e=m[k]);return e.yieldTime}}}(),KindleRendererScaleHelper=
    function(){function f(b,d){if(!c[d])return null;var a=b.match(e);return a?(a=c[a[1]],parseFloat(b,10)*a/c[d]):null}function m(b,c,a){if((b=b.match(k))&&c.length>0){var b=d[b[1]],e=Math.floor((c.length-1)/2),f=parseFloat(c[0],10),e=parseFloat(c[e],10),c=parseFloat(c[c.length-1],10);return Math.min(c,Math.max(f,b*e))+a}return null}var k=/(xx-small|x-small|small|medium|large|x-large|xx-large)/,e=/(mm|cm|in|pt|pc|px)/,d={"xx-small":0.6,"x-small":0.75,small:0.889,medium:1,large:1.2,"x-large":1.5,"xx-large":2},
        c={mm:2.835,cm:28.346,"in":72,pt:1,pc:6,px:1.25};return{scaleFont:function(b,c,a){if(a=a.match(e)){var a=a[1],k;if(!(k=m(b,c,a)))k=(b=f(b,"pt"))?m(b<=d["xx-small"]*25?"xx-small":b<=d["x-small"]*25?"x-small":b<=d.small*25?"small":b<=d.medium*25?"medium":b<=d.large*25?"large":b<=d["x-large"]*25?"x-large":"xx-large",c,a):null;c=k}else c=b;return c},convertLength:function(b,c){var a=f(b,c);return a?a+c:null}}}(),KindleRendererUtils=function(){function f(b){if(b)if(b.firstChild)return b.firstChild;else if(b.nextSibling)return b.nextSibling;
else{do b=b.parentNode;while(b&&!b.nextSibling);return b&&b.nextSibling}else return null}function m(b){if(b)if(b.lastChild)return b.lastChild;else if(b.previousSibling)return b.previousSibling;else{do b=b.parentNode;while(b&&!b.previousSibling);return b&&b.previousSibling}else return null}function k(b){return b?/^(SPAN|CANVAS|IMG)$/i.test(b.tagName)&&isFinite(b.id):!1}var e=/metro/i,d=/desktop/i,c={};return{nextPositionedNode:function(b){for(b=f(b);b;){if(k(b))return b;b=f(b)}return null},previousPositionedNode:function(b){for(b=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         m(b);b;){if(k(b))return b;b=m(b)}return null},followingNode:function(b){var c;if(b){for(c=b.nextSibling;b&&!c;)b=b.parentNode,c=b.nextSibling;return c}else return null},precedingNode:function(b){var c;if(b){for(c=b.previousSibling;b&&!c;)b=b.parentNode,c=b.previousSibling;return c}else return null},isBlock:function(b){return b?/^(ADDRESS|ARTICLE|ASIDE|AUDIO|BLOCKQUOTE|DD|DIV|DL|FIELDSET|FIGCAPTION|FIGURE|FOOTER|FORM|H[1-6]|HEADER|HGROUP|HR|NOSCRIPT|OL|OUTPUT|P|PRE|SECTION|TABLE|TFOOT|UL|VIDEO)$/i.test(b.tagName):
        !1},findElementAtOrAfterPosition:function(b,c){for(var a=b.querySelectorAll("span.k4w, canvas.k4wc, img"),d=0;a[d];){if(parseInt(a[d].id,10)>=c)return a[d];d++}return null},findElementAtOrBeforePosition:function(b,c){for(var a=b.querySelectorAll("span.k4w, canvas.k4wc, img"),d=null,e=0;a[e]&&parseInt(a[e].id,10)<=c;)d=a[e],e++;return d},treeDepth:function(b){for(var c=0;b.parentNode;)c++,b=b.parentNode;return c},elementFromPoint:function(b,c,a){var f=KindleHostDeviceDetector.getDevicePlatform(),h=
        f&&f.match(e),f=f&&f.match(d)&&KindleHostDeviceDetector.isIE();if(h||f){if(b=b.msElementsFromPoint(c,a),b!==null&&b.length>0)return b[0]}else return b.elementFromPoint(c,a)},isNumeric:function(b){return!isNaN(parseFloat(b))&&isFinite(b)},count:function(b,d,a){if(b){var e=c[b]||0;a||c[b]===void 0?c[b]=d:d&&(c[b]+=d);return e}}}}(),KindleRendererWordRectsHelper=function(){function f(e,d,c,b){if(d)for(var f=d.length,a=0;a<f;a++)!c&&b?e.push({rect:d[a],dataNid:c,tagName:b}):e.push({rect:d[a],dataNid:c})}
    function m(e,d,c,b,g){function a(a){if(a&&h[a]){var a=h[a],d=c,e=b,m=g,n=d.querySelector("["+k+"='"+a.dataNid+"']").childNodes[a.childIndex],d=d.createRange();d.setStart(n,a.startOffset);d.setEnd(n,a.endOffset);var d=d.getClientRects(),o;e&&e.getComputedStyle&&(o=e.getComputedStyle(n.parentNode));j=m.getTransformedClientRects(d,n,o);f(l,j,a.dataNid)}}var l=[],h={},j,m=!1,p,o;for(o=e.start;o<=e.end;o+=1)if(d[o])if(d[o].rects)p&&h[p]&&(a(p),delete h[p]),f(l,d[o].selectableRects||d[o].rects,d[o].dataNid,
        d[o].tagName),m=!0;else{var q=d[o];if(m||h[p]===void 0||h[p].dataNid!==q.dataNid||h[p].childIndex!==q.childIndex)h[o]={startOffset:q.startOffset,endOffset:q.endOffset,dataNid:q.dataNid,childIndex:q.childIndex},p=o;else{m=h[p].startOffset;if(m===void 0||m>q.startOffset)h[p].startOffset=q.startOffset;m=h[p].endOffset;if(m===void 0||m<q.endOffset)h[p].endOffset=q.endOffset}m=!1}for(o in h)a(o);return l}var k="data-nid";return{createWordBoundaries:function(e,d,c,b,f){return m(e,d,c,b,f)}}}(),KindleRendererZoomableFixedContentFactory=
    function(){function f(b,c){return b.data&&c.data?b.data.ordinal!==void 0&&c.data.ordinal!==void 0?b.data.ordinal-c.data.ordinal:b.data.ordinal===void 0&&c.data.ordinal===void 0?0:b.data.ordinal!==void 0?-1:1:!b.data&&!c.data?0:b.data?-1:1}function m(b,c){if(b.getBoundingClientRect){var a=b.getBoundingClientRect();if(a)return{top:a.top+c.y,right:a.right+c.x,bottom:a.bottom+c.y,left:a.left+c.x,width:a.width,height:a.height}}return null}function k(b){b.setActive=function(b){if(this.sourceElement){var a=
        this.sourceElement.ownerDocument;if(a&&this.data.targetId){var c=$(a).find("#"+this.data.targetId),d=null;b?(this.data.sourceId&&(d=$(a).find("#"+this.data.sourceId),c.html().trim().length===0&&(b=d.clone(),b.css({visibility:"visible",color:"black"}),$(c).append(b)),d.hide()),c.show()):(c.hide(),this.data.sourceId&&(d=$(a).find("#"+this.data.sourceId),d.show()))}}};b.isSame=function(b){return b.internalComparison(this.sourceElement)};b.internalComparison=function(b){return this.sourceElement===b};
        b.getBounds=function(){if(this.sourceElement){var b=this.sourceElement.ownerDocument;if(b&&this.data.targetId&&(b=$(b).find("#"+this.data.targetId),b.is(":visible"))){var a=b.children(".target-mag"),b=a.length===1?a:b;return m(b.get(0),this.origin)}return m(this.sourceElement,this.origin)}return null}}function e(b,c){b.activate=function(){return c.setActive(!0)};b.deactivate=function(){return c.setActive(!1)};b.isSame=function(a){return c.isSame(a)};b.getBounds=function(){return c.getBounds()};b.internalComparison=
        function(a){return c.internalComparison(a)}}function d(b,d,a){b.origin=d;b.sourceElement=a;d=a.getAttribute(c);b.data=jQuery.parseJSON(d)}var c="data-app-amzn-magnify";return{buildList:function(b,c){for(var a=[],l=$(b).find(".app-amzn-magnify").get(),h=0;h<l.length;h++)try{var j={};d(j,c,l[h]);k(j);a.push(j)}catch(m){}a.sort(f);l=[];for(h=0;h<a.length;h++)j={},e(j,a[h]),l.push(j);return l},buildFromCoord:function(b,c,a,f){a:{for(b=KindleRendererUtils.elementFromPoint(b,a-c.x,f-c.y);b;){if($(b).hasClass("app-amzn-magnify")){a=
            b;break a}b=b.parentNode}a=null}if(a)try{return b={},d(b,c,a),k(b),c={},e(c,b),c}catch(h){}return null}}}(),KindleRendererZoomableReflowableContentFactory=function(){function f(e){for(;e;){if(e.tagName==="IMG")return e;e=e.parentNode}return null}function m(e){e.clone=function(){if(this.sourceElement)return $(this.sourceElement).clone().get(0)};e.getBounds=function(){var d;if(this.sourceElement)a:{var c=this.sourceElement;d=this.origin;if(c.getBoundingClientRect&&(c=c.getBoundingClientRect())){d={top:c.top+
        d.y,right:c.right+d.x,bottom:c.bottom+d.y,left:c.left+d.x,width:c.width,height:c.height};break a}d=null}else d=null;return d}}function k(e,d){e.clone=function(){return d.clone()};e.getBounds=function(){return d.getBounds()}}return{buildFromCoord:function(e,d,c,b){c-=d.x;b-=d.y;var g=KindleRendererUtils.elementFromPoint(e,c,b);if(g&&g.className.match(/amazon-highlight/)){var a=g;a.style.display="none";g=KindleRendererUtils.elementFromPoint(e,c,b);a.style.display="block"}if(c=f(g))try{return e={},e.origin=
        d,e.sourceElement=c,m(e),d={},k(d,e),d}catch(l){}return null},buildFromElement:function(e,d){var c=f(e);if(c)try{var b={};b.origin=d;b.sourceElement=c;m(b);c={};k(c,b);return c}catch(g){}return null}}}(),KindleRendererZoomablesFactory=function(){return{buildList:function(f,m){return $(f.body).css("position")==="absolute"?KindleRendererZoomableFixedContentFactory.buildList(f,m):[]},buildFromCoord:function(f,m,k,e){return $(f.body).css("position")==="absolute"?KindleRendererZoomableFixedContentFactory.buildFromCoord(f,
        m,k,e):KindleRendererZoomableReflowableContentFactory.buildFromCoord(f,m,k,e)}}}();_KReW_build_id="6925405a153d7e2c11f61e4a7e791693a071a948";

KindleRenderer.DRAW_AFTER = KindleRendererAnnotationRenderer.DRAW_AFTER;
KindleRenderer.DRAW_OVER  = KindleRendererAnnotationRenderer.DRAW_OVER;
return KindleRenderer;
}
